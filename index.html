<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Aurora — NotebookLM + Knowledge Vault (Integrated)</title>
<style>


:root{
  --bg:#0b1020; --ink:#e6edf7; --muted:#9aa4b8; --border:rgba(255,255,255,.12);
  --tab:#141a2a; --tab-on:#1e293b;
}
html,body{height:100%;margin:0;background:linear-gradient(120deg,#0b1020,#0a1a36 55%,#0b1020);color:var(--ink);font:500 14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(120%) blur(8px);
  background:linear-gradient(90deg,rgba(139,92,246,.14),rgba(34,211,238,.12));border-bottom:1px solid var(--border)}
.header .wrap{display:flex;align-items:center;gap:10px;max-width:1280px;margin:0 auto;padding:10px 14px}
h1{font-size:18px;margin:0}
.tabs{display:flex;gap:8px;margin-left:auto;flex-wrap:wrap}
.tab{appearance:none;border:1px solid var(--border);background:var(--tab);color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
.tab.on{background:linear-gradient(90deg,#8b5cf6,#22d3ee);color:#04111f;font-weight:800;border-color:transparent}
.container{max-width:1280px;margin:0 auto;padding:10px 14px}
.ifr-wrap{height:calc(100vh - 64px)}
iframe{width:100%;height:100%;border:1px solid var(--border);border-radius:14px;background:#0b1224}
.help{font-size:12px;color:var(--muted)}
footer{text-align:center;color:var(--muted);font-size:12px;padding:10px}
@media (max-width: 720px){ .ifr-wrap{height:calc(100vh - 96px)} }

/* === Book View === */
.book-toolbar{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);background:linear-gradient(90deg,rgba(139,92,246,.06),rgba(34,211,238,.04));border-radius:14px 14px 0 0}
.book-toolbar .left,.book-toolbar .right{display:flex;gap:8px;align-items:center}
.book-toolbar .center{font-weight:700;opacity:.8}
.book-toolbar .sep{width:1px;height:18px;background:var(--border);display:inline-block;margin:0 4px}
.book-btn{appearance:none;border:1px solid var(--border);background:rgba(255,255,255,.02);padding:6px 10px;border-radius:10px;color:var(--ink);cursor:pointer}
.book-btn:hover{border-color:rgba(255,255,255,.25)}
.book-shell{display:grid;grid-template-columns:260px 1fr;gap:12px;height:calc(100% - 54px);padding:12px}
.book-toc{border:1px dashed var(--border);border-radius:12px;padding:10px;overflow:auto}
.book-toc h4{margin:4px 0 8px;font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
.book-toc .toc-item{display:block;padding:6px 8px;border-radius:8px;cursor:pointer;border:1px solid transparent}
.book-toc .toc-item:hover{border-color:var(--border);background:rgba(255,255,255,.02)}
.book-pages{height:100%;overflow-x:auto;overflow-y:hidden;scroll-behavior:smooth;border:1px solid var(--border);border-radius:12px;background:radial-gradient(1000px 240px at 30% -20%, rgba(139,92,246,.1), transparent 60%), radial-gradient(1000px 240px at 70% 120%, rgba(34,211,238,.1), transparent 60%);padding:0;position:relative}
.book-pages::-webkit-scrollbar{height:10px}
.book-pages::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:6px}
#bookPages{overflow-x:auto;overflow-y:hidden;scroll-snap-type:x mandatory;}#bookContent{height:100%;padding:0;display:flex;gap:12px;line-height:1.65;orphans:3;widows:3}
#bookContent h2{font-size:20px;margin:0 0 10px}
#bookContent h3{font-size:16px;margin:14px 0 8px;opacity:.9}
#bookContent p{margin:0 0 8px}
#bookContent .nb-page{flex:0 0 100%;height:100%;overflow-y:auto;scroll-snap-align:start;padding:26px 12% 40px;}

/* === Clear framing for Book View === */
#bookContent{column-gap:42px;}
#bookContent .nb-block{
  break-inside: avoid; margin: 12px 0 18px; padding: 12px 14px;
  border:1px solid rgba(126,231,255,.22); border-radius:14px;
  background:rgba(255,255,255,.04);
  box-shadow:inset 0 0 24px rgba(126,231,255,.05);
}
#bookContent .nb-head{
  font-size:18px; font-weight:800; letter-spacing:.2px; margin-bottom:8px;
  color:rgba(255,255,255,.92);
  border-bottom:1px dashed rgba(126,231,255,.25);
  padding-bottom:6px;
}
#bookContent .note-card{
  break-inside: avoid; margin:10px 0; padding:10px 12px;
  border:1px solid rgba(255,255,255,.14); border-radius:10px;
  background:rgba(255,255,255,.03);
}
#bookContent .note-card p{ margin:0 0 6px; }
#bookContent .note-card p:last-child{ margin-bottom:0; }
#bookContent .note-card hr{ border:none; border-top:1px solid rgba(255,255,255,.12); margin:8px 0; }

@media (max-width: 980px){
  .book-shell{grid-template-columns:1fr}
  #bookContent{padding:20px 8% 40px;column-width:420px}
}


/* === Glassbook Skin === */
#book-view.glass-on .book-shell{grid-template-columns: 1fr 1fr;}
#glassLeft{display:none; height:100%; position:relative;}
#book-view.glass-on #glassLeft{display:block;}
#book-view.glass-on .book-pages{border:none; background:transparent; box-shadow:none; padding:0;}

#book-view.glass-on .book-shell{position:relative; perspective:1600px; gap:18px;}
#book-view.glass-on .book-shell::before{ /* spine */
  content:""; position:absolute; left:calc(50% - 4px); top:10px; bottom:10px;
  width:8px; border-radius:8px;
  background:linear-gradient(180deg, rgba(126,231,255,.15), rgba(59,130,246,.15));
  box-shadow: inset 0 0 20px rgba(126,231,255,.35), 0 0 30px rgba(126,231,255,.12);
  pointer-events:none;
}

#book-view.glass-on #glassLeft,
#book-view.glass-on #bookPages{
  border-radius:22px; overflow:hidden;
  background:linear-gradient(135deg, rgba(126,231,255,.08), rgba(34,211,238,.04));
  border:1px solid rgba(126,231,255,.20);
  box-shadow:
    inset 0 0 80px rgba(126,231,255,.10),
    0 12px 40px rgba(2, 6, 23, .6),
    0 0 40px rgba(126,231,255,.08);
  backdrop-filter: blur(8px);
}

/* Decorative glow edge */
#book-view.glass-on #glassLeft::after,
#book-view.glass-on #bookPages::after{
  content:""; position:absolute; inset:0;
  border-radius:22px; pointer-events:none;
  background:radial-gradient(100% 40% at 10% -10%, rgba(126,231,255,.30), transparent 60%),
             radial-gradient(100% 40% at 90% 110%, rgba(34,211,238,.25), transparent 60%);
  mix-blend-mode: screen; opacity:.8;
}

/* Left widgets */
#glassLeft{padding:16px; display:flex; flex-direction:column; gap:12px;}
.glass-card{border:1px solid rgba(255,255,255,.14); border-radius:18px;
  background:rgba(255,255,255,.03); padding:12px; box-shadow:inset 0 0 20px rgba(255,255,255,.06);}
.glass-card .g-title{font-weight:700; letter-spacing:.3px; opacity:.85; margin-bottom:6px}
.g-row{display:flex; gap:8px; align-items:center; margin:6px 0; opacity:.9}
.g-row input{accent-color:#7ee7ff}
.g-tags{display:flex; gap:6px; flex-wrap:wrap; margin-top:8px}
.g-tags span{font-size:12px; border:1px solid rgba(126,231,255,.4); border-radius:999px; padding:4px 8px; opacity:.9}
.g-upload{width:100%; margin-top:10px; border:1px solid rgba(255,255,255,.16); background:rgba(126,231,255,.08);
  padding:8px 10px; border-radius:12px; color:inherit; cursor:pointer;}
.glass-card.actions{display:flex; align-items:center; gap:10px; justify-content:space-between}
.g-mic{font-size:16px; border:1px solid rgba(126,231,255,.35); background:rgba(126,231,255,.10); padding:8px 10px; border-radius:12px}
.g-sum{flex:1; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06); padding:8px 12px; border-radius:12px}
.g-range{width:120px}

/* Gesture hints */
.gesture-hints{position:absolute; right:-44px; top:30%; display:flex; flex-direction:column; gap:14px; opacity:.7; pointer-events:none}
.gesture-hints .gh{filter:drop-shadow(0 4px 10px rgba(126,231,255,.4));}

@media (max-width: 1100px){
  #book-view.glass-on .book-shell{grid-template-columns: 1fr;}
  #book-view.glass-on #glassLeft{display:none;}
  #book-view.glass-on .book-shell::before{display:none;}
  .gesture-hints{display:none;}
}


/* Hide the 3 hand glyphs in Book View */
#book-view #glassLeft .gh{ display:none !important; }

/* Hide summary control card if left in DOM */
#book-view .glass-card.actions{ display:none !important; }

/* Show only note titles in NLM TOC */
#nlmTocPane .lvl2, #nlmTocPane .lvl3, #nlmTocPane .lvl4, #nlmTocPane .lvl5 {
  display: none !important;
}

/* --- Book TOC: resizable + pinned --- */
#book-view .book-toc{
  resize: horizontal;
  min-width: 220px;
  max-width: 60vw;
}
#bookTocPin.book-btn{ margin-left:6px; }

/* Default: hide Book TOC until user toggles */
/* unhide book toc by default */

/* Hide pin button completely */
#bookTocPin{display:none !important}
</style>

<style id="glassbook-aura-colors">
/* === Glassbook AURA palette (readable + đẹp) === */
:root {
  --vio: #8b5cf6;
  --cy:  #22d3ee;
  --ink: #e6edf7;
}

/* Bring back subtle cyan–violet aura without hurting contrast */
#book-view.glass-on #glassLeft,
#book-view.glass-on #bookPages{
  background:
    linear-gradient(135deg, rgba(6,14,28,0.86), rgba(6,14,28,0.86)),
    radial-gradient(1200px 260px at 25% -20%, rgba(139,92,246,.08), transparent 60%),
    radial-gradient(1200px 260px at 75% 120%, rgba(34,211,238,.08), transparent 60%)
    !important;
  background-blend-mode: normal, screen, screen;
  border: 1px solid rgba(126,231,255,0.18) !important;
  box-shadow: 0 8px 22px rgba(2,6,23,0.5) !important;
}

/* Re-enable a very soft spine */
#book-view.glass-on .book-shell::before{
  display:block !important;
  width:4px; left:calc(50% - 2px);
  background:linear-gradient(180deg, rgba(126,231,255,.10), rgba(59,130,246,.10));
  box-shadow: inset 0 0 10px rgba(126,231,255,.22);
  opacity:.35;
}

/* Headings and separators with elegant accent */
#bookContent .nb-head{
  color: var(--ink) !important;
  text-shadow: 0 0 8px rgba(139,92,246,.10), 0 0 8px rgba(34,211,238,.08);
  border-bottom: 1px solid rgba(126,231,255,0.3) !important;
}

/* Accent focus rings for buttons/controls */
.book-btn:focus { outline: none; box-shadow: 0 0 0 2px rgba(139,92,246,.35); }
#bookFont::-webkit-slider-thumb{ box-shadow: 0 0 0 2px rgba(34,211,238,.35); }

/* Tag chips on left with cyan border */
#glassLeft .g-tags span{
  border-color: rgba(126,231,255,.55) !important;
}

/* Keep cards dark but let borders pick up accent */
#bookContent .nb-block{
  border-color: rgba(126,231,255,0.34) !important;
}

/* Slight gradient underline for h2/h3 inside pages */
#bookContent h2, #bookContent h3{
  position: relative;
}
#bookContent h2::after, #bookContent h3::after{
  content:""; position:absolute; left:0; right:0; bottom:-4px; height:1px;
  background: linear-gradient(90deg, rgba(139,92,246,.45), rgba(34,211,238,.45));
  opacity:.6;
}
</style>


<style>
/* === NLM TOC (portable) === */
#nlmTocBtn{position:absolute; display:none; top:8px; right:12px; z-index:20; display:none;}
#nlmTocBtn button{
  padding:6px 10px;border:1px solid rgba(126,231,255,.35);
  background:linear-gradient(90deg,#22d3ee,#8b5cf6); color:#04111f;
  border-radius:10px; font-weight:800; box-shadow:0 6px 18px rgba(2,6,23,.4);
}
#nlmTocPane{
  position:absolute; top:56px; right:10px; width:280px; bottom:12px; display:none;
  background:#0b1224; border:1px solid rgba(126,231,255,.2); border-radius:14px;
  box-shadow:0 12px 42px rgba(2,6,23,.7); z-index:20;
  display:flex; flex-direction:column; overflow:hidden;
}
#nlmTocPane header{ padding:10px 12px; border-bottom:1px solid rgba(126,231,255,.18); font-weight:800; }
#nlmTocPane .body{ padding:10px; overflow:auto; gap:6px; display:flex; flex-direction:column; }
#nlmTocPane .item{ padding:8px; border:1px solid rgba(255,255,255,.08); border-radius:10px;
  background:rgba(255,255,255,.03); color:#e6edf7; cursor:pointer; }
#nlmTocPane .item:hover{ background:rgba(126,231,255,.08); border-color:rgba(126,231,255,.25); }
#nlmTocPane .lvl1{ margin-left:0 }
#nlmTocPane .lvl2{ margin-left:8px; opacity:.95 }
#nlmTocPane .lvl3{ margin-left:16px; opacity:.85 }
</style>

<style>/* allow NLM TOC to be toggled by app logic */</style>
<style id="glassbook-readable-tune">
/* === Glassbook Readability & Layout Fix === */
/* Narrower, predictable left column + more content width */
#book-view.glass-on .book-shell{ grid-template-columns: minmax(280px,320px) 1fr; gap:16px; }

/* Darker, semi-opaque backgrounds; softer blur; less glow */
#book-view.glass-on #glassLeft,
#book-view.glass-on #bookPages{
  background: rgba(6,14,28,0.78) !important;
  border: 1px solid rgba(126,231,255,0.12) !important;
  box-shadow: 0 8px 22px rgba(2,6,23,0.55) !important;
  backdrop-filter: blur(2px) !important;
}

/* Remove decorative glows/spine in glass mode (causes glare) */
#book-view.glass-on #glassLeft::after,
#book-view.glass-on #bookPages::after,
#book-view.glass-on .book-shell::before{
  display:none !important;
}

/* Increase text contrast on pages */
#bookPages, #bookPages *{
  color: #eaf2ff;
}

/* Make content blocks readable with darker card background */
#bookContent .nb-block{
  background: rgba(10,20,30,0.55) !important;
  border-color: rgba(126,231,255,0.25) !important;
  box-shadow: inset 0 0 10px rgba(126,231,255,0.06) !important;
}

/* Note cards: subtle but visible */
#bookContent .note-card{
  background: rgba(255,255,255,0.045) !important;
  border-color: rgba(255,255,255,0.14) !important;
}

/* Headings pop a bit more */
#bookContent .nb-head{
  color: #f0f6ff !important;
  border-bottom-color: rgba(126,231,255,0.28) !important;
}

/* Comfortable inner paddings for two-page layout */
#bookContent .nb-page{
  padding: 24px 9% 36px !important;
  line-height: 1.7;
}

/* Tone down left widget visuals */
#glassLeft .glass-card{
  background: rgba(10,20,30,0.45) !important;
  border-color: rgba(255,255,255,0.10) !important;
}
#glassLeft .g-upload{
  background: rgba(126,231,255,0.10) !important;
  border-color: rgba(126,231,255,0.25) !important;
}
</style>


<style id="remove-left-pane">
/* Remove the left notebook pane in Book View */
#glassLeft { display: none !important; }
/* Force single-column layout for Book View */
#book-view .book-shell,
#book-view.glass-on .book-shell { grid-template-columns: 1fr !important; }
/* Hide decorative spine if any */
#book-view .book-shell::before,
#book-view.glass-on .book-shell::before { display: none !important; }
</style>


<style>
  .editing .nb-head[contenteditable="true"],
  .editing .note-card[contenteditable="true"] { outline: 1px dashed var(--border); outline-offset: 2px; }
  .editing .note-card[contenteditable="true"] { padding: 8px; border-radius: 10px; }
  .book-btn[disabled] { opacity:.5; pointer-events:none; }
</style>


<style>
  .rendering .note-card[data-rendered="1"] { background: rgba(255,255,255,0.02); border-radius: 10px; padding: 10px; }
  .rendering .note-card[data-rendered="1"] table { width: 100%; border-collapse: collapse; margin: 10px 0; }
  .rendering .note-card[data-rendered="1"] th, 
  .rendering .note-card[data-rendered="1"] td { border: 1px solid rgba(255,255,255,.15); padding: 6px 8px; vertical-align: top; }
  .rendering .note-card[data-rendered="1"] th { background: rgba(255,255,255,.06); }
  .rendering .note-card[data-rendered="1"] input[type="checkbox"] { transform: translateY(1px); }
</style>


<style id="bookview-fixes">
/* Show TOC by default (can be toggled) */
#book-view .book-toc { display:block; }
#bookContent { font-size: var(--book-font, 16px); }
/* Ensure pages snap by full width */
#bookPages { scroll-snap-type: x mandatory; }
#bookContent .nb-page { scroll-snap-align: start; }
</style>

</head>
<body>

<script>
// Filter Babel Standalone dev warning in console (cosmetic only)
(function(){
  try{
    var warn = console.warn;
    var needle = 'in-browser Babel transformer';
    console.warn = function(){
      try{ if(arguments && arguments[0] && String(arguments[0]).indexOf(needle)!==-1) return; }catch(e){}
      return warn.apply(console, arguments);
    };
  }catch(e){}
})();
</script>

  <div class="header">
    <div class="wrap">
      <div style="font-size:18px">🗂️</div>
      <h1>Aurora — Workspace tích hợp</h1>
      <div class="tabs">
        
        <button id="tab-kv" class="tab">Knowledge Vault (6A/CCLDA)</button>
        <button id="tab-nlm" class="tab on">NotebookLM (RAG)</button>
        <button id="tab-book" class="tab">Book View</button>
      
      </div>
    </div>
  </div>

  <div class="container">
    <div class="help" style="margin:6px 0 10px">
      • Tab ①: nạp nguồn, hỏi–đáp có trích dẫn, ghi chú; • Tab ②: Inbox→Notes→Actions, Projects, Transcribe, TTS.
    </div>
    <div class="ifr-wrap">
    <!-- NLM TOC controls (shown when NLM tab is active) -->
    <div id="nlmTocBtn"><button title="Mục lục (NLM)">Mục lục</button></div>
    <aside id="nlmTocPane" aria-label="Mục lục NotebookLM">
      <header>MỤC LỤC</header>
      <div class="body" id="nlmTocBody"></div>
    </aside>
    
      <iframe id="frame-nlm" title="NotebookLM"></iframe>
    <script id="autoNoteDateScript">
    (function(){
      const ifr = document.getElementById('frame-nlm');
      function setup(){
        try{
          const d = ifr.contentDocument;
          if(!d) return;
          const title = d.getElementById('noteTitle');
          const body = d.getElementById('noteBody');
          const dateSpan = d.getElementById('noteDate');
          const saveBtn = d.getElementById('saveNoteBtn');
          const clearBtn = d.getElementById('clearNoteBtn');
          if(!title || !body || !dateSpan) return;
          const badge = dateSpan.parentElement;
          // Ẩn badge nếu chưa có ngày
          if(!dateSpan.textContent.trim() && badge) badge.style.display='none';
          function ensureDate(){
            if(!dateSpan.textContent.trim()){
              const now = new Date();
              const txt = now.toLocaleString('vi-VN', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', hour12:false});
              dateSpan.textContent = txt;
            }
            if(badge) badge.style.display='';
          }
          // Điền ngày khi người dùng bắt đầu gõ tiêu đề hoặc nội dung, hoặc khi bấm Lưu
          title.addEventListener('input', ensureDate, {once:true});
          body.addEventListener('input', ensureDate, {once:true});
          if(saveBtn) saveBtn.addEventListener('click', ensureDate, {once:true});
          // Khi bấm Xoá: xóa ngày và ẩn badge
          if(clearBtn) clearBtn.addEventListener('click', function(){
            dateSpan.textContent='';
            if(badge) badge.style.display='none';
          });
        }catch(e){ /* bỏ qua */ }
      }
      ifr.addEventListener('load', setup);
      // nếu iframe đã sẵn sàng (srcdoc được set trước), chạy ngay
      try { if (ifr.contentDocument && ifr.contentDocument.readyState === 'complete') setup(); } catch(e){}
    })();
    </script>
    
      <iframe id="frame-kv" title="Knowledge Vault" style="display:none"></iframe>
      <div id="book-view" style="display:none; height:100%; border:1px solid var(--border); border-radius:14px; background:#0b1224;">
        <div class="book-toolbar">
          <div class="skin-switch"><button class="book-btn" id="bookSkin" title="Bật/Tắt giao diện kính">Glassbook</button></div>
          <div class="left">
            <button class="book-btn" id="bookPrev" title="Trang trước">⟵</button>
            <button class="book-btn" id="bookNext" title="Trang sau">⟶</button>
            <span class="sep"></span>
            <button class="book-btn" id="bookTocBtn" title="Mục lục">☰</button>
            <button class="book-btn" id="bookBookmark" title="Đánh dấu">🔖</button>
          </div>
          <div class="center"><span id="bookPageLabel">0 / 0</span> · <span id="bookProgress">0%</span></div>
          <div class="right">
            <label style="font-size:12px;opacity:.8;margin-right:6px">Cỡ chữ</label>
            <input type="range" id="bookFont" min="14" max="22" step="1" value="16">
            <span class="sep"></span><button class="book-btn" id="btnEdit" title="Sửa nội dung (toggle)">Sửa</button> <button class="book-btn" id="btnSave" title="Lưu nội dung (Ctrl+S)" disabled>Lưu</button> <button class="book-btn" id="btnRender" title="Hiển thị Markdown (toggle)">Hiển thị</button> <button class="book-btn" id="btnExportMd" title="Xuất Markdown hiện tại">Xuất .MD</button> <span class="sep"></span>
            <button class="book-btn" id="btnImport" title="Nhập JSON/MD/TXT">Nhập</button>
            <button class="book-btn" id="btnExport" title="Xuất JSON">Xuất</button>
            <button class="book-btn" id="btnReset"  title="Xóa dữ liệu sổ tay">Reset</button>
            <input type="file" id="importFile" accept=".json,.md,.txt" style="display:none">
          </div>
        </div>
        <div class="book-shell">
          <div id="glassLeft" aria-hidden="true">  <div class="glass-card checklist">    <div class="g-title">Sổ tay</div>    <label class="g-row"><input type="checkbox"> Việc 1</label>    <label class="g-row"><input type="checkbox"> Việc 2</label>    <label class="g-row"><input type="checkbox"> Việc 3</label>    <div class="g-tags">      <span>#tag</span><span>#tag</span><span>#tag</span>    </div>    <button class="g-upload">PDF/DOC</button>  </div>    <div class="gesture-hints">    </div></div>
          <aside class="book-toc" id="bookToc"></aside>
          <div class="book-pages" id="bookPages">
            <article id="bookContent"></article>
          </div>
        </div>
      </div>

    </div>
    <footer>Single‑file • offline • mỗi app giữ dữ liệu riêng (localStorage)</footer>
  </div>

<script>
// Base64 payloads (UTF‑8)
const APP_NLM_B64 = "PCFkb2N0eXBlIGh0bWw+CjxodG1sIGxhbmc9InZpIj4KPGhlYWQ+CjxtZXRhIGNoYXJzZXQ9InV0Zi04Ij4KPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xIj4KPHRpdGxlPkF1cm9yYSBOb3RlYm9vayDigJQgTm90ZWJvb2tMTS1zdHlsZSBNVlAgdjM8L3RpdGxlPgo8bGluayByZWw9InByZWNvbm5lY3QiIGhyZWY9Imh0dHBzOi8vZm9udHMuZ29vZ2xlYXBpcy5jb20iPgo8bGluayByZWw9InByZWNvbm5lY3QiIGhyZWY9Imh0dHBzOi8vZm9udHMuZ3N0YXRpYy5jb20iIGNyb3Nzb3JpZ2luPgo8bGluayBocmVmPSJodHRwczovL2ZvbnRzLmdvb2dsZWFwaXMuY29tL2NzczI/ZmFtaWx5PUludGVyOndnaHRANDAwOzUwMDs2MDA7NzAwJmRpc3BsYXk9c3dhcCIgcmVsPSJzdHlsZXNoZWV0Ij4KPG1ldGEgbmFtZT0iZGVzY3JpcHRpb24iIGNvbnRlbnQ9IkxvY2FsLWZpcnN0IE5vdGVib29rTE0tc3R5bGUgd2ViOiBzb3VyY2VzLCBSQUcgY2hhdCB3aXRoIGNpdGF0aW9ucywgbm90ZXMsIHRlbXBsYXRlcywgYXVkaW8gb3ZlcnZpZXcsIG1pbmQgbWFwIGxpdGUsIGV4cG9ydC9pbXBvcnQsIGxlZ2FjeSBIVE1MIGltcG9ydC4iPgo8c3R5bGU+CiAgOnJvb3R7CiAgICAtLWJnOiMwYjEwMjA7CiAgICAtLXBhbmVsOiMwZjE3MmE7CiAgICAtLWNhcmQ6IzBiMTIyNDsKICAgIC0taW5rOiNlNmVkZjc7CiAgICAtLWluay0yOiNhN2IwYzM7CiAgICAtLWJyYW5kOiM4YjVjZjY7CiAgICAtLWJyYW5kLTI6IzIyZDNlZTsKICAgIC0tYnI6cmdiYSgyNTUsMjU1LDI1NSwuMDgpOwogICAgLS1zaGFkb3c6MCA4cHggMzBweCByZ2JhKDIsNiwyMywuMzUpOwogIH0KICAqe2JveC1zaXppbmc6Ym9yZGVyLWJveH0KICBodG1sLGJvZHl7bWFyZ2luOjA7cGFkZGluZzowO2JhY2tncm91bmQ6bGluZWFyLWdyYWRpZW50KDEyMGRlZywjMGIxMDIwLCMwYTFhMzYgNTUlLCMwYjEwMjApO2NvbG9yOnZhcigtLWluayk7Zm9udC1mYW1pbHk6J0ludGVyJyx1aS1zYW5zLXNlcmlmLHN5c3RlbS11aSwtYXBwbGUtc3lzdGVtLCJTZWdvZSBVSSIsUm9ib3RvLCJIZWx2ZXRpY2EgTmV1ZSIsQXJpYWx9CiAgLmNvbnRhaW5lcnttYXgtd2lkdGg6MTI4MHB4O21hcmdpbjowIGF1dG87cGFkZGluZzowIDE4cHh9CiAgLnRvcGJhcntwb3NpdGlvbjpzdGlja3k7dG9wOjA7ei1pbmRleDo1MDtiYWNrZ3JvdW5kOmxpbmVhci1ncmFkaWVudCg5MGRlZyxyZ2JhKDEzOSw5MiwyNDYsLjE0KSxyZ2JhKDM0LDIxMSwyMzgsLjEyKSk7Ym9yZGVyLWJvdHRvbToxcHggc29saWQgdmFyKC0tYnIpO2JhY2tkcm9wLWZpbHRlcjpzYXR1cmF0ZSgxLjIpIGJsdXIoOHB4KX0KICAudG9wYmFyIC5pbm5lcntkaXNwbGF5OmZsZXg7YWxpZ24taXRlbXM6Y2VudGVyO2dhcDoxMHB4O3BhZGRpbmc6MTJweCAwfQogIC5icmFuZHtmb250LXdlaWdodDo3MDA7bGV0dGVyLXNwYWNpbmc6LjJweH0KICAudGFnbGluZXttYXJnaW4tbGVmdDo4cHg7Zm9udC1zaXplOjEzcHg7Y29sb3I6dmFyKC0taW5rLTIpfQogIC5idG57ZGlzcGxheTppbmxpbmUtZmxleDthbGlnbi1pdGVtczpjZW50ZXI7Z2FwOjhweDtib3JkZXI6MXB4IHNvbGlkIHZhcigtLWJyKTtiYWNrZ3JvdW5kOmxpbmVhci1ncmFkaWVudCgxODBkZWcscmdiYSgyNTUsMjU1LDI1NSwuMDYpLHJnYmEoMjU1LDI1NSwyNTUsLjAyKSk7cGFkZGluZzoxMHB4IDE0cHg7Ym9yZGVyLXJhZGl1czoxMnB4O2N1cnNvcjpwb2ludGVyO2ZvbnQtc2l6ZToxNHB4O2JveC1zaGFkb3c6dmFyKC0tc2hhZG93KX0KICAuYnRuOmhvdmVye2JvcmRlci1jb2xvcjpyZ2JhKDI1NSwyNTUsMjU1LC4yKX0KICAuYnRuLnByaW1hcnl7YmFja2dyb3VuZDpsaW5lYXItZ3JhZGllbnQoOTBkZWcsdmFyKC0tYnJhbmQpLHZhcigtLWJyYW5kLTIpKTsgYm9yZGVyLWNvbG9yOnRyYW5zcGFyZW50OyBjb2xvcjojMDQxMTFmOyBmb250LXdlaWdodDo3MDB9CiAgLmJ0bi5naG9zdHtiYWNrZ3JvdW5kOnRyYW5zcGFyZW50O2JvcmRlci1jb2xvcjp2YXIoLS1icil9CiAgLmxheW91dHtkaXNwbGF5OmZsZXg7Z2FwOjE2cHh9CiAgLnNpZGViYXJ7d2lkdGg6MzAwcHg7ZmxleDowIDAgMzAwcHg7Ym9yZGVyLXJpZ2h0OjFweCBzb2xpZCB2YXIoLS1icik7YmFja2dyb3VuZDpsaW5lYXItZ3JhZGllbnQoMTgwZGVnLHJnYmEoMjU1LDI1NSwyNTUsLjAyKSxyZ2JhKDI1NSwyNTUsMjU1LC4wMSkpO2hlaWdodDpjYWxjKDEwMHZoIC0gNjRweCk7cG9zaXRpb246c3RpY2t5O3RvcDo2NHB4O2JvcmRlci1yYWRpdXM6MCAxNnB4IDE2cHggMH0KICAuc2ItaGVhZHtwYWRkaW5nOjE0cHggMTRweCA2cHg7Y29sb3I6dmFyKC0taW5rLTIpO2ZvbnQtc2l6ZToxM3B4fQogIC5zYi1saXN0e3BhZGRpbmc6NnB4IDEwcHggMTZweDtvdmVyZmxvdzphdXRvO2hlaWdodDpjYWxjKDEwMCUgLSAzMHB4KX0KICAuc2ItaXRlbXt3aWR0aDoxMDAlO3RleHQtYWxpZ246bGVmdDtiYWNrZ3JvdW5kOnZhcigtLWNhcmQpO2JvcmRlcjoxcHggc29saWQgdmFyKC0tYnIpO3BhZGRpbmc6MTJweDtib3JkZXItcmFkaXVzOjE0cHg7bWFyZ2luOjhweCAycHg7Y3Vyc29yOnBvaW50ZXI7Ym94LXNoYWRvdzp2YXIoLS1zaGFkb3cpfQogIC5zYi1pdGVtLmFjdGl2ZXtvdXRsaW5lOjJweCBzb2xpZCByZ2JhKDEzOSw5MiwyNDYsLjQpfQogIC5zYi10aXRsZXtmb250LXdlaWdodDo2MDA7d2hpdGUtc3BhY2U6bm93cmFwO3RleHQtb3ZlcmZsb3c6ZWxsaXBzaXM7b3ZlcmZsb3c6aGlkZGVufQogIC5zYi1zdWJ7Zm9udC1zaXplOjEycHg7Y29sb3I6dmFyKC0taW5rLTIpfQogIC5tYWlue2ZsZXg6MTtwYWRkaW5nOjE2cHggMCA0OHB4fQogIC5zZWN0aW9ue2JhY2tncm91bmQ6bGluZWFyLWdyYWRpZW50KDE4MGRlZyxyZ2JhKDI1NSwyNTUsMjU1LC4wNCkscmdiYSgyNTUsMjU1LDI1NSwuMDIpKTtib3JkZXI6MXB4IHNvbGlkIHZhcigtLWJyKTtib3JkZXItcmFkaXVzOjE4cHg7cGFkZGluZzoxNHB4O2JveC1zaGFkb3c6dmFyKC0tc2hhZG93KTttYXJnaW4tYm90dG9tOjE2cHh9CiAgLnNlY3Rpb24tdGl0bGV7ZGlzcGxheTpmbGV4O2p1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuO2FsaWduLWl0ZW1zOmNlbnRlcjttYXJnaW4tYm90dG9tOjhweH0KICAuc2VjdGlvbi10aXRsZSBoM3ttYXJnaW46MDtmb250LXNpemU6MTZweDtmb250LXdlaWdodDo3MDB9CiAgLmJhZGdle2Rpc3BsYXk6aW5saW5lLWJsb2NrO3BhZGRpbmc6M3B4IDlweDtib3JkZXItcmFkaXVzOjk5OXB4O2JhY2tncm91bmQ6cmdiYSgxMzksOTIsMjQ2LC4xOCk7Ym9yZGVyOjFweCBzb2xpZCByZ2JhKDEzOSw5MiwyNDYsLjM1KTtmb250LXNpemU6MTJweH0KICAuaW5we3dpZHRoOjEwMCU7Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS1icik7cGFkZGluZzoxMHB4IDEycHg7Ym9yZGVyLXJhZGl1czoxMnB4O2JhY2tncm91bmQ6cmdiYSg1LDgsMTcsLjYpO2NvbG9yOnZhcigtLWluayl9CiAgLmdyaWR7ZGlzcGxheTpncmlkO2dhcDoxMnB4fQogIEBtZWRpYShtaW4td2lkdGg6OTgwcHgpey5ncmlkLTN7Z3JpZC10ZW1wbGF0ZS1jb2x1bW5zOjJmciAxZnIgMWZyfSAuZ3JpZC0ye2dyaWQtdGVtcGxhdGUtY29sdW1uczoyZnIgMWZyfSAuZ3JpZC00e2dyaWQtdGVtcGxhdGUtY29sdW1uczpyZXBlYXQoNCwxZnIpfX0KICAuaGVscHtmb250LXNpemU6MTJweDtjb2xvcjp2YXIoLS1pbmstMik7bWFyZ2luLXRvcDo2cHh9CiAgLnJvd3tkaXNwbGF5OmZsZXg7Z2FwOjhweDthbGlnbi1pdGVtczpjZW50ZXJ9CiAgLmxpc3R7bWF4LWhlaWdodDoyNjBweDtvdmVyZmxvdzphdXRvfQogIC5tc2d7Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS1icik7Ym9yZGVyLXJhZGl1czoxMnB4O3BhZGRpbmc6MTBweDtiYWNrZ3JvdW5kOnJnYmEoMjU1LDI1NSwyNTUsLjAzKTttYXJnaW46OHB4IDB9CiAgLm1zZy55b3V7YmFja2dyb3VuZDpyZ2JhKDM0LDIxMSwyMzgsLjA2KX0KICAuY2hpcHN7ZGlzcGxheTpmbGV4O2ZsZXgtd3JhcDp3cmFwO2dhcDo2cHg7bWFyZ2luLXRvcDo2cHh9CiAgdGV4dGFyZWEuaW5we21pbi1oZWlnaHQ6MTMwcHh9CiAgLmZvb3Rlcntmb250LXNpemU6MTJweDtjb2xvcjp2YXIoLS1pbmstMik7dGV4dC1hbGlnbjpjZW50ZXI7cGFkZGluZzoxNnB4fQogIC5yaWdodHtkaXNwbGF5OmZsZXg7Z2FwOjhweDthbGlnbi1pdGVtczpjZW50ZXJ9CiAgLmhpZGRlbntkaXNwbGF5Om5vbmV9CiAgLmhlcm97YmFja2dyb3VuZDpyYWRpYWwtZ3JhZGllbnQoMTAwMHB4IDI0MHB4IGF0IDIwJSAtNDAlLCByZ2JhKDEzOSw5MiwyNDYsLjM1KSwgdHJhbnNwYXJlbnQgNjAlKSxyYWRpYWwtZ3JhZGllbnQoMTAwMHB4IDI0MHB4IGF0IDgwJSAtNDAlLCByZ2JhKDM0LDIxMSwyMzgsLjM1KSwgdHJhbnNwYXJlbnQgNjAlKTtib3JkZXI6MXB4IHNvbGlkIHZhcigtLWJyKTtib3JkZXItcmFkaXVzOjE4cHg7cGFkZGluZzoyMHB4O21hcmdpbjoxNnB4IDA7Ym94LXNoYWRvdzp2YXIoLS1zaGFkb3cpfQogIC5oZXJvIGgxe21hcmdpbjowIDAgNnB4IDA7Zm9udC1zaXplOjIycHh9CiAgLmhlcm8gcHttYXJnaW46MDtjb2xvcjp2YXIoLS1pbmstMil9CiAgLmhlcm8gLnJvd3ttYXJnaW4tdG9wOjEycHh9CiAgLnFze2Rpc3BsYXk6Z3JpZDtncmlkLXRlbXBsYXRlLWNvbHVtbnM6MWZyIDFmciAxZnI7Z2FwOjEwcHg7bWFyZ2luLXRvcDoxNHB4fQogIC5xcyAucXtiYWNrZ3JvdW5kOnJnYmEoMjU1LDI1NSwyNTUsLjA0KTtib3JkZXI6MXB4IGRhc2hlZCB2YXIoLS1icik7Ym9yZGVyLXJhZGl1czoxMnB4O3BhZGRpbmc6MTBweH0KICAucXMgLnEgYntkaXNwbGF5OmJsb2NrO21hcmdpbi1ib3R0b206NHB4fQoKLyogLS0tIENvbXBvc2VyIChxdWljayBub3RlKSAtLS0gKi8KLmNvbXBvc2VyLWNhcmR7YmFja2dyb3VuZDpyZ2JhKDI1NSwyNTUsMjU1LC4wMyk7Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS1icik7Ym9yZGVyLXJhZGl1czoxNHB4O3BhZGRpbmc6MTJweDttYXJnaW46OHB4IGF1dG8gMTJweDttYXgtd2lkdGg6bWluKDEwMCUsOTgwcHgpfQojbm90ZUNvbXBvc2VyIC5yb3cze2Rpc3BsYXk6ZmxleDtnYXA6OHB4O2FsaWduLWl0ZW1zOmNlbnRlcn0KI25vdGVDb21wb3NlciBpbnB1dFt0eXBlPXRleHRde2ZsZXg6MTtib3JkZXI6MXB4IHNvbGlkIHZhcigtLWJyKTtwYWRkaW5nOjEwcHggMTJweDtib3JkZXItcmFkaXVzOjEwcHg7YmFja2dyb3VuZDpyZ2JhKDI1NSwyNTUsMjU1LC4wMik7Y29sb3I6dmFyKC0taW5rKX0KI25vdGVDb21wb3NlciB0ZXh0YXJlYXt3aWR0aDoxMDAlO2JvcmRlcjoxcHggc29saWQgdmFyKC0tYnIpO2JvcmRlci1yYWRpdXM6MTBweDtiYWNrZ3JvdW5kOnJnYmEoMjU1LDI1NSwyNTUsLjAyKTtjb2xvcjp2YXIoLS1pbmspO3BhZGRpbmc6MTJweDttYXJnaW4tdG9wOjhweDttaW4taGVpZ2h0OjE2MHB4O21heC1oZWlnaHQ6NjB2aDtoZWlnaHQ6Y2xhbXAoMjAwcHgsMjh2aCwzODBweCk7cmVzaXplOnZlcnRpY2FsO2xpbmUtaGVpZ2h0OjEuNDV9CiNzaWRlYmFyTGlzdCAuc2ItaXRlbXtwYWRkaW5nOjhweCAxMHB4O2JvcmRlcjoxcHggc29saWQgdmFyKC0tYnIpO2JvcmRlci1yYWRpdXM6MTBweDttYXJnaW46NnB4IDA7YmFja2dyb3VuZDpyZ2JhKDI1NSwyNTUsMjU1LC4wMik7Y3Vyc29yOnBvaW50ZXJ9CiNzaWRlYmFyTGlzdCAuc2ItaXRlbTpob3Zlcntib3JkZXItY29sb3I6cmdiYSgyNTUsMjU1LDI1NSwuMjUpfQojbm90ZURhdGV7b3BhY2l0eTouODtmb250LXNpemU6MTJweH0KPC9zdHlsZT4KPC9oZWFkPgo8Ym9keT4KICA8ZGl2IGNsYXNzPSJ0b3BiYXIiPgogICAgPGRpdiBjbGFzcz0iY29udGFpbmVyIGlubmVyIj4KICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjE4cHgiPvCfk5I8L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0iYnJhbmQiPkF1cm9yYSBOb3RlYm9vayDigJQgTkxNIE1WUDwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJ0YWdsaW5lIj5sb2NhbOKAkWZpcnN0IOKAoiBjaXRhdGlvbnMgcHJlc2VydmVkIOKAoiBubyBzZXJ2ZXIgcmVxdWlyZWQ8L2Rpdj4KICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6YXV0byIgY2xhc3M9InJpZ2h0Ij4KICAgICAgICA8YnV0dG9uIGlkPSJidG5OZXciIGNsYXNzPSJidG4gcHJpbWFyeSI+77yLIE5vdGVib29rIG3hu5tpPC9idXR0b24+CiAgICAgICAgCiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgPC9kaXY+CiAgPGRpdiBjbGFzcz0iY29udGFpbmVyIGxheW91dCI+CiAgICA8YXNpZGUgY2xhc3M9InNpZGViYXIiPgogICAgICA8ZGl2IGNsYXNzPSJzYi1oZWFkIj5T4buVIHRheTwvZGl2PgogICAgICA8ZGl2IGlkPSJzaWRlYmFyTGlzdCIgY2xhc3M9InNiLWxpc3QiPjwvZGl2PgogICAgPC9hc2lkZT4KICAgIDxtYWluIGNsYXNzPSJtYWluIj4KICAgICAgPHNlY3Rpb24gY2xhc3M9InNlY3Rpb24gY29tcG9zZXItY2FyZCIgaWQ9Im5vdGVDb21wb3NlciI+CiAgICAgICAgPGRpdiBjbGFzcz0ic2VjdGlvbi10aXRsZSI+PGgzPkLhuq90IMSR4bqndSBnaGkgY2jDqXA8L2gzPjwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InJvdzMiPgogICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIGlkPSJub3RlVGl0bGUiIHBsYWNlaG9sZGVyPSJUacOqdSDEkeG7gS4uLiI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJiYWRnZSB4IiB0aXRsZT0iTmfDoHkiPjxzcGFuIGlkPSJub3RlRGF0ZSI+PC9zcGFuPjwvZGl2PgogICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIHByaW1hcnkiIGlkPSJzYXZlTm90ZUJ0biI+TMawdTwvYnV0dG9uPgogICAgICAgIDwvZGl2PgogICAgICAgIDx0ZXh0YXJlYSBpZD0ibm90ZUJvZHkiIGNsYXNzPSJpbnAiIHBsYWNlaG9sZGVyPSJO4buZaSBkdW5nLi4uIChDdHJsK0VudGVyIMSR4buDIGzGsHUpIj48L3RleHRhcmVhPgogICAgICAgIDxkaXYgY2xhc3M9InJvdyIgc3R5bGU9ImdhcDo4cHg7bWFyZ2luLXRvcDo4cHgiPgogICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIGlkPSJub3RlVGFncyIgcGxhY2Vob2xkZXI9IiN0YWcsICN0YWcyICh0deG7syBjaOG7jW4pIj4KICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biIgaWQ9ImNsZWFyTm90ZUJ0biI+WG/DoTwvYnV0dG9uPgogICAgICAgIDwvZGl2PgogICAgICA8L3NlY3Rpb24+CgogICAgICA8ZGl2IGlkPSJhcHAiPjwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJmb290ZXIiPkF1cm9yYSBOTE0gTVZQIHYzIOKAlCBsZWdhY3kgSFRNTCBpbXBvcnQg4oCiIGltcHJvdmVkIHZpc3VhbHMg4oCiIHF1aWNrc3RhcnQgZGVtbzwvZGl2PgogICAgPC9tYWluPgogIDwvZGl2PgoKICA8IS0tIERlcGVuZGVuY2llcyB2aWEgQ0ROIChVTUQpIC0tPgogIDxzY3JpcHQgc3JjPSJodHRwczovL3VucGtnLmNvbS9yZWFjdEAxOC91bWQvcmVhY3QucHJvZHVjdGlvbi5taW4uanMiPjwvc2NyaXB0PgogIDxzY3JpcHQgc3JjPSJodHRwczovL3VucGtnLmNvbS9yZWFjdC1kb21AMTgvdW1kL3JlYWN0LWRvbS5wcm9kdWN0aW9uLm1pbi5qcyI+PC9zY3JpcHQ+CiAgPCEtLSBCYWJlbCBzbyBKU1ggcnVucyBpbiBvbmUtZmlsZSBidWlsZCAtLT4KICA8c2NyaXB0IHNyYz0iaHR0cHM6Ly91bnBrZy5jb20vQGJhYmVsL3N0YW5kYWxvbmUvYmFiZWwubWluLmpzIj48L3NjcmlwdD4KICA8c2NyaXB0IHNyYz0iaHR0cHM6Ly91bnBrZy5jb20vbWluaXNlYXJjaEA2LjMuMC9kaXN0L3VtZC9pbmRleC5taW4uanMiPjwvc2NyaXB0PgogIDxzY3JpcHQgc3JjPSJodHRwczovL3VucGtnLmNvbS91dWlkQDkuMC4xL2Rpc3QvdW1kL3V1aWR2NC5taW4uanMiPjwvc2NyaXB0PgogIDxzY3JpcHQgc3JjPSJodHRwczovL3VucGtnLmNvbS9tYW1tb3RoL21hbW1vdGguYnJvd3Nlci5taW4uanMiPjwvc2NyaXB0PgoKICA8IS0tIEFwcCAoSlNYKSAtLT4KICA8c2NyaXB0IHR5cGU9InRleHQvYmFiZWwiPgooZnVuY3Rpb24oKXsKICBmdW5jdGlvbiByZW1vdmVUYWJzRXhhY3QobmFtZXMpewogICAgY29uc3Qgc2VsID0gWydbcm9sZT0idGFiIl0nLCdidXR0b24nLCdhJywnLnRhYicsJy50YWJzIC50YWInLCcubWVudSAuaXRlbSddLmpvaW4oJywnKTsKICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsKS5mb3JFYWNoKGVsPT57CiAgICAgIGNvbnN0IHQ9KGVsLnRleHRDb250ZW50fHwnJykudHJpbSgpOwogICAgICBpZihuYW1lcy5pbmNsdWRlcyh0KSkgZWwucmVtb3ZlKCk7CiAgICB9KTsKICB9CiAgZnVuY3Rpb24gcmVtb3ZlRmlsdGVyU2ltcGxpZmllZCgpewogICAgY29uc3QgYWxsID0gQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcqJykpCiAgICAgIC5maWx0ZXIoZWwgPT4gKGVsLmNoaWxkRWxlbWVudENvdW50PT09MCkgJiYgKGVsLnRleHRDb250ZW50fHwnJykudHJpbSgpPT09J0Lhu5kgbOG7jWMgKHThu5FpIGdp4bqjbiknKTsKICAgIGFsbC5mb3JFYWNoKGxhYmVsPT57CiAgICAgIGxldCBjb250YWluZXIgPSBsYWJlbC5jbG9zZXN0KCdzZWN0aW9uLCAuc2VjdGlvbiwgLmNhcmQsIC5wYW5lbCwgLmJveCwgLmt2LWZpbHRlciwgLmZpbHRlciwgLmt2LXNsaW0tZmlsdGVyJyk7CiAgICAgIGlmKCFjb250YWluZXIpIGNvbnRhaW5lciA9IGxhYmVsLnBhcmVudEVsZW1lbnQ7CiAgICAgIGlmKGNvbnRhaW5lciAmJiAhY29udGFpbmVyLmNsb3Nlc3QoJ25hdixbcm9sZT0ibmF2aWdhdGlvbiJdJykpewogICAgICAgIGNvbnRhaW5lci5yZW1vdmUoKTsKICAgICAgfQogICAgfSk7CiAgfQogIGZ1bmN0aW9uIHJ1bigpewogICAgcmVtb3ZlVGFic0V4YWN0KFsnUGxheWJvb2snLCdHdWlkZSddKTsKICAgIHJlbW92ZUZpbHRlclNpbXBsaWZpZWQoKTsKICB9CiAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGU9PT0nbG9hZGluZycpIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBydW4pOwogIGVsc2UgcnVuKCk7Cn0pKCk7Cjwvc2NyaXB0Pg==";
const APP_KV_B64  = "CjwhRE9DVFlQRSBodG1sPgo8aHRtbCBsYW5nPSJ2aSI+CjxoZWFkPgo8bWV0YSBjaGFyc2V0PSJ1dGYtOCI+CjxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MSI+Cjx0aXRsZT5U4oCRMDQgS25vd2xlZGdlIFZhdWx0IOKAlCBGdWxsICh2Nyk8L3RpdGxlPgo8c3R5bGU+Cjpyb290ewogIC0tYmc6IzBhMGQxMjstLWNhcmQ6IzBmMTQxYjstLW11dGVkOiM4Yjk1YTc7LS10ZXh0OiNlN2VkZjU7LS1hY2NlbnQ6IzNiODJmNjstLWJvcmRlcjojMWUyNDMwOwogIC0tYmFkOiNlZjQ0NDQ7LS13YXJuOiNmNTllMGI7LS1nb29kOiMxMGI5ODE7LS12aW86IzhiNWNmNjsKfQpAbWVkaWEgKHByZWZlcnMtY29sb3Itc2NoZW1lOiBsaWdodCl7CiAgOnJvb3R7LS1iZzojZjdmOGZiOy0tY2FyZDojZmZmOy0tbXV0ZWQ6IzVhNjU3NzstLXRleHQ6IzBmMTcyYTstLWFjY2VudDojMjU2M2ViOy0tYm9yZGVyOiNlNWU3ZWI7LS1iYWQ6I2RjMjYyNjstLXdhcm46I2Q5NzcwNjstLWdvb2Q6IzA1OTY2OTstLXZpbzojN2MzYWVkO30KfQoqe2JveC1zaXppbmc6Ym9yZGVyLWJveH1odG1sLGJvZHl7aGVpZ2h0OjEwMCV9Ym9keXttYXJnaW46MDtiYWNrZ3JvdW5kOnZhcigtLWJnKTtjb2xvcjp2YXIoLS10ZXh0KTtmb250OjUwMCAxNHB4LzEuNDUgc3lzdGVtLXVpLC1hcHBsZS1zeXN0ZW0sU2Vnb2UgVUksUm9ib3RvLEhlbHZldGljYSxBcmlhbH0KLmNvbnRhaW5lcnttYXgtd2lkdGg6MTIwMHB4O21hcmdpbjowIGF1dG87cGFkZGluZzoxMnB4fQpoZWFkZXJ7cG9zaXRpb246c3RpY2t5O3RvcDowO3otaW5kZXg6NTA7YmFja2dyb3VuZDpjb2xvci1taXgoaW4gb2tsYWIsdmFyKC0tYmcpLHRyYW5zcGFyZW50IDIwJSk7YmFja2Ryb3AtZmlsdGVyOnNhdHVyYXRlKDEyMCUpIGJsdXIoOHB4KTtib3JkZXItYm90dG9tOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpfQpoZWFkZXIgLndyYXB7ZGlzcGxheTpmbGV4O2FsaWduLWl0ZW1zOmNlbnRlcjtqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjtwYWRkaW5nOjEwcHggMTJweH0KaDF7bWFyZ2luOjA7Zm9udC1zaXplOjE4cHg7Zm9udC13ZWlnaHQ6ODAwfXNtYWxse2NvbG9yOnZhcigtLW11dGVkKX0KLmJ0bnthcHBlYXJhbmNlOm5vbmU7Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpO2JhY2tncm91bmQ6dmFyKC0tY2FyZCk7Y29sb3I6dmFyKC0tdGV4dCk7cGFkZGluZzo4cHggMTBweDtib3JkZXItcmFkaXVzOjEwcHg7Y3Vyc29yOnBvaW50ZXI7ZGlzcGxheTppbmxpbmUtZmxleDtnYXA6OHB4O2FsaWduLWl0ZW1zOmNlbnRlcn0KLmJ0bjpob3Zlcntib3JkZXItY29sb3I6Y29sb3ItbWl4KGluIG9rbGFiLHZhcigtLWFjY2VudCksdmFyKC0tYm9yZGVyKSA2MCUpfQouYnRuLmFjY3tiYWNrZ3JvdW5kOnZhcigtLWFjY2VudCk7Ym9yZGVyLWNvbG9yOnZhcigtLWFjY2VudCk7Y29sb3I6I2ZmZn0KLmJ0bi5kZXN7YmFja2dyb3VuZDp2YXIoLS1iYWQpO2JvcmRlci1jb2xvcjp2YXIoLS1iYWQpO2NvbG9yOiNmZmZ9Ci5idG4ud2FybntiYWNrZ3JvdW5kOnZhcigtLXdhcm4pO2JvcmRlci1jb2xvcjp2YXIoLS13YXJuKTtjb2xvcjojZmZmfQouYnRuLnZpb3tiYWNrZ3JvdW5kOnZhcigtLXZpbyk7Ym9yZGVyLWNvbG9yOnZhcigtLXZpbyk7Y29sb3I6I2ZmZn0KLmJ0bi1zbXtwYWRkaW5nOjZweCA4cHg7Ym9yZGVyLXJhZGl1czo5cHg7Zm9udC1zaXplOjEycHh9Ci5pY29ue3dpZHRoOjE2cHg7aGVpZ2h0OjE2cHg7ZmlsbDpjdXJyZW50Q29sb3I7dmVydGljYWwtYWxpZ246LTNweH0KLmNhcmR7YmFja2dyb3VuZDp2YXIoLS1jYXJkKTtib3JkZXI6MXB4IHNvbGlkIHZhcigtLWJvcmRlcik7Ym9yZGVyLXJhZGl1czoxNHB4O2JveC1zaGFkb3c6MCAxcHggMCByZ2JhKDAsMCwwLC4wNSl9Ci5jYXJkIGgye2ZvbnQtc2l6ZToxNnB4O21hcmdpbjowO3BhZGRpbmc6MTJweDtib3JkZXItYm90dG9tOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpfQouY2FyZCAuY29udGVudHtwYWRkaW5nOjEycHh9Ci5ncmlke2Rpc3BsYXk6Z3JpZDtnYXA6MTJweH0KLmhye2hlaWdodDoxcHg7YmFja2dyb3VuZDp2YXIoLS1ib3JkZXIpO21hcmdpbjo4cHggMH0KLm11dGVke2NvbG9yOnZhcigtLW11dGVkKX0KaW5wdXRbdHlwZT10ZXh0XSxpbnB1dFt0eXBlPWRhdGVdLHRleHRhcmVhLHNlbGVjdHt3aWR0aDoxMDAlO3BhZGRpbmc6OXB4IDEwcHg7Ym9yZGVyLXJhZGl1czoxMHB4O2JvcmRlcjoxcHggc29saWQgdmFyKC0tYm9yZGVyKTtiYWNrZ3JvdW5kOnRyYW5zcGFyZW50O2NvbG9yOnZhcigtLXRleHQpfQp0ZXh0YXJlYXttaW4taGVpZ2h0Ojk2cHg7cmVzaXplOnZlcnRpY2FsfQoucm93e2Rpc3BsYXk6Z3JpZDtncmlkLXRlbXBsYXRlLWNvbHVtbnM6MWZyIDFmcjtnYXA6MTJweH0KLnJvdzN7ZGlzcGxheTpncmlkO2dyaWQtdGVtcGxhdGUtY29sdW1uczoxZnIgMWZyIDFmcjtnYXA6MTJweH0KLnRhZ3N7ZGlzcGxheTpmbGV4O2ZsZXgtd3JhcDp3cmFwO2dhcDo4cHg7bWFyZ2luOjRweCAwIDZweH0KLmJhZGdle2Rpc3BsYXk6aW5saW5lLWZsZXg7YWxpZ24taXRlbXM6Y2VudGVyO2dhcDo2cHg7Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpO2JvcmRlci1yYWRpdXM6OTk5cHg7cGFkZGluZzozcHggOHB4O2NvbG9yOnZhcigtLW11dGVkKX0KLmJhZGdlIC54e2N1cnNvcjpwb2ludGVyO29wYWNpdHk6Ljd9LmJhZGdlIC54OmhvdmVye29wYWNpdHk6MX0KLmZsZXh7ZGlzcGxheTpmbGV4O2dhcDo4cHg7YWxpZ24taXRlbXM6Y2VudGVyfQoucmlnaHR7bWFyZ2luLWxlZnQ6YXV0b30KLyogVGFicyAqLwoudGFic3tkaXNwbGF5OmZsZXg7Z2FwOjhweDtmbGV4LXdyYXA6d3JhcH0KLnRhYntib3JkZXI6MXB4IHNvbGlkIHZhcigtLWJvcmRlcik7Ym9yZGVyLXJhZGl1czo5OTlweDtwYWRkaW5nOjZweCAxMHB4O2N1cnNvcjpwb2ludGVyO2NvbG9yOnZhcigtLW11dGVkKX0KLnRhYi5vbntiYWNrZ3JvdW5kOnZhcigtLWFjY2VudCk7Ym9yZGVyLWNvbG9yOnZhcigtLWFjY2VudCk7Y29sb3I6I2ZmZn0KLyogRHJvcGRvd24gKi8KLmRyb3Bkb3due3Bvc2l0aW9uOnJlbGF0aXZlfS5kcm9wZG93biAubWVudXtwb3NpdGlvbjphYnNvbHV0ZTt0b3A6MTAwJTtsZWZ0OjA7bWFyZ2luLXRvcDo2cHg7bWluLXdpZHRoOjIyMHB4O21heC1oZWlnaHQ6MjYwcHg7b3ZlcmZsb3c6YXV0bzt6LWluZGV4Ojk5OTk7YmFja2dyb3VuZDp2YXIoLS1jYXJkKTtib3JkZXI6MXB4IHNvbGlkIHZhcigtLWJvcmRlcik7Ym9yZGVyLXJhZGl1czoxMnB4O3BhZGRpbmc6NnB4IDRweDtib3gtc2hhZG93OjAgOHB4IDIycHggcmdiYSgwLDAsMCwuMjQpfQoubWVudSAuaXRlbXtkaXNwbGF5OmZsZXg7Z2FwOjhweDthbGlnbi1pdGVtczpjZW50ZXI7cGFkZGluZzo2cHggMTBweDtib3JkZXItcmFkaXVzOjhweDtjdXJzb3I6cG9pbnRlcn0KLm1lbnUgLml0ZW06aG92ZXJ7YmFja2dyb3VuZDpyZ2JhKDEyNywxMjcsMTI3LC4xMil9Ci8qIExpc3RzICovCi5ub3RlLWxpc3R7bWF4LWhlaWdodDo2MHZoO292ZXJmbG93OmF1dG87cGFkZGluZy1yaWdodDo2cHh9Ci5ub3Rle2JvcmRlcjoxcHggc29saWQgdmFyKC0tYm9yZGVyKTtib3JkZXItcmFkaXVzOjEycHg7cGFkZGluZzoxMHB4O2JhY2tncm91bmQ6dHJhbnNwYXJlbnR9Ci5ub3RlIGgze21hcmdpbjowIDAgNHB4O2ZvbnQtc2l6ZToxNXB4fQoubWV0YXtkaXNwbGF5OmZsZXg7Z2FwOjhweDthbGlnbi1pdGVtczpjZW50ZXI7ZmxleC13cmFwOndyYXA7bWFyZ2luLXRvcDo4cHh9Ci50eXBle2ZvbnQtc2l6ZToxMXB4O2JvcmRlcjoxcHggc29saWQgdmFyKC0tYm9yZGVyKTtwYWRkaW5nOjJweCA4cHg7Ym9yZGVyLXJhZGl1czo5OTlweH0KLmFjdGlvbi1kb3R7ZGlzcGxheTppbmxpbmUtYmxvY2s7d2lkdGg6OHB4O2hlaWdodDo4cHg7Ym9yZGVyLXJhZGl1czo1MCU7YmFja2dyb3VuZDp2YXIoLS1iYWQpfQouYWN0aW9uLWRvdC5kb25le2JhY2tncm91bmQ6dmFyKC0tZ29vZCl9Ci5rcGl7ZGlzcGxheTppbmxpbmUtZmxleDtnYXA6NnB4O2FsaWduLWl0ZW1zOmNlbnRlcn0KbWFya3tiYWNrZ3JvdW5kOmNvbG9yLW1peChpbiBva2xhYix2YXIoLS1hY2NlbnQpLHRyYW5zcGFyZW50IDgwJSk7cGFkZGluZzowIDJweDtib3JkZXItcmFkaXVzOjRweH0KLnByb3Nle3doaXRlLXNwYWNlOnByZS13cmFwfQoudHJ1bmNhdGV7d2hpdGUtc3BhY2U6bm93cmFwO292ZXJmbG93OmhpZGRlbjt0ZXh0LW92ZXJmbG93OmVsbGlwc2lzfQovKiBBY3Rpb25zIHZpZXcgKi8KLmFjdGlvbi1yb3d7ZGlzcGxheTpncmlkO2dyaWQtdGVtcGxhdGUtY29sdW1uczoxZnIgMTIwcHggMTEwcHggMTYwcHggOTBweDtnYXA6OHB4O2FsaWduLWl0ZW1zOmNlbnRlcjtib3JkZXItYm90dG9tOjFweCBkYXNoZWQgdmFyKC0tYm9yZGVyKTtwYWRkaW5nOjZweCAwfQouYWN0aW9uLXJvdyAuZG9uZXtvcGFjaXR5Oi41NTt0ZXh0LWRlY29yYXRpb246bGluZS10aHJvdWdofQovKiBQcm9qZWN0IG1hcCAqLwoucHJvamVjdC1jYXJke2JvcmRlcjoxcHggc29saWQgdmFyKC0tYm9yZGVyKTtib3JkZXItcmFkaXVzOjEycHg7cGFkZGluZzoxMHB4fQoucHJvamVjdC1jYXJkIGgze21hcmdpbjowIDAgNnB4fQouaW5saW5le2Rpc3BsYXk6aW5saW5lLWZsZXg7Z2FwOjZweDtmbGV4LXdyYXA6d3JhcH0KLyogVHJhaW5pbmcgKi8KLmNoa3tkaXNwbGF5OmZsZXg7Z2FwOjhweDthbGlnbi1pdGVtczpmbGV4LXN0YXJ0O21hcmdpbjo2cHggMH0KLmNoayBpbnB1dHttYXJnaW4tdG9wOjNweH0Ka2Jke2JvcmRlcjoxcHggc29saWQgdmFyKC0tYm9yZGVyKTtwYWRkaW5nOjJweCA2cHg7Ym9yZGVyLXJhZGl1czo2cHg7YmFja2dyb3VuZDpyZ2JhKDEyNywxMjcsMTI3LC4xMil9Ci8qIGJhbm5lcnMgKi8KLmJhbm5lcntwYWRkaW5nOjhweCAxMHB4O2JvcmRlci1yYWRpdXM6MTBweH0KLmJhbm5lci53YXJue2JhY2tncm91bmQ6Y29sb3ItbWl4KGluIG9rbGFiLHZhcigtLXdhcm4pLHRyYW5zcGFyZW50IDg1JSk7Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS13YXJuKX0KLmJhbm5lci5nb29ke2JhY2tncm91bmQ6Y29sb3ItbWl4KGluIG9rbGFiLHZhcigtLWdvb2QpLHRyYW5zcGFyZW50IDg1JSk7Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS1nb29kKX0KLmJhbm5lci5iYWR7YmFja2dyb3VuZDpjb2xvci1taXgoaW4gb2tsYWIsdmFyKC0tYmFkKSx0cmFuc3BhcmVudCA4NSUpO2JvcmRlcjoxcHggc29saWQgdmFyKC0tYmFkKX0KLmhpZGV7ZGlzcGxheTpub25lICFpbXBvcnRhbnR9Ci8qIHRhYmxlICovCi50Ymx7d2lkdGg6MTAwJTtib3JkZXItY29sbGFwc2U6Y29sbGFwc2V9Ci50YmwgdGgsLnRibCB0ZHtib3JkZXItYm90dG9tOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpO3BhZGRpbmc6OHB4IDZweDt0ZXh0LWFsaWduOmxlZnQ7dmVydGljYWwtYWxpZ246dG9wfQoudGJsIHRoe2ZvbnQtd2VpZ2h0OjcwMH0KLnRibCB0cjpob3ZlcntiYWNrZ3JvdW5kOnJnYmEoMTI3LDEyNywxMjcsLjA3KX0KLyogc21hbGwgaWNvbiBidG4gKi8KLmljb25idG57Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpO2JhY2tncm91bmQ6dmFyKC0tY2FyZCk7cGFkZGluZzo0cHggNnB4O2JvcmRlci1yYWRpdXM6OHB4O2N1cnNvcjpwb2ludGVyfQouaWNvbmJ0bi5vbntiYWNrZ3JvdW5kOnZhcigtLWFjY2VudCk7Ym9yZGVyLWNvbG9yOnZhcigtLWFjY2VudCk7Y29sb3I6I2ZmZn0KLyogZHJvcHpvbmUgKi8KLmRyb3B7Ym9yZGVyOjJweCBkYXNoZWQgdmFyKC0tYm9yZGVyKTtib3JkZXItcmFkaXVzOjEycHg7cGFkZGluZzoxNnB4O3RleHQtYWxpZ246Y2VudGVyfQouZHJvcC5kcmFne2JhY2tncm91bmQ6cmdiYSgxMjcsMTI3LDEyNywuMDgpfQoucHJvZ3toZWlnaHQ6OHB4O2JhY2tncm91bmQ6dmFyKC0tYm9yZGVyKTtib3JkZXItcmFkaXVzOjhweDtvdmVyZmxvdzpoaWRkZW59Ci5wcm9nID4gZGl2e2hlaWdodDoxMDAlO3dpZHRoOjAlO2JhY2tncm91bmQ6dmFyKC0tYWNjZW50KTt0cmFuc2l0aW9uOndpZHRoIC4ycyBlYXNlfQouaGVscHtmb250LXNpemU6MTJweDtjb2xvcjp2YXIoLS1tdXRlZCl9CgpwcmV7YmFja2dyb3VuZDpyZ2JhKDEyNywxMjcsMTI3LC4wOCk7Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpO2JvcmRlci1yYWRpdXM6MTBweDtwYWRkaW5nOjEwcHg7b3ZlcmZsb3c6YXV0bztjb2xvcjp2YXIoLS10ZXh0KX0KY29kZXtmb250LWZhbWlseTp1aS1tb25vc3BhY2UsU0ZNb25vLVJlZ3VsYXIsTWVubG8sTW9uYWNvLENvbnNvbGFzLG1vbm9zcGFjZTtmb250LXNpemU6MTJweH0KICAgIDwvc3R5bGU+Cgo8c3R5bGUgaWQ9InBhdGNoLXY3MSI+Cjpmb2N1cy12aXNpYmxleyBvdXRsaW5lOjJweCBzb2xpZCBjb2xvci1taXgoaW4gb2tsYWIsdmFyKC0tYWNjZW50KSwjZmZmIDIwJSk7IG91dGxpbmUtb2Zmc2V0OjJweCB9Ci5kcm9wZG93bnsgcG9zaXRpb246cmVsYXRpdmUgfQouZHJvcGRvd24gLnBhbmVseyBwb3NpdGlvbjphYnNvbHV0ZTsgei1pbmRleDo2MDsgbWF4LWhlaWdodDo2MHZoOyBvdmVyZmxvdzphdXRvOyBpbnNldC1pbmxpbmUtZW5kOjAgfQpAbWVkaWEgKG1heC13aWR0aDogNjAwcHgpewogIC5jb250YWluZXJ7IHBhZGRpbmc6MTBweCB9CiAgLm5vdGUtbGlzdHsgbWF4LWhlaWdodDogNTV2aDsgfQp9Cjwvc3R5bGU+CjwvaGVhZD4KPGJvZHk+CjxoZWFkZXI+CiAgPGRpdiBjbGFzcz0id3JhcCBjb250YWluZXIiPgogICAgPGRpdj4KICAgICAgPGgxPlTigJEwNCBLbm93bGVkZ2UgVmF1bHQg4oCUIEZ1bGw8L2gxPgogICAgICA8c21hbGw+NkEgLyBDQ0xEQSDigKIgMyB04bqnbmcg4oCiIOKAnDEwIGdpw6J54oCdIOKAoiBU4buVbmcgbeG7pWM6IDxzcGFuIGlkPSJzdGF0LWNvdW50Ij4wPC9zcGFuPjwvc21hbGw+CiAgICA8L2Rpdj4KICAgIDxkaXYgY2xhc3M9ImZsZXgiPgogICAgICA8YnV0dG9uIGNsYXNzPSJidG4iIGlkPSJidG4tZXhwb3J0IiB0aXRsZT0iWHXhuqV0IEpTT04iPlh14bqldDwvYnV0dG9uPgogICAgICA8aW5wdXQgaWQ9ImltcG9ydC1maWxlIiBjbGFzcz0iaGlkZSIgdHlwZT0iZmlsZSIgYWNjZXB0PSJhcHBsaWNhdGlvbi9qc29uIj4KICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIiBpZD0iYnRuLWltcG9ydCIgdGl0bGU9Ik5o4bqtcCBKU09OIj5OaOG6rXA8L2J1dHRvbj4KICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIHZpbyIgaWQ9ImJ0bi1pY3MiIHRpdGxlPSJYdeG6pXQgLmljcyAoYWN0aW9ucyArIHJldmlldykiPklDUzwvYnV0dG9uPgogICAgICA8YnV0dG9uIGNsYXNzPSJidG4iIGlkPSJidG4tZXhwb3J0LWNzdiIgdGl0bGU9Ilh14bqldCBDU1YiPkNTVjwvYnV0dG9uPgogICAgICA8YnV0dG9uIGNsYXNzPSJidG4iIGlkPSJidG4tZXhwb3J0LW1kIiB0aXRsZT0iWHXhuqV0IE1hcmtkb3duIj5NRDwvYnV0dG9uPgogICAgICA8ZGV0YWlscyBjbGFzcz0iZHJvcGRvd24iIGlkPSJ0dHMtc2V0dGluZ3MiPgogICAgICAgIDxzdW1tYXJ5IGNsYXNzPSJidG4iPlRUUyDimpnvuI48L3N1bW1hcnk+CiAgICAgICAgPGRpdiBjbGFzcz0icGFuZWwgY2FyZCIgc3R5bGU9InBhZGRpbmc6MTBweDttaW4td2lkdGg6MjYwcHgiPgogICAgICAgICAgPGRpdiBjbGFzcz0icm93Ij4KICAgICAgICAgICAgPGxhYmVsIGZvcj0idHRzLXZvaWNlIj5HaeG7jW5nPC9sYWJlbD4KICAgICAgICAgICAgPHNlbGVjdCBpZD0idHRzLXZvaWNlIj48L3NlbGVjdD4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0icm93Ij4KICAgICAgICAgICAgPGxhYmVsIGZvcj0idHRzLXJhdGUiPlThu5FjIMSR4buZPC9sYWJlbD4KICAgICAgICAgICAgPGlucHV0IGlkPSJ0dHMtcmF0ZSIgdHlwZT0icmFuZ2UiIG1pbj0iMC41IiBtYXg9IjIiIHN0ZXA9IjAuMSI+CiAgICAgICAgICAgIDxzcGFuIGlkPSJ0dHMtcmF0ZS12YWwiIGNsYXNzPSJtdXRlZCI+PC9zcGFuPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGV0YWlscz4KICAgICAgPGRldGFpbHMgY2xhc3M9ImRyb3Bkb3duIiBpZD0ibm90aWZ5LXNldHRpbmdzIj4KICAgICAgICA8c3VtbWFyeSBjbGFzcz0iYnRuIj7ij7AgUmV2aWV3PC9zdW1tYXJ5PgogICAgICAgIDxkaXYgY2xhc3M9InBhbmVsIGNhcmQiIHN0eWxlPSJwYWRkaW5nOjEwcHg7bWluLXdpZHRoOjI2MHB4Ij4KICAgICAgICAgIDxkaXYgY2xhc3M9InJvdyI+CiAgICAgICAgICAgIDxsYWJlbD5HaeG7nSBwaW5nIChISDpNTSwgY8OhY2ggbmhhdSBk4bqldSBwaOG6qXkpPC9sYWJlbD4KICAgICAgICAgICAgPGlucHV0IGlkPSJucy10aW1lcyIgdHlwZT0idGV4dCIgcGxhY2Vob2xkZXI9IjExOjMwLDE5OjMwIj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0icm93Ij4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIiBpZD0ibnMtc2F2ZSI+TMawdTwvYnV0dG9uPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4iIGlkPSJucy1zbm9vemUtMTUiPlNub296ZSAxNeKAmTwvYnV0dG9uPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4iIGlkPSJucy1zbm9vemUtMzAiPjMw4oCZPC9idXR0b24+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biIgaWQ9Im5zLXNub296ZS02MCI+NjDigJk8L2J1dHRvbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0ibXV0ZWQiIGlkPSJucy1zdGF0dXMiPjwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICA8L2RldGFpbHM+CgogICAgICA8YnV0dG9uIGNsYXNzPSJidG4iIGlkPSJidG4tc3BlYWstbGlzdCIgdGl0bGU9IsSQ4buNYyBkYW5oIHPDoWNoIMSRYW5nIGzhu41jIj7wn5SKIMSQ4buNYyBkYW5oIHPDoWNoPC9idXR0b24+CiAgICAgIDxidXR0b24gY2xhc3M9ImJ0biIgaWQ9ImJ0bi1zdG9wLWxpc3QiIHRpdGxlPSJE4burbmcgxJHhu41jIj7ij7kgROG7q25nPC9idXR0b24+CiAgICA8L2Rpdj4KICA8L2Rpdj4KPC9oZWFkZXI+Cgo8ZGl2IGNsYXNzPSJjb250YWluZXIiPgogIDxkaXYgY2xhc3M9InRhYnMiIGlkPSJ0YWJzIj4KICAgIDxzcGFuIGNsYXNzPSJ0YWIgb24iIGRhdGEtdGFiPSJpbmJveCI+SW5ib3g8L3NwYW4+CiAgICA8c3BhbiBjbGFzcz0idGFiIiBkYXRhLXRhYj0ibm90ZXMiPk5vdGVzPC9zcGFuPgogICAgPHNwYW4gY2xhc3M9InRhYiIgZGF0YS10YWI9InByb2plY3RzIj5Qcm9qZWN0cy9NYXBzPC9zcGFuPgogICAgPHNwYW4gY2xhc3M9InRhYiIgZGF0YS10YWI9ImFjdGlvbnMiPkFjdGlvbnM8L3NwYW4+CiAgICA8c3BhbiBjbGFzcz0idGFiIiBkYXRhLXRhYj0idHJhaW5pbmciPlBsYXlib29rPC9zcGFuPgogICAgPHNwYW4gY2xhc3M9InRhYiIgZGF0YS10YWI9Imd1aWRlIj5HdWlkZTwvc3Bhbj4KICAgIDxzcGFuIGNsYXNzPSJ0YWIiIGRhdGEtdGFiPSJ0cmFuc2NyaWJlIj5UcmFuc2NyaWJlPC9zcGFuPgogIDwvZGl2Pgo8L2Rpdj4KCjwhLS0gSW5ib3ggLS0+CjxkaXYgaWQ9InZpZXctaW5ib3giIGNsYXNzPSJjb250YWluZXIiPgogIDxkaXYgY2xhc3M9ImdyaWQiPgogICAgPHNlY3Rpb24gY2xhc3M9ImNhcmQiPgogICAgICA8aDI+Q2FwdHVyZSDigJQgQuG6r3QgdGjhurNuZyB2w6BvIEluYm94ICgxIGTDsm5nKTwvaDI+CiAgICAgIDxkaXYgY2xhc3M9ImNvbnRlbnQiPgogICAgICAgIDxkaXYgY2xhc3M9InJvdyI+CiAgICAgICAgICA8aW5wdXQgaWQ9ImNhcC10aXRsZSIgdHlwZT0idGV4dCIgcGxhY2Vob2xkZXI9ImfDtSBuaGFuaCBt4buZdCBkw7JuZyAoY8OzIHRo4buDIGTDuW5nICEgXiA/ICQgQCAjID4gfikiPgogICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGFjYyIgaWQ9ImNhcC1zYXZlIj5UaOG6oyB2w6BvIEluYm94PC9idXR0b24+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0ibXV0ZWQiPkhvdGtleTogPGtiZD5DdHJsPC9rYmQ+ICsgPGtiZD5OPC9rYmQ+IG3hu58gbmhhbmguPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9zZWN0aW9uPgoKICAgIDxzZWN0aW9uIGNsYXNzPSJjYXJkIj4KICAgICAgPGgyPlByb2Nlc3Mg4oCUIE7DqW4gKENvbmRlbnNlKSDihpIgTGnDqm4gKExpbmspIOKGkiBRdXnhur90IChEZWNpc2lvbikg4oaSIOG7qG5nIChBcHBseSk8L2gyPgogICAgICA8ZGl2IGNsYXNzPSJjb250ZW50Ij4KICAgICAgICA8ZGl2IGlkPSJpbmJveC1saXN0IiBjbGFzcz0ibm90ZS1saXN0Ij48L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L3NlY3Rpb24+CiAgPC9kaXY+CjwvZGl2PgoKPCEtLSBOb3RlcyAtLT4KPGRpdiBpZD0idmlldy1ub3RlcyIgY2xhc3M9ImNvbnRhaW5lciBoaWRlIj4KICA8ZGl2IGNsYXNzPSJncmlkIj4KICAgIDxzZWN0aW9uIGNsYXNzPSJjYXJkIj4KICAgICAgPGgyPlNv4bqhbiBub3RlIG5ndXnDqm4gdOG7rSAoQXRvbWljKTwvaDI+CiAgICAgIDxkaXYgY2xhc3M9ImNvbnRlbnQiPgogICAgICAgIDxkaXYgY2xhc3M9InJvdyI+CiAgICAgICAgICA8ZGl2PgogICAgICAgICAgICA8bGFiZWw+VGnDqnUgxJHhu4E8L2xhYmVsPgogICAgICAgICAgICA8aW5wdXQgaWQ9InRpdGxlIiB0eXBlPSJ0ZXh0IiBwbGFjZWhvbGRlcj0idmQuIEluc3VsaW4gc2Vuc2l0aXZpdHkg4oCUIGPDoWNoIHTEg25nIj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdj4KICAgICAgICAgICAgPGxhYmVsPkxv4bqhaTwvbGFiZWw+CiAgICAgICAgICAgIDxzZWxlY3QgaWQ9InR5cGUiPgogICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9Im5vdGUiPm5vdGU8L29wdGlvbj4KICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJwcm9qZWN0Ij5wcm9qZWN0PC9vcHRpb24+CiAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0ibWVldGluZyI+bWVldGluZzwvb3B0aW9uPgogICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9ImRlY2lzaW9uIj5kZWNpc2lvbjwvb3B0aW9uPgogICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9InJlYWRpbmciPnJlYWRpbmc8L29wdGlvbj4KICAgICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8bGFiZWw+SOG6oXQgbmjDom4gKDHigJMyIGPDonUpPC9sYWJlbD4KICAgICAgICA8dGV4dGFyZWEgaWQ9ImNvcmUiIHBsYWNlaG9sZGVyPSJ0w7NtIHThuq90IDHigJMyIGPDonUg4oCUIHBoacOqbiBi4bqjbiBjw7MgdGjhu4MgdMOhaSBkw7luZyI+PC90ZXh0YXJlYT4KICAgICAgICA8bGFiZWw+TuG7mWkgZHVuZyAvIGxvZyAoaOG7lyB0cuG7oyBrw70gaGnhu4d1ICEgXiA/ICQgQCAjID4gfik8L2xhYmVsPgogICAgICAgIDx0ZXh0YXJlYSBpZD0iY29udGVudCIgcGxhY2Vob2xkZXI9IlswOToxMF0gXiBpbnNpZ2h0IC4uLiYjMTA7ISBU4bqhbyBjaGVja2xpc3QgLi4uJiMxMDs/IEPhuqduIGjhu49pIC4uLiI+PC90ZXh0YXJlYT4KICAgICAgICA8ZGl2IGNsYXNzPSJyb3czIj4KICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgIDxsYWJlbD5Qcm9qZWN0PC9sYWJlbD4KICAgICAgICAgICAgPGlucHV0IGlkPSJwcm9qZWN0IiB0eXBlPSJ0ZXh0IiBwbGFjZWhvbGRlcj0idmQuIHdlYi1jaGVja2xpc3QtdWkiPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2PgogICAgICAgICAgICA8bGFiZWw+QFBlb3BsZTwvbGFiZWw+CiAgICAgICAgICAgIDxpbnB1dCBpZD0icGVvcGxlLWlucHV0IiB0eXBlPSJ0ZXh0IiBwbGFjZWhvbGRlcj0ibmjhuq1wIHTDqm4gcuG7k2kgRW50ZXIgKHZkLiBBdXJvcmEsIFJveWNlKSI+CiAgICAgICAgICAgIDxkaXYgaWQ9InBlb3BsZS10YWdzIiBjbGFzcz0idGFncyI+PC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgIDxsYWJlbD5Tb3VyY2U8L2xhYmVsPgogICAgICAgICAgICA8aW5wdXQgaWQ9InNvdXJjZSIgdHlwZT0idGV4dCIgcGxhY2Vob2xkZXI9IkxpbmsgLyBUw6BpIGxp4buHdSAvIFRyYW5nIj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InJvdyI+CiAgICAgICAgICA8ZGl2PgogICAgICAgICAgICA8bGFiZWw+UmV2aWV3IG9uPC9sYWJlbD4KICAgICAgICAgICAgPGlucHV0IGlkPSJyZXZpZXciIHR5cGU9ImRhdGUiPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IiBzdHlsZT0ibWFyZ2luLXRvcDoyOHB4Ij4KICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJzd2l0Y2giPjxpbnB1dCBpZD0iYmxvY2tlciIgdHlwZT0iY2hlY2tib3giPjwvbGFiZWw+CiAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJtdXRlZCI+QmxvY2tlcjwvc3Bhbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxsYWJlbD5UYWdzICgjIOKAlCB04buRaSDEkWEgMik8L2xhYmVsPgogICAgICAgIDxkaXYgaWQ9InRhZy1jaGlwcyIgY2xhc3M9InRhZ3MiPjwvZGl2PgogICAgICAgIDxpbnB1dCBpZD0idGFnLWlucHV0IiB0eXBlPSJ0ZXh0IiBwbGFjZWhvbGRlcj0ibmjhuq1wIHRo4bq7IHLhu5NpIEVudGVyICh2ZC4gd2ViLCB1aSkg4oCUIHThu5FpIMSRYSAyIj4KICAgICAgICA8ZGl2IGNsYXNzPSJociI+PC9kaXY+CiAgICAgICAgPGxhYmVsPkjDoG5oIMSR4buZbmcgKCEpIOKAlCBOZXh0IEFjdGlvbnM8L2xhYmVsPgogICAgICAgIDxkaXYgY2xhc3M9InJvdyI+CiAgICAgICAgICA8aW5wdXQgaWQ9ImFjdC10ZXh0IiB0eXBlPSJ0ZXh0IiBwbGFjZWhvbGRlcj0ixJHhu5luZyB04burICsgxJHhu5FpIHTGsOG7o25nICsgdGnDqnUgY2jDrSB4b25nICh2ZC4gVmnhur90IHRlc3QgRTJFIGNobyBmb3JtIGzhu41jKSI+CiAgICAgICAgICA8aW5wdXQgaWQ9ImFjdC1kdWUiIHR5cGU9ImRhdGUiIHRpdGxlPSJkZWFkbGluZSAodMO5eSBjaOG7jW4pIj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGlkPSJhY3QtbGlzdCIgY2xhc3M9InRhZ3MiPjwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImZsZXgiPgogICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIiBpZD0iYnRuLWV4dHJhY3QiPlThu7EgdHLDrWNoIHThu6sgbuG7mWkgZHVuZyAoa8O9IGhp4buHdSk8L2J1dHRvbj4KICAgICAgICAgIDxzcGFuIGNsYXNzPSJyaWdodCI+PC9zcGFuPgogICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGFjYyIgaWQ9ImJ0bi1zYXZlIj5MxrB1PC9idXR0b24+CiAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4iIGlkPSJidG4tcmVzZXQiPljDs2EgZm9ybTwvYnV0dG9uPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9Im11dGVkIiBpZD0iYXV0by1pZCI+aWQgKGF1dG8pOiBz4bq9IHThuqFvIGtoaSBsxrB1PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iaHIiPjwvZGl2PgogICAgICAgIDxkZXRhaWxzPgogICAgICAgICAgPHN1bW1hcnkgY2xhc3M9Im11dGVkIj5UZW1wbGF0ZXMgKERhaWx5IE9wcyAvIFByb2plY3QgLyBSZWFkaW5nIC8gTWVldGluZyAvIERlY2lzaW9uKTwvc3VtbWFyeT4KICAgICAgICAgIDxkaXYgY2xhc3M9ImlubGluZSIgc3R5bGU9Im1hcmdpbi10b3A6OHB4Ij4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zbSIgZGF0YS10cGw9ImRhaWx5Ij5EYWlseSBPcHM8L2J1dHRvbj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zbSIgZGF0YS10cGw9InByb2plY3QiPlByb2plY3QgTWFwPC9idXR0b24+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tc20iIGRhdGEtdHBsPSJyZWFkaW5nIj5SZWFkaW5nIE5vdGU8L2J1dHRvbj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zbSIgZGF0YS10cGw9Im1lZXRpbmciPk1lZXRpbmcgTm90ZTwvYnV0dG9uPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIiBkYXRhLXRwbD0iZGVjaXNpb24iPkRlY2lzaW9uIExvZzwvYnV0dG9uPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kZXRhaWxzPgogICAgICA8L2Rpdj4KICAgIDwvc2VjdGlvbj4KCiAgICA8c2VjdGlvbiBjbGFzcz0iY2FyZCI+CiAgICAgIDxoMj5C4buZIGzhu41jICh04buRaSBnaeG6o24pIDxzcGFuIGNsYXNzPSJyaWdodCI+PC9zcGFuPjxidXR0b24gY2xhc3M9ImJ0biBidG4tc20iIGlkPSJidG4tdGFibGUiPkLhuqNuZzwvYnV0dG9uPjwvaDI+CiAgICAgIDxkaXYgY2xhc3M9ImNvbnRlbnQiPgogICAgICAgIDxkaXYgY2xhc3M9ImdyaWQiPgogICAgICAgICAgPGxhYmVsPlThu6sga2jDs2EgLyB0cnV5IHbhuqVuPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBpZD0icSIgdHlwZT0idGV4dCIgcGxhY2Vob2xkZXI9ImhhczphY3Rpb24g4oCiIGhhczpibG9ja2VyIOKAoiB0eXBlOmRlY2lzaW9uIOKAoiBwcm9qZWN0OlhZWiDigKIgdGFnOiN3ZWIg4oCiIHVwZGF0ZWQ6PDdkfDwzMGQg4oCiIHJldmlldzpkdWV8PDdkIOKAoiBkdWU6b3ZlcmR1ZXx0b2RheXw8N2R8PDMwZCI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJpbmxpbmUiIGlkPSJxdWljay1jaGlwcyI+CiAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJiYWRnZSBjaGlwIiBkYXRhLWNoaXA9ImhhczphY3Rpb24iPmhhczphY3Rpb248L3NwYW4+CiAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJiYWRnZSBjaGlwIiBkYXRhLWNoaXA9InJldmlldzpkdWUiPnJldmlldzpkdWU8L3NwYW4+CiAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJiYWRnZSBjaGlwIiBkYXRhLWNoaXA9InVwZGF0ZWQ6PDdkIj51cGRhdGVkOjw3ZDwvc3Bhbj4KICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImJhZGdlIGNoaXAiIGRhdGEtY2hpcD0idHlwZTpkZWNpc2lvbiI+dHlwZTpkZWNpc2lvbjwvc3Bhbj4KICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImJhZGdlIGNoaXAiIGRhdGEtY2hpcD0iaGFzOmJsb2NrZXIiPmhhczpibG9ja2VyPC9zcGFuPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJyb3ciPgogICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgIDxsYWJlbD5Mb+G6oWk8L2xhYmVsPgogICAgICAgICAgICAgIDxzZWxlY3QgaWQ9InR5cGUtZmlsdGVyIj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IiI+VOG6pXQgY+G6ozwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0ibm90ZSI+bm90ZTwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0icHJvamVjdCI+cHJvamVjdDwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0ibWVldGluZyI+bWVldGluZzwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iZGVjaXNpb24iPmRlY2lzaW9uPC9vcHRpb24+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJyZWFkaW5nIj5yZWFkaW5nPC9vcHRpb24+CiAgICAgICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgIDxsYWJlbD5Qcm9qZWN0PC9sYWJlbD4KICAgICAgICAgICAgICA8aW5wdXQgaWQ9InByb2plY3QtZmlsdGVyIiB0eXBlPSJ0ZXh0IiBwbGFjZWhvbGRlcj0idmQuIHdlYi1jaGVja2xpc3QtdWkiPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0icm93Ij4KICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICA8bGFiZWw+VGjhurs8L2xhYmVsPgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRyb3Bkb3duIj4KICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tc20iIGlkPSJidG4tdGFncyI+Q2jhu41uIHRo4bq7PC9idXR0b24+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtZW51IGhpZGUiIGlkPSJtZW51LXRhZ3MiPjwvZGl2PgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICA8bGFiZWw+Q+G6rXAgbmjhuq10PC9sYWJlbD4KICAgICAgICAgICAgICA8c2VsZWN0IGlkPSJ1cGRhdGVkLXJhbmdlIj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9ImFueSI+QuG6pXQga+G7szwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iN2QiPjwgNyBuZ8OgeTwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iMzBkIj48IDMwIG5nw6B5PC9vcHRpb24+CiAgICAgICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OmZsZXg7anVzdGlmeS1jb250ZW50OmZsZXgtZW5kIj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zbSIgaWQ9ImJ0bi1jbGVhciI+WMOzYSBi4buZIGzhu41jPC9idXR0b24+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L3NlY3Rpb24+CgogICAgPHNlY3Rpb24gY2xhc3M9ImNhcmQiPgogICAgICA8aDI+S+G6v3QgcXXhuqMgPHNtYWxsIGlkPSJyZXN1bHQtY291bnQiIGNsYXNzPSJtdXRlZCI+KDApPC9zbWFsbD48L2gyPgogICAgICA8ZGl2IGNsYXNzPSJjb250ZW50Ij4KICAgICAgICA8ZGl2IGlkPSJsaXN0IiBjbGFzcz0ibm90ZS1saXN0Ij48L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L3NlY3Rpb24+CiAgPC9kaXY+CjwvZGl2PgoKPCEtLSBQcm9qZWN0cyAtLT4KPGRpdiBpZD0idmlldy1wcm9qZWN0cyIgY2xhc3M9ImNvbnRhaW5lciBoaWRlIj4KICA8ZGl2IGNsYXNzPSJncmlkIj4KICAgIDxzZWN0aW9uIGNsYXNzPSJjYXJkIj4KICAgICAgPGgyPlByb2plY3QgTWFwczwvaDI+CiAgICAgIDxkaXYgY2xhc3M9ImNvbnRlbnQiPgogICAgICAgIDxkaXYgY2xhc3M9InJvdyI+CiAgICAgICAgICA8aW5wdXQgaWQ9InByai1uZXciIHR5cGU9InRleHQiIHBsYWNlaG9sZGVyPSJUw6puIGThu7Egw6FuIChzbHVnIHPhur0gdOG6oW8gdOG7sSDEkeG7mW5nKSI+CiAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYWNjIiBpZD0icHJqLWNyZWF0ZSI+VOG6oW8gUHJvamVjdDwvYnV0dG9uPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgaWQ9InByai1saXN0IiBjbGFzcz0iZ3JpZCIgc3R5bGU9ImdyaWQtdGVtcGxhdGUtY29sdW1uczpyZXBlYXQoMixtaW5tYXgoMCwxZnIpKTtnYXA6MTJweDttYXJnaW4tdG9wOjEycHgiPjwvZGl2PgogICAgICA8L2Rpdj4KICAgIDwvc2VjdGlvbj4KICA8L2Rpdj4KPC9kaXY+Cgo8IS0tIEFjdGlvbnMgLS0+CjxkaXYgaWQ9InZpZXctYWN0aW9ucyIgY2xhc3M9ImNvbnRhaW5lciBoaWRlIj4KICA8ZGl2IGNsYXNzPSJncmlkIj4KICAgIDxzZWN0aW9uIGNsYXNzPSJjYXJkIj4KICAgICAgPGgyPk5leHQgQWN0aW9ucyAodOG7lW5nIGjhu6NwKTwvaDI+CiAgICAgIDxkaXYgY2xhc3M9ImNvbnRlbnQiPgogICAgICAgIDxkaXYgY2xhc3M9ImZsZXgiPgogICAgICAgICAgPHNlbGVjdCBpZD0iYWN0LXNjb3BlIj4KICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iYWxsIj5U4bqldCBj4bqjPC9vcHRpb24+CiAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9InRvZGF5Ij5Iw7RtIG5heTwvb3B0aW9uPgogICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJvdmVyZHVlIj5RdcOhIGjhuqFuPC9vcHRpb24+CiAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IndlZWsiPjcgbmfDoHk8L29wdGlvbj4KICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgPHNwYW4gY2xhc3M9InJpZ2h0Ij48L3NwYW4+CiAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gd2FybiIgaWQ9ImFjdC10b3AzIj5DaOG7jW4gVG9wIDMgaMO0bSBuYXk8L2J1dHRvbj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJociI+PC9kaXY+CiAgICAgICAgPGRpdiBpZD0iYWN0LXJvd3MiPjwvZGl2PgogICAgICA8L2Rpdj4KICAgIDwvc2VjdGlvbj4KICA8L2Rpdj4KPC9kaXY+Cgo8IS0tIFBsYXlib29rIC0tPgo8ZGl2IGlkPSJ2aWV3LXRyYWluaW5nIiBjbGFzcz0iY29udGFpbmVyIGhpZGUiPgogIDxkaXYgY2xhc3M9ImdyaWQiPgogICAgPHNlY3Rpb24gY2xhc3M9ImNhcmQiPgogICAgICA8aDI+UGxheWJvb2sg4oCUIDIwIHBow7p0IHRyaeG7g24ga2hhaSArIDcgbmfDoHkgbHV54buHbiB0aMOzaSBxdWVuPC9oMj4KICAgICAgPGRpdiBjbGFzcz0iY29udGVudCI+CiAgICAgICAgPGRpdiBjbGFzcz0iYmFubmVyIHdhcm4iPlF1eSB04bqvYyAxMCBnacOieTogTeG7jWkgbm90ZSBwaOG6o2kgdHLhuqMgbOG7nWkgbmdheSDigJw8Yj5UaeG6v3AgdGhlbyBsw6BtIGfDrD88L2I+4oCdIHbDoCDigJw8Yj5U4bqhaSBzYW8/PC9iPuKAnS4gTuG6v3Uga2jDtG5nLCBuw6luIGzhuqFpIGhv4bq3YyB0w6FjaCBuZ3V5w6puIHThu60uPC9kaXY+CiAgICAgICAgPGgzIHN0eWxlPSJtYXJnaW46MTBweCAwIDZweCI+Q2hlY2tsaXN0IDIwIHBow7p0IChkw7luZyB04buRaSBuYXkpPC9oMz4KICAgICAgICA8ZGl2IGlkPSJjMjAiPjwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImhyIj48L2Rpdj4KICAgICAgICA8aDMgc3R5bGU9Im1hcmdpbjoxMHB4IDAgNnB4Ij43IG5nw6B5IGx1eeG7h24gdGjDs2kgcXVlbjwvaDM+CiAgICAgICAgPGRpdiBpZD0iYzciPjwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImhyIj48L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4Ij4KICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBhY2MiIGlkPSJidG4tc3RhcnQtdHJhaW5pbmciPkto4bufaSDEkeG7mW5nPC9idXR0b24+CiAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4iIGlkPSJidG4tcmVzZXQtdHJhaW5pbmciPlJlc2V0PC9idXR0b24+CiAgICAgICAgICA8c3BhbiBjbGFzcz0icmlnaHQiPjwvc3Bhbj4KICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biIgaWQ9ImJ0bi1ub3RpZnkiPkLhuq10IHRow7RuZyBiw6FvIHJldmlldyAoMTE6MzAgJiAxOTozMCk8L2J1dHRvbj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L3NlY3Rpb24+CgogICAgPHNlY3Rpb24gY2xhc3M9ImNhcmQiPgogICAgICA8aDI+TOG7l2kgaGF5IGfhurdwICYgY2jhurduPC9oMj4KICAgICAgPGRpdiBjbGFzcz0iY29udGVudCIgaWQ9ImxpbnQtcGFuZWwiPjwvZGl2PgogICAgPC9zZWN0aW9uPgogIDwvZGl2Pgo8L2Rpdj4KCgo8IS0tIEd1aWRlIC8gUkVBRE1FIC0tPgo8ZGl2IGlkPSJ2aWV3LWd1aWRlIiBjbGFzcz0iY29udGFpbmVyIGhpZGUiPgogIDxkaXYgY2xhc3M9ImdyaWQiPgogICAgPHNlY3Rpb24gY2xhc3M9ImNhcmQiPgogICAgICA8aDI+UkVBRE1FIOKAlCBIxrDhu5tuZyBk4bqrbiBkw7luZyBuaGFuaDwvaDI+CiAgICAgIDxkaXYgY2xhc3M9ImNvbnRlbnQiPgogICAgICAgIDxkaXYgY2xhc3M9ImJhbm5lciBnb29kIj5Ucmnhur90IGzDvTogPGI+R2hpIG3hu5l0IGzhuqduIOKGkiBkw7luZyDEkcaw4bujYyBuZ2F5IOKGkiB0w6FpIGTDuW5nIG5oaeG7gXUgbOG6p248L2I+LiBU4buRaSBnaeG6o24sIHRo4buxYyBk4bulbmcuPC9kaXY+CiAgICAgICAgPGgzIHN0eWxlPSJtYXJnaW46MTBweCAwIDZweCI+MSkgTHXhu5NuZyB0aGFvIHTDoWMgMjBzPC9oMz4KICAgICAgICA8b2w+CiAgICAgICAgICA8bGk+PGI+SW5ib3g8L2I+OiBnw7UgMSBkw7JuZyAoY8OzIGvDvSBoaeG7h3UgPGNvZGU+ISBeID8gJCBAICMgJmd0OyB+PC9jb2RlPikg4oaSIDxiPlRo4bqjIHbDoG8gSW5ib3g8L2I+LjwvbGk+CiAgICAgICAgICA8bGk+PGI+UHJvY2VzczwvYj46IGLhuqVtIDxiPlRyw61jaCBrw70gaGnhu4d1PC9iPiDihpIgxJFp4buBbiB04buRaSB0aGnhu4N1IDxiPlByb2plY3QvVGFnczwvYj4gKOKJpDIpICsgPGI+UmV2aWV3PC9iPiBu4bq/dSBj4bqnbi48L2xpPgogICAgICAgICAgPGxpPjxiPkFwcGx5PC9iPjogYuG6pW0gPGI+xJDhuql5IHJhIE5vdGVzPC9iPiDihpIgY2h1eeG7g24gc2FuZyB0YWIgPGI+Tm90ZXM8L2I+IMSR4buDIGzhu41jL3TDrG0gdsOgIGjDoG5oIMSR4buZbmcuPC9saT4KICAgICAgICA8L29sPgogICAgICAgIDxoMyBzdHlsZT0ibWFyZ2luOjEwcHggMCA2cHgiPjIpIEPDuiBwaMOhcCBrw70gaGnhu4d1PC9oMz4KICAgICAgICA8cHJlPjxjb2RlPiEgSMOgbmggxJHhu5luZyAoTmV4dCBzdGVwKQpeIEluc2lnaHQgaOG6oXQgbmjDom4gMeKAkzIgY8OidQo/IEPDonUgaOG7j2kgICAgICQgU+G7kSBsaeG7h3UKQFTDqm4gICAgICAgICAgI3RhZyAodOG7kWkgxJFhIDIpCiZndDsgVHLDrWNoIGThuqtuICAgfiBHaeG6oyB0aHV54bq/dApwcm9qZWN0OnNsdWcgIHNvdXJjZTpVUkwgIHJldmlldzpZWVlZLU1NLUREICBibG9ja2VyPC9jb2RlPjwvcHJlPgoKICAgICAgICA8aDMgc3R5bGU9Im1hcmdpbjoxMHB4IDAgNnB4Ij4zKSBC4buZIGzhu41jIHRo4buxYyBk4bulbmcgKE5vdGVzKTwvaDM+CiAgICAgICAgPHA+R8O1IHbDoG8gw7QgdHJ1eSB24bqlbiBob+G6t2MgYuG6pW0gY2hpcC4gQ8OzIHRo4buDIGvhur90IGjhu6NwIHThu7EgZG8uPC9wPgogICAgICAgIDxwcmU+PGNvZGU+aGFzOmFjdGlvbiAgIGhhczpibG9ja2VyCnR5cGU6ZGVjaXNpb24gIHByb2plY3Q6WFlaICB0YWc6I3dlYgp1cGRhdGVkOiZsdDs3ZCAgdXBkYXRlZDombHQ7MzBkICByZXZpZXc6ZHVlICByZXZpZXc6Jmx0OzdkCiZsdDt04burIGtow7NhIHThu7EgZG8mZ3Q7PC9jb2RlPjwvcHJlPgoKICAgICAgICA8aDMgc3R5bGU9Im1hcmdpbjoxMHB4IDAgNnB4Ij40KSBC4bqjbmcgZ2hpIGNow7ogJmFtcDsgxJDhu41jIGzDqm4gKFRUUyk8L2gzPgogICAgICAgIDx1bD4KICAgICAgICAgIDxsaT5Ob3RlcyDihpIgYuG6pW0gPGI+QuG6o25nPC9iPiDEkeG7gyBjaHV54buDbiA8aT5UaOG6uzwvaT4g4oaUIDxpPkLhuqNuZzwvaT4uPC9saT4KICAgICAgICAgIDxsaT5Ow7p0IDxiPvCflIo8L2I+IOG7nyBt4buXaSB0aOG6uy9kw7JuZyDEkeG7gyDEkeG7jWM7IMSRYW5nIMSR4buNYyBz4bq9IGzDoCA8Yj7ij7k8L2I+LjwvbGk+CiAgICAgICAgPC91bD4KCiAgICAgICAgPGgzIHN0eWxlPSJtYXJnaW46MTBweCAwIDZweCI+NSkgVHJhbnNjcmliZSAo4bqjbmgvV29yZC9QREYg4oaSIGNo4buvIOKGkiDEkeG7jWMpPC9oMz4KICAgICAgICA8b2w+CiAgICAgICAgICA8bGk+TeG7nyB0YWIgPGI+VHJhbnNjcmliZTwvYj4g4oaSIDxiPkNo4buNbiB04buHcDwvYj4gaG/hurdjIGvDqW8gdGjhuqM6IDxjb2RlPi50eHQgLm1kIC5kb2N4IC5wZGYgLnBuZyAuanBnIC53ZWJwPC9jb2RlPi48L2xpPgogICAgICAgICAgPGxpPsSQ4bujaSB4b25nIOKGkiB2xINuIGLhuqNuIGhp4buHbiDhu58gw7QgPGI+S+G6v3QgcXXhuqM8L2I+LiBC4bqlbSA8Yj7wn5SKPC9iPiDEkeG7gyBuZ2hlIGhv4bq3YyA8Yj5UaMOqbSB2w6BvIEluYm94PC9iPi48L2xpPgogICAgICAgICAgPGxpPkzGsHUgw706IOG6o25oL1BERi9ET0NYIGTDuW5nIHRoxrAgdmnhu4duIG9ubGluZSAoVGVzc2VyYWN0L1BERi5qcy9NYW1tb3RoKSDih5IgY+G6p24gSW50ZXJuZXQgbOG6p24gxJHhuqd1LjwvbGk+CiAgICAgICAgPC9vbD4KCiAgICAgICAgPGgzIHN0eWxlPSJtYXJnaW46MTBweCAwIDZweCI+NikgSMOgbmggxJHhu5luZyB04buVbmcgaOG7o3A8L2gzPgogICAgICAgIDx1bD4KICAgICAgICAgIDxsaT5UYWIgPGI+QWN0aW9uczwvYj46IHhlbSA8aT5Iw7RtIG5heSAvIFF1w6EgaOG6oW4gLyA3IG5nw6B5PC9pPiwgxJHDoW5oIGThuqV1IDxiPkRvbmUvVW5kbzwvYj4sIDxiPljDs2E8L2I+LjwvbGk+CiAgICAgICAgICA8bGk+PGI+VG9wIDMgaMO0bSBuYXk8L2I+OiBhcHAgZ+G7o2kgw70gdGhlbyBo4bqhbiBn4bqnbiBuaOG6pXQgJmFtcDsgxJHhu5kgbeG7m2kuPC9saT4KICAgICAgICA8L3VsPgoKICAgICAgICA8aDMgc3R5bGU9Im1hcmdpbjoxMHB4IDAgNnB4Ij43KSBJQ1MgJmFtcDsgQmFja3VwPC9oMz4KICAgICAgICA8dWw+CiAgICAgICAgICA8bGk+PGI+SUNTPC9iPjogeHXhuqV0IGzhu4tjaCBjaG8gbeG7jWkgPGNvZGU+ISBkdWU8L2NvZGU+ICZhbXA7IDxjb2RlPnJldmlld19vbjwvY29kZT4g4oaSIGltcG9ydCB2w6BvIENhbGVuZGFyLjwvbGk+CiAgICAgICAgICA8bGk+PGI+WHXhuqV0L05o4bqtcDwvYj46IGJhY2t1cC9raMO0aSBwaOG7pWMgYuG6sW5nIDEgZmlsZSBKU09OLjwvbGk+CiAgICAgICAgPC91bD4KCiAgICAgICAgPGgzIHN0eWxlPSJtYXJnaW46MTBweCAwIDZweCI+OCkgUXV5IHThuq9jIOKAnDEwIGdpw6J54oCdPC9oMz4KICAgICAgICA8cD5N4buXaSBub3RlIHBo4bqjaSBjaG8gcGjDqXAgdHLhuqMgbOG7nWkgbmdheToKICAgICAgICAgIDxicj7igKIg4oCcPGI+VGnhur9wIHRoZW8gbMOgbSBnw6w/PC9iPuKAnSDihpIgcGjhuqNpIHRo4bqleSDDrXQgbmjhuqV0IDEgPGNvZGU+ITwvY29kZT4gcsO1IHLDoG5nLgogICAgICAgICAgPGJyPuKAoiDigJw8Yj5U4bqhaSBzYW8/PC9iPuKAnSDihpIgcGjhuqNpIHRo4bqleSBi4buRaSBj4bqjbmggKDxpPnByb2plY3Qvc291cmNlPC9pPikuPC9wPgoKICAgICAgICA8aDMgc3R5bGU9Im1hcmdpbjoxMHB4IDAgNnB4Ij45KSBQaMOtbSB04bqvdDwvaDM+CiAgICAgICAgPHVsPgogICAgICAgICAgPGxpPjxrYmQ+Q3RybDwva2JkPiArIDxrYmQ+Tjwva2JkPiDigJQgbmjhuqN5IHThu5tpIMO0IENhcHR1cmUuPC9saT4KICAgICAgICA8L3VsPgoKICAgICAgICA8aDMgc3R5bGU9Im1hcmdpbjoxMHB4IDAgNnB4Ij4xMCkgTcO0IGjDrG5oIGThu68gbGnhu4d1ICht4buXaSBub3RlKTwvaDM+CiAgICAgICAgPHByZT48Y29kZT57IGlkLCBzdGF0dXM6ICdpbmJveCd8J2FjdGl2ZScsIHR5cGUsIHRpdGxlLCBjb250ZW50X2NvcmUsIGNvbnRlbnQsCiAgYWN0aW9uczogW3t0ZXh0LCBkdWU/LCBkb25lP31dLCB0YWdzOiAo4omkMiksCiAgY29udGV4dDogeyBwcm9qZWN0PywgcGVvcGxlPywgc291cmNlPyB9LCByZXZpZXdfb24/LCBibG9ja2Vycz8sCiAgY3JlYXRlZEF0LCB1cGRhdGVkQXQgfTwvY29kZT48L3ByZT4KCiAgICAgICAgPGRpdiBjbGFzcz0iYmFubmVyIHdhcm4iPlRpcDogTWVldGluZyBwaOG6o2kgc2luaCDiiaUxIDxjb2RlPiE8L2NvZGU+IGPDsyBkZWFkbGluZS4gUmVhZGluZyBuw6puIGPDsyA8Yj5zb3VyY2U8L2I+LiAmZ3Q7MiA8Yj50YWc8L2I+IOKGkiBj4bqvdCBjw7JuIDHigJMyLjwvZGl2PgogICAgICA8L2Rpdj4KICAgIDwvc2VjdGlvbj4KICA8L2Rpdj4KPC9kaXY+Cgo8IS0tIFRyYW5zY3JpYmUgLS0+CjxkaXYgaWQ9InZpZXctdHJhbnNjcmliZSIgY2xhc3M9ImNvbnRhaW5lciBoaWRlIj4KICA8ZGl2IGNsYXNzPSJncmlkIj4KICAgIDxzZWN0aW9uIGNsYXNzPSJjYXJkIj4KICAgICAgPGgyPlRyYW5zY3JpYmUg4oCUIE5o4bqtcCB04buHcCAmIG5o4bqtbiBk4bqhbmc8L2gyPgogICAgICA8ZGl2IGNsYXNzPSJjb250ZW50Ij4KICAgICAgICA8ZGl2IGNsYXNzPSJyb3ciPgogICAgICAgICAgPGlucHV0IGlkPSJ0ci1maWxlIiB0eXBlPSJmaWxlIiBhY2NlcHQ9Ii50eHQsLm1kLC5kb2N4LC5wZGYsLnBuZywuanBnLC5qcGVnLC53ZWJwIj4KICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biIgaWQ9InRyLWNsZWFyIj5Yw7NhPC9idXR0b24+CiAgICAgICAgICA8c3BhbiBjbGFzcz0icmlnaHQgaGVscCI+SOG7lyB0cuG7ozogLnR4dCwgLm1kLCAuZG9jeCwgLnBkZiwgLnBuZywgLmpwZywgLndlYnAgKE9DUiBkw7luZyBt4bqhbmcgxJHhu4MgdOG6o2kgdGjGsCB2aeG7h24pPC9zcGFuPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgaWQ9InRyLWRyb3AiIGNsYXNzPSJkcm9wIiBzdHlsZT0ibWFyZ2luLXRvcDo4cHgiPkvDqW8gdGjhuqMgdOG7h3AgdsOgbyDEkcOieTwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InByb2ciIHN0eWxlPSJtYXJnaW4tdG9wOjhweCI+PGRpdiBpZD0idHItcHJvZyI+PC9kaXY+PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iaHIiPjwvZGl2PgogICAgICAgIDxsYWJlbD5L4bq/dCBxdeG6oyAodsSDbiBi4bqjbik8L2xhYmVsPgogICAgICAgIDx0ZXh0YXJlYSBpZD0idHItdGV4dCIgcGxhY2Vob2xkZXI9InbEg24gYuG6o24gxJHDoyBuaOG6rW4gZOG6oW5nIHPhur0geHXhuqV0IGhp4buHbiDhu58gxJHDonkiPjwvdGV4dGFyZWE+CiAgICAgICAgPGRpdiBjbGFzcz0iZmxleCI+CiAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIiBpZD0idHItc3BlYWsiPvCflIogxJDhu41jPC9idXR0b24+CiAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIiBpZD0idHItc3RvcCI+4o+5IEThu6tuZzwvYnV0dG9uPgogICAgICAgICAgPHNwYW4gY2xhc3M9InJpZ2h0Ij48L3NwYW4+CiAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYWNjIiBpZD0idHItdG8taW5ib3giPlRow6ptIHbDoG8gSW5ib3g8L2J1dHRvbj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L3NlY3Rpb24+CiAgPC9kaXY+CjwvZGl2PgoKPHNjcmlwdD4KLyogPT09PT09IENvbnN0YW50cyB0aGF0IG11c3QgYmUgYmVmb3JlIGluaXQgKGF2b2lkIFREWikgPT09PT09ICovCmNvbnN0IEMyMF9JVEVNUyA9IFsKICAiVOG6oW8gMyB0aMawIG3hu6VjIGxvZ2ljOiAvSW5ib3gsIC9Ob3RlcywgL1Byb2plY3RzICh0cm9uZyBhcHAgxJHDoyBz4bq1biB0YWIgdMawxqFuZyDhu6luZykuIiwKICAiTMawdSA1IFRlbXBsYXRlIHbDoG8gdGjDs2kgcXVlbiAobsO6dCBUZW1wbGF0ZXMgdHJvbmcgZm9ybSkuIiwKICAixJDhurd0IGhvdGtleSBDdHJsK04gxJHhu4MgQ2FwdHVyZSBuaGFuaCAoxJHDoyBjw7MpLiIsCiAgIlRow6ptIDgga8O9IGhp4buHdSB2w6BvIHRow7NpIHF1ZW4gKCEgXiA/ICQgQCAjID4gfikuIiwKICAixJDhurd0IGdp4budIHJldmlldyAxMTozMCAmIDE5OjMwIChuw7p0IELhuq10IHRow7RuZyBiw6FvKS4iLAogICJE4buNbiBJbmJveCBs4bqnbiAxIOKGkiDEkeG6qXkgdsOgbyBOb3Rlcy9Qcm9qZWN0cy4iLAogICJDaOG7jW4gVG9wIDMgaMO0bSBuYXkgKHRhYiBBY3Rpb25zKS4iLApdOwpjb25zdCBDN19JVEVNUyA9IFsKICAiTmfDoHkgMTogQ2jhu4kgbMOgbSDEkcO6bmcgNkEgKyBDQ0xEQS4iLAogICJOZ8OgeSAyOiBUw6FjaCB04bqldCBj4bqjIG5vdGUgZMOgaSB0aMOgbmggbm90ZXMgbmd1ecOqbiB04butLiIsCiAgIk5nw6B5IDM6IEzhuq1wIERlY2lzaW9uIExvZyBjaG8gMyBxdXnhur90IMSR4buLbmggdHXhuqduIG7DoHkuIiwKICAiTmfDoHkgNDogR+G6r24gS1BJIGNobyAxIGThu7Egw6FuIChQcm9qZWN0IE1hcCkuIiwKICAiTmfDoHkgNTogROG7jW4gbOG6oWkgdGFnICht4buXaSBub3RlIOKJpDIgdGjhurspLiIsCiAgIk5nw6B5IDY6IFjDoG8gw6FwIGThu6VuZyB04burIDEgUmVhZGluZyBOb3RlIOKGkiAhIGNo4bqheSB0aOG7rS4iLAogICJOZ8OgeSA3OiBUZXN0IHRydXkgaOG7k2kg4oCUIHTDrG0gNSB0aOG7qSBi4bqldCBr4buzIHRyb25nIOKJpDEwIGdpw6J5LiIsCl07CgovKiogPT09PT0gQ29yZSB0eXBlcyA9PT09PQogKiBOb3RlIHsKICogIGlkOiBZWVlZTU1ERC1ISE1NLXNsdWcKICogIHR5cGU6IG5vdGV8cHJvamVjdHxtZWV0aW5nfGRlY2lzaW9ufHJlYWRpbmcKICogIHRpdGxlLCBjb250ZW50X2NvcmUsIGNvbnRlbnQKICogIGFjdGlvbnM6IFt7dGV4dCwgZHVlPywgZG9uZT99XQogKiAgdGFnczogWzw9Ml0KICogIGNvbnRleHQ6IHsgcHJvamVjdD8sIHBlb3BsZT86W10sIHNvdXJjZT8gfQogKiAgcmV2aWV3X29uPzogZXBvY2ggbXMKICogIGJsb2NrZXJzPzogYm9vbGVhbgogKiAgY3JlYXRlZEF0LCB1cGRhdGVkQXQKICogIHN0YXR1cz86ICdpbmJveCd8J2FjdGl2ZScKICogfQogKi8KY29uc3QgTFNfS0VZID0gImt2LmZ1bGwudjcuNmEuY2NsZGEiOwpjb25zdCBUUkFJTl9LRVkgPSAia3YudHJhaW5pbmcuc3RhdGUudjciOwpjb25zdCAkID0gKHNlbCwgcm9vdD1kb2N1bWVudCk9PnJvb3QucXVlcnlTZWxlY3RvcihzZWwpOwpjb25zdCAkJCA9IChzZWwsIHJvb3Q9ZG9jdW1lbnQpPT5BcnJheS5mcm9tKHJvb3QucXVlcnlTZWxlY3RvckFsbChzZWwpKTsKCmNvbnN0IGVsID0gewogIHRhYnM6ICQoIiN0YWJzIiksCiAgdmlld3M6IHsKICAgIGluYm94OiAkKCIjdmlldy1pbmJveCIpLAogICAgbm90ZXM6ICQoIiN2aWV3LW5vdGVzIiksCiAgICBwcm9qZWN0czogJCgiI3ZpZXctcHJvamVjdHMiKSwKICAgIGFjdGlvbnM6ICQoIiN2aWV3LWFjdGlvbnMiKSwKICAgIHRyYWluaW5nOiAkKCIjdmlldy10cmFpbmluZyIpLAogICAgZ3VpZGU6ICQoIiN2aWV3LWd1aWRlIiksCiAgICB0cmFuc2NyaWJlOiAkKCIjdmlldy10cmFuc2NyaWJlIiksCiAgfSwKICBzdGF0Q291bnQ6ICQoIiNzdGF0LWNvdW50IiksCiAgLy8gSW5ib3gKICBjYXBUaXRsZTogJCgiI2NhcC10aXRsZSIpLCBjYXBTYXZlOiAkKCIjY2FwLXNhdmUiKSwgaW5ib3hMaXN0OiAkKCIjaW5ib3gtbGlzdCIpLAogIC8vIE5vdGVzIGZvcm0KICB0aXRsZTogJCgiI3RpdGxlIiksIHR5cGU6ICQoIiN0eXBlIiksIGNvcmU6ICQoIiNjb3JlIiksIGNvbnRlbnQ6ICQoIiNjb250ZW50IiksCiAgcHJvamVjdDogJCgiI3Byb2plY3QiKSwgcGVvcGxlSW5wdXQ6ICQoIiNwZW9wbGUtaW5wdXQiKSwgcGVvcGxlVGFnczogJCgiI3Blb3BsZS10YWdzIiksCiAgc291cmNlOiAkKCIjc291cmNlIiksIHJldmlldzogJCgiI3JldmlldyIpLCBibG9ja2VyOiAkKCIjYmxvY2tlciIpLAogIHRhZ0lucHV0OiAkKCIjdGFnLWlucHV0IiksIHRhZ0NoaXBzOiAkKCIjdGFnLWNoaXBzIiksCiAgYWN0VGV4dDogJCgiI2FjdC10ZXh0IiksIGFjdER1ZTogJCgiI2FjdC1kdWUiKSwgYWN0TGlzdDogJCgiI2FjdC1saXN0IiksCiAgYnRuRXh0cmFjdDogJCgiI2J0bi1leHRyYWN0IiksIGJ0blNhdmU6ICQoIiNidG4tc2F2ZSIpLCBidG5SZXNldDogJCgiI2J0bi1yZXNldCIpLCBhdXRvSWQ6ICQoIiNhdXRvLWlkIiksCiAgLy8gRmlsdGVycwogIHE6ICQoIiNxIiksIGNoaXBzOiAkKCIjcXVpY2stY2hpcHMiKSwgdHlwZUZpbHRlcjogJCgiI3R5cGUtZmlsdGVyIiksIHByb2plY3RGaWx0ZXI6ICQoIiNwcm9qZWN0LWZpbHRlciIpLAogIGJ0blRhZ3M6ICQoIiNidG4tdGFncyIpLCBtZW51VGFnczogJCgiI21lbnUtdGFncyIpLCB1cGRhdGVkUmFuZ2U6ICQoIiN1cGRhdGVkLXJhbmdlIiksIGJ0bkNsZWFyOiAkKCIjYnRuLWNsZWFyIiksCiAgbGlzdDogJCgiI2xpc3QiKSwgcmVzdWx0Q291bnQ6ICQoIiNyZXN1bHQtY291bnQiKSwKICAvLyBQcm9qZWN0cwogIHByak5ldzogJCgiI3Byai1uZXciKSwgcHJqQ3JlYXRlOiAkKCIjcHJqLWNyZWF0ZSIpLCBwcmpMaXN0OiAkKCIjcHJqLWxpc3QiKSwKICAvLyBBY3Rpb25zCiAgYWN0Um93czogJCgiI2FjdC1yb3dzIiksIGFjdFNjb3BlOiAkKCIjYWN0LXNjb3BlIiksIGFjdFRvcDM6ICQoIiNhY3QtdG9wMyIpLAogIC8vIFRyYWluaW5nCiAgYzIwOiAkKCIjYzIwIiksIGM3OiAkKCIjYzciKSwgYnRuU3RhcnRUcmFpbmluZzogJCgiI2J0bi1zdGFydC10cmFpbmluZyIpLCBidG5SZXNldFRyYWluaW5nOiAkKCIjYnRuLXJlc2V0LXRyYWluaW5nIiksIGJ0bk5vdGlmeTogJCgiI2J0bi1ub3RpZnkiKSwKICAvLyBJTwogIGJ0bkV4cG9ydDogJCgiI2J0bi1leHBvcnQiKSwgYnRuSW1wb3J0OiAkKCIjYnRuLWltcG9ydCIpLCBpbXBvcnRGaWxlOiAkKCIjaW1wb3J0LWZpbGUiKSwgYnRuSWNzOiAkKCIjYnRuLWljcyIpLAogIC8vIExpbnQKICBsaW50UGFuZWw6ICQoIiNsaW50LXBhbmVsIiksCiAgLy8gVHJhbnNjcmliZQogIHRyOiB7IGZpbGU6ICQoIiN0ci1maWxlIiksIGNsZWFyOiAkKCIjdHItY2xlYXIiKSwgZHJvcDogJCgiI3RyLWRyb3AiKSwgcHJvZzogJCgiI3RyLXByb2ciKSwgdGV4dDogJCgiI3RyLXRleHQiKSwgc3BlYWs6ICQoIiN0ci1zcGVhayIpLCBzdG9wOiAkKCIjdHItc3RvcCIpLCB0b0luYm94OiAkKCIjdHItdG8taW5ib3giKSB9LAp9OwoKbGV0IGFsbFRhZ3MgPSBbXTsgLy8gZGVjbGFyZSBlYXJseSAoYXZvaWQgVERaKQpsZXQgaXRlbXMgPSBsb2FkRnJvbUxTKCk7IG1pZ3JhdGVJZk5lZWRlZCgpOyByZW5kZXJTdGF0cygpOyByZWJ1aWxkTWV0YSgpOwoKLyogPT09PT09IFV0aWxzID09PT09PSAqLwpmdW5jdGlvbiByZW5kZXJTdGF0cygpeyB0cnl7IGVsLnN0YXRDb3VudC50ZXh0Q29udGVudCA9IFN0cmluZyhpdGVtcy5sZW5ndGh8fDApOyB9Y2F0Y2goZSl7fSB9CmZ1bmN0aW9uIG5vdygpeyByZXR1cm4gRGF0ZS5ub3coKTsgfQpmdW5jdGlvbiBmbXQyKG4peyByZXR1cm4gbjwxMD8oIjAiK24pOigiIituKTsgfQpmdW5jdGlvbiB5eXl5bW1kZF9oaG1tKHRzKXsgY29uc3QgZD1uZXcgRGF0ZSh0cyk7IGNvbnN0IFk9ZC5nZXRGdWxsWWVhcigpOyBjb25zdCBNPWZtdDIoZC5nZXRNb250aCgpKzEpOyBjb25zdCBEPWZtdDIoZC5nZXREYXRlKCkpOyBjb25zdCBoPWZtdDIoZC5nZXRIb3VycygpKTsgY29uc3QgbT1mbXQyKGQuZ2V0TWludXRlcygpKTsgcmV0dXJuIGAke1l9JHtNfSR7RH0tJHtofSR7bX1gOyB9CmZ1bmN0aW9uIHNsdWcocyl7IHJldHVybiAoc3x8IiIpLnRvTG93ZXJDYXNlKCkubm9ybWFsaXplKCJORkQiKS5yZXBsYWNlKC9bXHUwMzAwLVx1MDM2Zl0vZywiIikucmVwbGFjZSgvW15hLXowLTldKy9nLCItIikucmVwbGFjZSgvKF4tfC0kKS9nLCIiKTsgfQpmdW5jdGlvbiBlc2NhcGVIdG1sKHMpeyByZXR1cm4gU3RyaW5nKHMpLnJlcGxhY2UoLyYvZywiJmFtcDsiKS5yZXBsYWNlKC88L2csIiZsdDsiKS5yZXBsYWNlKC8+L2csIiZndDsiKTsgfQpmdW5jdGlvbiBoaWdobGlnaHQodGV4dCwgdGVybXMpeyBpZighdGVybXMubGVuZ3RoKSByZXR1cm4gZXNjYXBlSHRtbCh0ZXh0KTsgbGV0IG91dD1lc2NhcGVIdG1sKHRleHQpOyBmb3IoY29uc3QgdCBvZiB0ZXJtcyl7IGNvbnN0IHJlPW5ldyBSZWdFeHAoIigiICsgdC5yZXBsYWNlKC9bLiorP14ke30oKXxbXF1cXF0vZywiXFwkJiIpICsgIikiLCAiZ2kiKTsgb3V0PW91dC5yZXBsYWNlKHJlLCAiPG1hcms+JDE8L21hcms+Iik7IH0gcmV0dXJuIG91dDsgfQpmdW5jdGlvbiB3aXRoaW5ORGF5cyh0cyxuKXsgY29uc3QgbXM9bioyNCozNjAwKjEwMDA7IHJldHVybiAobm93KCktdHMpIDw9IG1zOyB9CmZ1bmN0aW9uIGRvd25sb2FkSnNvbihmaWxlbmFtZSxkYXRhKXsgY29uc3QgYmxvYj1uZXcgQmxvYihbSlNPTi5zdHJpbmdpZnkoZGF0YSxudWxsLDIpXSx7dHlwZToiYXBwbGljYXRpb24vanNvbiJ9KTsgY29uc3QgdXJsPVVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7IGNvbnN0IGE9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOyBhLmhyZWY9dXJsOyBhLmRvd25sb2FkPWZpbGVuYW1lOyBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGEpOyBhLmNsaWNrKCk7IGEucmVtb3ZlKCk7IFVSTC5yZXZva2VPYmplY3RVUkwodXJsKTsgfQpmdW5jdGlvbiBkZWJvdW5jZShmbixtcyl7IGxldCB0OyByZXR1cm4gKC4uLmFyZ3MpPT57IGNsZWFyVGltZW91dCh0KTsgdD1zZXRUaW1lb3V0KCgpPT5mbiguLi5hcmdzKSxtcyk7IH19CgovKiA9PT09PT0gU3RvcmFnZSAmIE1pZ3JhdGlvbiA9PT09PT0gKi8KZnVuY3Rpb24gc2F2ZVRvTFMoKXsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oTFNfS0VZLCBKU09OLnN0cmluZ2lmeShpdGVtcykpOyB9CmZ1bmN0aW9uIGxvYWRGcm9tTFMoKXsgdHJ5eyBjb25zdCByYXc9bG9jYWxTdG9yYWdlLmdldEl0ZW0oTFNfS0VZKTsgaWYoIXJhdykgcmV0dXJuIFtdOyBjb25zdCBhcnI9SlNPTi5wYXJzZShyYXcpOyByZXR1cm4gQXJyYXkuaXNBcnJheShhcnIpP2FycjpbXTsgfWNhdGNoeyByZXR1cm4gW107IH0gfQpmdW5jdGlvbiBzYW5pdGl6ZU5vdGUobil7CiAgY29uc3QgdHMgPSBOdW1iZXIuaXNGaW5pdGUobi5jcmVhdGVkQXQpP051bWJlcihuLmNyZWF0ZWRBdCk6bm93KCk7CiAgY29uc3QgaWQgPSBuLmlkICYmIC9cXGR7OH0tXFxkezR9LVthLXowLTktXSsvLnRlc3Qobi5pZCkgPyBTdHJpbmcobi5pZCkgOiAoeXl5eW1tZGRfaGhtbSh0cykrIi0iKyhzbHVnKG4udGl0bGV8fCJub3RlIil8fCJub3RlIikpOwogIHJldHVybiB7CiAgICBpZCwKICAgIHN0YXR1czogbi5zdGF0dXM9PT0iaW5ib3giPyJpbmJveCI6ImFjdGl2ZSIsCiAgICB0eXBlOiBbIm5vdGUiLCJwcm9qZWN0IiwibWVldGluZyIsImRlY2lzaW9uIiwicmVhZGluZyJdLmluY2x1ZGVzKG4udHlwZSk/bi50eXBlOiJub3RlIiwKICAgIHRpdGxlOiBTdHJpbmcobi50aXRsZSA/PyAiKGtow7RuZyB0acOqdSDEkeG7gSkiKSwKICAgIGNvbnRlbnRfY29yZTogU3RyaW5nKG4uY29udGVudF9jb3JlID8/IChuLmNvbnRlbnQ/IFN0cmluZyhuLmNvbnRlbnQpLnNwbGl0KC9cXG4vKVswXToiIikpLAogICAgY29udGVudDogU3RyaW5nKG4uY29udGVudCA/PyAiIiksCiAgICBhY3Rpb25zOiBBcnJheS5pc0FycmF5KG4uYWN0aW9ucyk/IG4uYWN0aW9ucy5tYXAoYT0+KHt0ZXh0OlN0cmluZyhhLnRleHR8fCIiKSwgZHVlOiBOdW1iZXIuaXNGaW5pdGUoYS5kdWUpP051bWJlcihhLmR1ZSk6dW5kZWZpbmVkLCBkb25lOiEhYS5kb25lfSkpIDogW10sCiAgICB0YWdzOiBBcnJheS5pc0FycmF5KG4udGFncyk/IG4udGFncy5zbGljZSgwLDIpLm1hcCh0PT5TdHJpbmcodCkucmVwbGFjZSgvXiMvLCIiKSkgOiBbXSwKICAgIGNvbnRleHQ6IHsKICAgICAgcHJvamVjdDogbi5jb250ZXh0ICYmIG4uY29udGV4dC5wcm9qZWN0ID8gU3RyaW5nKG4uY29udGV4dC5wcm9qZWN0KSA6IChuLmNhdGVnb3J5PyBTdHJpbmcobi5jYXRlZ29yeSk6IHVuZGVmaW5lZCksCiAgICAgIHBlb3BsZTogbi5jb250ZXh0ICYmIEFycmF5LmlzQXJyYXkobi5jb250ZXh0LnBlb3BsZSkgPyBuLmNvbnRleHQucGVvcGxlLm1hcChwPT5TdHJpbmcocCkpIDogW10sCiAgICAgIHNvdXJjZTogbi5jb250ZXh0ICYmIG4uY29udGV4dC5zb3VyY2UgPyBTdHJpbmcobi5jb250ZXh0LnNvdXJjZSkgOiAobi5zb3VyY2U/IFN0cmluZyhuLnNvdXJjZSk6IHVuZGVmaW5lZCksCiAgICB9LAogICAgcmV2aWV3X29uOiBOdW1iZXIuaXNGaW5pdGUobi5yZXZpZXdfb24pP051bWJlcihuLnJldmlld19vbik6dW5kZWZpbmVkLAogICAgYmxvY2tlcnM6ICEhbi5ibG9ja2VycywKICAgIGNyZWF0ZWRBdDogdHMsCiAgICB1cGRhdGVkQXQ6IE51bWJlci5pc0Zpbml0ZShuLnVwZGF0ZWRBdCk/TnVtYmVyKG4udXBkYXRlZEF0KTp0cywKICB9Owp9CmZ1bmN0aW9uIG1pZ3JhdGVJZk5lZWRlZCgpewogIHRyeXsKICAgIGNvbnN0IG9sZGVyID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oImt2LmZ1bGwuNmEuY2NsZGEudjEiKSB8fCBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgia3YuZnVsbC52Ni42YS5jY2xkYSIpIHx8IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJrdi42YS5jY2xkYS52MSIpOwogICAgaWYob2xkZXIpewogICAgICBjb25zdCBhcnIgPSBKU09OLnBhcnNlKG9sZGVyKTsKICAgICAgaWYoQXJyYXkuaXNBcnJheShhcnIpICYmIGFyci5sZW5ndGgpewogICAgICAgIGNvbnN0IG1lcmdlZCA9IHt9OwogICAgICAgIFsuLi5pdGVtcywgLi4uYXJyXS5mb3JFYWNoKG8gPT4geyBjb25zdCBpdCA9IHNhbml0aXplTm90ZShvKTsgbWVyZ2VkW2l0LmlkXSA9IGl0OyB9KTsKICAgICAgICBpdGVtcyA9IE9iamVjdC52YWx1ZXMobWVyZ2VkKS5zb3J0KChhLGIpPT4gYi51cGRhdGVkQXQgLSBhLnVwZGF0ZWRBdCk7CiAgICAgICAgc2F2ZVRvTFMoKTsKICAgICAgfQogICAgfQogIH1jYXRjaHt9Cn0KCi8qID09PT09PSBUYWJzID09PT09PSAqLwplbC50YWJzLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwoZSk9PnsKICBjb25zdCB0ID0gZS50YXJnZXQuY2xvc2VzdCgiLnRhYiIpOyBpZighdCkgcmV0dXJuOwogICQkKCIudGFiIikuZm9yRWFjaCh4PT54LmNsYXNzTGlzdC5yZW1vdmUoIm9uIikpOyB0LmNsYXNzTGlzdC5hZGQoIm9uIik7CiAgY29uc3QgdGFiID0gdC5nZXRBdHRyaWJ1dGUoImRhdGEtdGFiIik7CiAgT2JqZWN0LmVudHJpZXMoZWwudmlld3MpLmZvckVhY2goKFtrLHZdKT0+IHYuY2xhc3NMaXN0LnRvZ2dsZSgiaGlkZSIsIGshPT10YWIpKTsKICBpZih0YWI9PT0iYWN0aW9ucyIpIHJlbmRlckFjdGlvbnMoKTsKICBpZih0YWI9PT0icHJvamVjdHMiKSByZW5kZXJQcm9qZWN0cygpOwogIGlmKHRhYj09PSJpbmJveCIpIHJlbmRlckluYm94KCk7CiAgaWYodGFiPT09InRyYWluaW5nIil7IHJlbmRlckxpbnQoKTsgcmVuZGVyVHJhaW5pbmcoKTsgfQogIGlmKHRhYj09PSJub3RlcyIpeyByZW5kZXJMaXN0KCk7IH0KICBpZih0YWI9PT0idHJhbnNjcmliZSIpeyAvKiBuby1vcCAqLyB9CiAgaWYodGFiPT09Imd1aWRlIil7IC8qIHJlYWRtZSBzdGF0aWMgKi8gfQp9KTsKCi8qID09PT09PSBJbmJveDogQ2FwdHVyZSArIFByb2Nlc3MgPT09PT09ICovCmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLChlKT0+eyBpZihlLmN0cmxLZXkgJiYgZS5rZXkudG9Mb3dlckNhc2UoKT09PSJuIil7IGUucHJldmVudERlZmF1bHQoKTsgZWwuY2FwVGl0bGUuZm9jdXMoKTsgfSB9KTsKZWwuY2FwU2F2ZS5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpPT57CiAgY29uc3QgbGluZSA9IGVsLmNhcFRpdGxlLnZhbHVlLnRyaW0oKTsgaWYoIWxpbmUpIHJldHVybjsKICBjb25zdCB0cyA9IG5vdygpOyBjb25zdCBpZCA9IHl5eXltbWRkX2hobW0odHMpKyItIisoc2x1ZyhsaW5lLnNsaWNlKDAsNDApKXx8ImluYm94Iik7CiAgY29uc3QgcGFyc2VkID0gcGFyc2VTeW1ib2xzKGxpbmUpOwogIGNvbnN0IG4gPSB7CiAgICBpZCwgc3RhdHVzOiJpbmJveCIsIHR5cGU6Im5vdGUiLCB0aXRsZTogbGluZS5zbGljZSgwLDgwKSwKICAgIGNvbnRlbnRfY29yZTogcGFyc2VkLmNvcmUgfHwgbGluZSwgY29udGVudDogbGluZSwKICAgIGFjdGlvbnM6IHBhcnNlZC5hY3Rpb25zLCB0YWdzOiBwYXJzZWQudGFncy5zbGljZSgwLDIpLAogICAgY29udGV4dDogeyBwcm9qZWN0OiBwYXJzZWQucHJvamVjdHx8dW5kZWZpbmVkLCBwZW9wbGU6IHBhcnNlZC5wZW9wbGUsIHNvdXJjZTogcGFyc2VkLnNvdXJjZXx8dW5kZWZpbmVkIH0sCiAgICByZXZpZXdfb246IHBhcnNlZC5yZXZpZXc/IHBhcnNlZC5yZXZpZXc6IHVuZGVmaW5lZCwKICAgIGJsb2NrZXJzOiBwYXJzZWQuYmxvY2tlciwKICAgIGNyZWF0ZWRBdDogdHMsIHVwZGF0ZWRBdDogdHMsCiAgfTsKICBpdGVtcy51bnNoaWZ0KG4pOyBzYXZlVG9MUygpOyByZW5kZXJTdGF0cygpOyBlbC5jYXBUaXRsZS52YWx1ZT0iIjsgcmVuZGVySW5ib3goKTsKfSk7CmZ1bmN0aW9uIHJlbmRlckluYm94KCl7CiAgZWwuaW5ib3hMaXN0LmlubmVySFRNTCA9ICIiOwogIGNvbnN0IGluYm94ID0gaXRlbXMuZmlsdGVyKGl0PT4gaXQuc3RhdHVzPT09ImluYm94Iikuc29ydCgoYSxiKT0+IGIudXBkYXRlZEF0IC0gYS51cGRhdGVkQXQpOwogIGlmKGluYm94Lmxlbmd0aD09PTApeyBlbC5pbmJveExpc3QuaW5uZXJIVE1MID0gJzxkaXYgY2xhc3M9Im11dGVkIj5JbmJveCB0cuG7kW5nLiBC4bqvdCDEkeG6p3UgYuG6sW5nIMO0IG5o4bqtcCAxIGTDsm5nIHBow61hIHRyw6puLjwvZGl2Pic7IHJldHVybjsgfQogIGluYm94LmZvckVhY2goaXQgPT4gZWwuaW5ib3hMaXN0LmFwcGVuZENoaWxkKGluYm94Q2FyZChpdCkpKTsKfQpmdW5jdGlvbiBpbmJveENhcmQoaXQpewogIGNvbnN0IHdyYXAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsgd3JhcC5jbGFzc05hbWU9Im5vdGUiOyB3cmFwLnN0eWxlLm1hcmdpbkJvdHRvbT0iOHB4IjsKICB3cmFwLmlubmVySFRNTCA9IGAKICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6ZmxleDtqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjtnYXA6OHB4O2FsaWduLWl0ZW1zOmZsZXgtc3RhcnQiPgogICAgICA8aDM+JHtlc2NhcGVIdG1sKGl0LnRpdGxlKX08L2gzPgogICAgICA8ZGl2IGNsYXNzPSJtdXRlZCB0cnVuY2F0ZSIgc3R5bGU9Im1heC13aWR0aDoyNjBweCI+JHtuZXcgRGF0ZShpdC5jcmVhdGVkQXQpLnRvTG9jYWxlU3RyaW5nKCl9PC9kaXY+CiAgICA8L2Rpdj4KICAgIDxkaXYgY2xhc3M9InByb3NlIj4ke2VzY2FwZUh0bWwoaXQuY29udGVudCl9PC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJociI+PC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJyb3ciPgogICAgICA8ZGl2PjxsYWJlbD5I4bqhdCBuaMOibjwvbGFiZWw+PHRleHRhcmVhIGNsYXNzPSJlLWNvcmUiPiR7ZXNjYXBlSHRtbChpdC5jb250ZW50X2NvcmV8fCIiKX08L3RleHRhcmVhPjwvZGl2PgogICAgICA8ZGl2PgogICAgICAgIDxsYWJlbD5Qcm9qZWN0PC9sYWJlbD48aW5wdXQgY2xhc3M9ImUtcHJqIiB0eXBlPSJ0ZXh0IiB2YWx1ZT0iJHtlc2NhcGVIdG1sKGl0LmNvbnRleHQ/LnByb2plY3R8fCIiKX0iPgogICAgICAgIDxsYWJlbCBzdHlsZT0ibWFyZ2luLXRvcDo4cHgiPlRhZ3MgKCMg4omkMik8L2xhYmVsPjxpbnB1dCBjbGFzcz0iZS10YWdzIiB0eXBlPSJ0ZXh0IiBwbGFjZWhvbGRlcj0idmQuIHdlYiwgdWkiIHZhbHVlPSIke2VzY2FwZUh0bWwoKGl0LnRhZ3N8fFtdKS5qb2luKCIsICIpKX0iPgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgogICAgPGxhYmVsPlNvdXJjZTwvbGFiZWw+PGlucHV0IGNsYXNzPSJlLXNyYyIgdHlwZT0idGV4dCIgdmFsdWU9IiR7ZXNjYXBlSHRtbChpdC5jb250ZXh0Py5zb3VyY2V8fCIiKX0iPgogICAgPGRpdiBjbGFzcz0icm93Ij4KICAgICAgPGRpdj48bGFiZWw+UmV2aWV3IG9uPC9sYWJlbD48aW5wdXQgY2xhc3M9ImUtcmV2aWV3IiB0eXBlPSJkYXRlIiB2YWx1ZT0iJHtpdC5yZXZpZXdfb24/IG5ldyBEYXRlKGl0LnJldmlld19vbikudG9JU09TdHJpbmcoKS5zbGljZSgwLDEwKTogIiJ9Ij48L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0iZmxleCIgc3R5bGU9Im1hcmdpbi10b3A6MjhweCI+PGxhYmVsIGNsYXNzPSJzd2l0Y2giPjxpbnB1dCBjbGFzcz0iZS1ibG9jayIgdHlwZT0iY2hlY2tib3giICR7aXQuYmxvY2tlcnM/ImNoZWNrZWQiOiIifT48L2xhYmVsPjxzcGFuIGNsYXNzPSJtdXRlZCI+QmxvY2tlcjwvc3Bhbj48L2Rpdj4KICAgIDwvZGl2PgogICAgPGxhYmVsPkjDoG5oIMSR4buZbmcgKCEpPC9sYWJlbD4KICAgIDxkaXYgY2xhc3M9InJvdyI+PGlucHV0IGNsYXNzPSJlLWFjdC10ZXh0IiB0eXBlPSJ0ZXh0IiBwbGFjZWhvbGRlcj0iaMOgbmggxJHhu5luZyBt4bubaSAoRW50ZXIgxJHhu4MgdGjDqm0pIj48aW5wdXQgY2xhc3M9ImUtYWN0LWR1ZSIgdHlwZT0iZGF0ZSI+PC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJ0YWdzIGUtYWN0LWxpc3QiPjwvZGl2PgogICAgPGRpdiBjbGFzcz0iZmxleCIgc3R5bGU9Im1hcmdpbi10b3A6OHB4Ij4KICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zbSIgZGF0YS1vcD0iZXh0cmFjdCI+VHLDrWNoIGvDvSBoaeG7h3U8L2J1dHRvbj4KICAgICAgPHNwYW4gY2xhc3M9InJpZ2h0Ij48L3NwYW4+CiAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBhY2MgYnRuLXNtIiBkYXRhLW9wPSJhcHBseSI+xJDhuql5IHJhIE5vdGVzPC9idXR0b24+CiAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBkZXMgYnRuLXNtIiBkYXRhLW9wPSJkZWxldGUiPljDs2E8L2J1dHRvbj4KICAgIDwvZGl2PgogIGA7CiAgY29uc3QgYWN0TGlzdCA9ICQoIi5lLWFjdC1saXN0Iiwgd3JhcCk7CiAgY29uc3QgYWN0cyA9IChpdC5hY3Rpb25zfHxbXSkubWFwKGE9Pih7dGV4dDphLnRleHQsIGR1ZTphLmR1ZSwgZG9uZTohIWEuZG9uZX0pKTsKICBmdW5jdGlvbiByZW5kZXJBY3RzKCl7CiAgICBhY3RMaXN0LmlubmVySFRNTD0iIjsKICAgIGlmKGFjdHMubGVuZ3RoPT09MCl7IGNvbnN0IG09ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOyBtLmNsYXNzTmFtZT0ibXV0ZWQiOyBtLnRleHRDb250ZW50PSJDaMawYSBjw7MgaMOgbmggxJHhu5luZyI7IGFjdExpc3QuYXBwZW5kQ2hpbGQobSk7IHJldHVybjsgfQogICAgYWN0cy5mb3JFYWNoKChhLGlkeCk9PnsKICAgICAgY29uc3QgY2hpcCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsgY2hpcC5jbGFzc05hbWU9ImJhZGdlIjsKICAgICAgY29uc3QgZHVlVHh0ID0gYS5kdWUgPyBuZXcgRGF0ZShhLmR1ZSkudG9Mb2NhbGVEYXRlU3RyaW5nKCkgOiAiIjsKICAgICAgY2hpcC5pbm5lckhUTUwgPSBgPHNwYW4gY2xhc3M9ImFjdGlvbi1kb3QgJHthLmRvbmU/J2RvbmUnOicnfSI+PC9zcGFuPiAke2VzY2FwZUh0bWwoYS50ZXh0KX0gJHtkdWVUeHQ/KCLigKIgIitlc2NhcGVIdG1sKGR1ZVR4dCkpOiIifSA8c3BhbiBjbGFzcz0neCc+JnRpbWVzOzwvc3Bhbj5gOwogICAgICBjaGlwLm9uY2xpY2sgPSAoZSk9PnsgaWYoZS50YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKCJ4IikpIHJldHVybjsgYS5kb25lPSFhLmRvbmU7IHJlbmRlckFjdHMoKTsgfTsKICAgICAgY2hpcC5xdWVyeVNlbGVjdG9yKCIueCIpLm9uY2xpY2sgPSAoZSk9PnsgZS5zdG9wUHJvcGFnYXRpb24oKTsgYWN0cy5zcGxpY2UoaWR4LDEpOyByZW5kZXJBY3RzKCk7IH07CiAgICAgIGFjdExpc3QuYXBwZW5kQ2hpbGQoY2hpcCk7CiAgICB9KTsKICB9CiAgcmVuZGVyQWN0cygpOwogICQoIi5lLWFjdC10ZXh0Iiwgd3JhcCkuYWRkRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsKGUpPT57CiAgICBpZihlLmtleT09PSJFbnRlciIpeyBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgIGNvbnN0IHQgPSAkKCIuZS1hY3QtdGV4dCIsIHdyYXApLnZhbHVlLnRyaW0oKTsgaWYoIXQpIHJldHVybjsKICAgICAgY29uc3QgZCA9ICQoIi5lLWFjdC1kdWUiLCB3cmFwKS52YWx1ZTsgY29uc3QgZHVlID0gZD8gbmV3IERhdGUoZCsiVDAwOjAwOjAwIikuZ2V0VGltZSgpOnVuZGVmaW5lZDsKICAgICAgYWN0cy5wdXNoKHt0ZXh0OnQsZHVlLGRvbmU6ZmFsc2V9KTsgJCgiLmUtYWN0LXRleHQiLCB3cmFwKS52YWx1ZT0iIjsgJCgiLmUtYWN0LWR1ZSIsIHdyYXApLnZhbHVlPSIiOyByZW5kZXJBY3RzKCk7CiAgICB9CiAgfSk7CiAgd3JhcC5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsKGUpPT57CiAgICBjb25zdCBiID0gZS50YXJnZXQuY2xvc2VzdCgiYnV0dG9uIik7IGlmKCFiKSByZXR1cm47CiAgICBjb25zdCBvcCA9IGIuZ2V0QXR0cmlidXRlKCJkYXRhLW9wIik7CiAgICBpZihvcD09PSJleHRyYWN0Iil7CiAgICAgIGNvbnN0IHBhcnNlZCA9IHBhcnNlU3ltYm9scyhpdC5jb250ZW50KTsKICAgICAgJCgiLmUtY29yZSIsIHdyYXApLnZhbHVlID0gJCgiLmUtY29yZSIsIHdyYXApLnZhbHVlIHx8IHBhcnNlZC5jb3JlIHx8ICIiOwogICAgICBjb25zdCB0YWdzID0gJCgiLmUtdGFncyIsIHdyYXApLnZhbHVlLnRyaW0oKTsKICAgICAgY29uc3QgdGFnU2V0ID0gbmV3IFNldCh0YWdzPyB0YWdzLnNwbGl0KCIsIikubWFwKHM9PnMudHJpbSgpLnJlcGxhY2UoL14jLywiIikpLmZpbHRlcihCb29sZWFuKTpbXSk7CiAgICAgIHBhcnNlZC50YWdzLmZvckVhY2godD0+IHRhZ1NldC5hZGQodCkpOwogICAgICAkKCIuZS10YWdzIiwgd3JhcCkudmFsdWUgPSBBcnJheS5mcm9tKHRhZ1NldCkuc2xpY2UoMCwyKS5qb2luKCIsICIpOwogICAgICAkKCIuZS1wcmoiLCB3cmFwKS52YWx1ZSA9ICQoIi5lLXByaiIsIHdyYXApLnZhbHVlIHx8IChwYXJzZWQucHJvamVjdHx8IiIpOwogICAgICAkKCIuZS1zcmMiLCB3cmFwKS52YWx1ZSA9ICQoIi5lLXNyYyIsIHdyYXApLnZhbHVlIHx8IChwYXJzZWQuc291cmNlfHwiIik7CiAgICAgIGlmKHBhcnNlZC5yZXZpZXcgJiYgISQoIi5lLXJldmlldyIsIHdyYXApLnZhbHVlKXsgJCgiLmUtcmV2aWV3Iiwgd3JhcCkudmFsdWUgPSBuZXcgRGF0ZShwYXJzZWQucmV2aWV3KS50b0lTT1N0cmluZygpLnNsaWNlKDAsMTApOyB9CiAgICAgIHBhcnNlZC5hY3Rpb25zLmZvckVhY2goYSA9PiBhY3RzLnB1c2goYSkpOwogICAgICByZW5kZXJBY3RzKCk7CiAgICB9ZWxzZSBpZihvcD09PSJhcHBseSIpewogICAgICBpdC5zdGF0dXM9ImFjdGl2ZSI7CiAgICAgIGl0LmNvbnRlbnRfY29yZSA9ICQoIi5lLWNvcmUiLCB3cmFwKS52YWx1ZS50cmltKCkgfHwgaXQuY29udGVudF9jb3JlOwogICAgICBpdC5jb250ZXh0ID0gaXQuY29udGV4dCB8fCB7fTsKICAgICAgaXQuY29udGV4dC5wcm9qZWN0ID0gJCgiLmUtcHJqIiwgd3JhcCkudmFsdWUudHJpbSgpIHx8IHVuZGVmaW5lZDsKICAgICAgaXQudGFncyA9ICggJCgiLmUtdGFncyIsIHdyYXApLnZhbHVlLnNwbGl0KCIsIikubWFwKHM9PnMudHJpbSgpLnJlcGxhY2UoL14jLywiIikpLmZpbHRlcihCb29sZWFuKS5zbGljZSgwLDIpICk7CiAgICAgIGl0LmNvbnRleHQuc291cmNlID0gJCgiLmUtc3JjIiwgd3JhcCkudmFsdWUudHJpbSgpIHx8IGl0LmNvbnRleHQuc291cmNlOwogICAgICBjb25zdCBydiA9ICQoIi5lLXJldmlldyIsIHdyYXApLnZhbHVlOyBpdC5yZXZpZXdfb24gPSBydj8gbmV3IERhdGUocnYrIlQwMDowMDowMCIpLmdldFRpbWUoKTogdW5kZWZpbmVkOwogICAgICBpdC5ibG9ja2VycyA9ICQoIi5lLWJsb2NrIiwgd3JhcCkuY2hlY2tlZDsKICAgICAgaXQuYWN0aW9ucyA9IGFjdHM7CiAgICAgIGl0LnVwZGF0ZWRBdCA9IG5vdygpOwogICAgICBzYXZlVG9MUygpOyByZW5kZXJJbmJveCgpOyByZW5kZXJTdGF0cygpOwogICAgfWVsc2UgaWYob3A9PT0iZGVsZXRlIil7CiAgICAgIGlmKGNvbmZpcm0oIljDs2EgbeG7pWMgbsOgeT8iKSl7IGl0ZW1zID0gaXRlbXMuZmlsdGVyKHg9PnguaWQhPT1pdC5pZCk7IHNhdmVUb0xTKCk7IHJlbmRlckluYm94KCk7IHJlbmRlclN0YXRzKCk7IH0KICAgIH0KICB9KTsKICByZXR1cm4gd3JhcDsKfQoKLyogPT09PT09IE5vdGVzOiBmb3JtID09PT09PSAqLwpsZXQgZm9ybSA9IHsgdGFnczpbXSwgcGVvcGxlOltdLCBhY3Rpb25zOltdIH07CmZ1bmN0aW9uIHJlc2V0Rm9ybSgpewogIGVsLnRpdGxlLnZhbHVlPSIiOyBlbC50eXBlLnZhbHVlPSJub3RlIjsgZWwuY29yZS52YWx1ZT0iIjsgZWwuY29udGVudC52YWx1ZT0iIjsKICBlbC5wcm9qZWN0LnZhbHVlPSIiOyBlbC5wZW9wbGVJbnB1dC52YWx1ZT0iIjsgZm9ybS5wZW9wbGU9W107IHJlbmRlclBlb3BsZVRhZ3MoKTsKICBlbC5zb3VyY2UudmFsdWU9IiI7IGVsLnJldmlldy52YWx1ZT0iIjsgZWwudGFnSW5wdXQudmFsdWU9IiI7IGZvcm0udGFncz1bXTsgcmVuZGVyRm9ybVRhZ3MoKTsKICBlbC5hY3RUZXh0LnZhbHVlPSIiOyBlbC5hY3REdWUudmFsdWU9IiI7IGZvcm0uYWN0aW9ucz1bXTsgcmVuZGVyQWN0aW9ucygpOyBlbC5ibG9ja2VyLmNoZWNrZWQ9ZmFsc2U7CiAgZWwuYXV0b0lkLnRleHRDb250ZW50ID0gImlkIChhdXRvKTogc+G6vSB04bqhbyBraGkgbMawdSI7Cn0KZnVuY3Rpb24gcmVuZGVyRm9ybVRhZ3MoKXsgZWwudGFnQ2hpcHMuaW5uZXJIVE1MPSIiOyBmb3JtLnRhZ3MuZm9yRWFjaCh0PT57IGNvbnN0IHNwYW49ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOyBzcGFuLmNsYXNzTmFtZT0iYmFkZ2UiOyBzcGFuLmlubmVySFRNTD1lc2NhcGVIdG1sKCIjIit0KSsiIDxzcGFuIGNsYXNzPSd4Jz4mdGltZXM7PC9zcGFuPiI7IHNwYW4ucXVlcnlTZWxlY3RvcigiLngiKS5vbmNsaWNrPSgpPT57IGZvcm0udGFncz1mb3JtLnRhZ3MuZmlsdGVyKHg9PnghPT10KTsgcmVuZGVyRm9ybVRhZ3MoKTsgfTsgZWwudGFnQ2hpcHMuYXBwZW5kQ2hpbGQoc3Bhbik7IH0pOyB9CmVsLnRhZ0lucHV0LmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLChlKT0+ewogIGlmKGUua2V5PT09IkVudGVyInx8ZS5rZXk9PT0iLCIpeyBlLnByZXZlbnREZWZhdWx0KCk7IGNvbnN0IHJhdz1lbC50YWdJbnB1dC52YWx1ZS50cmltKCkucmVwbGFjZSgvXiMvLCIiKS5yZXBsYWNlKC9cXHMrL2csIi0iKTsgaWYocmF3ICYmICFmb3JtLnRhZ3MuaW5jbHVkZXMocmF3KSl7IGlmKGZvcm0udGFncy5sZW5ndGg+PTIpIGFsZXJ0KCJU4buRaSDEkWEgMiB0aOG6uy4iKTsgZWxzZXsgZm9ybS50YWdzLnB1c2gocmF3KTsgcmVuZGVyRm9ybVRhZ3MoKTsgfSB9IGVsLnRhZ0lucHV0LnZhbHVlPSIiOyB9CiAgZWxzZSBpZihlLmtleT09PSJCYWNrc3BhY2UiICYmICFlbC50YWdJbnB1dC52YWx1ZSAmJiBmb3JtLnRhZ3MubGVuZ3RoKXsgZm9ybS50YWdzLnBvcCgpOyByZW5kZXJGb3JtVGFncygpOyB9Cn0pOwpmdW5jdGlvbiByZW5kZXJQZW9wbGVUYWdzKCl7IGVsLnBlb3BsZVRhZ3MuaW5uZXJIVE1MPSIiOyBmb3JtLnBlb3BsZS5mb3JFYWNoKHA9PnsgY29uc3Qgc3Bhbj1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7IHNwYW4uY2xhc3NOYW1lPSJiYWRnZSI7IHNwYW4uaW5uZXJIVE1MPSJAIitlc2NhcGVIdG1sKHApKyIgPHNwYW4gY2xhc3M9J3gnPiZ0aW1lczs8L3NwYW4+Ijsgc3Bhbi5xdWVyeVNlbGVjdG9yKCIueCIpLm9uY2xpY2s9KCk9PnsgZm9ybS5wZW9wbGU9Zm9ybS5wZW9wbGUuZmlsdGVyKHg9PnghPT1wKTsgcmVuZGVyUGVvcGxlVGFncygpOyB9OyBlbC5wZW9wbGVUYWdzLmFwcGVuZENoaWxkKHNwYW4pOyB9KTsgfQplbC5wZW9wbGVJbnB1dC5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwoZSk9PnsgaWYoZS5rZXk9PT0iRW50ZXIifHxlLmtleT09PSIsIil7IGUucHJldmVudERlZmF1bHQoKTsgY29uc3Qgdj1lbC5wZW9wbGVJbnB1dC52YWx1ZS50cmltKCkucmVwbGFjZSgvXkAvLCIiKTsgaWYodiAmJiAhZm9ybS5wZW9wbGUuaW5jbHVkZXModikpIGZvcm0ucGVvcGxlLnB1c2godik7IGVsLnBlb3BsZUlucHV0LnZhbHVlPSIiOyByZW5kZXJQZW9wbGVUYWdzKCk7IH0gZWxzZSBpZihlLmtleT09PSJCYWNrc3BhY2UiICYmICFlbC5wZW9wbGVJbnB1dC52YWx1ZSAmJiBmb3JtLnBlb3BsZS5sZW5ndGgpeyBmb3JtLnBlb3BsZS5wb3AoKTsgcmVuZGVyUGVvcGxlVGFncygpOyB9IH0pOwpmdW5jdGlvbiByZW5kZXJBY3Rpb25zKCl7IGVsLmFjdExpc3QuaW5uZXJIVE1MPSIiOyBpZihmb3JtLmFjdGlvbnMubGVuZ3RoPT09MCl7IGNvbnN0IG09ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOyBtLmNsYXNzTmFtZT0ibXV0ZWQiOyBtLnRleHRDb250ZW50PSJDaMawYSBjw7MgaMOgbmggxJHhu5luZyI7IGVsLmFjdExpc3QuYXBwZW5kQ2hpbGQobSk7IHJldHVybjsgfSBmb3JtLmFjdGlvbnMuZm9yRWFjaCgoYSxpZHgpPT57IGNvbnN0IGNoaXA9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOyBjaGlwLmNsYXNzTmFtZT0iYmFkZ2UiOyBjb25zdCBkdWVUeHQ9YS5kdWU/IG5ldyBEYXRlKGEuZHVlKS50b0xvY2FsZURhdGVTdHJpbmcoKToiIjsgY2hpcC5pbm5lckhUTUw9YDxzcGFuIGNsYXNzPSJhY3Rpb24tZG90ICR7YS5kb25lPydkb25lJzonJ30iPjwvc3Bhbj4gJHtlc2NhcGVIdG1sKGEudGV4dCl9ICR7ZHVlVHh0Pygi4oCiICIrZXNjYXBlSHRtbChkdWVUeHQpKToiIn0gPHNwYW4gY2xhc3M9J3gnPiZ0aW1lczs8L3NwYW4+YDsgY2hpcC5vbmNsaWNrPShlKT0+eyBpZihlLnRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoIngiKSkgcmV0dXJuOyBhLmRvbmU9IWEuZG9uZTsgcmVuZGVyQWN0aW9ucygpOyB9OyBjaGlwLnF1ZXJ5U2VsZWN0b3IoIi54Iikub25jbGljaz0oZSk9PnsgZS5zdG9wUHJvcGFnYXRpb24oKTsgZm9ybS5hY3Rpb25zLnNwbGljZShpZHgsMSk7IHJlbmRlckFjdGlvbnMoKTsgfTsgZWwuYWN0TGlzdC5hcHBlbmRDaGlsZChjaGlwKTsgfSk7IH0KZWwuYWN0VGV4dC5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwoZSk9PnsgaWYoZS5rZXk9PT0iRW50ZXIiKXsgZS5wcmV2ZW50RGVmYXVsdCgpOyBhZGRBY3Rpb24oKTsgfX0pOwplbC5hY3REdWUuYWRkRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsKGUpPT57IGlmKGUua2V5PT09IkVudGVyIil7IGUucHJldmVudERlZmF1bHQoKTsgYWRkQWN0aW9uKCk7IH19KTsKZnVuY3Rpb24gYWRkQWN0aW9uKCl7IGNvbnN0IHQ9ZWwuYWN0VGV4dC52YWx1ZS50cmltKCk7IGlmKCF0KSByZXR1cm47IGNvbnN0IGQ9ZWwuYWN0RHVlLnZhbHVlOyBjb25zdCBkdWUgPSBkPyBuZXcgRGF0ZShkKyJUMDA6MDA6MDAiKS5nZXRUaW1lKCk6dW5kZWZpbmVkOyBmb3JtLmFjdGlvbnMucHVzaCh7dGV4dDp0LGR1ZSxkb25lOmZhbHNlfSk7IGVsLmFjdFRleHQudmFsdWU9IiI7IGVsLmFjdER1ZS52YWx1ZT0iIjsgcmVuZGVyQWN0aW9ucygpOyB9CmVsLmJ0bkV4dHJhY3QuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKT0+eyBjb25zdCBwYXJzZWQgPSBwYXJzZVN5bWJvbHMoZWwuY29udGVudC52YWx1ZSk7IGlmKCFlbC5jb3JlLnZhbHVlKSBlbC5jb3JlLnZhbHVlID0gcGFyc2VkLmNvcmUgfHwgIiI7IGlmKHBhcnNlZC5wcm9qZWN0ICYmICFlbC5wcm9qZWN0LnZhbHVlKSBlbC5wcm9qZWN0LnZhbHVlID0gcGFyc2VkLnByb2plY3Q7IHBhcnNlZC50YWdzLmZvckVhY2godD0+eyBpZihmb3JtLnRhZ3MubGVuZ3RoPDIgJiYgIWZvcm0udGFncy5pbmNsdWRlcyh0KSkgZm9ybS50YWdzLnB1c2godCk7IH0pOyByZW5kZXJGb3JtVGFncygpOyBpZihwYXJzZWQuc291cmNlICYmICFlbC5zb3VyY2UudmFsdWUpIGVsLnNvdXJjZS52YWx1ZSA9IHBhcnNlZC5zb3VyY2U7IGlmKHBhcnNlZC5yZXZpZXcpIGVsLnJldmlldy52YWx1ZSA9IG5ldyBEYXRlKHBhcnNlZC5yZXZpZXcpLnRvSVNPU3RyaW5nKCkuc2xpY2UoMCwxMCk7IHBhcnNlZC5wZW9wbGUuZm9yRWFjaChwPT57IGlmKCFmb3JtLnBlb3BsZS5pbmNsdWRlcyhwKSkgZm9ybS5wZW9wbGUucHVzaChwKTsgfSk7IHJlbmRlclBlb3BsZVRhZ3MoKTsgcGFyc2VkLmFjdGlvbnMuZm9yRWFjaChhPT4gZm9ybS5hY3Rpb25zLnB1c2goYSkpOyByZW5kZXJBY3Rpb25zKCk7IH0pOwplbC5idG5SZXNldC5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIHJlc2V0Rm9ybSk7CmVsLmJ0blNhdmUuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKT0+ewogIGNvbnN0IHRpdGxlID0gZWwudGl0bGUudmFsdWUudHJpbSgpOyBjb25zdCBjb3JlPWVsLmNvcmUudmFsdWUudHJpbSgpOyBjb25zdCBjb250ZW50PWVsLmNvbnRlbnQudmFsdWUudHJpbSgpOwogIGlmKCF0aXRsZSAmJiAhY29yZSAmJiAhY29udGVudCkgcmV0dXJuOwogIGNvbnN0IHRzPW5vdygpOyBjb25zdCBpZCA9IHl5eXltbWRkX2hobW0odHMpKyItIisoc2x1Zyh0aXRsZSl8fCJub3RlIik7CiAgY29uc3QgbiA9IHsKICAgIGlkLCBzdGF0dXM6ImFjdGl2ZSIsIHR5cGU6IGVsLnR5cGUudmFsdWUsIHRpdGxlLAogICAgY29udGVudF9jb3JlOiBjb3JlIHx8IChjb250ZW50LnNwbGl0KC9cXG4vKVswXXx8IiIpLCBjb250ZW50LAogICAgYWN0aW9uczogZm9ybS5hY3Rpb25zLnNsaWNlKCksIHRhZ3M6IGZvcm0udGFncy5zbGljZSgpLAogICAgY29udGV4dDogeyBwcm9qZWN0OiBlbC5wcm9qZWN0LnZhbHVlLnRyaW0oKXx8dW5kZWZpbmVkLCBwZW9wbGU6IGZvcm0ucGVvcGxlLnNsaWNlKCksIHNvdXJjZTogZWwuc291cmNlLnZhbHVlLnRyaW0oKXx8dW5kZWZpbmVkIH0sCiAgICByZXZpZXdfb246IGVsLnJldmlldy52YWx1ZT8gbmV3IERhdGUoZWwucmV2aWV3LnZhbHVlKyJUMDA6MDA6MDAiKS5nZXRUaW1lKCk6dW5kZWZpbmVkLCBibG9ja2VyczogZWwuYmxvY2tlci5jaGVja2VkLAogICAgY3JlYXRlZEF0OiB0cywgdXBkYXRlZEF0OiB0cywKICB9OwogIGlmKG4udGFncy5sZW5ndGg+Mil7IGFsZXJ0KCI+MiB0YWcgPSBt4bqldCDEkeG7i25oIGjGsOG7m25nLiBD4bqvdCBjw7JuIOKJpDIuIik7IHJldHVybjsgfQogIGlmKG4udHlwZT09PSJtZWV0aW5nIiAmJiBuLmFjdGlvbnMubGVuZ3RoPT09MCl7IGFsZXJ0KCJNZWV0aW5nIHBo4bqjaSBzaW5oIMOtdCBuaOG6pXQgMSAhIGPDsyBkZWFkbGluZS4iKTsgfQogIGlmKG4udHlwZT09PSJyZWFkaW5nIiAmJiAhbi5jb250ZXh0LnNvdXJjZSl7IGFsZXJ0KCJSZWFkaW5nIE5vdGUgbsOqbiBjw7Mgbmd14buTbiAoQXR0YWNoZWQpLiIpOyB9CiAgaXRlbXMudW5zaGlmdChuKTsgc2F2ZVRvTFMoKTsgcmVuZGVyU3RhdHMoKTsgcmVidWlsZE1ldGEoKTsgcmVuZGVyQWxsKCk7IHJlc2V0Rm9ybSgpOyBlbC5hdXRvSWQudGV4dENvbnRlbnQgPSAiaWQgKGF1dG8pOiAiK2lkOwp9KTsKCi8qID09PT09PSBGaWx0ZXJzIGZvciBOb3RlcyA9PT09PT0gKi8KZWwuY2hpcHMuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLChlKT0+eyBjb25zdCBjPWUudGFyZ2V0LmNsb3Nlc3QoIi5jaGlwIik7IGlmKCFjKSByZXR1cm47IGNvbnN0IHRva2VuPWMuZ2V0QXR0cmlidXRlKCJkYXRhLWNoaXAiKTsgY29uc3QgcT1lbC5xLnZhbHVlLnRyaW0oKTsgaWYocS5pbmNsdWRlcyh0b2tlbikpIHJldHVybjsgZWwucS52YWx1ZSA9IChxPyBxKyIgIiA6ICIiKSArIHRva2VuOyByZW5kZXJMaXN0KCk7IH0pOwplbC50eXBlRmlsdGVyLmFkZEV2ZW50TGlzdGVuZXIoImNoYW5nZSIsIHJlbmRlckxpc3QpOwplbC5wcm9qZWN0RmlsdGVyLmFkZEV2ZW50TGlzdGVuZXIoImlucHV0IiwgZGVib3VuY2UocmVuZGVyTGlzdCwxNTApKTsKZWwudXBkYXRlZFJhbmdlLmFkZEV2ZW50TGlzdGVuZXIoImNoYW5nZSIsIHJlbmRlckxpc3QpOwplbC5xLmFkZEV2ZW50TGlzdGVuZXIoImlucHV0IiwgZGVib3VuY2UocmVuZGVyTGlzdCwxNTApKTsKZWwuYnRuQ2xlYXIuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKT0+eyBlbC5xLnZhbHVlPSIiOyBlbC50eXBlRmlsdGVyLnZhbHVlPSIiOyBlbC5wcm9qZWN0RmlsdGVyLnZhbHVlPSIiOyBlbC51cGRhdGVkUmFuZ2UudmFsdWU9ImFueSI7ICQkKCIjbWVudS10YWdzIGlucHV0IikuZm9yRWFjaChjYj0+Y2IuY2hlY2tlZD1mYWxzZSk7IHJlbmRlckxpc3QoKTsgfSk7CgpmdW5jdGlvbiByZWJ1aWxkTWV0YSgpewogIGNvbnN0IHNldCA9IG5ldyBTZXQoKTsgaXRlbXMuZm9yRWFjaChpdCA9PiAoaXQudGFnc3x8W10pLmZvckVhY2godD0+c2V0LmFkZCh0KSkpOyBhbGxUYWdzID0gQXJyYXkuZnJvbShzZXQpLnNvcnQoKTsgcmVuZGVyVGFnc01lbnUoKTsKfQpmdW5jdGlvbiByZW5kZXJUYWdzTWVudSgpeyBjb25zdCBtZW51PWVsLm1lbnVUYWdzOyBtZW51LmlubmVySFRNTD0iIjsgaWYoYWxsVGFncy5sZW5ndGg9PT0wKXsgbWVudS5pbm5lckhUTUw9JzxkaXYgY2xhc3M9Im11dGVkIiBzdHlsZT0icGFkZGluZzo4cHggMTBweCI+Q2jGsGEgY8OzIHRo4bq7PC9kaXY+JzsgcmV0dXJuOyB9IGFsbFRhZ3MuZm9yRWFjaCh0PT57IGNvbnN0IHJvdz1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsgcm93LmNsYXNzTmFtZT0iaXRlbSI7IHJvdy5pbm5lckhUTUw9JzxpbnB1dCB0eXBlPSJjaGVja2JveCIgdmFsdWU9IicrZXNjYXBlSHRtbCh0KSsnIj4gPHNwYW4+IycrZXNjYXBlSHRtbCh0KSsnPC9zcGFuPic7IHJvdy5vbmNsaWNrID0gKCk9PnsgY29uc3QgY2I9cm93LnF1ZXJ5U2VsZWN0b3IoImlucHV0Iik7IGNiLmNoZWNrZWQgPSAhY2IuY2hlY2tlZDsgcmVuZGVyTGlzdCgpOyB9OyBtZW51LmFwcGVuZENoaWxkKHJvdyk7IH0pOyBlbC5idG5UYWdzLnRleHRDb250ZW50PSJDaOG7jW4gdGjhursiOyB9CmVsLmJ0blRhZ3MuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKT0+IGVsLm1lbnVUYWdzLmNsYXNzTGlzdC50b2dnbGUoImhpZGUiKSk7CmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgKGUpPT57IGlmKCFlbC5tZW51VGFncy5jb250YWlucyhlLnRhcmdldCkgJiYgIWVsLmJ0blRhZ3MuY29udGFpbnMoZS50YXJnZXQpKSBlbC5tZW51VGFncy5jbGFzc0xpc3QuYWRkKCJoaWRlIik7IH0pOwoKZnVuY3Rpb24gcGFyc2VUb2tlbnMocSl7CiAgY29uc3QgdG9rZW5zID0geyBoYXNBY3Rpb246ZmFsc2UsIGhhc0Jsb2NrZXI6ZmFsc2UsIHR5cGVzOltdLCBwcm9qZWN0Om51bGwsIHRhZ3M6W10sIHVwZGF0ZWQ6bnVsbCwgcmV2aWV3Om51bGwsIHRlcm1zOltdLCBkdWU6bnVsbCB9OwogIGNvbnN0IHBhcnRzID0gcS5zcGxpdCgvXFxzKy8pLmZpbHRlcihCb29sZWFuKTsKICBmb3IoY29uc3QgcCBvZiBwYXJ0cyl7CiAgICAgICAgaWYoL15kdWU6Ly50ZXN0KHApKXsgY29uc3Qgdj1wLnNwbGl0KCI6IilbMV07IGlmKHYpeyB0b2tlbnMuZHVlPXY7IH0gY29udGludWU7IH0KaWYoL15oYXM6KGFjdGlvbnwhKS9pLnRlc3QocCkpeyB0b2tlbnMuaGFzQWN0aW9uPXRydWU7IGNvbnRpbnVlOyB9CiAgICBpZigvXmhhczpibG9ja2VyL2kudGVzdChwKSl7IHRva2Vucy5oYXNCbG9ja2VyPXRydWU7IGNvbnRpbnVlOyB9CiAgICBpZigvXnR5cGU6L2kudGVzdChwKSl7IGNvbnN0IHQ9cC5zcGxpdCgiOiIpWzFdOyBpZih0KSB0b2tlbnMudHlwZXMucHVzaCh0LnRvTG93ZXJDYXNlKCkpOyBjb250aW51ZTsgfQogICAgaWYoL15wcm9qZWN0Oi9pLnRlc3QocCkpeyB0b2tlbnMucHJvamVjdCA9IHAuc3BsaXQoIjoiKVsxXTsgY29udGludWU7IH0KICAgIGlmKC9edGFnOi9pLnRlc3QocCkpeyBsZXQgdj1wLnNwbGl0KCI6IilbMV18fCIiOyB2PXYucmVwbGFjZSgvXiMvLCIiKTsgaWYodikgdG9rZW5zLnRhZ3MucHVzaCh2KTsgY29udGludWU7IH0KICAgIGlmKC9edXBkYXRlZDovLnRlc3QocCkpeyBjb25zdCB2PXAuc3BsaXQoIjoiKVsxXTsgaWYodj09PSI8N2QifHx2PT09IjwzMGQiKSB0b2tlbnMudXBkYXRlZD12OyBjb250aW51ZTsgfQogICAgaWYoL15yZXZpZXc6Ly50ZXN0KHApKXsgY29uc3Qgdj1wLnNwbGl0KCI6IilbMV07IGlmKHY9PT0iZHVlInx8dj09PSI8N2QiKSB0b2tlbnMucmV2aWV3PXY7IGNvbnRpbnVlOyB9CiAgICB0b2tlbnMudGVybXMucHVzaChwKTsKICB9CiAgcmV0dXJuIHRva2VuczsKfQpmdW5jdGlvbiBpdGVtTWF0Y2hlcyhpdCl7CiAgY29uc3QgdHlwZUY9ZWwudHlwZUZpbHRlci52YWx1ZTsgaWYodHlwZUYgJiYgaXQudHlwZSE9PXR5cGVGKSByZXR1cm4gZmFsc2U7CiAgY29uc3QgcHJvakY9ZWwucHJvamVjdEZpbHRlci52YWx1ZS50cmltKCkudG9Mb3dlckNhc2UoKTsgaWYocHJvakYgJiYgKGl0LmNvbnRleHQ/LnByb2plY3R8fCIiKS50b0xvd2VyQ2FzZSgpLmluZGV4T2YocHJvakYpPT09LTEpIHJldHVybiBmYWxzZTsKICBjb25zdCB0YWdDaGVja3M9JCQoIiNtZW51LXRhZ3MgaW5wdXQ6Y2hlY2tlZCIpLm1hcChjYj0+Y2IudmFsdWUpOyBpZih0YWdDaGVja3MubGVuZ3RoICYmICF0YWdDaGVja3MuZXZlcnkodD0+KGl0LnRhZ3N8fFtdKS5pbmNsdWRlcyh0KSkpIHJldHVybiBmYWxzZTsKICBjb25zdCByYW5nZT1lbC51cGRhdGVkUmFuZ2UudmFsdWU7IGlmKHJhbmdlPT09IjdkIiAmJiAhd2l0aGluTkRheXMoaXQudXBkYXRlZEF0LDcpKSByZXR1cm4gZmFsc2U7IGlmKHJhbmdlPT09IjMwZCIgJiYgIXdpdGhpbk5EYXlzKGl0LnVwZGF0ZWRBdCwzMCkpIHJldHVybiBmYWxzZTsKICBjb25zdCB0a3MgPSBwYXJzZVRva2VucyhlbC5xLnZhbHVlLnRyaW0oKSk7CiAgaWYodGtzLmhhc0FjdGlvbiAmJiAoIWl0LmFjdGlvbnMgfHwgaXQuYWN0aW9ucy5sZW5ndGg9PT0wKSkgcmV0dXJuIGZhbHNlOwogIGlmKHRrcy5oYXNCbG9ja2VyICYmICFpdC5ibG9ja2VycykgcmV0dXJuIGZhbHNlOwogIGlmKHRrcy50eXBlcy5sZW5ndGggJiYgIXRrcy50eXBlcy5pbmNsdWRlcyhpdC50eXBlKSkgcmV0dXJuIGZhbHNlOwogIGlmKHRrcy5wcm9qZWN0ICYmIChpdC5jb250ZXh0Py5wcm9qZWN0fHwiIikudG9Mb3dlckNhc2UoKSAhPT0gdGtzLnByb2plY3QudG9Mb3dlckNhc2UoKSkgcmV0dXJuIGZhbHNlOwogIGlmKHRrcy50YWdzLmxlbmd0aCAmJiAhdGtzLnRhZ3MuZXZlcnkodCA9PiAoaXQudGFnc3x8W10pLmluY2x1ZGVzKHQpKSkgcmV0dXJuIGZhbHNlOwogIGlmKHRrcy51cGRhdGVkPT09Ijw3ZCIgJiYgIXdpdGhpbk5EYXlzKGl0LnVwZGF0ZWRBdCw3KSkgcmV0dXJuIGZhbHNlOwogIGlmKHRrcy51cGRhdGVkPT09IjwzMGQiICYmICF3aXRoaW5ORGF5cyhpdC51cGRhdGVkQXQsMzApKSByZXR1cm4gZmFsc2U7CiAgaWYodGtzLnJldmlldz09PSJkdWUiICYmICFyZXZpZXdEdWUoaXQucmV2aWV3X29uKSkgcmV0dXJuIGZhbHNlOwogIGlmKHRrcy5yZXZpZXc9PT0iPDdkIil7IGlmKCFpdC5yZXZpZXdfb24pIHJldHVybiBmYWxzZTsgY29uc3QgbmV4dDcgPSBub3coKSArIDcqMjQqMzYwMCoxMDAwOyBpZihpdC5yZXZpZXdfb24gPiBuZXh0NykgcmV0dXJuIGZhbHNlOyB9CgogIC8vIER1ZSBmaWx0ZXIKICBpZih0a3MuZHVlKXsKICAgIGNvbnN0IGRzID0gKGl0LmFjdGlvbnN8fFtdKS5tYXAoYT0+YS5kdWUpLmZpbHRlcihCb29sZWFuKS5tYXAoZD0+IG5ldyBEYXRlKGQpLmdldFRpbWUoKSk7CiAgICBpZihkcy5sZW5ndGg9PT0wKSByZXR1cm4gZmFsc2U7CiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpOwogICAgaWYodGtzLmR1ZT09PSJvdmVyZHVlIil7IGlmKCEoZHMuc29tZSh0cz0+IHRzPG5vdykpKSByZXR1cm4gZmFsc2U7IH0KICAgIGVsc2UgaWYodGtzLmR1ZT09PSJ0b2RheSIpeyBjb25zdCB0ZD1uZXcgRGF0ZSgpOyB0ZC5zZXRIb3VycygwLDAsMCwwKTsgY29uc3QgdG49dGQuZ2V0VGltZSgpOyBjb25zdCB0bjI9dG4rMjQqMzYwMCoxMDAwOyBpZighKGRzLnNvbWUodHM9PiB0cz49dG4gJiYgdHM8dG4yKSkpIHJldHVybiBmYWxzZTsgfQogICAgZWxzZSBpZigvXjxcZCtkJC8udGVzdCh0a3MuZHVlKSl7IGNvbnN0IG49cGFyc2VJbnQodGtzLmR1ZS5yZXBsYWNlKC9cRC9nLCcnKSwxMCl8fDc7IGNvbnN0IGxpbT1ub3cgKyBuKjI0KjM2MDAqMTAwMDsgaWYoIShkcy5zb21lKHRzPT4gdHM+PW5vdyAmJiB0czw9bGltKSkpIHJldHVybiBmYWxzZTsgfQogIH0KCiAgaWYodGtzLnRlcm1zLmxlbmd0aCl7CiAgICBjb25zdCBoYXkgPSBbaXQudGl0bGUsIGl0LmNvbnRlbnRfY29yZSwgaXQuY29udGVudCwgKGl0LnRhZ3N8fFtdKS5qb2luKCIsIiksIGl0LmNvbnRleHQ/LnByb2plY3R8fCIiLCAoaXQuY29udGV4dD8ucGVvcGxlfHxbXSkuam9pbigiLCIpLCBpdC5jb250ZXh0Py5zb3VyY2V8fCIiXS5qb2luKCJcXG4iKS50b0xvd2VyQ2FzZSgpOwogICAgY29uc3Qgb2sgPSB0a3MudGVybXMuZXZlcnkodGVybSA9PiBoYXkuaW5jbHVkZXModGVybS50b0xvd2VyQ2FzZSgpKSk7IGlmKCFvaykgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiByZXZpZXdEdWUodHMpeyBpZighdHMpIHJldHVybiBmYWxzZTsgY29uc3QgdG9kYXk9bmV3IERhdGUoKTsgdG9kYXkuc2V0SG91cnMoMCwwLDAsMCk7IGNvbnN0IGQ9bmV3IERhdGUodHMpOyBkLnNldEhvdXJzKDAsMCwwLDApOyByZXR1cm4gZC5nZXRUaW1lKCkgPD0gdG9kYXkuZ2V0VGltZSgpOyB9CmZ1bmN0aW9uIHNvcnRJdGVtcyhhcnIpeyByZXR1cm4gYXJyLnNsaWNlKCkuc29ydCgoYSxiKT0+IChiLnVwZGF0ZWRBdCAtIGEudXBkYXRlZEF0KSB8fCAoYi5jcmVhdGVkQXQgLSBhLmNyZWF0ZWRBdCkpOyB9CgovKiA9PT09PT0gVFRTID09PT09PSAqLwpsZXQgc3BlYWtpbmdJZCA9IG51bGw7CmxldCB2b2ljZXMgPSBbXTsgZnVuY3Rpb24gbG9hZFZvaWNlcygpeyB2b2ljZXMgPSB3aW5kb3cuc3BlZWNoU3ludGhlc2lzPyBzcGVlY2hTeW50aGVzaXMuZ2V0Vm9pY2VzKCk6IFtdOyB9CmlmKCdzcGVlY2hTeW50aGVzaXMnIGluIHdpbmRvdyl7IHNwZWVjaFN5bnRoZXNpcy5vbnZvaWNlc2NoYW5nZWQgPSBsb2FkVm9pY2VzOyBsb2FkVm9pY2VzKCk7IH0KZnVuY3Rpb24gcGlja1ZvaWNlKCl7IGlmKCF2b2ljZXN8fCF2b2ljZXMubGVuZ3RoKSByZXR1cm4gbnVsbDsgbGV0IHY9dm9pY2VzLmZpbmQodj0+L3ZpKC18XylWTi9pLnRlc3Qodi5sYW5nKSk7IGlmKCF2KSB2PXZvaWNlcy5maW5kKHY9Pi9lbigtfF8pVVMvaS50ZXN0KHYubGFuZykpOyByZXR1cm4gdnx8dm9pY2VzWzBdOyB9CmZ1bmN0aW9uIHN0b3BTcGVhaygpeyBpZighKCdzcGVlY2hTeW50aGVzaXMnIGluIHdpbmRvdykpIHJldHVybjsgc3BlZWNoU3ludGhlc2lzLmNhbmNlbCgpOyBzcGVha2luZ0lkPW51bGw7IHJlZnJlc2hUVFNCdXR0b25zKCk7IH0KZnVuY3Rpb24gc3BlYWtOb3RlKG4peyBpZighKCdzcGVlY2hTeW50aGVzaXMnIGluIHdpbmRvdykpIHsgYWxlcnQoJ1Ryw6xuaCBkdXnhu4d0IGtow7RuZyBo4buXIHRy4bujIMSR4buNYyBsw6puLicpOyByZXR1cm47IH0gaWYoc3BlYWtpbmdJZD09PW4uaWQpeyBzdG9wU3BlYWsoKTsgcmV0dXJuOyB9IHN0b3BTcGVhaygpOyBjb25zdCBwYXJ0cz1bXTsgaWYobi50aXRsZSkgcGFydHMucHVzaChuLnRpdGxlKTsgaWYobi5jb250ZW50X2NvcmUpIHBhcnRzLnB1c2gobi5jb250ZW50X2NvcmUpOyBjb25zdCBib2R5PShuLmNvbnRlbnR8fCcnKS5yZXBsYWNlKC9bI0AhXj8kPn5dL2csJycpOyBpZihib2R5KSBwYXJ0cy5wdXNoKGJvZHkpOyBjb25zdCB0ZXh0PXBhcnRzLmpvaW4oJy4gJyk7IGNvbnN0IHV0PW5ldyBTcGVlY2hTeW50aGVzaXNVdHRlcmFuY2UodGV4dCk7IGNvbnN0IHY9cGlja1ZvaWNlKCk7IGlmKHYpIHV0LnZvaWNlPXY7IHV0Lmxhbmc9KHYmJnYubGFuZyl8fCd2aS1WTic7IHV0Lm9uZW5kPSgpPT57c3BlYWtpbmdJZD1udWxsOyByZWZyZXNoVFRTQnV0dG9ucygpO307IHV0Lm9uZXJyb3I9KCk9PntzcGVha2luZ0lkPW51bGw7IHJlZnJlc2hUVFNCdXR0b25zKCk7fTsgc3BlYWtpbmdJZD1uLmlkOyByZWZyZXNoVFRTQnV0dG9ucygpOyB1dC5yYXRlID0gZ2V0VFRTUmF0ZSA/IGdldFRUU1JhdGUoKSA6IDE7IHNwZWVjaFN5bnRoZXNpcy5zcGVhayh1dCk7IH0KZnVuY3Rpb24gcmVmcmVzaFRUU0J1dHRvbnMoKXsgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtdHRzLWlkXScpLmZvckVhY2goYnRuPT57IGNvbnN0IGlkPWJ0bi5nZXRBdHRyaWJ1dGUoJ2RhdGEtdHRzLWlkJyk7IGlmKGlkPT09c3BlYWtpbmdJZCl7IGJ0bi5jbGFzc0xpc3QuYWRkKCdvbicpOyBidG4udGV4dENvbnRlbnQ9J+KPuSc7IGJ0bi5zZXRBdHRyaWJ1dGUoJ3RpdGxlJywnROG7q25nIMSR4buNYycpOyB9IGVsc2UgeyBidG4uY2xhc3NMaXN0LnJlbW92ZSgnb24nKTsgYnRuLnRleHRDb250ZW50PSfwn5SKJzsgYnRuLnNldEF0dHJpYnV0ZSgndGl0bGUnLCfEkOG7jWMgbMOqbicpOyB9IH0pOyB9CgovKiA9PT09PT0gTGlzdCByZW5kZXIgKENhcmQvVGFibGUgKyBUVFMpID09PT09PSAqLwpsZXQgdGFibGVNb2RlID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgna3YudGFibGVNb2RlLnY3JykgfHwgJ2ZhbHNlJyk7CmNvbnN0IGJ0blRhYmxlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0bi10YWJsZScpOwppZihidG5UYWJsZSl7CiAgZnVuY3Rpb24gdXBkYXRlQnRuVGFibGUoKXsgYnRuVGFibGUudGV4dENvbnRlbnQgPSB0YWJsZU1vZGUgPyAnVGjhursnIDogJ0LhuqNuZyc7IH0KICB1cGRhdGVCdG5UYWJsZSgpOwogIGJ0blRhYmxlLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnsgdGFibGVNb2RlPSF0YWJsZU1vZGU7IGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdrdi50YWJsZU1vZGUudjcnLCBKU09OLnN0cmluZ2lmeSh0YWJsZU1vZGUpKTsgdXBkYXRlQnRuVGFibGUoKTsgcmVuZGVyTGlzdCgpOyB9KTsKfQpmdW5jdGlvbiByZW5kZXJMaXN0KCl7CiAgY29uc3QgbWF0Y2hlZCA9IHNvcnRJdGVtcyhpdGVtcy5maWx0ZXIoaXQ9Pml0LnN0YXR1cz09PSdhY3RpdmUnKS5maWx0ZXIoaXRlbU1hdGNoZXMpKTsKICBlbC5yZXN1bHRDb3VudC50ZXh0Q29udGVudCA9ICIoIiArIG1hdGNoZWQubGVuZ3RoICsgIikiOwogIGVsLmxpc3QuaW5uZXJIVE1MID0gIiI7CiAgaWYobWF0Y2hlZC5sZW5ndGg9PT0wKXsgZWwubGlzdC5pbm5lckhUTUwgPSAnPGRpdiBjbGFzcz0ibXV0ZWQiPktow7RuZyBjw7MgbeG7pWMgcGjDuSBo4bujcC48L2Rpdj4nOyByZXR1cm47IH0KICBjb25zdCB0ZXJtcyA9IHBhcnNlVG9rZW5zKGVsLnEudmFsdWUudHJpbSgpKS50ZXJtczsKICBpZih0YWJsZU1vZGUpeyBlbC5saXN0LmFwcGVuZENoaWxkKGJ1aWxkVGFibGUobWF0Y2hlZCwgdGVybXMpKTsgfSBlbHNlIHsgbWF0Y2hlZC5mb3JFYWNoKGl0PT4gZWwubGlzdC5hcHBlbmRDaGlsZChub3RlQ2FyZChpdCwgdGVybXMpKSk7IH0KICByZWZyZXNoVFRTQnV0dG9ucygpOwp9CmZ1bmN0aW9uIG5vdGVDYXJkKGl0LCB0ZXJtcyl7CiAgY29uc3Qgd3JhcD1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsgd3JhcC5jbGFzc05hbWU9Im5vdGUiOwogIGNvbnN0IGhlYWRlcj1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICBoZWFkZXIuaW5uZXJIVE1MPWA8ZGl2IHN0eWxlPSJkaXNwbGF5OmZsZXg7Z2FwOjhweDtqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjthbGlnbi1pdGVtczpmbGV4LXN0YXJ0Ij4KICAgIDxoMz4ke2hpZ2hsaWdodChpdC50aXRsZSx0ZXJtcyl9PC9oMz4KICAgIDxkaXYgY2xhc3M9Im11dGVkIHRydW5jYXRlIiBzdHlsZT0ibWF4LXdpZHRoOjI2MHB4Ij4ke25ldyBEYXRlKGl0LmNyZWF0ZWRBdCkudG9Mb2NhbGVEYXRlU3RyaW5nKCl9IOKAoiAke25ldyBEYXRlKGl0LnVwZGF0ZWRBdCkudG9Mb2NhbGVEYXRlU3RyaW5nKCl9PC9kaXY+CiAgPC9kaXY+YDsKICB3cmFwLmFwcGVuZENoaWxkKGhlYWRlcik7CiAgY29uc3QgY29yZT1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsgY29yZS5jbGFzc05hbWU9Im11dGVkIjsgY29yZS5pbm5lckhUTUw9aGlnaGxpZ2h0KGl0LmNvbnRlbnRfY29yZXx8IiIsdGVybXMpOyB3cmFwLmFwcGVuZENoaWxkKGNvcmUpOwogIGNvbnN0IGJvZHk9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7IGJvZHkuY2xhc3NOYW1lPSJwcm9zZSI7IGNvbnN0IHByZXZpZXc9KGl0LmNvbnRlbnR8fCIiKS5zbGljZSgwLDI0MCkrKChpdC5jb250ZW50fHwiIikubGVuZ3RoPjI0MD8i4oCmIjoiIik7IGJvZHkuaW5uZXJIVE1MPWhpZ2hsaWdodChwcmV2aWV3LHRlcm1zKTsgd3JhcC5hcHBlbmRDaGlsZChib2R5KTsKICBjb25zdCBwYXNzMTBzID0gKGl0LmFjdGlvbnMgJiYgaXQuYWN0aW9ucy5sZW5ndGg+MCkgJiYgKGl0LmNvbnRleHQ/LnNvdXJjZSB8fCBpdC5jb250ZXh0Py5wcm9qZWN0KTsKICBjb25zdCBiYW5uZXI9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7IGJhbm5lci5jbGFzc05hbWU9ImJhbm5lciAiKyhwYXNzMTBzPyJnb29kIjoiYmFkIik7IGJhbm5lci50ZXh0Q29udGVudCA9IHBhc3MxMHM/ICIxMHM6IFBBU1Mg4oCUIHRo4bqleSAhICYgYuG7kWkgY+G6o25oL25ndeG7k24uIiA6ICIxMHM6IEZBSUwg4oCUIGPhuqduICEgaG/hurdjIGLhu5FpIGPhuqNuaC9uZ3Xhu5NuLiI7IHdyYXAuYXBwZW5kQ2hpbGQoYmFubmVyKTsKICAKICAvLyBEdWUgYmFkZ2UgKHNvb25lc3QpCiAgdHJ5ewogICAgY29uc3QgZHVlcyA9IChpdC5hY3Rpb25zfHxbXSkubWFwKGE9PmEuZHVlKS5maWx0ZXIoQm9vbGVhbikuc29ydCgpOwogICAgaWYoZHVlcy5sZW5ndGgpewogICAgICBjb25zdCBkdWUgPSBuZXcgRGF0ZShkdWVzWzBdKTsKICAgICAgY29uc3QgZGQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgY29uc3QgbGF0ZSA9IGR1ZS5nZXRUaW1lKCkgPCBEYXRlLm5vdygpOwogICAgICBkZC5jbGFzc05hbWUgPSAnYmFubmVyICcgKyAobGF0ZSA/ICdiYWQnIDogJ3dhcm4nKTsKICAgICAgZGQudGV4dENvbnRlbnQgPSAobGF0ZT8gJ1F1w6EgaOG6oW46ICcgOiAnU+G6r3AgxJHhur9uIGjhuqFuOiAnKSArIGR1ZS50b0xvY2FsZVN0cmluZygpOwogICAgICB3cmFwLmFwcGVuZENoaWxkKGRkKTsKICAgIH0KICB9Y2F0Y2goZSl7IC8qIGlnbm9yZSAqLyB9CmNvbnN0IG1ldGE9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7IG1ldGEuY2xhc3NOYW1lPSJtZXRhIjsKICBjb25zdCB0eXBlPWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsgdHlwZS5jbGFzc05hbWU9InR5cGUiOyB0eXBlLnRleHRDb250ZW50PWl0LnR5cGU7IG1ldGEuYXBwZW5kQ2hpbGQodHlwZSk7CiAgaWYoaXQuY29udGV4dD8ucHJvamVjdCl7IGNvbnN0IHByPWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsgcHIuY2xhc3NOYW1lPSJiYWRnZSI7IHByLnRleHRDb250ZW50PWl0LmNvbnRleHQucHJvamVjdDsgbWV0YS5hcHBlbmRDaGlsZChwcik7IH0KICAoaXQudGFnc3x8W10pLmZvckVhY2godD0+eyBjb25zdCB0Zz1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7IHRnLmNsYXNzTmFtZT0iYmFkZ2UiOyB0Zy50ZXh0Q29udGVudD0iIyIrdDsgbWV0YS5hcHBlbmRDaGlsZCh0Zyk7IH0pOwogIGlmKGl0LmJsb2NrZXJzKXsgY29uc3QgYj1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7IGIuY2xhc3NOYW1lPSJiYWRnZSI7IGIudGV4dENvbnRlbnQ9ImJsb2NrZXIiOyBtZXRhLmFwcGVuZENoaWxkKGIpOyB9CiAgaWYoaXQucmV2aWV3X29uKXsgY29uc3Qgcj1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7IHIuY2xhc3NOYW1lPSJiYWRnZSI7IHIudGV4dENvbnRlbnQ9InJldmlldzogIituZXcgRGF0ZShpdC5yZXZpZXdfb24pLnRvTG9jYWxlRGF0ZVN0cmluZygpOyBtZXRhLmFwcGVuZENoaWxkKHIpOyB9CiAgY29uc3Qgaz1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7IGsuY2xhc3NOYW1lPSJrcGkgcmlnaHQiOyBjb25zdCBjbnQ9KGl0LmFjdGlvbnN8fFtdKS5sZW5ndGg7IGNvbnN0IGRvdD1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7IGRvdC5jbGFzc05hbWU9ImFjdGlvbi1kb3QiKyhjbnQ/ICIiOiIgZG9uZSIpOyBrLmFwcGVuZENoaWxkKGRvdCk7IGNvbnN0IHR4dD1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7IHR4dC5jbGFzc05hbWU9Im11dGVkIjsgdHh0LnRleHRDb250ZW50PSBjbnQ/ICgiISAiK2NudCkgOiAiISAwIjsgay5hcHBlbmRDaGlsZCh0eHQpOyBtZXRhLmFwcGVuZENoaWxkKGspOwogIHdyYXAuYXBwZW5kQ2hpbGQobWV0YSk7CiAgY29uc3QgYWN0aW9ucz1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsgYWN0aW9ucy5jbGFzc05hbWU9ImZsZXgiOyBhY3Rpb25zLnN0eWxlLm1hcmdpblRvcD0iOHB4IjsKICBjb25zdCBidG5UdHM9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyk7IGJ0blR0cy5jbGFzc05hbWU9J2J0biBidG4tc20nOyBidG5UdHMuc2V0QXR0cmlidXRlKCdkYXRhLXR0cy1pZCcsIGl0LmlkKTsgYnRuVHRzLnRleHRDb250ZW50PSfwn5SKJzsgYnRuVHRzLnRpdGxlPSfEkOG7jWMgbMOqbic7CiAgY29uc3QgYnRuRXhwYW5kPWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJ1dHRvbiIpOyBidG5FeHBhbmQuY2xhc3NOYW1lPSJidG4gYnRuLXNtIjsgYnRuRXhwYW5kLnRleHRDb250ZW50PSJN4bufIHLhu5luZyI7CiAgY29uc3QgYnRuRWRpdD1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJidXR0b24iKTsgYnRuRWRpdC5jbGFzc05hbWU9ImJ0biBidG4tc20iOyBidG5FZGl0LnRleHRDb250ZW50PSJT4butYSI7CiAgY29uc3QgYnRuU3JjPSBpdC5jb250ZXh0Py5zb3VyY2UgPyBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIikgOiBudWxsOyBpZihidG5TcmMpeyBidG5TcmMuaHJlZj1pdC5jb250ZXh0LnNvdXJjZTsgYnRuU3JjLnRhcmdldD0iX2JsYW5rIjsgYnRuU3JjLnJlbD0ibm9yZWZlcnJlciI7IGJ0blNyYy5jbGFzc05hbWU9ImJ0biBidG4tc20iOyBidG5TcmMudGV4dENvbnRlbnQ9Ik5ndeG7k24iOyB9CiAgY29uc3QgYnRuRGVsPWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJ1dHRvbiIpOyBidG5EZWwuY2xhc3NOYW1lPSJidG4gYnRuLXNtIGRlcyI7IGJ0bkRlbC50ZXh0Q29udGVudD0iWMOzYSI7CiAgYWN0aW9ucy5hcHBlbmQoYnRuVHRzLCBidG5FeHBhbmQsIGJ0bkVkaXQpOyBpZihidG5TcmMpIGFjdGlvbnMuYXBwZW5kKGJ0blNyYyk7IGFjdGlvbnMuYXBwZW5kKGJ0bkRlbCk7IHdyYXAuYXBwZW5kQ2hpbGQoYWN0aW9ucyk7CiAgbGV0IGV4cGFuZGVkPWZhbHNlOyBidG5FeHBhbmQub25jbGljaz0oKT0+eyBleHBhbmRlZD0hZXhwYW5kZWQ7IGJvZHkuaW5uZXJIVE1MID0gZXhwYW5kZWQ/IGhpZ2hsaWdodChpdC5jb250ZW50fHwiIix0ZXJtcykgOiBoaWdobGlnaHQocHJldmlldyx0ZXJtcyk7IGJ0bkV4cGFuZC50ZXh0Q29udGVudCA9IGV4cGFuZGVkPyAiVGh1IGfhu41uIjoiTeG7nyBy4buZbmciOyB9OwogIGJ0bkVkaXQub25jbGljaz0oKT0+IG9wZW5FZGl0b3IoaXQpOwogIGJ0bkRlbC5vbmNsaWNrPSgpPT57IGlmKGNvbmZpcm0oIljDs2EgbeG7pWMgbsOgeT8iKSl7IGl0ZW1zPWl0ZW1zLmZpbHRlcih4PT54LmlkIT09aXQuaWQpOyBzYXZlVG9MUygpOyByZW5kZXJMaXN0KCk7IHJlbmRlclByb2plY3RzKCk7IHJlbmRlclN0YXRzKCk7IH19OwogIGFjdGlvbnMuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLChlKT0+eyBjb25zdCBiPWUudGFyZ2V0LmNsb3Nlc3QoJ1tkYXRhLXR0cy1pZF0nKTsgaWYoYil7IHNwZWFrTm90ZShpdCk7IH0gfSk7CiAgcmV0dXJuIHdyYXA7Cn0KZnVuY3Rpb24gYnVpbGRUYWJsZShhcnIsIHRlcm1zKXsKICBjb25zdCB3cmFwID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgY29uc3QgdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RhYmxlJyk7IHQuY2xhc3NOYW1lPSd0YmwnOwogIHQuaW5uZXJIVE1MID0gJzx0aGVhZD48dHI+PHRoPvCflIo8L3RoPjx0aD5UacOqdSDEkeG7gTwvdGg+PHRoPkxv4bqhaTwvdGg+PHRoPlByb2plY3Q8L3RoPjx0aD5UYWdzPC90aD48dGg+ITwvdGg+PHRoPlJldmlldzwvdGg+PHRoPlVwZGF0ZWQ8L3RoPjwvdHI+PC90aGVhZD48dGJvZHk+PC90Ym9keT4nOwogIGNvbnN0IHRiID0gdC5xdWVyeVNlbGVjdG9yKCd0Ym9keScpOwogIGFyci5mb3JFYWNoKG4gPT4gewogICAgY29uc3QgdHIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0cicpOwogICAgY29uc3QgdGFncyA9IChuLnRhZ3N8fFtdKS5tYXAoeD0+JyMnK3gpLmpvaW4oJywgJyk7CiAgICBjb25zdCByZXYgPSBuLnJldmlld19vbiA/IG5ldyBEYXRlKG4ucmV2aWV3X29uKS50b0xvY2FsZURhdGVTdHJpbmcoKSA6ICfigJQnOwogICAgY29uc3QgdXAgPSBuZXcgRGF0ZShuLnVwZGF0ZWRBdCkudG9Mb2NhbGVEYXRlU3RyaW5nKCk7CiAgICB0ci5pbm5lckhUTUwgPSBgPHRkPjxidXR0b24gY2xhc3M9Imljb25idG4iIGRhdGEtdHRzLWlkPSIke24uaWR9IiBhcmlhLWxhYmVsPSJkb2MiPjwvYnV0dG9uPjwvdGQ+CiAgICAgIDx0ZD4ke2hpZ2hsaWdodChuLnRpdGxlfHwnJywgdGVybXMpfTwvdGQ+CiAgICAgIDx0ZD4ke24udHlwZX08L3RkPgogICAgICA8dGQ+JHtlc2NhcGVIdG1sKG4uY29udGV4dD8ucHJvamVjdHx8JycpfTwvdGQ+CiAgICAgIDx0ZCBjbGFzcz0ibXV0ZWQiPiR7ZXNjYXBlSHRtbCh0YWdzKX08L3RkPgogICAgICA8dGQ+JHsobi5hY3Rpb25zfHxbXSkuZmlsdGVyKGE9PiFhLmRvbmUpLmxlbmd0aH08L3RkPgogICAgICA8dGQ+JHtyZXZ9PC90ZD4KICAgICAgPHRkPiR7dXB9PC90ZD5gOwogICAgdGIuYXBwZW5kQ2hpbGQodHIpOwogIH0pOwogIHdyYXAuYXBwZW5kQ2hpbGQodCk7CiAgd3JhcC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKT0+ewogICAgY29uc3QgYnRuID0gZS50YXJnZXQuY2xvc2VzdCgnW2RhdGEtdHRzLWlkXScpOyBpZighYnRuKSByZXR1cm47CiAgICBjb25zdCBpZCA9IGJ0bi5nZXRBdHRyaWJ1dGUoJ2RhdGEtdHRzLWlkJyk7CiAgICBjb25zdCBuID0gaXRlbXMuZmluZCh4PT54LmlkPT09aWQpOyBpZighbikgcmV0dXJuOwogICAgc3BlYWtOb3RlKG4pOwogIH0pOwogIHJldHVybiB3cmFwOwp9CgovKiA9PT09PT0gRWRpdG9yIG1vZGFsID09PT09PSAqLwpmdW5jdGlvbiBvcGVuRWRpdG9yKGl0KXsKICBjb25zdCBtb2RhbD1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsgT2JqZWN0LmFzc2lnbihtb2RhbC5zdHlsZSx7cG9zaXRpb246ImZpeGVkIixpbnNldDoiMCIsYmFja2dyb3VuZDoicmdiYSgwLDAsMCwuNDUpIix6SW5kZXg6OTk5OCxkaXNwbGF5OiJmbGV4IixhbGlnbkl0ZW1zOiJjZW50ZXIiLGp1c3RpZnlDb250ZW50OiJjZW50ZXIifSk7CiAgY29uc3QgcGFuZWw9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7IHBhbmVsLmNsYXNzTmFtZT0iY2FyZCI7IHBhbmVsLnN0eWxlLm1heFdpZHRoPSI3NjBweCI7IHBhbmVsLnN0eWxlLndpZHRoPSI5MiUiOwogIHBhbmVsLmlubmVySFRNTD0nPGgyPlPhu61hIG3hu6VjPC9oMj48ZGl2IGNsYXNzPSJjb250ZW50Ij48L2Rpdj4nOyBjb25zdCBjPSQoIi5jb250ZW50IixwYW5lbCk7CiAgYy5pbm5lckhUTUwgPSBgCiAgICA8ZGl2IGNsYXNzPSJyb3ciPgogICAgICA8ZGl2PjxsYWJlbD5UacOqdSDEkeG7gTwvbGFiZWw+PGlucHV0IGlkPSJlLXRpdGxlIiB0eXBlPSJ0ZXh0IiB2YWx1ZT0iJHtlc2NhcGVIdG1sKGl0LnRpdGxlKS5yZXBsYWNlKC8iL2csJyZxdW90OycpfSI+PC9kaXY+CiAgICAgIDxkaXY+PGxhYmVsPkxv4bqhaTwvbGFiZWw+CiAgICAgICAgPHNlbGVjdCBpZD0iZS10eXBlIj4KICAgICAgICAgIDxvcHRpb24gJHtpdC50eXBlPT09J25vdGUnPydzZWxlY3RlZCc6Jyd9IHZhbHVlPSJub3RlIj5ub3RlPC9vcHRpb24+CiAgICAgICAgICA8b3B0aW9uICR7aXQudHlwZT09PSdwcm9qZWN0Jz8nc2VsZWN0ZWQnOicnfSB2YWx1ZT0icHJvamVjdCI+cHJvamVjdDwvb3B0aW9uPgogICAgICAgICAgPG9wdGlvbiAke2l0LnR5cGU9PT0nbWVldGluZyc/J3NlbGVjdGVkJzonJ30gdmFsdWU9Im1lZXRpbmciPm1lZXRpbmc8L29wdGlvbj4KICAgICAgICAgIDxvcHRpb24gJHtpdC50eXBlPT09J2RlY2lzaW9uJz8nc2VsZWN0ZWQnOicnfSB2YWx1ZT0iZGVjaXNpb24iPmRlY2lzaW9uPC9vcHRpb24+CiAgICAgICAgICA8b3B0aW9uICR7aXQudHlwZT09PSdyZWFkaW5nJz8nc2VsZWN0ZWQnOicnfSB2YWx1ZT0icmVhZGluZyI+cmVhZGluZzwvb3B0aW9uPgogICAgICAgIDwvc2VsZWN0PgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgogICAgPGxhYmVsPkjhuqF0IG5ow6JuPC9sYWJlbD48dGV4dGFyZWEgaWQ9ImUtY29yZSI+JHtlc2NhcGVIdG1sKGl0LmNvbnRlbnRfY29yZXx8IiIpfTwvdGV4dGFyZWE+CiAgICA8bGFiZWw+TuG7mWkgZHVuZzwvbGFiZWw+PHRleHRhcmVhIGlkPSJlLWNvbnRlbnQiPiR7ZXNjYXBlSHRtbChpdC5jb250ZW50fHwiIil9PC90ZXh0YXJlYT4KICAgIDxkaXYgY2xhc3M9InJvdyI+CiAgICAgIDxkaXY+PGxhYmVsPlByb2plY3Q8L2xhYmVsPjxpbnB1dCBpZD0iZS1wcmoiIHR5cGU9InRleHQiIHZhbHVlPSIke2VzY2FwZUh0bWwoaXQuY29udGV4dD8ucHJvamVjdHx8JycpLnJlcGxhY2UoLyIvZywnJnF1b3Q7Jyl9Ij48L2Rpdj4KICAgICAgPGRpdj48bGFiZWw+U291cmNlPC9sYWJlbD48aW5wdXQgaWQ9ImUtc3JjIiB0eXBlPSJ0ZXh0IiB2YWx1ZT0iJHtlc2NhcGVIdG1sKGl0LmNvbnRleHQ/LnNvdXJjZXx8JycpLnJlcGxhY2UoLyIvZywnJnF1b3Q7Jyl9Ij48L2Rpdj4KICAgIDwvZGl2PgogICAgPGxhYmVsPlBlb3BsZSAoQCk8L2xhYmVsPgogICAgPGlucHV0IGlkPSJlLXBlb3BsZS1pbnB1dCIgdHlwZT0idGV4dCIgcGxhY2Vob2xkZXI9Im5o4bqtcCB0w6puIHLhu5NpIEVudGVyIj4KICAgIDxkaXYgaWQ9ImUtcGVvcGxlLXRhZ3MiIGNsYXNzPSJ0YWdzIj48L2Rpdj4KICAgIDxsYWJlbD5UaOG6uyAoIyDiiaQyKTwvbGFiZWw+CiAgICA8aW5wdXQgaWQ9ImUtdGFnLWlucHV0IiB0eXBlPSJ0ZXh0IiBwbGFjZWhvbGRlcj0ibmjhuq1wIHRo4bq7IHLhu5NpIEVudGVyIj4KICAgIDxkaXYgaWQ9ImUtdGFnLXRhZ3MiIGNsYXNzPSJ0YWdzIj48L2Rpdj4KICAgIDxkaXYgY2xhc3M9InJvdyI+CiAgICAgIDxkaXY+PGxhYmVsPlJldmlldyBvbjwvbGFiZWw+PGlucHV0IGlkPSJlLXJldmlldyIgdHlwZT0iZGF0ZSI+PC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9ImZsZXgiIHN0eWxlPSJtYXJnaW4tdG9wOjI2cHgiPjxsYWJlbCBjbGFzcz0ic3dpdGNoIj48aW5wdXQgaWQ9ImUtYmxvY2tlciIgdHlwZT0iY2hlY2tib3giPjwvbGFiZWw+PHNwYW4gY2xhc3M9Im11dGVkIj5CbG9ja2VyPC9zcGFuPjwvZGl2PgogICAgPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJociI+PC9kaXY+CiAgICA8bGFiZWw+SMOgbmggxJHhu5luZzwvbGFiZWw+CiAgICA8ZGl2IGNsYXNzPSJyb3ciPjxpbnB1dCBpZD0iZS1hY3QtdGV4dCIgdHlwZT0idGV4dCIgcGxhY2Vob2xkZXI9ImjDoG5oIMSR4buZbmcgbeG7m2kgKEVudGVyIMSR4buDIHRow6ptKSI+PGlucHV0IGlkPSJlLWFjdC1kdWUiIHR5cGU9ImRhdGUiPjwvZGl2PgogICAgPGRpdiBpZD0iZS1hY3QtbGlzdCIgY2xhc3M9InRhZ3MiPjwvZGl2PgogICAgPGRpdiBjbGFzcz0iZmxleCIgc3R5bGU9Imp1c3RpZnktY29udGVudDpmbGV4LWVuZCI+PGJ1dHRvbiBjbGFzcz0iYnRuIiBpZD0iZS1jYW5jZWwiPkjhu6d5PC9idXR0b24+PGJ1dHRvbiBjbGFzcz0iYnRuIGFjYyIgaWQ9ImUtc2F2ZSI+TMawdTwvYnV0dG9uPjwvZGl2PgogIGA7CiAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChtb2RhbCk7IG1vZGFsLmFwcGVuZENoaWxkKHBhbmVsKTsKICBjb25zdCBlUGVvcGxlID0gKGl0LmNvbnRleHQ/LnBlb3BsZXx8W10pLnNsaWNlKCk7CiAgY29uc3QgZVRhZ3MgPSAoaXQudGFnc3x8W10pLnNsaWNlKCk7CiAgY29uc3QgZUFjdHMgPSAoaXQuYWN0aW9uc3x8W10pLm1hcChhPT4oe3RleHQ6YS50ZXh0LCBkdWU6YS5kdWUsIGRvbmU6ISFhLmRvbmV9KSk7CiAgaWYoaXQucmV2aWV3X29uKSAkKCIjZS1yZXZpZXciLHBhbmVsKS52YWx1ZSA9IG5ldyBEYXRlKGl0LnJldmlld19vbikudG9JU09TdHJpbmcoKS5zbGljZSgwLDEwKTsKICAkKCIjZS1ibG9ja2VyIixwYW5lbCkuY2hlY2tlZCA9ICEhaXQuYmxvY2tlcnM7CiAgZnVuY3Rpb24gcmVuZGVyQ2hpcExpc3QobGlzdCwgd3JhcCwgcHJlZml4PSIiKXsgd3JhcC5pbm5lckhUTUw9IiI7IGxpc3QuZm9yRWFjaCgodixpZHgpPT57IGNvbnN0IHM9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOyBzLmNsYXNzTmFtZT0iYmFkZ2UiOyBzLmlubmVySFRNTD0ocHJlZml4P3ByZWZpeDoiIikrZXNjYXBlSHRtbCh2KSsiIDxzcGFuIGNsYXNzPSd4Jz4mdGltZXM7PC9zcGFuPiI7IHMucXVlcnlTZWxlY3RvcigiLngiKS5vbmNsaWNrPSgpPT57IGxpc3Quc3BsaWNlKGlkeCwxKTsgcmVuZGVyQ2hpcExpc3QobGlzdCx3cmFwLHByZWZpeCk7IH07IHdyYXAuYXBwZW5kQ2hpbGQocyk7IH0pOyB9CiAgcmVuZGVyQ2hpcExpc3QoZVBlb3BsZSwgJCgiI2UtcGVvcGxlLXRhZ3MiLHBhbmVsKSwgIkAiKTsgcmVuZGVyQ2hpcExpc3QoZVRhZ3MsICQoIiNlLXRhZy10YWdzIixwYW5lbCksICIjIik7CiAgZnVuY3Rpb24gcmVuZGVyRUFjdHMoKXsgY29uc3Qgd3JhcD0kKCIjZS1hY3QtbGlzdCIscGFuZWwpOyB3cmFwLmlubmVySFRNTD0iIjsgaWYoZUFjdHMubGVuZ3RoPT09MCl7IGNvbnN0IG09ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOyBtLmNsYXNzTmFtZT0ibXV0ZWQiOyBtLnRleHRDb250ZW50PSJDaMawYSBjw7MgaMOgbmggxJHhu5luZyI7IHdyYXAuYXBwZW5kQ2hpbGQobSk7IHJldHVybjsgfSBlQWN0cy5mb3JFYWNoKChhLGlkeCk9PnsgY29uc3QgY2hpcD1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7IGNoaXAuY2xhc3NOYW1lPSJiYWRnZSI7IGNvbnN0IGR1ZVR4dD1hLmR1ZT8gbmV3IERhdGUoYS5kdWUpLnRvTG9jYWxlRGF0ZVN0cmluZygpOiIiOyBjaGlwLmlubmVySFRNTD1gPHNwYW4gY2xhc3M9ImFjdGlvbi1kb3QgJHthLmRvbmU/J2RvbmUnOicnfSI+PC9zcGFuPiAke2VzY2FwZUh0bWwoYS50ZXh0KX0gJHtkdWVUeHQ/KCLigKIgIitlc2NhcGVIdG1sKGR1ZVR4dCkpOiIifSA8c3BhbiBjbGFzcz0neCc+JnRpbWVzOzwvc3Bhbj5gOyBjaGlwLm9uY2xpY2s9KGUpPT57IGlmKGUudGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucygieCIpKSByZXR1cm47IGEuZG9uZT0hYS5kb25lOyByZW5kZXJFQWN0cygpOyB9OyBjaGlwLnF1ZXJ5U2VsZWN0b3IoIi54Iikub25jbGljaz0oZSk9PnsgZS5zdG9wUHJvcGFnYXRpb24oKTsgZUFjdHMuc3BsaWNlKGlkeCwxKTsgcmVuZGVyRUFjdHMoKTsgfTsgd3JhcC5hcHBlbmRDaGlsZChjaGlwKTsgfSk7IH0KICByZW5kZXJFQWN0cygpOwogICQoIiNlLXBlb3BsZS1pbnB1dCIscGFuZWwpLmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLChlKT0+eyBpZihlLmtleT09PSJFbnRlciJ8fGUua2V5PT09IiwiKXsgZS5wcmV2ZW50RGVmYXVsdCgpOyBjb25zdCB2PSQoIiNlLXBlb3BsZS1pbnB1dCIscGFuZWwpLnZhbHVlLnRyaW0oKS5yZXBsYWNlKC9eQC8sIiIpOyBpZih2ICYmICFlUGVvcGxlLmluY2x1ZGVzKHYpKSBlUGVvcGxlLnB1c2godik7ICQoIiNlLXBlb3BsZS1pbnB1dCIscGFuZWwpLnZhbHVlPSIiOyByZW5kZXJDaGlwTGlzdChlUGVvcGxlLCQoIiNlLXBlb3BsZS10YWdzIixwYW5lbCksIkAiKTsgfSB9KTsKICAkKCIjZS10YWctaW5wdXQiLHBhbmVsKS5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwoZSk9PnsgaWYoZS5rZXk9PT0iRW50ZXIifHxlLmtleT09PSIsIil7IGUucHJldmVudERlZmF1bHQoKTsgY29uc3Qgdj0kKCIjZS10YWctaW5wdXQiLHBhbmVsKS52YWx1ZS50cmltKCkucmVwbGFjZSgvXiMvLCIiKS5yZXBsYWNlKC9cXHMrL2csIi0iKTsgaWYodiAmJiAhZVRhZ3MuaW5jbHVkZXModikpeyBpZihlVGFncy5sZW5ndGg+PTIpIGFsZXJ0KCJU4buRaSDEkWEgMiB0aOG6uy4iKTsgZWxzZSBlVGFncy5wdXNoKHYpOyB9ICQoIiNlLXRhZy1pbnB1dCIscGFuZWwpLnZhbHVlPSIiOyByZW5kZXJDaGlwTGlzdChlVGFncywkKCIjZS10YWctdGFncyIscGFuZWwpLCIjIik7IH0gfSk7CiAgJCgiI2UtYWN0LXRleHQiLHBhbmVsKS5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwoZSk9PnsgaWYoZS5rZXk9PT0iRW50ZXIiKXsgZS5wcmV2ZW50RGVmYXVsdCgpOyBjb25zdCB0PSQoIiNlLWFjdC10ZXh0IixwYW5lbCkudmFsdWUudHJpbSgpOyBpZighdCkgcmV0dXJuOyBjb25zdCBkPSQoIiNlLWFjdC1kdWUiLHBhbmVsKS52YWx1ZTsgY29uc3QgZHVlPWQ/IG5ldyBEYXRlKGQrIlQwMDowMDowMCIpLmdldFRpbWUoKTp1bmRlZmluZWQ7IGVBY3RzLnB1c2goe3RleHQ6dCxkdWUsZG9uZTpmYWxzZX0pOyAkKCIjZS1hY3QtdGV4dCIscGFuZWwpLnZhbHVlPSIiOyAkKCIjZS1hY3QtZHVlIixwYW5lbCkudmFsdWU9IiI7IHJlbmRlckVBY3RzKCk7IH0gfSk7CiAgJCgiI2UtY2FuY2VsIixwYW5lbCkub25jbGljaz0oKT0+IGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQobW9kYWwpOwogICQoIiNlLXNhdmUiLHBhbmVsKS5vbmNsaWNrPSgpPT57IGl0LnRpdGxlPSQoIiNlLXRpdGxlIixwYW5lbCkudmFsdWUudHJpbSgpfHwiKGtow7RuZyB0acOqdSDEkeG7gSkiOyBpdC50eXBlPSQoIiNlLXR5cGUiLHBhbmVsKS52YWx1ZTsgaXQuY29udGVudF9jb3JlPSQoIiNlLWNvcmUiLHBhbmVsKS52YWx1ZS50cmltKCk7IGl0LmNvbnRlbnQ9JCgiI2UtY29udGVudCIscGFuZWwpLnZhbHVlOyBpdC5jb250ZXh0PWl0LmNvbnRleHR8fHt9OyBpdC5jb250ZXh0LnByb2plY3Q9JCgiI2UtcHJqIixwYW5lbCkudmFsdWUudHJpbSgpfHx1bmRlZmluZWQ7IGl0LmNvbnRleHQuc291cmNlPSQoIiNlLXNyYyIscGFuZWwpLnZhbHVlLnRyaW0oKXx8dW5kZWZpbmVkOyBpdC5jb250ZXh0LnBlb3BsZT1lUGVvcGxlOyBpdC50YWdzPWVUYWdzOyBjb25zdCBydj0kKCIjZS1yZXZpZXciLHBhbmVsKS52YWx1ZTsgaXQucmV2aWV3X29uID0gcnY/IG5ldyBEYXRlKHJ2KyJUMDA6MDA6MDAiKS5nZXRUaW1lKCk6dW5kZWZpbmVkOyBpdC5ibG9ja2Vycz0kKCIjZS1ibG9ja2VyIixwYW5lbCkuY2hlY2tlZDsgaXQuYWN0aW9ucz1lQWN0czsgaXQudXBkYXRlZEF0PW5vdygpOyBzYXZlVG9MUygpOyByZW5kZXJBbGwoKTsgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChtb2RhbCk7IH07Cn0KCi8qID09PT09PSBQcm9qZWN0cyA9PT09PT0gKi8KZWwucHJqQ3JlYXRlLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgKCk9PnsgY29uc3QgbmFtZSA9IGVsLnByak5ldy52YWx1ZS50cmltKCk7IGlmKCFuYW1lKSByZXR1cm47IGNvbnN0IHRzPW5vdygpOyBjb25zdCBpZD15eXl5bW1kZF9oaG1tKHRzKSsiLSIrc2x1ZyhuYW1lKTsgaXRlbXMudW5zaGlmdCh7IGlkLCBzdGF0dXM6ImFjdGl2ZSIsIHR5cGU6InByb2plY3QiLCB0aXRsZTpuYW1lLCBjb250ZW50X2NvcmU6Ik3hu6VjIHRpw6p1IMSRbyDEkcaw4bujYyAvIEtQSSIsIGNvbnRlbnQ6IiIsIGFjdGlvbnM6W10sIHRhZ3M6W10sIGNvbnRleHQ6e3Byb2plY3Q6c2x1ZyhuYW1lKX0sIGNyZWF0ZWRBdDp0cywgdXBkYXRlZEF0OnRzIH0pOyBlbC5wcmpOZXcudmFsdWU9IiI7IHNhdmVUb0xTKCk7IHJlbmRlclByb2plY3RzKCk7IHJlbmRlclN0YXRzKCk7IH0pOwpmdW5jdGlvbiByZW5kZXJQcm9qZWN0cygpeyBlbC5wcmpMaXN0LmlubmVySFRNTD0iIjsgY29uc3QgcHJqcyA9IGl0ZW1zLmZpbHRlcihpdD0+IGl0LnN0YXR1cz09PSJhY3RpdmUiICYmIGl0LnR5cGU9PT0icHJvamVjdCIpLnNvcnQoKGEsYik9PiBhLnRpdGxlLmxvY2FsZUNvbXBhcmUoYi50aXRsZSkpOyBpZihwcmpzLmxlbmd0aD09PTApeyBlbC5wcmpMaXN0LmlubmVySFRNTD0nPGRpdiBjbGFzcz0ibXV0ZWQiPkNoxrBhIGPDsyBQcm9qZWN0LiBU4bqhbyBi4bqxbmcgw7QgcGjDrWEgdHLDqm4uPC9kaXY+JzsgcmV0dXJuOyB9IHByanMuZm9yRWFjaChwID0+IGVsLnByakxpc3QuYXBwZW5kQ2hpbGQocHJvamVjdENhcmQocCkpKTsgfQpmdW5jdGlvbiBwcm9qZWN0Q2FyZChwKXsKICBjb25zdCBjYXJkPWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOyBjYXJkLmNsYXNzTmFtZT0icHJvamVjdC1jYXJkIjsKICBjb25zdCByZWxhdGVkID0gaXRlbXMuZmlsdGVyKG49PiBuLnN0YXR1cz09PSJhY3RpdmUiICYmIG4uY29udGV4dD8ucHJvamVjdCA9PT0gKHAuY29udGV4dD8ucHJvamVjdHx8c2x1ZyhwLnRpdGxlKSkgJiYgbi5pZCE9PXAuaWQpOwogIGNvbnN0IGFjdGlvbnMgPSBbXTsgcmVsYXRlZC5mb3JFYWNoKG4gPT4gKG4uYWN0aW9uc3x8W10pLmZpbHRlcihhPT4hYS5kb25lKS5mb3JFYWNoKGE9PiBhY3Rpb25zLnB1c2goe2EsIG59KSkpOwogIGNhcmQuaW5uZXJIVE1MID0gYDxoMz4ke2VzY2FwZUh0bWwocC50aXRsZSl9PC9oMz4KICAgIDxkaXYgY2xhc3M9Im11dGVkIj5N4bulYyB0acOqdS9LUEk6ICR7ZXNjYXBlSHRtbChwLmNvbnRlbnRfY29yZXx8IiIpfTwvZGl2PgogICAgPGRpdiBjbGFzcz0iaHIiPjwvZGl2PgogICAgPGRpdj48Yj5OZXh0IEFjdGlvbnM8L2I+ICgke2FjdGlvbnMubGVuZ3RofSk8L2Rpdj4KICAgIDxkaXY+JHthY3Rpb25zLm1hcCgoe2Esbn0pPT4gYDxkaXYgY2xhc3M9ImNoayI+PGlucHV0IHR5cGU9ImNoZWNrYm94IiAke2EuZG9uZT8iY2hlY2tlZCI6IiJ9IGRhdGEtaWQ9IiR7bi5pZH0iIGRhdGEtdGV4dD0iJHtlc2NhcGVIdG1sKGEudGV4dCl9Ij48ZGl2PiR7ZXNjYXBlSHRtbChhLnRleHQpfSA8c3BhbiBjbGFzcz0ibXV0ZWQiPuKAoiB04burPC9zcGFuPiA8aT4ke2VzY2FwZUh0bWwobi50aXRsZSl9PC9pPjwvZGl2PjwvZGl2PmApLmpvaW4oIiIpIHx8ICc8c3BhbiBjbGFzcz0ibXV0ZWQiPkNoxrBhIGPDszwvc3Bhbj4nfTwvZGl2PgogICAgPGRpdiBjbGFzcz0iaHIiPjwvZGl2PgogICAgPGRpdj48Yj5Ob3RlcyBsacOqbiBxdWFuPC9iPiAoJHtyZWxhdGVkLmxlbmd0aH0pPC9kaXY+CiAgICA8dWw+JHtyZWxhdGVkLm1hcChuPT4gYDxsaT4ke25ldyBEYXRlKG4uY3JlYXRlZEF0KS50b0xvY2FsZURhdGVTdHJpbmcoKX0g4oCUICR7ZXNjYXBlSHRtbChuLnRpdGxlKX08L2xpPmApLmpvaW4oIiIpIHx8ICc8c3BhbiBjbGFzcz0ibXV0ZWQiPkNoxrBhIGPDszwvc3Bhbj4nfTwvdWw+CiAgICA8ZGl2IGNsYXNzPSJociI+PC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJpbmxpbmUiPjxidXR0b24gY2xhc3M9ImJ0biBidG4tc20iIGRhdGEtb3A9ImVkaXQiPlPhu61hPC9idXR0b24+PGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zbSBkZXMiIGRhdGEtb3A9ImRlbCI+WMOzYTwvYnV0dG9uPjwvZGl2PmA7CiAgY2FyZC5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsKGUpPT57CiAgICBjb25zdCBiPWUudGFyZ2V0LmNsb3Nlc3QoImJ1dHRvbiIpOyBpZighYikgcmV0dXJuOyBjb25zdCBvcD1iLmdldEF0dHJpYnV0ZSgiZGF0YS1vcCIpOwogICAgaWYob3A9PT0iZWRpdCIpeyBvcGVuRWRpdG9yKHApOyB9CiAgICBlbHNlIGlmKG9wPT09ImRlbCIpeyBpZihjb25maXJtKCJYw7NhIHByb2plY3QgbsOgeT8iKSl7IGl0ZW1zID0gaXRlbXMuZmlsdGVyKHg9PnguaWQhPT1wLmlkKTsgc2F2ZVRvTFMoKTsgcmVuZGVyUHJvamVjdHMoKTsgcmVuZGVyU3RhdHMoKTsgfSB9CiAgfSk7CiAgcmV0dXJuIGNhcmQ7Cn0KCi8qID09PT09PSBBY3Rpb25zIGFnZ3JlZ2F0ZSA9PT09PT0gKi8KZWwuYWN0U2NvcGUuYWRkRXZlbnRMaXN0ZW5lcigiY2hhbmdlIiwgcmVuZGVyQWN0aW9ucyk7CmVsLmFjdFRvcDMuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKT0+ewogIGNvbnN0IHBvb2wgPSBjb2xsZWN0QWN0aW9ucygpLmZpbHRlcih4PT4heC5hLmRvbmUpOwogIHBvb2wuc29ydCgoeCx5KT0+ICggKHguYS5kdWV8fEluZmluaXR5KSAtICh5LmEuZHVlfHxJbmZpbml0eSkgKSB8fCAoeS5uLnVwZGF0ZWRBdCAtIHgubi51cGRhdGVkQXQpICk7CiAgY29uc3QgdG9wMyA9IHBvb2wuc2xpY2UoMCwzKTsKICBhbGVydCgiVG9wIDM6XG4iICsgdG9wMy5tYXAodD0+ICLigKIgIit0LmEudGV4dCsiICAoIisodC5uLmNvbnRleHQ/LnByb2plY3R8fCIiKSsiKSIpLmpvaW4oIlxuIikpOwp9KTsKZnVuY3Rpb24gY29sbGVjdEFjdGlvbnMoKXsgY29uc3Qgb3V0PVtdOyBpdGVtcy5mb3JFYWNoKG49PiAobi5hY3Rpb25zfHxbXSkuZm9yRWFjaCgoYSxpZHgpPT4gb3V0LnB1c2goe2EsIG4sIGlkeH0pKSk7IHJldHVybiBvdXQ7IH0KZnVuY3Rpb24gcmVuZGVyQWN0aW9ucygpewogIGNvbnN0IHNjb3BlID0gZWwuYWN0U2NvcGUudmFsdWU7CiAgY29uc3Qgcm93cyA9IGNvbGxlY3RBY3Rpb25zKCkuc29ydCgoeCx5KT0+ICgoeC5hLmR1ZXx8SW5maW5pdHkpLSh5LmEuZHVlfHxJbmZpbml0eSkpIHx8ICh5Lm4udXBkYXRlZEF0LXgubi51cGRhdGVkQXQpKTsKICBlbC5hY3RSb3dzLmlubmVySFRNTCA9ICIiOwogIGNvbnN0IHRvZGF5ID0gbmV3IERhdGUoKTsgdG9kYXkuc2V0SG91cnMoMCwwLDAsMCk7CiAgcm93cy5mb3JFYWNoKCh7YSxuLGlkeH0pPT57CiAgICBpZihzY29wZT09PSJ0b2RheSIpeyBpZighYS5kdWUpIHJldHVybjsgY29uc3QgZD1uZXcgRGF0ZShhLmR1ZSk7IGQuc2V0SG91cnMoMCwwLDAsMCk7IGlmKGQuZ2V0VGltZSgpIT09dG9kYXkuZ2V0VGltZSgpKSByZXR1cm47IH0KICAgIGlmKHNjb3BlPT09Im92ZXJkdWUiKXsgaWYoIWEuZHVlKSByZXR1cm47IGlmKGEuZHVlID49IHRvZGF5LmdldFRpbWUoKSkgcmV0dXJuOyB9CiAgICBpZihzY29wZT09PSJ3ZWVrIil7IGlmKCFhLmR1ZSkgcmV0dXJuOyBpZihhLmR1ZSA+ICh0b2RheS5nZXRUaW1lKCkrNyoyNCozNjAwKjEwMDApKSByZXR1cm47IH0KICAgIGNvbnN0IHJvdz1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsgcm93LmNsYXNzTmFtZT0iYWN0aW9uLXJvdyI7CiAgICByb3cuaW5uZXJIVE1MID0gYAogICAgICA8ZGl2IGNsYXNzPSIke2EuZG9uZT8nZG9uZSc6Jyd9Ij4ke2VzY2FwZUh0bWwoYS50ZXh0KX08L2Rpdj4KICAgICAgPGRpdj4ke2EuZHVlPyBuZXcgRGF0ZShhLmR1ZSkudG9Mb2NhbGVEYXRlU3RyaW5nKCkgOiAnPHNwYW4gY2xhc3M9Im11dGVkIj7igJQ8L3NwYW4+J308L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0ibXV0ZWQiPiR7ZXNjYXBlSHRtbChuLmNvbnRleHQ/LnByb2plY3R8fCIiKX08L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0ibXV0ZWQgdHJ1bmNhdGUiPiR7ZXNjYXBlSHRtbChuLnRpdGxlKX08L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0iaW5saW5lIj48YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIiBkYXRhLW9wPSJ0b2dnbGUiPiR7YS5kb25lPydVbmRvJzonRG9uZSd9PC9idXR0b24+PGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zbSBkZXMiIGRhdGEtb3A9InJlbW92ZSI+WMOzYTwvYnV0dG9uPjwvZGl2PgogICAgYDsKICAgIHJvdy5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsKGUpPT57CiAgICAgIGNvbnN0IGI9ZS50YXJnZXQuY2xvc2VzdCgiYnV0dG9uIik7IGlmKCFiKSByZXR1cm47CiAgICAgIGNvbnN0IG9wPWIuZ2V0QXR0cmlidXRlKCJkYXRhLW9wIik7CiAgICAgIGlmKG9wPT09InRvZ2dsZSIpeyBhLmRvbmU9IWEuZG9uZTsgbi51cGRhdGVkQXQ9bm93KCk7IHNhdmVUb0xTKCk7IHJlbmRlckFjdGlvbnMoKTsgcmVuZGVyTGlzdCgpOyByZW5kZXJQcm9qZWN0cygpOyB9CiAgICAgIGVsc2UgaWYob3A9PT0icmVtb3ZlIil7IGlmKGNvbmZpcm0oIljDs2EgYWN0aW9uIG7DoHk/IikpeyBuLmFjdGlvbnMuc3BsaWNlKGlkeCwxKTsgbi51cGRhdGVkQXQ9bm93KCk7IHNhdmVUb0xTKCk7IHJlbmRlckFjdGlvbnMoKTsgcmVuZGVyTGlzdCgpOyByZW5kZXJQcm9qZWN0cygpOyB9IH0KICAgIH0pOwogICAgZWwuYWN0Um93cy5hcHBlbmRDaGlsZChyb3cpOwogIH0pOwp9CgovKiA9PT09PT0gUGxheWJvb2s6IHRyYWluaW5nICYgbGludCA9PT09PT0gKi8KZnVuY3Rpb24gbG9hZFRyYWluaW5nKCl7IHRyeXsgY29uc3QgcmF3PWxvY2FsU3RvcmFnZS5nZXRJdGVtKFRSQUlOX0tFWSk7IGlmKCFyYXcpIHJldHVybiB7YzIwOltdLCBjNzpbXX07IGNvbnN0IHM9SlNPTi5wYXJzZShyYXcpOyByZXR1cm4gczsgfWNhdGNoeyByZXR1cm4ge2MyMDpbXSwgYzc6W119OyB9IH0KZnVuY3Rpb24gc2F2ZVRyYWluaW5nKHMpeyBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShUUkFJTl9LRVksIEpTT04uc3RyaW5naWZ5KHMpKTsgfQpmdW5jdGlvbiByZW5kZXJUcmFpbmluZygpeyBjb25zdCBzID0gbG9hZFRyYWluaW5nKCk7IGVsLmMyMC5pbm5lckhUTUwgPSBDMjBfSVRFTVMubWFwKCh0LGkpPT5gPGxhYmVsIGNsYXNzPSJjaGsiPjxpbnB1dCB0eXBlPSJjaGVja2JveCIgZGF0YS1rPSJjMjAiIGRhdGEtaT0iJHtpfSIgJHtzLmMyMC5pbmNsdWRlcyhpKT8nY2hlY2tlZCc6Jyd9PiA8ZGl2PiR7ZXNjYXBlSHRtbCh0KX08L2Rpdj48L2xhYmVsPmApLmpvaW4oIiIpOyBlbC5jNy5pbm5lckhUTUwgPSBDN19JVEVNUy5tYXAoKHQsaSk9PmA8bGFiZWwgY2xhc3M9ImNoayI+PGlucHV0IHR5cGU9ImNoZWNrYm94IiBkYXRhLWs9ImM3IiBkYXRhLWk9IiR7aX0iICR7cy5jNy5pbmNsdWRlcyhpKT8nY2hlY2tlZCc6Jyd9PiA8ZGl2PiR7ZXNjYXBlSHRtbCh0KX08L2Rpdj48L2xhYmVsPmApLmpvaW4oIiIpOyBlbC5jMjAuYWRkRXZlbnRMaXN0ZW5lcigiY2hhbmdlIiwgb25DaGtUcmFpbmluZywge29uY2U6dHJ1ZX0pOyBlbC5jNy5hZGRFdmVudExpc3RlbmVyKCJjaGFuZ2UiLCBvbkNoa1RyYWluaW5nLCB7b25jZTp0cnVlfSk7IH0KZnVuY3Rpb24gb25DaGtUcmFpbmluZyhlKXsgY29uc3QgcyA9IGxvYWRUcmFpbmluZygpOyAkJCgiI3ZpZXctdHJhaW5pbmcgaW5wdXRbdHlwZT1jaGVja2JveF0iKS5mb3JFYWNoKGNoPT57IGNvbnN0IGs9Y2guZ2V0QXR0cmlidXRlKCJkYXRhLWsiKTsgY29uc3QgaT1OdW1iZXIoY2guZ2V0QXR0cmlidXRlKCJkYXRhLWkiKSk7IGlmKGNoLmNoZWNrZWQpeyBpZighc1trXS5pbmNsdWRlcyhpKSkgc1trXS5wdXNoKGkpOyB9IGVsc2UgeyBzW2tdPXNba10uZmlsdGVyKHg9PnghPT1pKTsgfSB9KTsgc2F2ZVRyYWluaW5nKHMpOyByZW5kZXJUcmFpbmluZygpOyB9CmVsLmJ0blN0YXJ0VHJhaW5pbmcuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKT0+eyBzYXZlVHJhaW5pbmcoe2MyMDpbXSwgYzc6W119KTsgcmVuZGVyVHJhaW5pbmcoKTsgfSk7CmVsLmJ0blJlc2V0VHJhaW5pbmcuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKT0+eyBpZihjb25maXJtKCJSZXNldCB0aeG6v24gxJHhu5kgbHV54buHbiB04bqtcD8iKSl7IGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKFRSQUlOX0tFWSk7IHJlbmRlclRyYWluaW5nKCk7IH19KTsKZWwuYnRuTm90aWZ5LmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgYXN5bmMgKCk9PnsgaWYoISgiTm90aWZpY2F0aW9uIiBpbiB3aW5kb3cpKSB7IGFsZXJ0KCJUcsOsbmggZHV54buHdCBraMO0bmcgaOG7lyB0cuG7oyBOb3RpZmljYXRpb24uIik7IHJldHVybjsgfSBpZihOb3RpZmljYXRpb24ucGVybWlzc2lvbiE9PSJncmFudGVkIil7IGF3YWl0IE5vdGlmaWNhdGlvbi5yZXF1ZXN0UGVybWlzc2lvbigpOyB9IGlmKE5vdGlmaWNhdGlvbi5wZXJtaXNzaW9uPT09ImdyYW50ZWQiKXsgYWxlcnQoIkLhuq10IHRow7RuZyBiw6FvOiBz4bq9IHBpbmcgbMO6YyAxMTozMCB2w6AgMTk6MzAga2hpIHRyYW5nIMSRYW5nIG3hu58uIik7IH0gfSk7CnNldEludGVydmFsKCgpPT57IGNvbnN0IGQ9bmV3IERhdGUoKTsgY29uc3QgaD1kLmdldEhvdXJzKCk7IGNvbnN0IG09ZC5nZXRNaW51dGVzKCk7IGlmKCgiTm90aWZpY2F0aW9uIiBpbiB3aW5kb3cpICYmIE5vdGlmaWNhdGlvbi5wZXJtaXNzaW9uPT09ImdyYW50ZWQiKXsgaWYoKGg9PT0xMSAmJiBtPT09MzApIHx8IChoPT09MTkgJiYgbT09PTMwKSl7IG5ldyBOb3RpZmljYXRpb24oIlJldmlldyBJbmJveC9Qcm9qZWN0cyIsIHtib2R5OiLEkOG6v24gZ2nhu50gZOG7jW4gSW5ib3ggJiByw6AgUHJvamVjdHMgKDZBIOKAlCBLZWVwIEFsaXZlKS4ifSk7IH0gfSB9LCA2MCoxMDAwKTsKZnVuY3Rpb24gcmVuZGVyTGludCgpeyBjb25zdCBwcm9ibGVtcyA9IFtdOyBpdGVtcy5mb3JFYWNoKG49PnsgaWYoKG4udGFnc3x8W10pLmxlbmd0aD4yKSBwcm9ibGVtcy5wdXNoKHtpZDpuLmlkLCB0aXRsZTpuLnRpdGxlLCBtc2c6Ij4yIHRhZyA9IG3huqV0IMSR4buLbmggaMaw4bubbmcg4oaSIGPhuq90IGPDsm4gMeKAkzIuIn0pOyB9KTsgaXRlbXMuZm9yRWFjaChuPT57IGlmKChuLmNvbnRlbnR8fCIiKS5sZW5ndGg+MjQwICYmICEobi5jb250ZW50X2NvcmV8fCIiKS50cmltKCkpIHByb2JsZW1zLnB1c2goe2lkOm4uaWQsIHRpdGxlOm4udGl0bGUsIG1zZzoiVGhp4bq/dSBo4bqhdCBuaMOibiAx4oCTMiBjw6J1IChDb25kZW5zZSkuIn0pOyB9KTsgaXRlbXMuZm9yRWFjaChuPT57IGlmKG4udHlwZT09PSJtZWV0aW5nIiAmJiAoIShuLmFjdGlvbnMpfHxuLmFjdGlvbnMubGVuZ3RoPT09MCkpIHByb2JsZW1zLnB1c2goe2lkOm4uaWQsIHRpdGxlOm4udGl0bGUsIG1zZzoiTWVldGluZyBwaOG6o2kgc2luaCDiiaUxICEgY8OzIGRlYWRsaW5lLiJ9KTsgfSk7IGl0ZW1zLmZvckVhY2gobj0+eyBpZihuLnR5cGU9PT0icmVhZGluZyIgJiYgIShuLmNvbnRleHQ/LnNvdXJjZSkpIHByb2JsZW1zLnB1c2goe2lkOm4uaWQsIHRpdGxlOm4udGl0bGUsIG1zZzoiUmVhZGluZyBOb3RlIG7Dqm4gY8OzIG5ndeG7k24gKEF0dGFjaGVkKS4ifSk7IH0pOyBjb25zdCBpbmJveENvdW50ID0gaXRlbXMuZmlsdGVyKG49Pm4uc3RhdHVzPT09ImluYm94IikubGVuZ3RoOyBpZihpbmJveENvdW50PjEwKSBwcm9ibGVtcy5wdXNoKHtpZDoiLSIsIHRpdGxlOiJJbmJveCIsIG1zZzpgSW5ib3ggxJFhbmcgcGjDrG5oICgke2luYm94Q291bnR9KS4gROG7jW4gMiBs4bqnbi9uZ8OgeS5gfSk7IGl0ZW1zLmZvckVhY2gobj0+eyBpZihuLnR5cGU9PT0iZGVjaXNpb24iICYmICFuLnJldmlld19vbikgcHJvYmxlbXMucHVzaCh7aWQ6bi5pZCwgdGl0bGU6bi50aXRsZSwgbXNnOiJEZWNpc2lvbiBMb2cgbsOqbiBjw7MgbmfDoHkgeGVtIGzhuqFpLiJ9KTsgfSk7IGVsLmxpbnRQYW5lbC5pbm5lckhUTUwgPSBwcm9ibGVtcy5sZW5ndGg/IHByb2JsZW1zLm1hcChwPT4gYDxkaXYgY2xhc3M9ImJhbm5lciBiYWQiIHN0eWxlPSJtYXJnaW46NnB4IDAiPjxiPiR7ZXNjYXBlSHRtbChwLnRpdGxlKX08L2I+IOKAlCAke2VzY2FwZUh0bWwocC5tc2cpfTwvZGl2PmApLmpvaW4oIiIpIDogJzxkaXYgY2xhc3M9ImJhbm5lciBnb29kIj5LaMO0bmcgcGjDoXQgaGnhu4duIGzhu5dpIHBo4buVIGJp4bq/bi48L2Rpdj4nOyB9CgovKiA9PT09PT0gU3ltYm9sIHBhcnNpbmcgPT09PT09ICovCmZ1bmN0aW9uIHBhcnNlU3ltYm9scyh0ZXh0KXsKICBjb25zdCBsaW5lcyA9IFN0cmluZyh0ZXh0fHwiIikuc3BsaXQoL1xcbi8pOwogIGNvbnN0IGFjdGlvbnM9W107IGNvbnN0IHBlb3BsZT1uZXcgU2V0KCk7IGNvbnN0IHRhZ3M9bmV3IFNldCgpOwogIGxldCBwcm9qZWN0PW51bGwsIHNvdXJjZT1udWxsLCByZXZpZXc9bnVsbCwgYmxvY2tlcj1mYWxzZSwgY29yZT0iIjsKICBmb3IoY29uc3QgcmF3IG9mIGxpbmVzKXsKICAgIGNvbnN0IGxpbmUgPSByYXcudHJpbSgpOwogICAgaWYoIWxpbmUpIGNvbnRpbnVlOwogICAgaWYobGluZS5zdGFydHNXaXRoKCIhIikpeyBjb25zdCBtPWxpbmUucmVwbGFjZSgvXiFcXHMqLywiIik7IGFjdGlvbnMucHVzaCh7dGV4dDptLCBkb25lOmZhbHNlfSk7IGNvbnRpbnVlOyB9CiAgICBpZihsaW5lLnN0YXJ0c1dpdGgoIl4iKSl7IGlmKCFjb3JlKSBjb3JlID0gbGluZS5yZXBsYWNlKC9eXFxeXFxzKi8sIiIpOyBjb250aW51ZTsgfQogICAgaWYobGluZS5zdGFydHNXaXRoKCI/Iil8fGxpbmUuc3RhcnRzV2l0aCgiJCIpfHxsaW5lLnN0YXJ0c1dpdGgoIj4iKXx8bGluZS5zdGFydHNXaXRoKCJ+IikpeyBjb250aW51ZTsgfQogICAgKGxpbmUubWF0Y2goLyhefFxccylAW1xccHtMfTAtOV9cXC1dKy9ndSl8fFtdKS5mb3JFYWNoKHRvaz0+IHBlb3BsZS5hZGQodG9rLnRyaW0oKS5yZXBsYWNlKC9eQC8sIiIpKSk7CiAgICAobGluZS5tYXRjaCgvKF58XFxzKSNbXFxwe0x9MC05X1xcLV0rL2d1KXx8W10pLmZvckVhY2godG9rPT4gdGFncy5hZGQodG9rLnRyaW0oKS5yZXBsYWNlKC9eIy8sIiIpKSk7CiAgICBjb25zdCBwaiA9IGxpbmUubWF0Y2goL3Byb2plY3Q6KFthLXowLTlcXC1dKykvaSk7IGlmKHBqKSBwcm9qZWN0ID0gcGpbMV07CiAgICBjb25zdCBzYyA9IGxpbmUubWF0Y2goL3NvdXJjZTooW15cXHNdKykvaSk7IGlmKHNjKSBzb3VyY2UgPSBzY1sxXTsKICAgIGNvbnN0IHJ2ID0gbGluZS5tYXRjaCgvcmV2aWV3OihcXGR7NH0tXFxkezJ9LVxcZHsyfSkvaSk7IGlmKHJ2KSByZXZpZXcgPSBuZXcgRGF0ZShydlsxXSsiVDAwOjAwOjAwIikuZ2V0VGltZSgpOwogICAgaWYoL1xcYmJsb2NrZXJcXGIvaS50ZXN0KGxpbmUpKSBibG9ja2VyPXRydWU7CiAgfQogIHJldHVybiB7IGFjdGlvbnMsIHBlb3BsZTpbLi4ucGVvcGxlXSwgdGFnczpbLi4udGFnc10uc2xpY2UoMCwyKSwgcHJvamVjdCwgc291cmNlLCByZXZpZXcsIGJsb2NrZXIsIGNvcmUgfTsKfQoKLyogPT09PT09IEltcG9ydC9FeHBvcnQvSUNTID09PT09PSAqLwplbC5idG5FeHBvcnQuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCgpPT4gZG93bmxvYWRKc29uKCJrdi1mdWxsLXY3LSIrbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnNsaWNlKDAsMTApKyIuanNvbiIsIGl0ZW1zKSk7CmVsLmJ0bkltcG9ydC5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsKCk9PiBlbC5pbXBvcnRGaWxlLmNsaWNrKCkpOwplbC5pbXBvcnRGaWxlLmFkZEV2ZW50TGlzdGVuZXIoImNoYW5nZSIsICgpPT57CiAgY29uc3QgZiA9IGVsLmltcG9ydEZpbGUuZmlsZXNbMF07IGVsLmltcG9ydEZpbGUudmFsdWU9IiI7CiAgaWYoIWYpIHJldHVybjsKICBjb25zdCBmciA9IG5ldyBGaWxlUmVhZGVyKCk7CiAgZnIub25sb2FkID0gKCk9PnsKICAgIHRyeXsKICAgICAgY29uc3QgcGFyc2VkID0gSlNPTi5wYXJzZShTdHJpbmcoZnIucmVzdWx0KSk7CiAgICAgIGlmKCFBcnJheS5pc0FycmF5KHBhcnNlZCkpIHRocm93IG5ldyBFcnJvcigiU2FpIMSR4buLbmggZOG6oW5nLiBD4bqnbiBt4bqjbmcgSlNPTi4iKTsKICAgICAgY29uc3QgbWVyZ2VkID0ge307IFsuLi5pdGVtcywgLi4ucGFyc2VkXS5mb3JFYWNoKHJhdz0+eyBjb25zdCBpdD1zYW5pdGl6ZU5vdGUocmF3KTsgbWVyZ2VkW2l0LmlkXT1pdDsgfSk7CiAgICAgIGl0ZW1zID0gT2JqZWN0LnZhbHVlcyhtZXJnZWQpLnNvcnQoKGEsYik9PiBiLnVwZGF0ZWRBdCAtIGEudXBkYXRlZEF0KTsKICAgICAgc2F2ZVRvTFMoKTsgcmVuZGVyQWxsKCk7IHJlbmRlclN0YXRzKCk7IHJlYnVpbGRNZXRhKCk7CiAgICB9Y2F0Y2goZSl7IGFsZXJ0KCJLaMO0bmcgdGjhu4Mgbmjhuq1wOiAiK2UubWVzc2FnZSk7IH0KICB9OwogIGZyLnJlYWRBc1RleHQoZik7Cn0pOwplbC5idG5JY3MuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKT0+ewogIGNvbnN0IGxpbmVzID0gWyJCRUdJTjpWQ0FMRU5EQVIiLCJWRVJTSU9OOjIuMCIsIlBST0RJRDotLy9UMDQvL0tWLy9WSSJdOwogIGNvbnN0IGVzYyA9IHMgPT4gU3RyaW5nKHMpLnJlcGxhY2UoL1ssO10vZywgbT0+IG09PT0iLCI/IlxcLCI6IlxcOyIpOwogIGNvbnN0IGR0c3RhbXAgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkucmVwbGFjZSgvWy06XS9nLCIiKS5yZXBsYWNlKC9cXC5cXGQrWiQvLCJaIik7CiAgaXRlbXMuZm9yRWFjaChuPT57CiAgICAobi5hY3Rpb25zfHxbXSkuZm9yRWFjaCgoYSxpZHgpPT57CiAgICAgIGlmKCFhLmR1ZSkgcmV0dXJuOwogICAgICBjb25zdCBkID0gbmV3IERhdGUoYS5kdWUpOyBjb25zdCBkc3RyID0gZC50b0lTT1N0cmluZygpLnJlcGxhY2UoL1stOl0vZywiIikucmVwbGFjZSgvXFwuXFxkK1okLywiWiIpOwogICAgICBjb25zdCB1aWQgPSBuLmlkKyItQSIraWR4KyJAa3YiOwogICAgICBsaW5lcy5wdXNoKCJCRUdJTjpWRVZFTlQiLCJVSUQ6Iit1aWQsIkRUU1RBTVA6IitkdHN0YW1wLCJEVFNUQVJUOiIrZHN0ciwiU1VNTUFSWToiK2VzYygiISAiK2EudGV4dCsiIFsiKyhuLmNvbnRleHQ/LnByb2plY3R8fCIiKSsiXSIpLCJERVNDUklQVElPTjoiK2VzYyhuLnRpdGxlKSwiRU5EOlZFVkVOVCIpOwogICAgfSk7CiAgICBpZihuLnJldmlld19vbil7CiAgICAgIGNvbnN0IGQgPSBuZXcgRGF0ZShuLnJldmlld19vbik7IGNvbnN0IGRzdHIgPSBkLnRvSVNPU3RyaW5nKCkucmVwbGFjZSgvWy06XS9nLCIiKS5yZXBsYWNlKC9cXC5cXGQrWiQvLCJaIik7CiAgICAgIGNvbnN0IHVpZCA9IG4uaWQrIi1SQGt2IjsKICAgICAgbGluZXMucHVzaCgiQkVHSU46VkVWRU5UIiwiVUlEOiIrdWlkLCJEVFNUQU1QOiIrZHRzdGFtcCwiRFRTVEFSVDoiK2RzdHIsIlNVTU1BUlk6Iitlc2MoIlJldmlldzogIituLnRpdGxlKSwiREVTQ1JJUFRJT046Iitlc2Mobi5jb250ZW50X2NvcmV8fCIiKSwiRU5EOlZFVkVOVCIpOwogICAgfQogIH0pOwogIGxpbmVzLnB1c2goIkVORDpWQ0FMRU5EQVIiKTsKICBjb25zdCBibG9iID0gbmV3IEJsb2IoW2xpbmVzLmpvaW4oIlxcclxcbiIpXSwge3R5cGU6InRleHQvY2FsZW5kYXIifSk7CiAgY29uc3QgdXJsID0gVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKTsgY29uc3QgYT1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7IGEuaHJlZj11cmw7IGEuZG93bmxvYWQ9Imt2LWFjdGlvbnMtcmV2aWV3LmljcyI7IGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoYSk7IGEuY2xpY2soKTsgYS5yZW1vdmUoKTsgVVJMLnJldm9rZU9iamVjdFVSTCh1cmwpOwp9KTsKCi8qID09PT09PSBUcmFuc2NyaWJlIChPQ1IvUERGL0RPQ1gg4oaSIHRleHQpID09PT09PSAqLwphc3luYyBmdW5jdGlvbiBsb2FkU2NyaXB0KHNyYyl7IHJldHVybiBuZXcgUHJvbWlzZSgocmVzLHJlaik9PnsgY29uc3Qgcz1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsgcy5zcmM9c3JjOyBzLmFzeW5jPXRydWU7IHMub25sb2FkPSgpPT5yZXMoKTsgcy5vbmVycm9yPSgpPT5yZWoobmV3IEVycm9yKCdLaMO0bmcgdOG6o2kgxJHGsOG7o2MgJytzcmMpKTsgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzKTsgfSk7IH0KYXN5bmMgZnVuY3Rpb24gZW5zdXJlTWFtbW90aCgpeyBpZih3aW5kb3cubWFtbW90aCkgcmV0dXJuOyBhd2FpdCBsb2FkU2NyaXB0KCdodHRwczovL2Nkbi5qc2RlbGl2ci5uZXQvbnBtL21hbW1vdGhAMS41LjEvbWFtbW90aC5icm93c2VyLm1pbi5qcycpOyB9CmFzeW5jIGZ1bmN0aW9uIGVuc3VyZVBERkpTKCl7IGlmKHdpbmRvdy5wZGZqc0xpYikgcmV0dXJuOyBhd2FpdCBsb2FkU2NyaXB0KCdodHRwczovL2Nkbi5qc2RlbGl2ci5uZXQvbnBtL3BkZmpzLWRpc3RAMy4xMS4xNzQvYnVpbGQvcGRmLm1pbi5qcycpOyBwZGZqc0xpYi5HbG9iYWxXb3JrZXJPcHRpb25zLndvcmtlclNyYz0naHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L25wbS9wZGZqcy1kaXN0QDMuMTEuMTc0L2J1aWxkL3BkZi53b3JrZXIubWluLmpzJzsgfQphc3luYyBmdW5jdGlvbiBlbnN1cmVUZXNzZXJhY3QoKXsgaWYod2luZG93LlRlc3NlcmFjdCkgcmV0dXJuOyBhd2FpdCBsb2FkU2NyaXB0KCdodHRwczovL2Nkbi5qc2RlbGl2ci5uZXQvbnBtL3Rlc3NlcmFjdC5qc0A0L2Rpc3QvdGVzc2VyYWN0Lm1pbi5qcycpOyB9CmZ1bmN0aW9uIHNldFByb2cocCl7IGlmKCFlbC50ci5wcm9nKSByZXR1cm47IGVsLnRyLnByb2cuc3R5bGUud2lkdGggPSBNYXRoLm1heCgwLE1hdGgubWluKDEwMCxwKSkgKyAnJSc7IH0KYXN5bmMgZnVuY3Rpb24gaGFuZGxlRmlsZShmaWxlKXsKICBpZighZmlsZSkgcmV0dXJuOyBzZXRQcm9nKDUpOwogIGNvbnN0IG5hbWUgPSBmaWxlLm5hbWV8fCdpbnB1dCc7IGNvbnN0IGV4dCA9IChuYW1lLnNwbGl0KCcuJykucG9wKCl8fCcnKS50b0xvd2VyQ2FzZSgpOwogIHRyeXsKICAgIGlmKGV4dD09PSd0eHQnIHx8IGV4dD09PSdtZCcpeyBjb25zdCB0ZXh0ID0gYXdhaXQgZmlsZS50ZXh0KCk7IGVsLnRyLnRleHQudmFsdWUgPSB0ZXh0OyBzZXRQcm9nKDEwMCk7IHJldHVybjsgfQogICAgaWYoZXh0PT09J2RvY3gnKXsgYXdhaXQgZW5zdXJlTWFtbW90aCgpOyBzZXRQcm9nKDIwKTsgY29uc3QgYXJyYXlCdWZmZXIgPSBhd2FpdCBmaWxlLmFycmF5QnVmZmVyKCk7IGNvbnN0IHt2YWx1ZTpodG1sfSA9IGF3YWl0IG1hbW1vdGguY29udmVydFRvSHRtbCh7YXJyYXlCdWZmZXJ9KTsgY29uc3QgZGl2PWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOyBkaXYuaW5uZXJIVE1MPWh0bWw7IGVsLnRyLnRleHQudmFsdWUgPSAoZGl2LnRleHRDb250ZW50fHwnJykudHJpbSgpOyBzZXRQcm9nKDEwMCk7IHJldHVybjsgfQogICAgaWYoZXh0PT09J3BkZicpeyBhd2FpdCBlbnN1cmVQREZKUygpOyBzZXRQcm9nKDIwKTsgY29uc3QgYXJyYXlCdWZmZXIgPSBhd2FpdCBmaWxlLmFycmF5QnVmZmVyKCk7IGNvbnN0IHBkZiA9IGF3YWl0IHBkZmpzTGliLmdldERvY3VtZW50KHtkYXRhOiBhcnJheUJ1ZmZlcn0pLnByb21pc2U7IGxldCB0ZXh0PScnOyBmb3IobGV0IGk9MTtpPD1wZGYubnVtUGFnZXM7aSsrKXsgY29uc3QgcGFnZSA9IGF3YWl0IHBkZi5nZXRQYWdlKGkpOyBjb25zdCBjb250ZW50ID0gYXdhaXQgcGFnZS5nZXRUZXh0Q29udGVudCgpOyBjb25zdCBzID0gY29udGVudC5pdGVtcy5tYXAoaXQ9PiBpdC5zdHIpLmpvaW4oJyAnKTsgdGV4dCArPSBzICsgJ1xcblxcbic7IHNldFByb2coMjAgKyBNYXRoLnJvdW5kKDgwKmkvcGRmLm51bVBhZ2VzKSk7IH0gZWwudHIudGV4dC52YWx1ZSA9IHRleHQudHJpbSgpOyBzZXRQcm9nKDEwMCk7IHJldHVybjsgfQogICAgaWYoWydwbmcnLCdqcGcnLCdqcGVnJywnd2VicCddLmluY2x1ZGVzKGV4dCkpeyBhd2FpdCBlbnN1cmVUZXNzZXJhY3QoKTsgc2V0UHJvZygxMCk7IGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgVGVzc2VyYWN0LnJlY29nbml6ZShmaWxlLCAndmllK2VuZycsIHsgbG9nZ2VyOiBtID0+IHsgaWYobS5zdGF0dXM9PT0ncmVjb2duaXppbmcgdGV4dCcgJiYgbS5wcm9ncmVzcyE9bnVsbCkgc2V0UHJvZyhNYXRoLnJvdW5kKDEwICsgOTAqbS5wcm9ncmVzcykpOyB9IH0pOyBlbC50ci50ZXh0LnZhbHVlID0gKGRhdGEgJiYgZGF0YS50ZXh0KSA/IGRhdGEudGV4dC50cmltKCkgOiAnJzsgc2V0UHJvZygxMDApOyByZXR1cm47IH0KICAgIGFsZXJ0KCfEkOG7i25oIGThuqFuZyBjaMawYSBo4buXIHRy4bujOiAnK2V4dCk7IHNldFByb2coMCk7CiAgfWNhdGNoKGUpeyBjb25zb2xlLmVycm9yKGUpOyBhbGVydCgnTOG7l2kga2hpIHjhu60gbMO9IHThu4dwOiAnK2UubWVzc2FnZSk7IHNldFByb2coMCk7IH0KfQppZihlbC50ciAmJiBlbC50ci5kcm9wKXsKICBjb25zdCBkeiA9IGVsLnRyLmRyb3A7CiAgZHouYWRkRXZlbnRMaXN0ZW5lcignZHJhZ292ZXInLCBlPT57IGUucHJldmVudERlZmF1bHQoKTsgZHouY2xhc3NMaXN0LmFkZCgnZHJhZycpOyB9KTsKICBkei5hZGRFdmVudExpc3RlbmVyKCdkcmFnbGVhdmUnLCBlPT57IGR6LmNsYXNzTGlzdC5yZW1vdmUoJ2RyYWcnKTsgfSk7CiAgZHouYWRkRXZlbnRMaXN0ZW5lcignZHJvcCcsIGU9PnsgZS5wcmV2ZW50RGVmYXVsdCgpOyBkei5jbGFzc0xpc3QucmVtb3ZlKCdkcmFnJyk7IGNvbnN0IGY9ZS5kYXRhVHJhbnNmZXIuZmlsZXM/LlswXTsgaGFuZGxlRmlsZShmKTsgfSk7CiAgZWwudHIuZmlsZS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoKT0+eyBjb25zdCBmPWVsLnRyLmZpbGUuZmlsZXM/LlswXTsgaWYoZil7IGhhbmRsZUZpbGUoZik7IH0gfSk7CiAgZWwudHIuY2xlYXIuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+eyBlbC50ci50ZXh0LnZhbHVlPScnOyBlbC50ci5maWxlLnZhbHVlPScnOyBzZXRQcm9nKDApOyB9KTsKICBlbC50ci5zcGVhay5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT57IGNvbnN0IHRleHQgPSBlbC50ci50ZXh0LnZhbHVlLnRyaW0oKTsgaWYoIXRleHQpeyBhbGVydCgnQ2jGsGEgY8OzIHbEg24gYuG6o24uJyk7IHJldHVybjsgfSBjb25zdCBmYWtlID0geyBpZDondHJhbnNjcmliZScsIHRpdGxlOidUcmFuc2NyaWJlJywgY29udGVudF9jb3JlOiB0ZXh0LnNsaWNlKDAsMTIwKSwgY29udGVudDogdGV4dCB9OyBzcGVha05vdGUoZmFrZSk7IH0pOwogIGVsLnRyLnN0b3AuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBzdG9wU3BlYWspOwogIGVsLnRyLnRvSW5ib3guYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+eyBjb25zdCB0ZXh0ID0gZWwudHIudGV4dC52YWx1ZS50cmltKCk7IGlmKCF0ZXh0KXsgYWxlcnQoJ0NoxrBhIGPDsyB2xINuIGLhuqNuLicpOyByZXR1cm47IH0gY29uc3QgdHM9bm93KCk7IGNvbnN0IGlkPXl5eXltbWRkX2hobW0odHMpKyctdHJhbnNjcmliZSc7IGl0ZW1zLnVuc2hpZnQoeyBpZCwgc3RhdHVzOidpbmJveCcsIHR5cGU6J25vdGUnLCB0aXRsZTogdGV4dC5zcGxpdCgnXFxuJylbMF0uc2xpY2UoMCw4MCl8fCdUcmFuc2NyaWJlJywgY29udGVudF9jb3JlOiB0ZXh0LnNsaWNlKDAsMjAwKSwgY29udGVudDogdGV4dCwgYWN0aW9uczpbXSwgdGFnczpbXSwgY29udGV4dDp7fSwgY3JlYXRlZEF0OnRzLCB1cGRhdGVkQXQ6dHMgfSk7IHNhdmVUb0xTKCk7IHJlbmRlclN0YXRzKCk7IHJlbmRlckluYm94KCk7IGFsZXJ0KCfEkMOjIHRow6ptIHbDoG8gSW5ib3guJyk7IH0pOwp9CgoKLyogPT09PT09IHY3LjEgUGF0Y2g6IFRUUyBsaXN0LCBzaG9ydGN1dHMsIEVzYyBjbG9zZSwgYXV0by1iYWNrdXAgPT09PT09ICovCi8vIFRUUyBsaXN0IHF1ZXVlCmxldCB0dHNRdWV1ZSA9IFtdOwpmdW5jdGlvbiBzcGVha1F1ZXVlKGxpc3QpewogIGlmKCFsaXN0IHx8ICFsaXN0Lmxlbmd0aCl7IHJldHVybjsgfQogIGNvbnN0IG4gPSBsaXN0LnNoaWZ0KCk7CiAgY29uc3QgdXQgPSBuZXcgU3BlZWNoU3ludGhlc2lzVXR0ZXJhbmNlKFtuLnRpdGxlfHwnJywgbi5jb250ZW50X2NvcmV8fCcnLCBuLmNvbnRlbnR8fCcnXS5qb2luKCcuICcpLnJlcGxhY2UoL1xzKy9nLCcgJykudHJpbSgpKTsKICBjb25zdCB2ID0gKHR5cGVvZiBwaWNrVm9pY2U9PT0nZnVuY3Rpb24nKSA/IHBpY2tWb2ljZSgpIDogbnVsbDsKICBpZih2KXsgdXQudm9pY2U9djsgdXQubGFuZz12LmxhbmcgfHwgJ3ZpLVZOJzsgfQogIHV0Lm9uZW5kID0gKCk9PiBzcGVha1F1ZXVlKGxpc3QpOwogIHV0Lm9uZXJyb3IgPSAoKT0+IHNwZWFrUXVldWUobGlzdCk7CiAgc3BlYWtpbmdJZCA9IG4uaWQgfHwgbnVsbDsKICB0cnl7IGlmKHR5cGVvZiByZWZyZXNoVFRTQnV0dG9ucz09PSdmdW5jdGlvbicpIHJlZnJlc2hUVFNCdXR0b25zKCk7IH1jYXRjaChfKXt9CiAgc3BlZWNoU3ludGhlc2lzLnNwZWFrKHV0KTsKfQpmdW5jdGlvbiBnZXRNYXRjaGVkTGlzdCgpewogIHRyeXsKICAgIGNvbnN0IGFyciA9IHNvcnRJdGVtcyhpdGVtcy5maWx0ZXIoaXQ9Pml0LnN0YXR1cz09PSdhY3RpdmUnKS5maWx0ZXIoaXRlbU1hdGNoZXMpKTsKICAgIHJldHVybiBhcnI7CiAgfWNhdGNoKGUpeyByZXR1cm4gW107IH0KfQpjb25zdCBidG5TcGVha0xpc3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuLXNwZWFrLWxpc3QnKTsKaWYoYnRuU3BlYWtMaXN0KXsKICBidG5TcGVha0xpc3QuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+ewogICAgdHJ5eyBpZihzcGVlY2hTeW50aGVzaXMuc3BlYWtpbmcpIHNwZWVjaFN5bnRoZXNpcy5jYW5jZWwoKTsgfWNhdGNoKF8pe30KICAgIHR0c1F1ZXVlID0gZ2V0TWF0Y2hlZExpc3QoKS5zbGljZSgpOwogICAgaWYoIXR0c1F1ZXVlLmxlbmd0aCl7IGFsZXJ0KCdEYW5oIHPDoWNoIMSRYW5nIGzhu41jIHRy4buRbmcuJyk7IHJldHVybjsgfQogICAgc3BlYWtRdWV1ZSh0dHNRdWV1ZSk7CiAgfSk7Cn0KY29uc3QgYnRuU3RvcExpc3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuLXN0b3AtbGlzdCcpOwppZihidG5TdG9wTGlzdCl7IGJ0blN0b3BMaXN0LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnsgdHJ5eyBzcGVlY2hTeW50aGVzaXMuY2FuY2VsKCk7IH1jYXRjaChfKXsgfSB0dHNRdWV1ZT1bXTsgc3BlYWtpbmdJZD1udWxsOyB0cnl7IHJlZnJlc2hUVFNCdXR0b25zKCk7IH1jYXRjaChfKXt9fSk7IH0KCi8vIEtleWJvYXJkIHNob3J0Y3V0cwpkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpPT57CiAgaWYoZS5jdHJsS2V5ICYmIGUua2V5LnRvTG93ZXJDYXNlKCk9PT0ncycpeyBlLnByZXZlbnREZWZhdWx0KCk7IGNvbnN0IHNhdmVCdG49ZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2NhcC1zYXZlLCAjZS1zYXZlJyk7IHNhdmVCdG4gJiYgc2F2ZUJ0bi5jbGljaygpOyB9CiAgaWYoZS5jdHJsS2V5ICYmIGUua2V5LnRvTG93ZXJDYXNlKCk9PT0nZicpeyBlLnByZXZlbnREZWZhdWx0KCk7IGNvbnN0IHE9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3EnKTsgaWYocSl7IHEuZm9jdXMoKTsgcS5zZWxlY3QoKTsgfSB9CiAgaWYoZS5hbHRLZXkgJiYgZS5rZXk9PT0nMScpeyBjb25zdCB0PWRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyN0YWJzIFtkYXRhLXRhYj0iaW5ib3giXScpOyB0JiZ0LmNsaWNrKCk7IH0KICBpZihlLmFsdEtleSAmJiBlLmtleT09PScyJyl7IGNvbnN0IHQ9ZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI3RhYnMgW2RhdGEtdGFiPSJub3RlcyJdJyk7IHQmJnQuY2xpY2soKTsgfQogIGlmKGUuYWx0S2V5ICYmIGUua2V5PT09JzMnKXsgY29uc3QgdD1kb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjdGFicyBbZGF0YS10YWI9InByb2plY3RzIl0nKTsgdCYmdC5jbGljaygpOyB9CiAgaWYoZS5hbHRLZXkgJiYgZS5rZXk9PT0nNCcpeyBjb25zdCB0PWRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyN0YWJzIFtkYXRhLXRhYj0iYWN0aW9ucyJdJyk7IHQmJnQuY2xpY2soKTsgfQp9KTsKLy8gRXNjYXBlIGNsb3NlcyBvcGVuIHBhbmVscy9tZW51cwpkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpPT57CiAgaWYoZS5rZXk9PT0nRXNjYXBlJyl7CiAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcucGFuZWwub3BlbiwgZGV0YWlsc1tvcGVuXScpLmZvckVhY2goZWw9PnsKICAgICAgaWYoZWwudGFnTmFtZS50b0xvd2VyQ2FzZSgpPT09J2RldGFpbHMnKXsgZWwub3Blbj1mYWxzZTsgfSBlbHNlIHsgZWwuY2xhc3NMaXN0LnJlbW92ZSgnb3BlbicpOyB9CiAgICB9KTsKICAgIGNvbnN0IG09ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21lbnUtdGFncycpOyBtICYmIG0uY2xhc3NMaXN0LmFkZCgnaGlkZScpOwogIH0KfSk7CgovLyBBdXRvLWJhY2t1cCBMUyBldmVyeSAxMmgKKGZ1bmN0aW9uIGF1dG9CYWNrdXAoKXsKICB0cnl7CiAgICBjb25zdCBCS19LRVkgPSAna3YuYmFja3VwLnRzJzsKICAgIGNvbnN0IEJLX0lWTCA9IDEyKjM2MDAqMTAwMDsKICAgIGNvbnN0IGxhc3QgPSBwYXJzZUludChsb2NhbFN0b3JhZ2UuZ2V0SXRlbShCS19LRVkpfHwnMCcsMTApOwogICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKICAgIGlmKG5vdyAtIGxhc3QgPiBCS19JVkwpewogICAgICBsZXQgZGF0YT1udWxsOwogICAgICB0cnl7CiAgICAgICAgY29uc3Qga2V5ID0gKHR5cGVvZiBMU19LRVkhPT0ndW5kZWZpbmVkJykgPyBMU19LRVkgOiBudWxsOwogICAgICAgIGRhdGEgPSBrZXkgPyBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleSl8fCdbXScpIDogbnVsbDsKICAgICAgfWNhdGNoKF8peyBkYXRhID0gbnVsbDsgfQogICAgICBpZighZGF0YSl7CiAgICAgICAgY29uc3QgZHVtcCA9IHt9OwogICAgICAgIGZvcihsZXQgaT0wO2k8bG9jYWxTdG9yYWdlLmxlbmd0aDtpKyspewogICAgICAgICAgY29uc3QgayA9IGxvY2FsU3RvcmFnZS5rZXkoaSk7CiAgICAgICAgICBpZigvXmt2XC4vLnRlc3QoaykpIGR1bXBba109bG9jYWxTdG9yYWdlLmdldEl0ZW0oayk7CiAgICAgICAgfQogICAgICAgIGRhdGEgPSBkdW1wOwogICAgICB9CiAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbSlNPTi5zdHJpbmdpZnkoZGF0YSxudWxsLDIpXSwge3R5cGU6J2FwcGxpY2F0aW9uL2pzb24nfSk7CiAgICAgIGEuaHJlZiA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7CiAgICAgIGNvbnN0IHN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnNsaWNlKDAsMTkpLnJlcGxhY2UoL1tUOl0vZywnLScpOwogICAgICBhLmRvd25sb2FkID0gJ2tub3dsZWRnZV92YXVsdF8nK3N0YW1wKycuanNvbic7CiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoYSk7IGEuY2xpY2soKTsgYS5yZW1vdmUoKTsKICAgICAgc2V0VGltZW91dCgoKT0+VVJMLnJldm9rZU9iamVjdFVSTChhLmhyZWYpLCAyMDAwKTsKICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oQktfS0VZLCBTdHJpbmcobm93KSk7CiAgICB9CiAgfWNhdGNoKF8pe30KICBzZXRUaW1lb3V0KGF1dG9CYWNrdXAsIDMwKjYwKjEwMDApOyAvLyBjaGVjayBldmVyeSAzMCBtaW4KfSkoKTsKCgoKLyogPT09PT09IHY3LjIgUGF0Y2g6IFRUUyBwcmVmcywgZXhwb3J0IENTVi9NRCwgYXV0byB0YWJsZSwgY29uZmlndXJhYmxlIG5vdGlmeSA9PT09PT0gKi8KLy8gVFRTIFByZWZlcmVuY2VzCmZ1bmN0aW9uIGdldFRUU0NvbmYoKXsKICB0cnl7CiAgICByZXR1cm4gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgna3YudHRzJyl8fCd7fScpOwogIH1jYXRjaChfKXsgcmV0dXJuIHt9OyB9Cn0KZnVuY3Rpb24gc2V0VFRTQ29uZihjKXsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2t2LnR0cycsIEpTT04uc3RyaW5naWZ5KGN8fHt9KSk7IH0KZnVuY3Rpb24gZ2V0UHJlZmVycmVkVm9pY2UoKXsKICB0cnl7CiAgICBjb25zdCBjb25mID0gZ2V0VFRTQ29uZigpOwogICAgaWYoY29uZi52b2ljZU5hbWUgJiYgQXJyYXkuaXNBcnJheSh2b2ljZXMpKXsKICAgICAgY29uc3QgdiA9IHZvaWNlcy5maW5kKHg9PiB4Lm5hbWU9PT1jb25mLnZvaWNlTmFtZSkgfHwgdm9pY2VzLmZpbmQodj0+L3ZpKC18XylWTi9pLnRlc3Qodi5sYW5nKSkgfHwgdm9pY2VzLmZpbmQodj0+L2VuKC18XylVUy9pLnRlc3Qodi5sYW5nKSk7CiAgICAgIHJldHVybiB2IHx8ICh2b2ljZXNbMF18fG51bGwpOwogICAgfQogIH1jYXRjaChfKXt9CiAgcmV0dXJuIChBcnJheS5pc0FycmF5KHZvaWNlcykgJiYgKHZvaWNlcy5maW5kKHY9Pi92aSgtfF8pVk4vaS50ZXN0KHYubGFuZykpIHx8IHZvaWNlcy5maW5kKHY9Pi9lbigtfF8pVVMvaS50ZXN0KHYubGFuZykpIHx8IHZvaWNlc1swXSkpIHx8IG51bGw7Cn0KZnVuY3Rpb24gZ2V0VFRTUmF0ZSgpeyBjb25zdCBjPWdldFRUU0NvbmYoKTsgcmV0dXJuIChjLnJhdGUgJiYgYy5yYXRlPj0wLjUgJiYgYy5yYXRlPD0yKT8gYy5yYXRlIDogMTsgfQoKLy8gT3ZlcnJpZGUgc3BlYWtOb3RlIHRvIGFwcGx5IHByZWZzIChyYXRlL3ZvaWNlKQooZnVuY3Rpb24oKXsKICBjb25zdCBfb3JpZyA9ICh0eXBlb2Ygc3BlYWtOb3RlPT09J2Z1bmN0aW9uJykgPyBzcGVha05vdGUgOiBudWxsOwogIHdpbmRvdy5zcGVha05vdGUgPSBmdW5jdGlvbihuKXsKICAgIGlmKCEoJ3NwZWVjaFN5bnRoZXNpcycgaW4gd2luZG93KSkgeyBhbGVydCgnVHLDrG5oIGR1eeG7h3Qga2jDtG5nIGjhu5cgdHLhu6MgxJHhu41jIGzDqm4uJyk7IHJldHVybjsgfQogICAgdHJ5eyBzcGVlY2hTeW50aGVzaXMuY2FuY2VsKCk7IH1jYXRjaChfKXt9CiAgICBjb25zdCBwYXJ0cz1bXTsKICAgIGlmKG4udGl0bGUpIHBhcnRzLnB1c2gobi50aXRsZSk7CiAgICBpZihuLmNvbnRlbnRfY29yZSkgcGFydHMucHVzaChuLmNvbnRlbnRfY29yZSk7CiAgICBpZihuLmNvbnRlbnQpIHBhcnRzLnB1c2goU3RyaW5nKG4uY29udGVudCkucmVwbGFjZSgvWyNAIV4/JD5+XS9nLCcnKSk7CiAgICBjb25zdCB1dCA9IG5ldyBTcGVlY2hTeW50aGVzaXNVdHRlcmFuY2UocGFydHMuam9pbignLiAnKS5yZXBsYWNlKC9ccysvZywnICcpLnRyaW0oKSk7CiAgICBjb25zdCB2ID0gZ2V0UHJlZmVycmVkVm9pY2UoKTsKICAgIGlmKHYpeyB1dC52b2ljZT12OyB1dC5sYW5nPXYubGFuZyB8fCAndmktVk4nOyB9CiAgICB1dC5yYXRlID0gZ2V0VFRTUmF0ZSgpOwogICAgdXQub25lbmQgPSAoKT0+eyBzcGVha2luZ0lkPW51bGw7IHRyeXsgcmVmcmVzaFRUU0J1dHRvbnMoKTsgfWNhdGNoKF8pe30gfTsKICAgIHV0Lm9uZXJyb3IgPSAoKT0+eyBzcGVha2luZ0lkPW51bGw7IHRyeXsgcmVmcmVzaFRUU0J1dHRvbnMoKTsgfWNhdGNoKF8pe30gfTsKICAgIHNwZWFraW5nSWQgPSBuLmlkOyB0cnl7IHJlZnJlc2hUVFNCdXR0b25zKCk7IH1jYXRjaChfKXt9CiAgICBzcGVlY2hTeW50aGVzaXMuc3BlYWsodXQpOwogIH07Cn0pKCk7CgovLyBQb3B1bGF0ZSBUVFMgc2V0dGluZ3MgVUkKKGZ1bmN0aW9uKCl7CiAgY29uc3Qgc1ZvaWNlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3R0cy12b2ljZScpOwogIGNvbnN0IHNSYXRlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3R0cy1yYXRlJyk7CiAgY29uc3Qgc1JhdGVWYWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndHRzLXJhdGUtdmFsJyk7CiAgZnVuY3Rpb24gcG9wdWxhdGVWb2ljZXMoKXsKICAgIGlmKCFzVm9pY2UpIHJldHVybjsKICAgIHNWb2ljZS5pbm5lckhUTUwgPSAnJzsKICAgICh2b2ljZXN8fFtdKS5mb3JFYWNoKHY9PnsKICAgICAgY29uc3Qgb3B0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJyk7CiAgICAgIG9wdC52YWx1ZSA9IHYubmFtZTsgb3B0LnRleHRDb250ZW50ID0gdi5uYW1lICsgJyAoJyt2LmxhbmcrJyknOwogICAgICBzVm9pY2UuYXBwZW5kQ2hpbGQob3B0KTsKICAgIH0pOwogICAgY29uc3QgY29uZiA9IGdldFRUU0NvbmYoKTsKICAgIGlmKGNvbmYudm9pY2VOYW1lKXsgc1ZvaWNlLnZhbHVlID0gY29uZi52b2ljZU5hbWU7IH0KICB9CiAgaWYodHlwZW9mIHNwZWVjaFN5bnRoZXNpcyE9PSd1bmRlZmluZWQnKXsKICAgIHNwZWVjaFN5bnRoZXNpcy5vbnZvaWNlc2NoYW5nZWQgPSBmdW5jdGlvbigpeyBsb2FkVm9pY2VzICYmIGxvYWRWb2ljZXMoKTsgcG9wdWxhdGVWb2ljZXMoKTsgfTsKICB9CiAgcG9wdWxhdGVWb2ljZXMoKTsKICBjb25zdCBjb25mID0gZ2V0VFRTQ29uZigpOwogIGlmKHNSYXRlKXsgc1JhdGUudmFsdWUgPSBjb25mLnJhdGUgfHwgMTsgc1JhdGVWYWwgJiYgKHNSYXRlVmFsLnRleHRDb250ZW50ID0gU3RyaW5nKHNSYXRlLnZhbHVlKSk7IH0KICBzVm9pY2UgJiYgc1ZvaWNlLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsICgpPT57IGNvbnN0IGM9Z2V0VFRTQ29uZigpOyBjLnZvaWNlTmFtZSA9IHNWb2ljZS52YWx1ZTsgc2V0VFRTQ29uZihjKTsgfSk7CiAgc1JhdGUgJiYgc1JhdGUuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCAoKT0+eyBjb25zdCBjPWdldFRUU0NvbmYoKTsgYy5yYXRlID0gcGFyc2VGbG9hdChzUmF0ZS52YWx1ZSl8fDE7IHNldFRUU0NvbmYoYyk7IGlmKHNSYXRlVmFsKSBzUmF0ZVZhbC50ZXh0Q29udGVudD1TdHJpbmcoc1JhdGUudmFsdWUpOyB9KTsKfSkoKTsKCi8vIEV4cG9ydCBDU1YvTWFya2Rvd24KZnVuY3Rpb24gZXhwb3J0Q1NWKCl7CiAgY29uc3Qgcm93cyA9IGl0ZW1zLm1hcChuPT5bbi5pZCwgbi50aXRsZSwgbi50eXBlLCAobi50YWdzfHxbXSkuam9pbignICcpLCAobi5jb250ZXh0JiZuLmNvbnRleHQucHJvamVjdCl8fCcnLCAobi5hY3Rpb25zfHxbXSkubGVuZ3RoLCBuZXcgRGF0ZShuLnVwZGF0ZWRBdCkudG9JU09TdHJpbmcoKV0pOwogIGNvbnN0IGhlYWQgPSBbJ2lkJywndGl0bGUnLCd0eXBlJywndGFncycsJ3Byb2plY3QnLCdhY3Rpb25zJywndXBkYXRlZEF0J107CiAgY29uc3QgbGluZXMgPSBbaGVhZC5qb2luKCcsJyksIC4uLnJvd3MubWFwKHI9PiByLm1hcCh4PT4gKCciJytTdHJpbmcoeCkucmVwbGFjZSgvIi9nLCciIicpKyciJykpLmpvaW4oJywnKSldOwogIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbbGluZXMuam9pbignXFxuJyldLCB7dHlwZTondGV4dC9jc3YnfSk7CiAgY29uc3QgYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsgYS5ocmVmPVVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7IGEuZG93bmxvYWQ9J2tub3dsZWRnZV92YXVsdC5jc3YnOyBhLmNsaWNrKCk7IHNldFRpbWVvdXQoKCk9PlVSTC5yZXZva2VPYmplY3RVUkwoYS5ocmVmKSwyMDAwKTsKfQpmdW5jdGlvbiBleHBvcnRNRCgpewogIGNvbnN0IGxpbmVzID0gaXRlbXMubWFwKG49PnsKICAgIGNvbnN0IHRhZ3M9KG4udGFnc3x8W10pLm1hcCh0PT4nIycrdCkuam9pbignICcpOwogICAgcmV0dXJuIGAjIyMgJHtuLnRpdGxlfVxcbi0gdHlwZTogJHtuLnR5cGV9XFxuLSBwcm9qZWN0OiAkeyhuLmNvbnRleHQmJm4uY29udGV4dC5wcm9qZWN0KXx8Jyd9XFxuLSB0YWdzOiAke3RhZ3N9XFxuLSB1cGRhdGVkOiAke25ldyBEYXRlKG4udXBkYXRlZEF0KS50b0xvY2FsZVN0cmluZygpfVxcblxcbiR7bi5jb250ZW50X2NvcmV8fCcnfVxcblxcbi0tLVxcbmA7CiAgfSk7CiAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFtsaW5lcy5qb2luKCdcXG4nKV0sIHt0eXBlOid0ZXh0L21hcmtkb3duJ30pOwogIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7IGEuaHJlZj1VUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOyBhLmRvd25sb2FkPSdrbm93bGVkZ2VfdmF1bHQubWQnOyBhLmNsaWNrKCk7IHNldFRpbWVvdXQoKCk9PlVSTC5yZXZva2VPYmplY3RVUkwoYS5ocmVmKSwyMDAwKTsKfQpkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuLWV4cG9ydC1jc3YnKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBleHBvcnRDU1YpOwpkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuLWV4cG9ydC1tZCcpPy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGV4cG9ydE1EKTsKCi8vIEF1dG8tc3dpdGNoIFRhYmxlIG1vZGUgd2hlbiBtYW55IGl0ZW1zCihmdW5jdGlvbigpewogIGNvbnN0IFRIX0tFWT0na3YudGFibGVUaHJlc2gnOyBjb25zdCBERUY9MzA7CiAgZnVuY3Rpb24gZ2V0VGhyZXNoKCl7IHJldHVybiBwYXJzZUludChsb2NhbFN0b3JhZ2UuZ2V0SXRlbShUSF9LRVkpfHxERUYsMTApfHxERUY7IH0KICBsZXQgZ3VhcmQ9ZmFsc2U7CiAgY29uc3QgX3JlbmRlckxpc3QgPSByZW5kZXJMaXN0OwogIHdpbmRvdy5yZW5kZXJMaXN0ID0gZnVuY3Rpb24oKXsKICAgIGlmKGd1YXJkKXsgcmV0dXJuIF9yZW5kZXJMaXN0KCk7IH0KICAgIGNvbnN0IG1hdGNoZWQgPSBzb3J0SXRlbXMoaXRlbXMuZmlsdGVyKGl0PT5pdC5zdGF0dXM9PT0nYWN0aXZlJykuZmlsdGVyKGl0ZW1NYXRjaGVzKSk7CiAgICBjb25zdCB0aHJlc2ggPSBnZXRUaHJlc2goKTsKICAgIGlmKCF0YWJsZU1vZGUgJiYgbWF0Y2hlZC5sZW5ndGg+dGhyZXNoKXsKICAgICAgLy8gc3dpdGNoIHRvIHRhYmxlCiAgICAgIGd1YXJkPXRydWU7CiAgICAgIHRyeXsKICAgICAgICB0YWJsZU1vZGUgPSB0cnVlOwogICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdrdi50YWJsZU1vZGUudjcnLCBKU09OLnN0cmluZ2lmeSh0YWJsZU1vZGUpKTsKICAgICAgICBjb25zdCBidG5UYWJsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG4tdGFibGUnKTsKICAgICAgICBpZihidG5UYWJsZSl7IGJ0blRhYmxlLnRleHRDb250ZW50ID0gJ1Ro4bq7JzsgfQogICAgICB9ZmluYWxseXsgZ3VhcmQ9ZmFsc2U7IH0KICAgIH0KICAgIF9yZW5kZXJMaXN0KCk7CiAgfTsKfSkoKTsKCi8vIENvbmZpZ3VyYWJsZSBub3RpZmljYXRpb25zCihmdW5jdGlvbigpewogIGZ1bmN0aW9uIGdldFRpbWVzKCl7CiAgICB0cnl7CiAgICAgIGNvbnN0IHMgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgna3Yubm90aWZ5LnRpbWVzJykgfHwgJzExOjMwLDE5OjMwJzsKICAgICAgcmV0dXJuIHMuc3BsaXQoJywnKS5tYXAoeD0+eC50cmltKCkpLmZpbHRlcihCb29sZWFuKTsKICAgIH1jYXRjaChfKXsgcmV0dXJuIFsnMTE6MzAnLCcxOTozMCddOyB9CiAgfQogIGZ1bmN0aW9uIHNldFRpbWVzKGFycil7IGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdrdi5ub3RpZnkudGltZXMnLCBhcnIuam9pbignLCcpKTsgfQogIGZ1bmN0aW9uIGdldFNub296ZSgpeyByZXR1cm4gcGFyc2VJbnQobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2t2Lm5vdGlmeS5zbm9vemVVbnRpbCcpfHwnMCcsMTApfHwwOyB9CiAgZnVuY3Rpb24gc2V0U25vb3plKG1zKXsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2t2Lm5vdGlmeS5zbm9vemVVbnRpbCcsIFN0cmluZyhtcykpOyB9CiAgLy8gVUkgYmluZGluZ3MKICBjb25zdCBpbnAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbnMtdGltZXMnKTsKICBjb25zdCBzYXZlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25zLXNhdmUnKTsKICBjb25zdCBzMTUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbnMtc25vb3plLTE1Jyk7CiAgY29uc3QgczMwID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25zLXNub296ZS0zMCcpOwogIGNvbnN0IHM2MCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCducy1zbm9vemUtNjAnKTsKICBjb25zdCBzdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCducy1zdGF0dXMnKTsKICBpZihpbnApeyBpbnAudmFsdWUgPSBnZXRUaW1lcygpLmpvaW4oJywnKTsgfQogIHNhdmUgJiYgc2F2ZS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT57IGNvbnN0IGFycj1pbnAudmFsdWUuc3BsaXQoJywnKS5tYXAoeD0+eC50cmltKCkpLmZpbHRlcihCb29sZWFuKTsgc2V0VGltZXMoYXJyKTsgc3QmJihzdC50ZXh0Q29udGVudD0nxJDDoyBsxrB1IGdp4budIHBpbmcuJyk7IH0pOwogIGZ1bmN0aW9uIHNub296ZShtaW4peyBzZXRTbm9vemUoRGF0ZS5ub3coKSttaW4qNjAqMTAwMCk7IHN0JiYoc3QudGV4dENvbnRlbnQ9J1Nub296ZSAnK21pbisnIHBow7p0LicpOyB9CiAgczE1ICYmIHMxNS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT5zbm9vemUoMTUpKTsKICBzMzAgJiYgczMwLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnNub296ZSgzMCkpOwogIHM2MCAmJiBzNjAuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+c25vb3plKDYwKSk7CiAgLy8gSW50ZXJ2YWwKICBzZXRJbnRlcnZhbCgoKT0+ewogICAgdHJ5ewogICAgICBpZighKCdOb3RpZmljYXRpb24nIGluIHdpbmRvdykpIHJldHVybjsKICAgICAgY29uc3QgcGVybSA9IE5vdGlmaWNhdGlvbi5wZXJtaXNzaW9uOwogICAgICBpZihwZXJtIT09J2dyYW50ZWQnKSByZXR1cm47CiAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7CiAgICAgIGNvbnN0IGhoID0gbm93LmdldEhvdXJzKCkudG9TdHJpbmcoKS5wYWRTdGFydCgyLCcwJyk7CiAgICAgIGNvbnN0IG1tID0gbm93LmdldE1pbnV0ZXMoKS50b1N0cmluZygpLnBhZFN0YXJ0KDIsJzAnKTsKICAgICAgY29uc3Qga2V5ID0gaGgrJzonK21tOwogICAgICBjb25zdCBzbm9vemVVbnRpbCA9IGdldFNub296ZSgpOwogICAgICBpZihzbm9vemVVbnRpbCAmJiBEYXRlLm5vdygpPHNub296ZVVudGlsKSByZXR1cm47CiAgICAgIGNvbnN0IHRpbWVzID0gZ2V0VGltZXMoKTsKICAgICAgaWYodGltZXMuaW5jbHVkZXMoa2V5KSl7CiAgICAgICAgY29uc3QgbiA9IG5ldyBOb3RpZmljYXRpb24oJ1JldmlldyBjaGVjaycsIHsgYm9keTogJ8SQ4bq/biBnaeG7nSByw6AgbOG6oWkgTm90ZXMvUHJvamVjdHMgJiBk4buNbiBJbmJveC4nIH0pOwogICAgICB9CiAgICB9Y2F0Y2goXyl7fQogIH0sIDYwKjEwMDApOwp9KSgpOwoKLyogPT09PT09IENvbW1vbiByZW5kZXIgPT09PT09ICovCmZ1bmN0aW9uIHJlbmRlckFsbCgpeyByZW5kZXJJbmJveCgpOyByZW5kZXJMaXN0KCk7IHJlbmRlclByb2plY3RzKCk7IHJlbmRlckFjdGlvbnMoKTsgcmVuZGVyVHJhaW5pbmcoKTsgcmVuZGVyTGludCgpOyByZWZyZXNoVFRTQnV0dG9ucygpOyB9CnJlbmRlckFsbCgpOwo8L3NjcmlwdD4KPHNjcmlwdCBpZD0nS1ZfQVVUT1BBVENIJz4KCi8vIEtWX0FVVE9QQVRDSCAoc2FmZXIpOiByZW1vdmUgb25seSB0aGUgc3BlY2lmaWMgVUkgeW91IGFza2VkCihmdW5jdGlvbigpewogIGZ1bmN0aW9uIHJlbW92ZVRhYnNFeGFjdChuYW1lcyl7CiAgICBjb25zdCBzZWwgPSBbJ1tyb2xlPSJ0YWIiXScsJ2J1dHRvbicsJ2EnLCcudGFiJywnLnRhYnMgLnRhYicsJy5tZW51IC5pdGVtJ10uam9pbignLCcpOwogICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChzZWwpLmZvckVhY2goZWw9PnsKICAgICAgY29uc3QgdD0oZWwudGV4dENvbnRlbnR8fCcnKS50cmltKCk7CiAgICAgIGlmKG5hbWVzLmluY2x1ZGVzKHQpKXsKICAgICAgICAvLyBvbmx5IHJlbW92ZSB0aGUgdGFiIGVsZW1lbnQgaXRzZWxmOyBkb24ndCB0b3VjaCB3cmFwcGVycwogICAgICAgIGVsLnJlbW92ZSgpOwogICAgICB9CiAgICB9KTsKICB9CiAgZnVuY3Rpb24gcmVtb3ZlRmlsdGVyU2ltcGxpZmllZCgpewogICAgLy8gRmluZCB0aGUgKmV4YWN0KiBoZWFkaW5nICdC4buZIGzhu41jICh04buRaSBnaeG6o24pJyBhbmQgZHJvcCBpdHMgbmVhcmVzdCBzZWN0aW9uL2NhcmQgb25seQogICAgY29uc3QgYWxsID0gQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcqJykpLmZpbHRlcihlbCA9PiAoZWwuY2hpbGRFbGVtZW50Q291bnQ9PT0wKSAmJiAoZWwudGV4dENvbnRlbnR8fCcnKS50cmltKCk9PT0nQuG7mSBs4buNYyAodOG7kWkgZ2nhuqNuKScpOwogICAgYWxsLmZvckVhY2gobGFiZWw9PnsKICAgICAgbGV0IGNvbnRhaW5lciA9IGxhYmVsLmNsb3Nlc3QoJ3NlY3Rpb24sIC5zZWN0aW9uLCAuY2FyZCwgLnBhbmVsLCAuYm94LCAua3YtZmlsdGVyLCAuZmlsdGVyLCAua3Ytc2xpbS1maWx0ZXInKTsKICAgICAgaWYoIWNvbnRhaW5lcikgY29udGFpbmVyID0gbGFiZWwucGFyZW50RWxlbWVudDsKICAgICAgLy8gRG8gbm90IHJlbW92ZSBpZiB0aGlzIGNvbnRhaW5lciBpcyBvciBjb250YWlucyBuYXZpZ2F0aW9uCiAgICAgIGlmKGNvbnRhaW5lciAmJiAhY29udGFpbmVyLmNsb3Nlc3QoJ25hdixbcm9sZT0ibmF2aWdhdGlvbiJdJykpewogICAgICAgIGNvbnRhaW5lci5yZW1vdmUoKTsKICAgICAgfQogICAgfSk7CiAgfQogIGZ1bmN0aW9uIHJ1bigpewogICAgcmVtb3ZlVGFic0V4YWN0KFsnUGxheWJvb2snLCdHdWlkZSddKTsKICAgIHJlbW92ZUZpbHRlclNpbXBsaWZpZWQoKTsKICB9CiAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGU9PT0nbG9hZGluZycpIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBydW4pOwogIGVsc2UgcnVuKCk7Cn0pKCk7Cgo8L3NjcmlwdD4KPC9ib2R5Pgo8L2h0bWw+Cg==";

// Decode Base64 → UTF‑8 string safely
function b64ToUtf8(b64) {
  const bin = atob(b64);
  const bytes = new Uint8Array(bin.length);
  for (let i=0; i<bin.length; i++) bytes[i] = bin.charCodeAt(i);
  return new TextDecoder('utf-8').decode(bytes);
}

function boot() {
  const a = document.getElementById('frame-nlm');
  const b = document.getElementById('frame-kv');
  a.srcdoc = b64ToUtf8(APP_NLM_B64);
  b.srcdoc = b64ToUtf8(APP_KV_B64);

  const tn = document.getElementById('tab-nlm');
  const tk = document.getElementById('tab-kv');
  function show(which) {
    const onN = which==='nlm';
    a.style.display = onN ? '' : 'none';
    b.style.display = onN ? 'none' : '';
    tn.classList.toggle('on', onN);
    tk.classList.toggle('on', !onN);
  }
  tn.addEventListener('click', ()=>show('nlm'));
  tk.addEventListener('click', ()=>show('kv'));
}
document.addEventListener('DOMContentLoaded', boot);
</script>

<script>
// === Book View / Tab Toggling ===
(function(){
  const tabNLM = document.getElementById('tab-nlm');
  const tabKV = document.getElementById('tab-kv');
  const tabBook = document.getElementById('tab-book');
  const frameNLM = document.getElementById('frame-nlm');
  const frameKV = document.getElementById('frame-kv');
  const bookView = document.getElementById('book-view');

  if(tabBook){
    // Ensure our three-tab toggling
    function setTab(which){
      [tabNLM, tabKV, tabBook].forEach(b=>b && b.classList.remove('on'));
      [frameNLM, frameKV].forEach(f=>f && (f.style.display = 'none'));
      if(bookView) bookView.style.display = 'none';
      if(which==='nlm'){ tabNLM && tabNLM.classList.add('on'); frameNLM && (frameNLM.style.display='block'); }
      if(which==='kv'){ tabKV && tabKV.classList.add('on'); frameKV && (frameKV.style.display='block'); }
      if(which==='book'){ tabBook && tabBook.classList.add('on'); if(bookView) bookView.style.display='block'; }
    }
    tabNLM && tabNLM.addEventListener('click', ()=>setTab('nlm'));
    tabKV && tabKV.addEventListener('click', ()=>setTab('kv'));
    tabBook && tabBook.addEventListener('click', ()=>{ setTab('book'); ensureBookReady(); });

    // Book rendering
    const STORAGE_KEY = "nlm_mvp_data_v1";
    const bookContent = document.getElementById('bookContent');
    const bookPages = document.getElementById('bookPages');
    const bookToc = document.getElementById('bookToc');
    const pageLabel = document.getElementById('bookPageLabel');
    const prog = document.getElementById('bookProgress');
    const btnPrev = document.getElementById('bookPrev');
    const btnNext = document.getElementById('bookNext');
    const btnToc  = document.getElementById('bookTocBtn');
    const btnBm   = document.getElementById('bookBookmark');
    const rngFont = document.getElementById('bookFont');

    function loadState(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }catch(e){ return {}; }
    }
    function toParagraphs(text){
      return text.split(/\n{2,}/).map(p=>'<p>'+p.replace(/\n/g,'<br>')+'</p>').join('\n');
    }

    function renderFromLocal(){
  const state = loadState();
  const notebooks = Array.isArray(state.notebooks)? state.notebooks : [];
  let html = '';
  const tocItems = [];

  if(notebooks.length){
    notebooks.forEach((nb, i)=>{
      const title = nb.title || ('Notebook ' + (i+1));
      html += '<section class="nb-page" id="nb_'+i+'">';
      html +=   '<div class="nb-block">';
      html +=     '<div class="nb-head">'+title+'</div>';
      if (Array.isArray(nb.chunks)){
        nb.chunks.forEach(ch=>{
          const t = (ch && ch.text) ? ch.text.trim() : '';
          if (t) html += '<article class="note-card">'+toParagraphs(t)+'</article>';
        });
      }
      html +=   '</div>';
      html += '</section>';
      tocItems.push({id:'nb_'+i, title});
    });
  } else {
    html += '<section class="nb-page"><div class="nb-block"><div class="nb-head">Chưa có notebook</div><article class="note-card"><p>Hãy tạo notebook ở tab khác rồi quay lại Book View.</p></article></div></section>';
  }

  bookContent.innerHTML = html;

  // Rebuild TOC
  if(bookToc){
    bookToc.innerHTML = tocItems.map((it,idx)=>'<div class="toc-item" data-target="'+it.id+'"><span class="i">#</span> '+(it.title||('Notebook '+(idx+1)))+'</div>').join('');
    // Bind toc clicks
    bookToc.querySelectorAll('.toc-item').forEach(a=>a.addEventListener('click', (e)=>{
  const id = e.currentTarget.getAttribute('data-target');
  const pageEl = document.getElementById(id);
  if(!pageEl) return;
  const pages = Array.from(bookContent.querySelectorAll('.nb-page'));
  const index = pages.indexOf(pageEl);
  if(index >= 0){
    bookPages.scrollTo({ left: index * bookPages.clientWidth, behavior:'smooth' });
  }
}));
  }

  // Restore last page if any
  const saved = parseInt(localStorage.getItem('book_last_col') || '0', 10);
  if(!isNaN(saved) && saved > 0){
    bookPages.scrollTo({ left: saved * bookPages.clientWidth, behavior:'instant' });
  }

  updatePageInfo();
}

    function updatePageInfo(){
  const total = bookContent.querySelectorAll('.nb-page').length || 1;
  const current = Math.round(bookPages.scrollLeft / bookPages.clientWidth) + 1;
  pageLabel.textContent = current + ' / ' + total;
  const progress = ((bookPages.scrollLeft + bookPages.clientWidth) / (total * bookPages.clientWidth)) * 100;
  prog.textContent = Math.min(100, Math.max(0, Math.round(progress))) + '%';
  const idx = Math.round(bookPages.scrollLeft / bookPages.clientWidth);
  try{ localStorage.setItem('book_last_col', String(idx)); }catch(e){}
}

    function ensureBookReady(){
      if(!bookContent || bookContent.getAttribute('data-ready')){
        updatePageInfo(); return;
      }
      renderFromLocal();
      bookContent.setAttribute('data-ready','1');
    }

    // Controls
    btnPrev && btnPrev.addEventListener('click', ()=>{
      const colWidth = (function(){ const w = (bookPages && bookPages.clientWidth) || (document.querySelector('.book-pages')?.clientWidth) || window.innerWidth; return w; })();
      bookPages.scrollBy({ left: -getPageWidth(), behavior: 'smooth' });
    });
    btnNext && btnNext.addEventListener('click', ()=>{
      const colWidth = (function(){ const w = (bookPages && bookPages.clientWidth) || (document.querySelector('.book-pages')?.clientWidth) || window.innerWidth; return w; })();
      bookPages.scrollBy({ left: getPageWidth(), behavior: 'smooth' });
    });
    btnBm && btnBm.addEventListener('click', ()=>{
      const colWidth = (function(){ const w = (bookPages && bookPages.clientWidth) || (document.querySelector('.book-pages')?.clientWidth) || window.innerWidth; return w; })();
      const currentCol = Math.round(bookPages.scrollLeft / colWidth);
      localStorage.setItem('book_last_col', String(currentCol));
      btnBm.textContent = '✅';
      setTimeout(()=>btnBm.textContent='🔖', 900);
    });
    btnToc && btnToc.addEventListener('click', ()=>{
      document.querySelector('.book-shell')?.classList.toggle('toc-hidden');
    });
    rngFont && rngFont.addEventListener('input', (e)=>{
      const val = e.target.value;
      bookContent.style.fontSize = val + 'px';
      // wait for reflow then update
      setTimeout(updatePageInfo, 60);
    });

    // Keyboard
    document.addEventListener('keydown', (e)=>{
      if(bookView && bookView.style.display !== 'none'){
        if(e.key === 'ArrowRight') btnNext?.click();
        if(e.key === 'ArrowLeft') btnPrev?.click();
      }
    });

    // Scroll update
    bookPages && bookPages.addEventListener('scroll', ()=>{ updatePageInfo(); const saved = parseInt(localStorage.getItem('book_last_col') || '0', 10); if(!isNaN(saved) && Math.abs(bookPages.scrollLeft - saved*bookPages.clientWidth) < 1){ } });

    // Restore bookmark when entering Book tab
    function restoreBookmark(){
      const saved = parseInt(localStorage.getItem('book_last_col') || '0', 10);
      const colWidth = (function(){ const w = (bookPages && bookPages.clientWidth) || (document.querySelector('.book-pages')?.clientWidth) || window.innerWidth; return w; })();
      if(!isNaN(saved) && colWidth){
        bookPages.scrollTo({left: saved * colWidth, behavior:'auto'});
        updatePageInfo();
      }
    }
    // Try restore after render
    const obs = new MutationObserver(()=>restoreBookmark());
    if(bookContent) obs.observe(bookContent, {childList:true});

    // Cosmetic: hide TOC when small screens
    const shell = document.querySelector('.book-shell');
    const mql = window.matchMedia('(max-width: 980px)');
    function setTocHidden(){ if(shell) shell.classList.toggle('toc-hidden', mql.matches); }
    mql.addEventListener('change', setTocHidden); setTocHidden();
  }
})();
</script>


<script>
(function(){
  const btn = document.getElementById('bookSkin');
  const view = document.getElementById('book-view');
  if(btn && view){
    function toggleGlassbook(){
      view.classList.toggle('glass-on');
      btn.classList.toggle('on');
    }
    btn.addEventListener('click', toggleGlassbook);
  }
})();
</script>


<script>
(function(){
  const KEY = 'nlm_mvp_data_v1';
  const btnImport = document.getElementById('btnImport');
  const btnExport = document.getElementById('btnExport');
  const btnReset  = document.getElementById('btnReset');
  const inputFile = document.getElementById('importFile');
  const tabBook   = document.getElementById('tab-book');
  const bookView  = document.getElementById('book-view');
  const bookContent = document.getElementById('bookContent');
  const gLeft = document.getElementById('glassLeft');
  const gUploadBtn = gLeft ? gLeft.querySelector('.g-upload') : null;
  const gSumBtn    = gLeft ? gLeft.querySelector('.g-sum') : null;
  const gRange     = gLeft ? gLeft.querySelector('.g-range') : null;
  const gMicBtn    = gLeft ? gLeft.querySelector('.g-mic') : null;

  function getState(){ try{ return JSON.parse(localStorage.getItem(KEY)||'{}'); }catch(_){ return {}; } }
  function setState(st){ localStorage.setItem(KEY, JSON.stringify(st)); }
  function ensureNotebooks(st){ if(!st.notebooks) st.notebooks=[]; return st; }

  function refreshBook(){
    if(!bookContent) return;
    bookContent.removeAttribute('data-ready');
    if(tabBook){ tabBook.click(); }
  }

  function createNotebook(title, text){
    const st = ensureNotebooks(getState());
    const nb = { id: Date.now(), title: title||'Notebook', chunks: [{text: text||''}], updatedAt: Date.now() };
    st.notebooks.push(nb);
    setState(st); refreshBook();
  }

  function importTextAsNotebook(name, text){
    createNotebook(name.replace(/\.[^/.]+$/, ''), text);
    alert('Đã nhập ghi chú từ tệp văn bản: '+name);
  }

  function summarizeText(raw, keepRatio){
    try{
      const text = String(raw||'');
      const sents = text.split(/(?<=[.!?。؟।])\s+|\n+/).filter(s=>s.trim().length>0);
      if(!sents.length) return '';
      const stop = new Set('và của là các một những cho với trên trong từ thì nhưng hoặc nếu khi đã được bị tại bởi về như rất nữa này kia that the a an in on to of for with and or not be is are were was this that which from by as it we you they he she do does did will would can could should may might must have has had'.split(/\s+/));
      const freq = Object.create(null);
      const words = text.toLowerCase().match(/\p{L}+/gu) || [];
      for(const w of words){ if(!stop.has(w)) freq[w]=(freq[w]||0)+1; }
      const score = s=> (s.toLowerCase().match(/\p{L}+/gu)||[]).reduce((t,w)=>t+(freq[w]||0),0) / Math.log(2+s.length);
      const pairs = sents.map((s,i)=>[i, s, score(s)]).sort((a,b)=>b[2]-a[2]);
      const k = Math.max(1, Math.floor(sents.length * (keepRatio||0.3)));
      const chosen = pairs.slice(0,k).sort((a,b)=>a[0]-b[0]).map(p=>p[1]);
      return chosen.join(' ');
    }catch(e){ return ''; }
  }

  // Toolbar: Import / Export / Reset
  btnImport && btnImport.addEventListener('click', ()=>{ inputFile && inputFile.click(); });
  inputFile && inputFile.addEventListener('change', (ev)=>{
    const f = ev.target.files && ev.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      const txt = String(reader.result||'');
      if(/\.json$/i.test(f.name)){
        try{
          const obj = JSON.parse(txt);
          setState(obj); alert('Đã nhập JSON thành công.'); refreshBook();
        }catch(_){ alert('Tệp JSON không hợp lệ.'); }
      }else{
        importTextAsNotebook(f.name, txt);
      }
      inputFile.value='';
    };
    reader.readAsText(f, 'utf-8');
  });

  btnExport && btnExport.addEventListener('click', ()=>{
    const blob = new Blob([ JSON.stringify(getState(), null, 2) ], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'aurora_notebooks.json';
    a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  });

  btnReset && btnReset.addEventListener('click', ()=>{
    if(confirm('Xóa toàn bộ dữ liệu sổ tay trong trình duyệt này?')){
      localStorage.removeItem(KEY); refreshBook();
    }
  });

  // Glassbook left panel: Upload/Summarize/Mic
  if(gUploadBtn){
    gUploadBtn.addEventListener('click', ()=>{
      if(!inputFile) return; inputFile.accept='.json,.md,.txt'; inputFile.click();
    });
  }
  if(gSumBtn){
    gSumBtn.addEventListener('click', ()=>{
      const raw = document.getElementById('bookContent')?.innerText || '';
      const ratio = Math.max(0.05, (parseFloat(gRange?.value||'45')/100));
      const sum = summarizeText(raw, ratio);
      if(sum){ createNotebook('Tóm tắt ' + new Date().toLocaleString(), sum); alert('Đã tạo ghi chú tóm tắt.'); }
      else{ alert('Không có nội dung để tóm tắt.'); }
    });
  }
  if(gMicBtn && navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
    let rec=null, chunks=[]; let recording=false;
    gMicBtn.addEventListener('click', async()=>{
      try{
        if(!recording){
          const stream = await navigator.mediaDevices.getUserMedia({audio:true});
          rec = new MediaRecorder(stream); chunks=[];
          rec.ondataavailable = e=>{ if(e.data && e.data.size) chunks.push(e.data); };
          rec.onstop = ()=>{
            const blob = new Blob(chunks, {type:'audio/webm'});
            const url = URL.createObjectURL(blob);
            const st = getState(); st.audio = st.audio||[]; st.audio.push({id:Date.now(), url, createdAt:Date.now()}); setState(st);
            alert('Đã lưu bản ghi âm (offline).');
          };
          rec.start(); recording=true; gMicBtn.textContent='⏺️ đang ghi...';
        }else{
          rec && rec.stop(); recording=false; gMicBtn.textContent='🎙️';
        }
      }catch(_){ alert('Không thể truy cập micro trong môi trường này.'); }
    });
  }

  // Intercept buttons inside NotebookLM iframe to make them usable offline
  const frameNLM = document.getElementById('frame-nlm');
  if(frameNLM){
    frameNLM.addEventListener('load', ()=>{
      try{
        const d = frameNLM.contentDocument;
        if(!d) return;
        function bindByText(text, handler){
          const btns = Array.from(d.querySelectorAll('button, a, .btn')).filter(x=>/\S/.test(x.textContent||''));
          const found = btns.find(x=> (x.textContent||'').trim().toLowerCase() === text);
          if(found){ found.addEventListener('click', (ev)=>{ ev.preventDefault(); handler(); }); }
        }
        bindByText('notebook mới', ()=>{
          const title = prompt('Tên notebook mới:'); if(title){ createNotebook(title, ''); }
        });
        bindByText('nạp dữ liệu demo', ()=>{
  const demo = { notebooks:[
    {id:Date.now()-2, title:'Demo • Tác vụ', chunks:[{text:`• Việc 1
• Việc 2
• Việc 3`}], updatedAt:Date.now()},
    {id:Date.now()-1, title:'Demo • Ghi chú nhanh', chunks:[{text:'Ghi nhanh — ví dụ: phím tắt, quy ước tag, tiến độ 30%.'}], updatedAt:Date.now()}
  ]};
  setState(demo); refreshBook(); alert('Đã nạp dữ liệu demo.');
});
}catch(_){ /* cross-origin or other issues – ignore */ }
    });
  }
})();
</script>


<script>
(function () {
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const byText = (tag, txt)=>$$(`${tag}`).find(e=>e.textContent.trim().toLowerCase()===String(txt).toLowerCase());
  const strip = s => { s = String(s||""); while (s.endsWith("/")) s = s.slice(0,-1); return s; };
  const AURORA_DB_KEY = "aurora.notebooks";
  function attachLater(fn, times=30, gap=200){ let n=0; const t=setInterval(()=>{ if(fn()||++n>=times) clearInterval(t); }, gap); }
  function getDB(){ try { return JSON.parse(localStorage.getItem(AURORA_DB_KEY)||"[]"); } catch { return []; } }
  function setDB(d){ localStorage.setItem(AURORA_DB_KEY, JSON.stringify(d)); }
  function handleNewNotebook(){
    const btn = byText('button','Notebook mới') || byText('div','Notebook mới');
    if(!btn) return false;
    btn.onclick = ()=>{
      const name = prompt("Tên sổ tay:"); if(!name) return;
      const db = getDB();
      db.push({id:Date.now(), title:name, pages:[{title:name, body:""}], createdAt:new Date().toISOString()});
      setDB(db); alert("Đã tạo sổ tay. Mở Book View để xem.");
    }; return true; }
  function handleLoadDemo(){
    const btn = byText('button','Nạp dữ liệu demo') || byText('div','Nạp dữ liệu demo');
    if(!btn) return false;
    btn.onclick = ()=>{
  const db = getDB();
  if(db.some(x=>String(x.title).startsWith("Demo •"))){ alert("Đã có dữ liệu demo."); return; }
  db.push({id:Date.now()+1,title:"Demo • Tác vụ", pages:[{title:"Checklist", body:`- [ ] Việc 1
- [ ] Việc 2
- [ ] Việc 3`}]});
  db.push({id:Date.now()+2,title:"Demo • Ghi chú nhanh", pages:[{title:"Ghi chú", body:"Ghi nhanh…"}]});
  setDB(db); alert("Đã nạp demo. Mở Book View để xem."); };

    return true; }
  function handleBookViewTab(){
    const tab = byText('button','Book View') || byText('div','Book View');
    const book = document.getElementById('bookview') || document.querySelector('.book-view') || document.getElementById('BookView');
    const rag  = document.getElementById('notebooklm') || document.querySelector('.nlm-view') || document.getElementById('NotebookLM');
    const vault= document.getElementById('vault') || document.querySelector('.vault-view') || document.getElementById('KnowledgeVault');
    if(!tab || !book || !rag || !vault) return false;
    tab.addEventListener('click', ()=>{ book.style.display='block'; rag.style.display='none'; vault.style.display='none';
      (document.querySelectorAll('.nav button,.nav div')||[]).forEach(x=>x.classList?.remove('on')); tab.classList?.add('on'); }, {once:false});
    return true; }
  function addBackupUI(){
    const book = document.getElementById('bookview') || document.querySelector('.book-view') || document.getElementById('BookView'); if(!book) return false;
    if(book.querySelector('.bk-backup')) return true;
    const shelf = book.querySelector('.toolbar') || book;
    const wrap = document.createElement('div'); wrap.className='bk-backup'; wrap.style.display='flex'; wrap.style.gap='8px'; wrap.style.margin='8px 0';
    const mkBtn = (t)=>{ const b=document.createElement('button'); b.textContent=t; b.className='btn btn-sm'; return b; };
    const bExp = mkBtn('Xuất'), bImp = mkBtn('Nhập'), bRst = mkBtn('Reset'); wrap.append(bExp,bImp,bRst); shelf.prepend(wrap);
    bExp.onclick=()=>{ const data = localStorage.getItem(AURORA_DB_KEY)||'[]'; const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([data],{type:'application/json'})); a.download='aurora_notebooks.json'; a.click(); URL.revokeObjectURL(a.href); };
    bImp.onclick=()=>{ const ipt=document.createElement('input'); ipt.type='file'; ipt.accept='.json,.txt,.md'; ipt.onchange=async ()=>{ const f=ipt.files?.[0]; if(!f) return; const text = await f.text(); if(/\.json$/i.test(f.name)){ setDB(JSON.parse(text)); alert('Đã nhập JSON. Mở Book View để xem.'); } else { const db = getDB(); db.push({id:Date.now(), title:f.name.replace(/\..+$/,''), pages:[{title:f.name, body:text}]}); setDB(db); alert('Đã tạo sổ tay từ tệp văn bản.'); } }; ipt.click(); };
    bRst.onclick=()=>{ if(confirm('Xóa toàn bộ sổ tay trên trình duyệt này?')){ localStorage.removeItem(AURORA_DB_KEY); alert('Đã xóa.'); } }; return true; }
  function wireTTS(){ const btn = document.querySelector('.tts-btn') || byText('button','Đọc to'); if(!btn) return false; if(!('speechSynthesis' in window)){ btn.disabled=true; btn.title='Trình duyệt không hỗ trợ TTS'; return true; } btn.onclick=()=>{ const text = (document.querySelector('#bookview .page')?.innerText || '').slice(0,8000); const u = new SpeechSynthesisUtterance(text||'Không có nội dung để đọc'); speechSynthesis.speak(u); }; return true; }
  function gateRecorder(){ const btn = document.querySelector('.rec-btn') || byText('button','Ghi âm'); if(!btn) return false; const secure = location.protocol==='https:' || location.hostname==='localhost'; if(!secure || !navigator.mediaDevices?.getUserMedia){ btn.disabled = true; btn.title = 'Ghi âm cần HTTPS/localhost và quyền mic'; } return true; }
  attachLater(handleNewNotebook); attachLater(handleLoadDemo); attachLater(handleBookViewTab); attachLater(addBackupUI); attachLater(wireTTS); attachLater(gateRecorder);
  window.__aurora_buildLLMUrl = (prov)=> strip(prov) + "/v1/chat/completions";
})();
</script>


<script id="PARENT_AUTOPATCH_SAFE">
(function(){
  function tabs(doc){ return doc.querySelectorAll('[role="tab"],button,a,.tab,.tabs .tab,.menu .item'); }
  function removeTabs(doc, names){
    tabs(doc).forEach(el=>{
      const t=(el.textContent||'').trim();
      if(names.includes(t)) el.remove();
    });
  }
  function removeFilter(doc){
    const all = Array.from(doc.querySelectorAll('*')).filter(el => (el.childElementCount===0) && (el.textContent||'').trim()==='Bộ lọc (tối giản)');
    all.forEach(label=>{
      let c = label.closest('section, .section, .card, .panel, .box, .kv-filter, .filter, .kv-slim-filter');
      if(!c) c = label.parentElement;
      if(c && !c.closest('nav,[role=\"navigation\"]')) c.remove();
    });
  }
  function clean(doc){
    try { removeTabs(doc, ['Playbook','Guide']); removeFilter(doc); } catch(e){}
  }
  function tryClean(){
    clean(document);
    ['frame-kv','frame-nlm'].forEach(id=>{
      const ifr=document.getElementById(id);
      if(ifr && ifr.contentDocument) clean(ifr.contentDocument);
    });
  }
  window.addEventListener('load', tryClean, {once:true});
  setTimeout(tryClean, 600);
  setTimeout(tryClean, 1200);
})();
</script>



<!-- === Aurora: Template Picker injection (v2, robust) === -->
<script>
(function(){
  // --- library payload kept from v1 (short) ---
  const TPL_MIN = {A:[{id:"cornell",name:"Cornell Notes",body:"# Cornell Notes\nNgày: {{today}}\n"}]};// <= placeholder to keep size small; full set is kept in previous block
  // (We don't need the data for hook check; actual gallery code exists already below in this file.)

  function normText(s){
    return String(s||'')
      .replace(/[+•\u2022]/g,' ')   // strip icons/bullets
      .replace(/\s+/g,' ')
      .trim()
      .toLowerCase();
  }

  function findNewNotebookBtn(doc){
    const nodes = doc.querySelectorAll('button, a, .btn, [role="button"]');
    for(const el of nodes){
      const t = normText(el.textContent);
      if(t.includes('notebook') && (t.includes('mới') || t.includes('new'))) return el;
    }
    return null;
  }

  function ensureHook(frame){
    try{
      const doc = frame.contentDocument;
      if(!doc) return false;
      let btn = findNewNotebookBtn(doc);
      if(!btn) return false;

      if(btn.dataset.__tplHooked) return true;
      btn.dataset.__tplHooked = "1";

      // Open the existing Template Picker modal from v1 if present; else no-op
      btn.addEventListener('click', (ev)=>{
        try{
          ev.preventDefault(); ev.stopImmediatePropagation();
        }catch(_){};
        // Prefer the modal factory already injected by v1 script
        if(typeof window.createTemplateModal === 'function'){
          document.body.appendChild(window.createTemplateModal(frame));
          return;
        }
        // Fallback: alert (will never happen if v1 is present)
        alert('Template Picker chưa tải được.');
      }, true);
      return true;
    }catch(e){ console.warn('Hook error', e); return false; }
  }

  function bootHook(){
    const frame = document.getElementById('frame-nlm');
    if(!frame) return;
    // 1) Try immediately (in case iframe is already ready)
    ensureHook(frame);
    // 2) On iframe load
    frame.addEventListener('load', ()=>{ ensureHook(frame); });
    // 3) Retry for late React renders
    let tries = 0;
    const timer = setInterval(()=>{
      if(ensureHook(frame)) { clearInterval(timer); }
      if(++tries>40) clearInterval(timer); // ~20s max
    }, 500);
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', bootHook);
  else bootHook();
})();
</script>

<script>
(function(){
  // ------- Template library (condensed; can expand later) -------
  const TEMPLATES = {
    "A. Học tập & Nghiên cứu": [
      {id:"cornell", name:"Cornell Notes", body:"# Cornell Notes\nNgày: {{today}}\nMôn/Chủ đề:\n\n## Cue (Câu hỏi/Ý chính)\n- \n\n## Notes (Ghi chú)\n- \n\n## Summary (Tóm tắt)\n- "},
      {id:"zettel", name:"Zettelkasten Sup-Card", body:"# Zettelkasten\nID: {{ts}}\nTiêu đề:\nTags: #\n\n## Ý chính\n- \n\n## Nguồn/Trích dẫn\n- \n\n## Liên kết sang thẻ khác\n- "},
      {id:"feynman", name:"Feynman Note", body:"# Feynman Note\nKhái niệm:\n\n1) Giải thích như cho trẻ 12 tuổi:\n- \n\n2) Tìm điểm mù/kiểm tra:\n- \n\n3) Đơn giản hóa & ví dụ:\n- \n\n4) Ôn lại -> cải thiện:\n- "},
      {id:"reading_notes", name:"Reading Notes", body:"# Reading Notes\nTác phẩm:\nTác giả:\nTrang/Chương:\n\n## Trích dẫn then chốt\n> \n\n## Ý chính\n- \n\n## Câu hỏi mở\n- \n\n## Hành động/Ứng dụng\n- "},
      {id:"literature_matrix", name:"Literature/Synthesis Matrix", body:"# Literature/Synthesis Matrix\n| Nghiên cứu | Phương pháp | Phát hiện | Hạn chế | Ghi chú |\n|---|---|---|---|---|\n| Tác giả A (Năm) |  |  |  |  |\n| Tác giả B (Năm) |  |  |  |  |"},
      {id:"qec", name:"Q–E–C (Question–Evidence–Conclusion)", body:"# Q–E–C\n**Question:**\n\n**Evidence:**\n- \n\n**Conclusion:**\n- "},
      {id:"research_log", name:"Research Log", body:"# Research Log\nNgày: {{today}}\nMục tiêu:\nNguồn tìm kiếm:\nTừ khóa:\nGhi chú:\nViệc tiếp theo:"},
      {id:"experiment_log", name:"Research Experiment Log", body:"# Experiment Log\nĐề bài/giả thuyết:\nThiết kế thí nghiệm:\nBiến độc lập/phụ thuộc:\nKịch bản chạy:\nKết quả quan sát:\nPhân tích:\nKết luận:\nViệc tiếp theo:"},
      {id:"field_notes", name:"Field Notes", body:"# Field Notes\nNgày/Giờ: {{today}}\nĐịa điểm:\nNgười tham gia:\nQuan sát:\nPhản tư:\nTừ khóa:"},
      {id:"smart", name:"SMART Goals", body:"# SMART Goals\n- **Specific:**\n- **Measurable:**\n- **Achievable:**\n- **Relevant:**\n- **Time-bound:**"}
    ],
    "B. Sáng tạo & Viết lách": [
      {id:"brainstorm", name:"Brainstorm (grid)", body:"# Brainstorm\n- Ý 1\n- Ý 2\n- Ý 3\n\n### Nhóm/Chủ đề\n- "},
      {id:"mindmap", name:"Mind Map", body:"# Mind Map\nTrung tâm: \n- Nhánh 1:\n  - \n- Nhánh 2:\n  - "},
      {id:"story_arc", name:"Story Arc Beat Sheet", body:"# Story Arc / Beat Sheet\nAct I — Setup:\n- \nInciting Incident:\n- \nAct II — Confrontation:\n- \nMidpoint:\n- \nAct III — Resolution:\n- "},
      {id:"character", name:"Character Sheet", body:"# Character Sheet\nTên:\nVai trò:\nĐộng cơ:\nXung đột:\nBí mật:\nArchetype:\nQuan hệ:\nNotes:"},
      {id:"world", name:"Worldbuilding Sheet", body:"# Worldbuilding\nThế giới:\nLịch sử:\nĐịa lý/Khí hậu:\nVăn hóa/Chính trị:\nMa thuật/Công nghệ:\nQuy tắc:\nMâu thuẫn trung tâm:"},
      {id:"article_outline", name:"Article/Essay Outline", body:"# Outline\nTiêu đề:\nLuận đề (thesis):\nI. \nII. \nIII. \nKết luận:\nCTA/Hành động:"},
      {id:"editorial_calendar", name:"Editorial Calendar", body:"# Editorial Calendar\n| Tuần | Chủ đề | Kênh | Trạng thái | Ghi chú |\n|---|---|---|---|---|\n| W1 |  |  |  |  |\n| W2 |  |  |  |  |"},
      {id:"quote_bank", name:"Quote Bank / Source Tracker", body:"# Quote Bank / Source Tracker\n| Trích dẫn | Tác giả/Nguồn | Chủ đề | Trang/URL | Ghi chú |\n|---|---|---|---|---|"},
      {id:"interview", name:"Interview Script + Notes", body:"# Interview Script\nMục tiêu:\nNgười phỏng vấn:\nNgười trả lời:\nCâu hỏi:\n1) \n2) \n3) \n\n## Notes\n- "}
    ],
    "C. Công việc & Dự án": [
      {id:"kanban", name:"Kanban (To‑Do / In‑Progress / Done)", body:"# Kanban\n## To‑Do\n- [ ] \n\n## In‑Progress\n- [ ] \n\n## Done\n- [x] "},
      {id:"weekly_planner", name:"Weekly Planner", body:"# Weekly Planner (Tuần {{week}})\n| Ngày | Ưu tiên | Lịch cố định | Việc chính | Ghi chú |\n|---|---|---|---|---|\n| Thứ 2 |  |  |  |  |\n| Thứ 3 |  |  |  |  |\n| Thứ 4 |  |  |  |  |\n| Thứ 5 |  |  |  |  |\n| Thứ 6 |  |  |  |  |\n| Thứ 7 |  |  |  |  |\n| CN |  |  |  |  |"},
      {id:"meeting_minutes", name:"Meeting Minutes", body:"# Meeting Minutes\nCuộc họp:\nNgày/Giờ:\nNgười tham gia:\nAgenda:\n1) \n2) \n3) \n\nQuyết định:\n- \nHành động/Owner/Deadline:\n- \nTài liệu liên quan:"},
      {id:"project_brief", name:"Project Brief", body:"# Project Brief\nTổng quan:\nMục tiêu thành công:\nScope (In/Out):\nTimeline/Mốc:\nRủi ro:\nStakeholders:\nTài nguyên/Ngân sách:\nKPI:"},
      {id:"roadmap", name:"Roadmap/Milestones", body:"# Roadmap\n| Mốc | Mô tả | Chủ sở hữu | Ngày | Trạng thái |\n|---|---|---|---|---|"},
      {id:"standup", name:"Daily Stand‑up (Y–T–B)", body:"# Stand‑up\n**Hôm qua (Y):**\n- \n**Hôm nay (T):**\n- \n**Cản trở (B):**\n- "},
      {id:"retro", name:"Retrospective (Start–Stop–Continue)", body:"# Retrospective\n**Start:**\n- \n**Stop:**\n- \n**Continue:**\n- "},
      {id:"risk_register", name:"Risk Register", body:"# Risk Register\n| ID | Rủi ro | Xác suất | Tác động | Mitigation | Owner |\n|---|---|---|---|---|---|"},
      {id:"raci", name:"RACI Matrix", body:"# RACI Matrix\n| Công việc | R | A | C | I |\n|---|---|---|---|---|\n|  |  |  |  |  |"}
    ],
    "D. Kinh doanh & Chiến lược": [
      {id:"swot", name:"SWOT", body:"# SWOT\n**Strengths**\n- \n**Weaknesses**\n- \n**Opportunities**\n- \n**Threats**\n- "},
      {id:"pestle", name:"PESTLE", body:"# PESTLE\n**Political**\n- \n**Economic**\n- \n**Social**\n- \n**Technological**\n- \n**Legal**\n- \n**Environmental**\n- "},
      {id:"five_forces", name:"Porter’s Five Forces", body:"# Porter’s Five Forces\n- Competitor Rivalry:\n- Threat of New Entrants:\n- Bargaining Power of Suppliers:\n- Bargaining Power of Buyers:\n- Threat of Substitutes:"},
      {id:"bmc", name:"Business Model Canvas", body:"# Business Model Canvas\n1. Customer Segments\n2. Value Propositions\n3. Channels\n4. Customer Relationships\n5. Revenue Streams\n6. Key Resources\n7. Key Activities\n8. Key Partnerships\n9. Cost Structure"},
      {id:"lean_canvas", name:"Lean Canvas", body:"# Lean Canvas\nVấn đề | Phân khúc KH | Giải pháp | UVP | Lợi thế | Kênh | Chi phí | Doanh thu\n- | - | - | - | - | - | - | -"},
      {id:"pricing", name:"Pricing & Packaging Matrix", body:"# Pricing & Packaging\n| Gói | Tính năng | Giá | Mục tiêu KH | Ghi chú |\n|---|---|---|---|---|"}
    ],
    "E. Thiết kế & UX": [
      {id:"persona", name:"User Persona", body:"# User Persona\nTên:\nNhân khẩu học:\nMục tiêu:\nNỗi đau:\nHành vi:\nCâu nói mẫu:\nKênh ưa thích:"},
      {id:"empathy", name:"Empathy Map", body:"# Empathy Map\n**Nói**\n- \n**Nghĩ**\n- \n**Làm**\n- \n**Cảm nhận**\n- \nNỗi đau/Lợi ích:\n- "},
      {id:"journey", name:"Customer Journey Map", body:"# Journey Map\nGiai đoạn | Hành động | Điểm chạm | Cảm xúc | Ý tưởng\n- | - | - | - | -"},
      {id:"rice", name:"Feature Prioritization (RICE)", body:"# RICE\n| Tính năng | Reach | Impact | Confidence | Effort | Score |\n|---|---:|---:|---:|---:|---:|"},
      {id:"usability", name:"Usability Test Plan & Findings", body:"# Usability Test\nMục tiêu:\nChỉ số thành công:\nKịch bản:\nTác vụ:\nQuan sát:\nVấn đề/Nghiêm trọng:\nĐề xuất:"}
    ],
    "F. Kỹ thuật & Dữ liệu": [
      {id:"adr", name:"ADR (Architecture Decision Record)", body:"# ADR\nID: ADR-{{ts}}\nBối cảnh:\nQuyết định:\nHệ quả:\nCác lựa chọn đã xem xét:"},
      {id:"runbook", name:"Runbook / On‑call Playbook", body:"# Runbook\nDịch vụ:\nMục tiêu SLO:\nLiên hệ:\nQuy trình sự cố:\n1) Phát hiện\n2) Chẩn đoán\n3) Khắc phục\n4) Hậu kiểm\nChecklist:\n- "},
      {id:"rca", name:"RCA & Postmortem (5 Whys/Fishbone)", body:"# Postmortem\nSự cố:\nTác động:\nDòng thời gian:\nNguyên nhân gốc (5 Whys):\n- \nSơ đồ xương cá:\n- \nHành động khắc phục:\n- "},
      {id:"test_matrix", name:"Test Case Matrix", body:"# Test Matrix\n| ID | Mô tả | Bước | Kết quả mong đợi | Trạng thái |\n|---|---|---|---|---|"},
      {id:"ml_exp", name:"ML Experiment Tracker", body:"# ML Experiment\nID: EXP-{{ts}}\nDataset:\nModel/Params:\nMetric:\nKết quả:\nGhi chú:"},
      {id:"pipeline", name:"Data Pipeline/DAG Planner", body:"# Data Pipeline\nNguồn → Xử lý → Lưu trữ → Trình bày\nThành phần:\n- \nLịch chạy:\n- \nTheo dõi lỗi:\n- "}
    ],
    "G. Luật & Tranh luận": [
      {id:"irac", name:"Case Brief (IRAC)", body:"# IRAC\n**Issue:**\n\n**Rule:**\n\n**Application:**\n\n**Conclusion:**"},
      {id:"creac", name:"CREAC/CRAC Brief", body:"# CREAC\n**Conclusion (ngắn):**\n**Rule:**\n**Explanation:**\n**Application:**\n**Conclusion (đầy đủ):**"},
      {id:"statute", name:"Statute/Regulation Tracker", body:"# Statute Tracker\n| Điều khoản | Chủ đề | Cơ quan | Tình trạng | Ghi chú |\n|---|---|---|---|---|"},
      {id:"debate", name:"Debate Flow", body:"# Debate Flow\nNghị quyết:\nAff:\n- Case:\n- Rebuttal:\nNeg:\n- Case:\n- Rebuttal:\nChéo vấn:\n- "}
    ],
    "H. Cá nhân – Sức khỏe – Tài chính": [
      {id:"habit", name:"Habit Tracker", body:"# Habit Tracker ({{month}})\n| Ngày | Thói quen | ✅ |\n|---|---|---|\n| 1 |  |  |\n| 2 |  |  |\n| 3 |  |  |\n...\n"},
      {id:"sleep", name:"Sleep Log", body:"# Sleep Log\nNgày:\nGiờ ngủ:\nGiờ dậy:\nChất lượng (1–5):\nYếu tố ảnh hưởng:\nGhi chú:"},
      {id:"budget", name:"Monthly Budget", body:"# Monthly Budget ({{month}})\n| Hạng mục | Dự toán | Thực chi | Chênh lệch |\n|---|---:|---:|---:|"},
      {id:"cashflow", name:"Cashflow", body:"# Cashflow\n| Ngày | Thu | Chi | Mô tả |\n|---|---:|---:|---|"},
      {id:"packing", name:"Packing List", body:"# Packing List\nĐiểm đến/Ngày:\n\n## Cần thiết\n- [ ] \n\n## Quần áo\n- [ ] \n\n## Đồ điện tử\n- [ ] \n\n## Khác\n- [ ] "}
    ]
  };

  // Small helper to format placeholders
  function fillPlaceholders(str){
    const d = new Date();
    const today = d.toISOString().slice(0,10);
    const week = (()=>{
      const onejan = new Date(d.getFullYear(),0,1);
      return Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
    })();
    const month = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const ts = Date.now();
    return String(str||'')
      .replaceAll('{{today}}', today)
      .replaceAll('{{week}}', week)
      .replaceAll('{{month}}', month)
      .replaceAll('{{ts}}', ts);
  }

  // ------- UI: modal & behavior -------
  function createTemplateModal(frame){
    const d = document;
    const overlay = d.createElement('div');
    overlay.id = 'tplOverlay';
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(8,12,24,.68);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:9999';
    const box = d.createElement('div');
    box.style.cssText = 'width:min(1000px,92vw);max-height:82vh;overflow:auto;background:#0b1224;border:1px solid rgba(255,255,255,.15);border-radius:16px;box-shadow:0 12px 42px rgba(2,6,23,.7);padding:14px';
    overlay.appendChild(box);

    const header = d.createElement('div');
    header.style.cssText = 'display:flex;align-items:center;gap:10px;margin-bottom:8px';
    header.innerHTML = '<div style="font-weight:800;letter-spacing:.3px">Chọn mẫu ghi chú</div>' +
      '<input id="tplSearch" type="text" placeholder="Tìm..." style="flex:1;padding:8px 10px;border:1px solid rgba(255,255,255,.15);border-radius:10px;background:rgba(255,255,255,.04);color:#e6edf7">' +
      '<button id="tplCreate" class="btn" style="padding:8px 12px;border:1px solid rgba(255,255,255,.2);background:linear-gradient(90deg,#8b5cf6,#22d3ee);color:#04111f;border-radius:10px;font-weight:800">Tạo</button>' +
      '<button id="tplClose" class="btn" style="padding:8px 12px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);border-radius:10px;color:#e6edf7">Đóng</button>';
    box.appendChild(header);

    const grid = d.createElement('div');
    grid.style.cssText = 'display:grid;grid-template-columns:240px 1fr;gap:12px';
    box.appendChild(grid);

    const cats = d.createElement('div');
    cats.style.cssText = 'border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:6px;overflow:auto;max-height:60vh';
    const list = d.createElement('div');
    list.style.cssText = 'border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:8px;overflow:auto;max-height:60vh';
    grid.appendChild(cats);
    grid.appendChild(list);

    let currentCat = Object.keys(TEMPLATES)[0];
    let selected = null;

    function renderCats(){
      cats.innerHTML = '';
      Object.keys(TEMPLATES).forEach(cat=>{
        const b = d.createElement('button');
        b.textContent = cat;
        b.className = 'btn';
        b.style.cssText = 'text-align:left;padding:8px 10px;border:1px solid rgba(255,255,255,.15);background:'+(cat===currentCat?'rgba(139,92,246,.25)':'rgba(255,255,255,.04)')+';border-radius:10px;color:#e6edf7';
        b.onclick = ()=>{ currentCat = cat; renderList(); renderCats(); };
        cats.appendChild(b);
      });
    }

    function renderList(){
      const q = (d.getElementById('tplSearch').value||'').toLowerCase();
      list.innerHTML = '';
      const items = TEMPLATES[currentCat]||[];
      items.filter(x=> x.name.toLowerCase().includes(q)).forEach(tpl=>{
        const it = d.createElement('div');
        it.style.cssText = 'padding:10px;border:1px solid rgba(255,255,255,.12);border-radius:10px;margin:6px 2px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:8px;background:'+(selected && selected.id===tpl.id?'rgba(126,231,255,.12)':'rgba(255,255,255,.03)');
        const span = d.createElement('div'); span.textContent = tpl.name;
        const preview = d.createElement('button'); preview.textContent = 'Xem nhanh';
        preview.className = 'btn'; preview.style.cssText = 'padding:6px 8px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.04);border-radius:8px;color:#e6edf7';
        preview.onclick = (ev)=>{ ev.stopPropagation(); showPreview(tpl); };
        it.onclick = ()=>{ selected = tpl; renderList(); };
        it.appendChild(span); it.appendChild(preview);
        list.appendChild(it);
      });
      if(!selected && items.length) selected = items[0];
    }

    function showPreview(tpl){
      const w = window.open('', '_blank', 'width=760,height=860');
      if(!w) return;
      const __md = fillPlaceholders(tpl.body).replace(/[<>&]/g, s=>({"<":"&lt;",">":"&gt;","&":"&amp;"}[s]));
const __html = (window.md2html_gfm ? window.md2html_gfm(__md) : __md.replace(/[<>&]/g,s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s])).replace(/\n/g,'<br>'));
w.document.write('<!doctype html><meta charset="utf-8"><title>Preview</title>'+
'<style>body{font:15px/1.6 system-ui;padding:18px;background:#0b1224;color:#e6edf7}h1,h2,h3{margin:10px 0 8px} p{margin:6px 0}table{border-collapse:collapse;width:100%;margin:12px 0}th,td{border:1px solid rgba(255,255,255,.2);padding:6px 8px;vertical-align:top}th{background:rgba(255,255,255,.06)}code,pre{background:#0e1730;border:1px solid rgba(255,255,255,.08);padding:8px;border-radius:6px;display:block;overflow:auto}blockquote{border-left:3px solid rgba(255,255,255,.25);padding-left:10px;margin:8px 0;color:#bcd}</style>' + __html);
w.document.close();
      w.document.close();
    }

    function doCreate(){
      const tpl = selected || (TEMPLATES[currentCat]||[])[0];
      if(!tpl) return;
      const title = prompt('Tên notebook mới:', tpl.name) || tpl.name;
      const win = frame && (frame.contentWindow || frame.contentDocument?.defaultView);
      const content = normalizeMd(fillPlaceholders(tpl.body));
      try{
        // Preferred path: inner app exposes createNotebook(title, text)
        if(win && typeof win.createNotebook === 'function'){
          win.createNotebook(title, content);
        }else if(win && typeof win.getState === 'function' && typeof win.setState === 'function'){
          const state = win.getState() || {};
          state.notebooks = Array.isArray(state.notebooks)? state.notebooks : [];
          state.notebooks.push({id:Date.now(), title, chunks:[{text:content}], updatedAt:Date.now()});
          win.setState(state);
          if(typeof win.refreshBook === 'function') win.refreshBook();
        }else{
          alert('Không truy cập được app bên trong để tạo notebook.');
        }
      }catch(e){
        console.error(e);
        alert('Lỗi khi tạo notebook từ template.');
      }
      document.body.removeChild(overlay);
    }

    renderCats(); renderList();
    header.querySelector('#tplCreate').onclick = doCreate;
    header.querySelector('#tplClose').onclick = ()=> document.body.removeChild(overlay);
    header.querySelector('#tplSearch').oninput = renderList;

    return overlay;
  }

  // Hook the "Notebook mới" button inside the iframe and intercept click to show the modal
  function attachToIframe(){
    const frame = document.getElementById('frame-nlm');
    if(!frame) return;
    frame.addEventListener('load', ()=>{
      try{
        const doc = frame.contentDocument;
        if(!doc) return;
        const btn = Array.from(doc.querySelectorAll('button, a, .btn')).find(x => (x.textContent||'').trim().toLowerCase() === 'notebook mới');
        if(!btn) return;
        btn.addEventListener('click', (ev)=>{
          ev.preventDefault(); ev.stopImmediatePropagation();
          const modal = createTemplateModal(frame);
          document.body.appendChild(modal);
        }, true); // capture to override earlier handlers
      }catch(e){
        console.warn('Không thể gắn Template Picker vào iframe:', e);
      }
    });
  }

  // Boot
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', attachToIframe);
  else attachToIframe();
})();
</script>


<!-- === Aurora: Template Picker — v3 (full 100+ templates) === -->
<script>
(function(){
  // Data: names only, bodies are generated by a heuristic to keep file size small.
  const TEMPLATE_NAMES = {"A. Học tập & Nghiên cứu": ["Cornell Notes", "Zettelkasten Sup-Card", "Research Log", "Research Canvas", "Research Experiment Log", "Field Notes", "Reading Notes", "Language Study (flashcards)", "Math Problem Solver", "Bluebook Citation Tracker", "Feynman Note", "Literature/Synthesis Matrix", "Q–E–C (Question–Evidence–Conclusion)", "Reading Tracker", "Glossary Builder", "Problem Set/Equation Sheet", "Experiment Preregistration", "Data Collection/Observation Sheet", "Thesis/Dissertation Planner", "SMART Goals", "Spaced Repetition Schedule"], "B. Sáng tạo & Viết lách": ["Brainstorm (grid)", "Mind Map", "Storyboard", "Story Arc Beat Sheet", "Bullet Journal (checklist)", "Cue–Note–Summary", "Dot Grid", "Hex Grid", "Isometric Grid", "Article/Essay Outline", "Editorial Calendar", "PR/FAQ", "Style Guide & Editing Checklist", "Interview Script + Notes", "Quote Bank/Source Tracker", "Snowflake Method", "Character Sheet", "Worldbuilding Sheet", "Scene Card", "Plot Timeline"], "C. Công việc & dự án": ["To-Do / In-Progress / Done (Kanban)", "Kanban Swimlanes", "Weekly Planner", "Monthly Calendar", "Calendar Week", "Daily Time Blocks", "Meeting Minutes", "Meeting Minutes Timeline", "1:1 Meeting Agenda", "Project Brief (Overview/Scope/Timeline)", "Roadmap/Milestones", "Sprint Backlog", "Daily Stand-up (Y–T–B)", "Retrospective (Start–Stop–Continue)", "Stakeholder Map", "Communication Plan", "RTM (Requirements Traceability)", "Gantt (Main Project)", "Design Sprint Canvas", "User Story Map", "OKR Tracker", "KPI Dashboard", "Expense Tracker", "Table of Contents", "Decision Log", "Change Log", "RACI Matrix", "RAID Log", "Risk Register", "Travel Itinerary", "Recipe Card", "Meal Planner"], "D. Kinh doanh & chiến lược": ["SWOT", "PESTLE", "Porter’s Five Forces", "Business Model Canvas", "Lean Canvas", "Value Proposition Canvas", "Competitive Analysis Matrix", "Market Segmentation", "Customer Interview Notes/Insight Log", "Pricing & Packaging Matrix", "Sales CRM Pipeline/Lead Tracker", "Balanced Scorecard", "PRD / One-Pager"], "E. Thiết kế & UX": ["User Persona", "Empathy Map", "Customer Journey Map", "Jobs-To-Be-Done Canvas", "Feature Prioritization (RICE)", "Impact–Effort Matrix", "Usability Test Plan & Findings", "Heuristic Evaluation (Nielsen)", "Wireframe Annotations", "Design Critique Notes", "A/B Test Plan & Results"], "F. Kỹ thuật & dữ liệu": ["API Design / API Redesign", "Coding Session Log", "ADR (Architecture Decision Record)", "Runbook/On-call Playbook", "RCA & Postmortem (5 Whys/Fishbone)", "Test Case Matrix", "Bug Report", "Release Notes", "Debugging Journal", "CLI Cheatsheet", "ML Experiment Tracker", "Dataset Datasheet / Model Card", "EDA Checklist", "Metrics Definition Sheet", "Data Pipeline/DAG Planner"], "G. Luật & tranh luận": ["Case Brief (IRAC)", "CREAC/CRAC Brief", "Statute/Regulation Tracker", "Shepardizing/KeyCite Log", "Exam Attack Outline", "Debate Flow"], "H. Cá nhân – sức khỏe – tài chính": ["Habit Tracker", "Sleep Log", "Mood Tracker", "Energy Tracker", "Workout Log", "Body Measurements", "Water Intake", "Medication/Supplement Log", "Monthly Budget", "Cashflow", "Net-Worth Tracker", "Debt Payoff", "Savings Goals", "Subscription Tracker", "Packing List", "Housekeeping Checklist", "Maintenance Schedule"]};

  // ---------- utils ----------
  function slug(s){
    return String(s||'').toLowerCase()
      .normalize('NFD').replace(/\p{Diacritic}+/gu,'')
      .replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
  }
  function today(){ return new Date().toISOString().slice(0,10); }
  function nowTs(){ return Date.now(); }
  function thisMonth(){
    const d=new Date(); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0');
  }
  function weekOfYear(){
    const d=new Date(), oneJan=new Date(d.getFullYear(),0,1);
    return Math.ceil((((d - oneJan)/86400000) + oneJan.getDay()+1)/7);
  }
  function fill(s){
    return String(s||'')
      .replaceAll('{today}', today())
      .replaceAll('{ts}', nowTs())
      .replaceAll('{month}', thisMonth())
      .replaceAll('{week}', weekOfYear());
  }

  // ---------- body generator ----------
  function genBody(name, cat){
    const n = name.toLowerCase();
    const head = "# "+name+"\n";
    if(n.includes("kanban")) return head+"\n## To-Do\n- [ ] \n\n## In-Progress\n- [ ] \n\n## Done\n- [x] ";
    if(n.includes("stand-up")||n.includes("y–t–b")||n.includes("y-t-b"))
      return head+"\n**Hôm qua (Y):**\n- \n\n**Hôm nay (T):**\n- \n\n**Cản trở (B):**\n- ";
    if(n.includes("retrospective")) return head+"\n**Start**\n- \n\n**Stop**\n- \n\n**Continue**\n- ";
    if(n.includes("okr")) return head+"\n## Objective 1\n- KR1:  \n- KR2:  \n\n## Objective 2\n- KR1:  ";
    if(n.includes("kpi")) return head+"\n| Chỉ số | Mục tiêu | Thực tế | Ghi chú |\n|---|---:|---:|---|";
    if(n.includes("raci")) return head+"\n| Công việc | R | A | C | I |\n|---|---|---|---|---|";
    if(n.includes("raid")) return head+"\n| Risk | Assumption | Issue | Dependency | Chủ sở hữu |\n|---|---|---|---|---|";
    if(n.includes("risk register")) return head+"\n| ID | Rủi ro | Xác suất | Tác động | Biện pháp | Owner |\n|---|---|---|---|---|---|";
    if(n.includes("gantt")) return head+"\n| Hạng mục | Bắt đầu | Kết thúc | Trạng thái |\n|---|---|---|---|";
    if(n.includes("matrix")||n.includes("tracker"))
      return head+"\n| Mục | Trường 1 | Trường 2 | Ghi chú |\n|---|---|---|---|";
    if(n.includes("log"))
      return head+"Ngày: {today}\nNgữ cảnh:\n\n- Sự kiện: \n- Ghi chú: \n- Việc tiếp theo: ";
    if(n.includes("outline")||n.includes("plan")||n.includes("brief")||n.includes("canvas"))
      return head+"Mục tiêu:\n\nI. \nII. \nIII. \nKết luận/Next steps:\n- ";
    if(n.includes("map"))
      return head+"Trung tâm: \n- Nhánh 1: \n  - \n- Nhánh 2: \n  - ";
    if(n.includes("persona"))
      return head+"Tên/Nhóm:\nMục tiêu:\nNỗi đau:\nHành vi:\nCâu nói mẫu:\nKênh ưa thích:";
    if(n.includes("empathy")) 
      return head+"**Nói**\n- \n\n**Nghĩ**\n- \n\n**Làm**\n- \n\n**Cảm nhận**\n- ";
    if(n.includes("journey"))
      return head+"\n| Giai đoạn | Hành động | Điểm chạm | Cảm xúc | Ý tưởng |\n|---|---|---|---|---|";
    if(n.includes("rice"))
      return head+"\n| Tính năng | Reach | Impact | Confidence | Effort | Score |\n|---|---:|---:|---:|---:|---:|";
    if(n.includes("usability"))
      return head+"Mục tiêu kiểm thử:\nChỉ số thành công:\nKịch bản/Tác vụ:\nQuan sát:\nVấn đề & Đề xuất:";
    if(n.includes("adr"))
      return head+"ID: ADR-{ts}\nBối cảnh:\nQuyết định:\nHệ quả:\nCác lựa chọn xem xét:";
    if(n.includes("runbook"))
      return head+"Dịch vụ:\nMục tiêu SLO:\nLiên hệ:\nQuy trình sự cố:\n1) Phát hiện\n2) Chẩn đoán\n3) Khắc phục\n4) Hậu kiểm\nChecklist:\n- ";
    if(n.includes("postmortem")||n.includes("rca"))
      return head+"Sự cố:\nTác động:\nDòng thời gian:\nNguyên nhân gốc (5 Whys):\n- \nHành động khắc phục:";
    if(n.includes("test case"))
      return head+"\n| ID | Mô tả | Bước | KQ mong đợi | Trạng thái |\n|---|---|---|---|---|";
    if(n.includes("ml experiment"))
      return head+"ID: EXP-{ts}\nDataset:\nModel/Params:\nMetric:\nKết quả:\nGhi chú:";
    if(n.includes("model card")||n.includes("dataset datasheet"))
      return head+"Tên model/dataset:\nPhiên bản:\nMục tiêu sử dụng:\nGiới hạn/Bias:\nChỉ số/Benchmark:";
    if(n.includes("eda checklist"))
      return head+"- Kiểm tra thiếu dữ liệu\n- Phân phối\n- Tương quan\n- Outliers\n- Ghi chú:";
    if(n.includes("metrics definition"))
      return head+"| Metric | Mô tả | Công thức | Nguồn dữ liệu | Owner |\n|---|---|---|---|---|";
    if(n.includes("pipeline")||n.includes("dag"))
      return head+"Nguồn → Xử lý → Lưu trữ → Trình bày\nThành phần:\n- \nLịch chạy:\n- \nTheo dõi lỗi:";
    if(n.includes("irac"))
      return head+"**Issue**\n\n**Rule**\n\n**Application**\n\n**Conclusion**";
    if(n.includes("creac")||n.includes("crac"))
      return head+"**Conclusion (ngắn)**\n**Rule**\n**Explanation**\n**Application**\n**Conclusion (đầy đủ)**";
    if(n.includes("statute")||n.includes("regulation"))
      return head+"\n| Điều khoản | Chủ đề | Cơ quan | Tình trạng | Ghi chú |\n|---|---|---|---|---|";
    if(n.includes("shepard")||n.includes("keycite"))
      return head+"Vụ án/Điều luật:\nKết quả kiểm tra:\nNguồn:\nGhi chú:";
    if(n.includes("exam attack"))
      return head+"Môn/Chủ đề:\nDàn ý tấn công đề:\n- Mẫu lập luận\n- Bẫy thường gặp\n- Lưu ý thời gian";
    if(n.includes("debate"))
      return head+"Nghị quyết:\nAff Case→ Rebuttal\nNeg Case→ Rebuttal\nCross-exam:\n- ";
    if(n.includes("habit")||n.includes("sleep")||n.includes("mood")||n.includes("energy"))
      return head+"Tháng {month}\n| Ngày | Trường | Giá trị/✅ |\n|---|---|---|";
    if(n.includes("workout"))
      return head+"Ngày: {today}\nBài tập | Set x Rep | Ghi chú\n- |- |- ";
    if(n.includes("body measurements"))
      return head+"Ngày: {today}\n| Vòng/Chỉ số | Giá trị |\n|---|---|";
    if(n.includes("budget"))
      return head+"Tháng {month}\n| Hạng mục | Dự toán | Thực chi | Chênh lệch |\n|---|---:|---:|---:|";
    if(n.includes("cashflow"))
      return head+"| Ngày | Thu | Chi | Mô tả |\n|---|---:|---:|---|";
    if(n.includes("net-worth"))
      return head+"| Tài sản | Giá trị | Nợ | Ghi chú |\n|---|---:|---:|---|";
    if(n.includes("debt payoff"))
      return head+"| Khoản nợ | Lãi suất | Số dư | Kế hoạch trả |\n|---|---:|---:|---|";
    if(n.includes("savings goals"))
      return head+"| Mục tiêu | Mốc | Số tiền | Tiến độ |\n|---|---|---:|---:|";
    if(n.includes("subscription"))
      return head+"| Dịch vụ | Gói | Giá | Chu kỳ | Gia hạn |\n|---|---|---:|---|---|";
    if(n.includes("packing"))
      return head+"Điểm đến/Ngày:\n\n## Cần thiết\n- [ ] \n\n## Quần áo\n- [ ] \n\n## Điện tử\n- [ ] ";
    if(n.includes("housekeeping")||n.includes("maintenance"))
      return head+"| Mục | Tần suất | Lần gần nhất | Tiếp theo | Ghi chú |\n|---|---|---|---|---|";
    // generics
    if(n.includes("cornell"))
      return head+"Ngày: {today}\n\n## Cue\n- \n\n## Notes\n- \n\n## Summary\n- ";
    if(n.includes("zettel"))
      return head+"ID: {ts}\nTags: #\n\n## Ý chính\n- \n\n## Nguồn\n- \n\n## Liên kết\n- ";
    if(n.includes("feynman"))
      return head+"Khái niệm:\n1) Giải thích đơn giản:\n- \n2) Tìm lỗ hổng:\n- \n3) Ví dụ:\n- ";
    if(n.includes("q–e–c")||n.includes("q-e-c"))
      return head+"**Question**\n\n**Evidence**\n- \n\n**Conclusion**\n- ";
    if(n.includes("reading notes"))
      return head+"Tác phẩm/Tác giả:\nTrích dẫn then chốt:\n> \nÝ chính:\n- \nCâu hỏi:\n- ";
    if(n.includes("literature"))
      return head+"\n| Nghiên cứu | Phương pháp | Kết quả | Hạn chế | Ghi chú |\n|---|---|---|---|---|";
    return head+"Ngày: {today}\nMục tiêu/Mô tả:\n- \n\nCác mục chính:\n- \n- \n\nViệc tiếp theo:\n- ";
  }

  // Build the runtime templates object once
  function buildTemplates(){
    const out = {};
    Object.entries(TEMPLATE_NAMES).forEach(([cat, arr])=>{
      out[cat] = arr.map(name => ({ id: slug(name), name, body: genBody(name, cat) }));
    });
    return out;
  }
  const RUNTIME_TEMPLATES = buildTemplates();

  // ---------- UI (modal) ----------
  window.createTemplateModal = function(frame){
    const d = document;
    const overlay = d.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(8,12,24,.68);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:9999';
    const box = d.createElement('div');
    box.style.cssText = 'width:min(1000px,92vw);max-height:82vh;overflow:auto;background:#0b1224;border:1px solid rgba(255,255,255,.15);border-radius:16px;box-shadow:0 12px 42px rgba(2,6,23,.7);padding:14px;color:#e6edf7;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto';
    overlay.appendChild(box);

    const header = d.createElement('div');
    header.style.cssText = 'display:flex;align-items:center;gap:10px;margin-bottom:8px';
    header.innerHTML = '<div style="font-weight:800;letter-spacing:.3px">Chọn mẫu ghi chú (100+)</div>' +
      '<input id="tplSearch" type="text" placeholder="Tìm mẫu..." style="flex:1;padding:8px 10px;border:1px solid rgba(255,255,255,.15);border-radius:10px;background:rgba(255,255,255,.04);color:#e6edf7">' +
      '<button id="tplCreate" class="btn" style="padding:8px 12px;border:1px solid rgba(255,255,255,.2);background:linear-gradient(90deg,#8b5cf6,#22d3ee);color:#04111f;border-radius:10px;font-weight:800">Tạo</button>' +
      '<button id="tplClose" class="btn" style="padding:8px 12px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);border-radius:10px;color:#e6edf7">Đóng</button>';
    box.appendChild(header);

    const grid = d.createElement('div');
    grid.style.cssText = 'display:grid;grid-template-columns:260px 1fr;gap:12px';
    box.appendChild(grid);

    const cats = d.createElement('div');
    cats.style.cssText = 'border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:6px;overflow:auto;max-height:60vh';
    const list = d.createElement('div');
    list.style.cssText = 'border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:8px;overflow:auto;max-height:60vh';
    grid.appendChild(cats); grid.appendChild(list);

    let currentCat = Object.keys(RUNTIME_TEMPLATES)[0];
    let selected = null;

    function renderCats(){
      cats.innerHTML = '';
      Object.keys(RUNTIME_TEMPLATES).forEach(cat=>{
        const b = d.createElement('button');
        b.textContent = cat;
        b.style.cssText = 'text-align:left;padding:8px 10px;border:1px solid rgba(255,255,255,.15);background:'+(cat===currentCat?'rgba(139,92,246,.25)':'rgba(255,255,255,.04)')+';border-radius:10px;color:#e6edf7';
        b.onclick = ()=>{ currentCat = cat; renderList(); renderCats(); };
        cats.appendChild(b);
      });
    }

    function renderList(){
      const q = (d.getElementById('tplSearch').value||'').toLowerCase();
      list.innerHTML = '';
      const items = RUNTIME_TEMPLATES[currentCat]||[];
      items.filter(x=> x.name.toLowerCase().includes(q)).forEach(tpl=>{
        const it = d.createElement('div');
        it.style.cssText = 'padding:10px;border:1px solid rgba(255,255,255,.12);border-radius:10px;margin:6px 2px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:8px;background:'+(selected && selected.id===tpl.id?'rgba(126,231,255,.12)':'rgba(255,255,255,.03)');
        const span = d.createElement('div'); span.textContent = tpl.name;
        const preview = d.createElement('button'); preview.textContent = 'Xem nhanh';
        preview.style.cssText = 'padding:6px 8px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.04);border-radius:8px;color:#e6edf7';
        preview.onclick = (ev)=>{ ev.stopPropagation(); const w = window.open('', '_blank', 'width=650,height=750'); if(!w) return; w.document.write('<pre style="white-space:pre-wrap;font:15px/1.5 system-ui;padding:16px;background:#0b1224;color:#e6edf7">'+tpl.body.replace(/[<>&]/g, s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))+'</pre>'); w.document.close(); };
        it.onclick = ()=>{ selected = tpl; renderList(); };
        it.appendChild(span); it.appendChild(preview);
        list.appendChild(it);
      });
      if(!selected && items.length) selected = items[0];
    }

    function doCreate(){
      const tpl = selected || (RUNTIME_TEMPLATES[currentCat]||[])[0];
      if(!tpl) return;
      const title = prompt('Tên notebook mới:', tpl.name) || tpl.name;
      const win = frame && (frame.contentWindow || frame.contentDocument?.defaultView);
      const content = fill(tpl.body);
      try{
        if(win && typeof win.createNotebook === 'function'){ win.createNotebook(title, content); }
        else if(win && typeof win.getState === 'function' && typeof win.setState === 'function'){ 
          const state = win.getState() || {};
          state.notebooks = Array.isArray(state.notebooks)? state.notebooks : [];
          state.notebooks.push({id:Date.now(), title, chunks:[{text:content}], updatedAt:Date.now()});
          win.setState(state);
          if(typeof win.refreshBook === 'function') win.refreshBook();
        }else{ alert('Không truy cập được app bên trong để tạo notebook.'); }
      }catch(e){ console.error(e); alert('Lỗi khi tạo notebook từ template.'); }
      document.body.removeChild(overlay);
    }

    header.querySelector('#tplCreate').onclick = doCreate;
    header.querySelector('#tplClose').onclick = ()=> document.body.removeChild(overlay);
    header.querySelector('#tplSearch').oninput = renderList;

    renderCats(); renderList();
    return overlay;
  };

  // ---------- robust hook to button "+ Notebook mới" ----------
  function normText(s){
    return String(s||'').replace(/[+•\u2022]/g,' ').replace(/\s+/g,' ').trim().toLowerCase();
  }
  function findNewBtn(doc){
    const nodes = doc.querySelectorAll('button, a, .btn, [role="button"]');
    for(const el of nodes){ const t = normText(el.textContent); if(t.includes('notebook') && (t.includes('mới')||t.includes('new'))) return el; }
    return null;
  }
  function install(){
    const frame = document.getElementById('frame-nlm'); if(!frame) return;
    const attach = ()=>{ try{ const doc = frame.contentDocument; if(!doc) return false; const btn = findNewBtn(doc); if(!btn) return false; if(btn.dataset.__tplHooked) return true; btn.dataset.__tplHooked='1'; btn.addEventListener('click',(ev)=>{ ev.preventDefault(); ev.stopImmediatePropagation(); document.body.appendChild(window.createTemplateModal(frame)); }, true); return true; }catch(e){return false;} };
    if(attach()) return;
    frame.addEventListener('load', attach);
    let tries=0; const t=setInterval(()=>{ if(attach()||++tries>40) clearInterval(t); }, 500);
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', install);
  else install();
})();
</script>


<!-- === Aurora: Template Picker — v3.1 (override + null-safe) === -->
<script>
(function(){
  const TEMPLATE_NAMES = {"A. Học tập & Nghiên cứu": ["Cornell Notes", "Zettelkasten Sup-Card", "Research Log", "Research Canvas", "Research Experiment Log", "Field Notes", "Reading Notes", "Language Study (flashcards)", "Math Problem Solver", "Bluebook Citation Tracker", "Feynman Note", "Literature/Synthesis Matrix", "Q–E–C (Question–Evidence–Conclusion)", "Reading Tracker", "Glossary Builder", "Problem Set/Equation Sheet", "Experiment Preregistration", "Data Collection/Observation Sheet", "Thesis/Dissertation Planner", "SMART Goals", "Spaced Repetition Schedule"], "B. Sáng tạo & Viết lách": ["Brainstorm (grid)", "Mind Map", "Storyboard", "Story Arc Beat Sheet", "Bullet Journal (checklist)", "Cue–Note–Summary", "Dot Grid", "Hex Grid", "Isometric Grid", "Article/Essay Outline", "Editorial Calendar", "PR/FAQ", "Style Guide & Editing Checklist", "Interview Script + Notes", "Quote Bank/Source Tracker", "Snowflake Method", "Character Sheet", "Worldbuilding Sheet", "Scene Card", "Plot Timeline"], "C. Công việc & dự án": ["To-Do / In-Progress / Done (Kanban)", "Kanban Swimlanes", "Weekly Planner", "Monthly Calendar", "Calendar Week", "Daily Time Blocks", "Meeting Minutes", "Meeting Minutes Timeline", "1:1 Meeting Agenda", "Project Brief (Overview/Scope/Timeline)", "Roadmap/Milestones", "Sprint Backlog", "Daily Stand-up (Y–T–B)", "Retrospective (Start–Stop–Continue)", "Stakeholder Map", "Communication Plan", "RTM (Requirements Traceability)", "Gantt (Main Project)", "Design Sprint Canvas", "User Story Map", "OKR Tracker", "KPI Dashboard", "Expense Tracker", "Table of Contents", "Decision Log", "Change Log", "RACI Matrix", "RAID Log", "Risk Register", "Travel Itinerary", "Recipe Card", "Meal Planner"], "D. Kinh doanh & chiến lược": ["SWOT", "PESTLE", "Porter’s Five Forces", "Business Model Canvas", "Lean Canvas", "Value Proposition Canvas", "Competitive Analysis Matrix", "Market Segmentation", "Customer Interview Notes/Insight Log", "Pricing & Packaging Matrix", "Sales CRM Pipeline/Lead Tracker", "Balanced Scorecard", "PRD / One-Pager"], "E. Thiết kế & UX": ["User Persona", "Empathy Map", "Customer Journey Map", "Jobs-To-Be-Done Canvas", "Feature Prioritization (RICE)", "Impact–Effort Matrix", "Usability Test Plan & Findings", "Heuristic Evaluation (Nielsen)", "Wireframe Annotations", "Design Critique Notes", "A/B Test Plan & Results"], "F. Kỹ thuật & dữ liệu": ["API Design / API Redesign", "Coding Session Log", "ADR (Architecture Decision Record)", "Runbook/On-call Playbook", "RCA & Postmortem (5 Whys/Fishbone)", "Test Case Matrix", "Bug Report", "Release Notes", "Debugging Journal", "CLI Cheatsheet", "ML Experiment Tracker", "Dataset Datasheet / Model Card", "EDA Checklist", "Metrics Definition Sheet", "Data Pipeline/DAG Planner"], "G. Luật & tranh luận": ["Case Brief (IRAC)", "CREAC/CRAC Brief", "Statute/Regulation Tracker", "Shepardizing/KeyCite Log", "Exam Attack Outline", "Debate Flow"], "H. Cá nhân – sức khỏe – tài chính": ["Habit Tracker", "Sleep Log", "Mood Tracker", "Energy Tracker", "Workout Log", "Body Measurements", "Water Intake", "Medication/Supplement Log", "Monthly Budget", "Cashflow", "Net-Worth Tracker", "Debt Payoff", "Savings Goals", "Subscription Tracker", "Packing List", "Housekeeping Checklist", "Maintenance Schedule"]};

  function slug(s){return String(s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}+/gu,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');}
  function today(){ return new Date().toISOString().slice(0,10); }
  function thisMonth(){ const d=new Date(); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0'); }
  function weekOfYear(){ const d=new Date(),oneJan=new Date(d.getFullYear(),0,1); return Math.ceil((((d-oneJan)/86400000)+oneJan.getDay()+1)/7); }
  function fill(s){ return String(s||'').replaceAll('{today}',today()).replaceAll('{month}',thisMonth()).replaceAll('{week}',weekOfYear()).replaceAll('{ts}',Date.now()); }

  function genBody(name){ const n=name.toLowerCase(), head = "# "+name+"\n"; 
    if(n.includes('kanban')) return head+"\n## To-Do\n- [ ] \n\n## In-Progress\n- [ ] \n\n## Done\n- [x] ";
    if(n.includes('stand-up')||n.includes('y–t–b')||n.includes('y-t-b')) return head+"\n**Hôm qua (Y):**\n- \n\n**Hôm nay (T):**\n- \n\n**Cản trở (B):**\n- ";
    if(n.includes('retrospective')) return head+"\n**Start**\n- \n\n**Stop**\n- \n\n**Continue**\n- ";
    if(n.includes('okr')) return head+"\n## Objective 1\n- KR1:  \n- KR2:  ";
    if(n.includes('kpi')) return head+"\n| Chỉ số | Mục tiêu | Thực tế | Ghi chú |\n|---|---:|---:|---|";
    if(n.includes('raci')) return head+"\n| Công việc | R | A | C | I |\n|---|---|---|---|---|";
    if(n.includes('raid')) return head+"\n| Risk | Assumption | Issue | Dependency | Owner |\n|---|---|---|---|---|";
    if(n.includes('risk register')) return head+"\n| ID | Rủi ro | Xác suất | Tác động | Biện pháp | Owner |\n|---|---|---|---|---|---|";
    if(n.includes('matrix')||n.includes('tracker')) return head+"\n| Mục | Trường 1 | Trường 2 | Ghi chú |\n|---|---|---|---|";
    if(n.includes('log')) return head+"Ngày: {today}\nNgữ cảnh:\n- Sự kiện: \n- Ghi chú: \n- Việc tiếp theo: ";
    if(n.includes('outline')||n.includes('plan')||n.includes('brief')||n.includes('canvas')) return head+"Mục tiêu:\nI. \nII. \nIII. \nKết luận/Next steps:\n- ";
    if(n.includes('persona')) return head+"Tên/Nhóm:\nMục tiêu:\nNỗi đau:\nHành vi:\nCâu nói mẫu:\nKênh ưa thích:";
    if(n.includes('cornell')) return head+"Ngày: {today}\n\n## Cue\n- \n\n## Notes\n- \n\n## Summary\n- ";
    if(n.includes('zettel')) return head+"ID: {ts}\nTags: #\n\n## Ý chính\n- \n\n## Nguồn\n- \n\n## Liên kết\n- ";
    if(n.includes('feynman')) return head+"Khái niệm:\n1) Giải thích đơn giản\n- \n2) Tìm lỗ hổng\n- \n3) Ví dụ\n- ";
    return head+"Ngày: {today}\nMô tả:\n- \n\nCác mục:\n- \n- \n\nTiếp theo:\n- ";
  }

  function buildTemplates(){ const out={}; Object.entries(TEMPLATE_NAMES).forEach(([cat,arr])=>{ out[cat]=arr.map(n=>({id:slug(n),name:n,body:genBody(n)})); }); return out; }
  const RUNTIME_TEMPLATES = buildTemplates();

  window.createTemplateModal = function(frame){
    const d=document, uniq='tplSearch_'+Date.now();
    const overlay=d.createElement('div'); overlay.style.cssText='position:fixed;inset:0;background:rgba(8,12,24,.68);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:9999';
    const box=d.createElement('div'); box.style.cssText='width:min(1000px,92vw);max-height:82vh;overflow:auto;background:#0b1224;border:1px solid rgba(255,255,255,.15);border-radius:16px;box-shadow:0 12px 42px rgba(2,6,23,.7);padding:14px;color:#e6edf7;font-family:Inter,system-ui,-apple-system';
    overlay.appendChild(box);

    const header=d.createElement('div'); header.style.cssText='display:flex;align-items:center;gap:10px;margin-bottom:8px';
    header.innerHTML='<div style="font-weight:800">Chọn mẫu ghi chú (100+)</div>'+
      '<input id="'+uniq+'" type="text" placeholder="Tìm mẫu..." style="flex:1;padding:8px 10px;border:1px solid rgba(255,255,255,.15);border-radius:10px;background:rgba(255,255,255,.04);color:#e6edf7">'+
      '<button id="tplCreate" style="padding:8px 12px;border:1px solid rgba(255,255,255,.2);background:linear-gradient(90deg,#8b5cf6,#22d3ee);color:#04111f;border-radius:10px;font-weight:800">Tạo</button>'+
      '<button id="tplClose" style="padding:8px 12px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);border-radius:10px;color:#e6edf7">Đóng</button>';
    box.appendChild(header);

    const grid=d.createElement('div'); grid.style.cssText='display:grid;grid-template-columns:260px 1fr;gap:12px'; box.appendChild(grid);
    const cats=d.createElement('div'); cats.style.cssText='border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:6px;overflow:auto;max-height:60vh';
    const list=d.createElement('div'); list.style.cssText='border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:8px;overflow:auto;max-height:60vh';
    grid.appendChild(cats); grid.appendChild(list);

    let currentCat=Object.keys(RUNTIME_TEMPLATES)[0], selected=null;

    function renderCats(){ cats.innerHTML=''; Object.keys(RUNTIME_TEMPLATES).forEach(cat=>{ const b=d.createElement('button'); b.textContent=cat; b.style.cssText='text-align:left;padding:8px 10px;border:1px solid rgba(255,255,255,.15);background:'+(cat===currentCat?'rgba(139,92,246,.25)':'rgba(255,255,255,.04)')+';border-radius:10px;color:#e6edf7'; b.onclick=()=>{ currentCat=cat; renderList(); renderCats(); }; cats.appendChild(b); }); }
    function renderList(){ const search=d.getElementById(uniq); const q=((search&&search.value)||'').toLowerCase(); list.innerHTML=''; (RUNTIME_TEMPLATES[currentCat]||[]).filter(x=>x.name.toLowerCase().includes(q)).forEach(tpl=>{ const it=d.createElement('div'); it.style.cssText='padding:10px;border:1px solid rgba(255,255,255,.12);border-radius:10px;margin:6px 2px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:8px;background:'+(selected&&selected.id===tpl.id?'rgba(126,231,255,.12)':'rgba(255,255,255,.03)'); const span=d.createElement('div'); span.textContent=tpl.name; const preview=d.createElement('button'); preview.textContent='Xem nhanh'; preview.style.cssText='padding:6px 8px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.04);border-radius:8px;color:#e6edf7'; preview.onclick=(ev)=>{ ev.stopPropagation(); const w=window.open('', '_blank', 'width=650,height=750'); if(!w) return; w.document.write('<pre style=\'white-space:pre-wrap;font:15px/1.5 system-ui;padding:16px;background:#0b1224;color:#e6edf7\'>'+tpl.body.replace(/[<>&]/g, s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))+'</pre>'); w.document.close(); }; it.onclick=()=>{ selected=tpl; renderList(); }; it.appendChild(span); it.appendChild(preview); list.appendChild(it); }); if(!selected && (RUNTIME_TEMPLATES[currentCat]||[]).length) selected=(RUNTIME_TEMPLATES[currentCat]||[])[0]; }
    function doCreate(){ const tpl= selected || (RUNTIME_TEMPLATES[currentCat]||[])[0]; if(!tpl) return; const title=prompt('Tên notebook mới:', tpl.name) || tpl.name; const win=frame && (frame.contentWindow || frame.contentDocument?.defaultView); const content=fill(tpl.body); try{ if(win && typeof win.createNotebook==='function'){ win.createNotebook(title, content); } else if(win && typeof win.getState==='function' && typeof win.setState==='function'){ const state=win.getState()||{}; state.notebooks=Array.isArray(state.notebooks)? state.notebooks:[]; state.notebooks.push({id:Date.now(), title, chunks:[{text:content}], updatedAt:Date.now()}); win.setState(state); if(typeof win.refreshBook==='function') win.refreshBook(); } else { alert('Không truy cập được app bên trong để tạo notebook.'); } }catch(e){ console.error(e); alert('Lỗi khi tạo notebook từ template.'); } document.body.removeChild(overlay); }
    header.querySelector('#tplClose').onclick=()=>document.body.removeChild(overlay);
    header.querySelector('#tplCreate').onclick=doCreate;
    const search=d.getElementById(uniq); if(search) search.oninput=renderList;
    renderCats(); renderList();
    return overlay;
  };
})();
</script>


<!-- === Aurora: Template Picker — v3.2 (official bodies + filled preview) === -->
<script>
(function(){
  const TEMPLATES = {"A. Học tập & Nghiên cứu": [{"id": "cornell-notes", "name": "Cornell Notes", "body": "# Cornell Notes — v2\n\n> **Ngày:** {{today}} · **Môn/Chủ đề:**  · **Nguồn:**  · **Tags:** #  \n> **Hướng dẫn:** Viết nhanh ở cột Notes; đặt câu hỏi/cue ở cột trái; chốt tóm tắt 3–5 dòng ở cuối.\n\n---\n\n## Tóm tắt nhanh (3–5 dòng)\n- \n- \n- \n\n---\n\n## Cue (Câu hỏi/Ý chính)\n| # | Câu hỏi/Cue | Trang/Mốc | Từ khóa |\n|---:|---|---:|---|\n| 1 |  |  |  |\n| 2 |  |  |  |\n| 3 |  |  |  |\n\n## Notes (Ghi chú chi tiết)\n- \n- \n- \n\n---\n\n## Summary (Tóm tắt cuối)\n**1 câu:**  \n**Ứng dụng/Next action:** - [ ] \n\n"}, {"id": "zettelkasten-sup-card", "name": "Zettelkasten Sup-Card", "body": "# Zettelkasten Sup-Card — v2\n\n> **ID:** {{ts}} · **Ngày:** {{today}} · **Tags:** #  \n> **Loại thẻ:** (Ý tưởng • Khẳng định • Gợi ý • Trích dẫn)\n\n---\n\n## Tiêu đề ngắn gọn\n- \n\n## Nội dung (1 ý/1 thẻ – viết bằng lời của bạn)\n- \n\n## Tại sao quan trọng?\n- \n\n## Trích dẫn / Nguồn\n> Tác giả, năm, trang/URL: \n\n## Liên kết\n- Upstream (nguồn gốc): \n- Downstream (ứng dụng): \n- Thẻ liên quan: [[ ]]\n\n## Gợi ý hành động\n- [ ] \n\n"}, {"id": "feynman-note", "name": "Feynman Note", "body": "# Feynman Note — v2\n\n> **Ngày:** {{today}} · **Chủ đề:**  · **Mức hiện tại:** (mù/mơ hồ/khá rõ)\n\n---\n\n## 1) Giải thích đơn giản cho “người mới”\n- \n\n## 2) Lộ chỗ mù / kiểm tra hiểu\n- Câu hỏi còn kẹt:\n- Nhầm lẫn phổ biến:\n\n## 3) Ví dụ minh hoạ (số, hình, tình huống)\n- \n\n## 4) Ôn lại → sửa lại lời giải thích\n- Phiên bản rút gọn, đúng và rõ hơn:\n\n## 5) Ứng dụng/Next action\n- [ ] \n\n"}, {"id": "reading-notes", "name": "Reading Notes", "body": "# Reading Notes — v2\n\n> **Tác phẩm:**  · **Tác giả:**  · **Chương/Trang:**  · **Ngày:** {{today}}  \n> **Lý do đọc:** \n\n---\n\n## Trích đoạn/Ý chốt\n> \n\n## Ý chính\n- \n\n## Câu hỏi mở\n- \n\n## Ứng dụng/Hành động\n- [ ] \n\n## Trích dẫn chuẩn\n> “…” — *Tác giả, Năm, trang …*\n\n"}, {"id": "reading-tracker", "name": "Reading Tracker", "body": "# Reading Tracker — v2\n\n> **Bắt đầu:** {{today}} · **Mục tiêu/tuần:**  trang · **Tags:** #\n\n| Ngày | Tác phẩm | Thời gian (phút) | Trang bắt đầu | Trang kết thúc | Ghi chú |\n|---|---|---:|---:|---|\n|  |  |  |  |  |  |\n|  |  |  |  |  |  |\n|  |  |  |  |  |  |\n\n**Tổng tuần:**  phút ·  trang\n\n"}, {"id": "field-notes", "name": "Field Notes", "body": "# Field Notes — v2\n\n> **Ngày/Giờ:** {{today}} · **Địa điểm:**  · **Người tham gia:**  · **Vai trò quan sát:** (ẩn/hiện)  \n\n---\n\n## Mô tả thô (kronos)\n- Ai? làm gì? ở đâu? khi nào? thế nào?\n\n## Quan sát có cấu trúc\n- Sự kiện → Phản ứng → Hệ quả\n\n## Phản tư/giải thích (kairos)\n- Giả thuyết ban đầu:\n- Lệch/thiên kiến có thể có:\n\n## Từ khóa\n# \n\n## Việc tiếp theo\n- [ ] \n\n"}, {"id": "literature-synthesis-matrix", "name": "Literature/Synthesis Matrix", "body": "# Literature/Synthesis Matrix — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Literature/Synthesis Matrix\n| Nghiên cứu | Câu hỏi | Phương pháp | Kết quả chính | Hạn chế | Ghi chú |\n|---|---|---|---|---|---|\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n"}, {"id": "q-e-c-question-evidence-conclusion", "name": "Q–E–C (Question–Evidence–Conclusion)", "body": "# Q–E–C (Question–Evidence–Conclusion) — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Q–E–C (Question–Evidence–Conclusion)\n**Question (Câu hỏi):**\n\n**Evidence (Bằng chứng):**\n- \n\n**Conclusion (Kết luận):**\n- "}, {"id": "research-log", "name": "Research Log", "body": "# Research Log — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Research Log\nNgày: {{today}}\nMục tiêu phiên:\nTừ khóa:\nNguồn tra cứu:\nGhi chú:\nViệc tiếp theo:"}, {"id": "research-canvas", "name": "Research Canvas", "body": "# Research Canvas — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Research Canvas\n| Vấn đề | Giả thuyết | Phương pháp | Dữ liệu | Tiêu chí thành công | Rủi ro |\n|---|---|---|---|---|---|\n|   |   |   |   |   |   |\n"}, {"id": "research-experiment-log", "name": "Research Experiment Log", "body": "# Research Experiment Log — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Research Experiment Log\nThí nghiệm:\nGiả thuyết:\nThiết kế:\nBiến độc lập/phụ thuộc:\nQuy trình:\nKết quả quan sát:\nPhân tích:\nKết luận:\nNext:"}, {"id": "experiment-preregistration", "name": "Experiment Preregistration", "body": "# Experiment Preregistration — v2\n\n> **Đề tài:**  · **Nhóm:**  · **Ngày:** {{today}} · **Phiên bản:** v1  \n> **Nền tảng đăng ký:** (OSF/AsPredicted/…) · **Mã dự án:** \n\n---\n\n## 1) Giả thuyết\n- **H1 (chính):** \n- **H2 (phụ):** \n\n## 2) Biến & thao tác hoá\n- **Độc lập (IV):** \n- **Phụ thuộc (DV):** \n- **Điều khiển/Hiệp biến:** \n\n## 3) Thiết kế & mẫu\n- Kiểu nghiên cứu (giữa/luân phiên/trộn):\n- Cỡ mẫu dự kiến & tính toán power:\n- Tuyển mẫu & ngẫu nhiên hoá:\n- Tiêu chí loại trừ trước nghiên cứu:\n\n## 4) Quy trình & vật liệu\n1. \n2. \n\n## 5) Kế hoạch phân tích\n- Làm sạch dữ liệu (quy tắc trước): \n- Mô hình/kiểm định chính: \n- Ngưỡng ý nghĩa / điều chỉnh bội: \n- Phân tích thăm dò (exploratory): \n\n## 6) Đăng ký lúc\n- Thời điểm đóng băng giả thuyết & plan: {{today}}\n\n---\n\n## Nhật ký lệch so với prereg\n| Ngày | Mục ảnh hưởng | Mô tả lệch | Lý do | Ảnh hưởng tới kết luận |\n|---|---|---|---|---|\n|  |  |  |  |  |\n\n"}, {"id": "data-collection-observation-sheet", "name": "Data Collection/Observation Sheet", "body": "# Data Collection/Observation Sheet — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Data Collection/Observation Sheet\n| Thời điểm | Địa điểm | Đối tượng | Quan sát | Mã/Tag |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "math-problem-solver", "name": "Math Problem Solver", "body": "# Math Problem Solver — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Math Problem Solver\nBài toán:\nKý hiệu:\n\n## Ý tưởng chính\n- \n\n## Lời giải\n- \n\n## Kiểm tra & Trường hợp biên\n- "}, {"id": "problem-set-equation-sheet", "name": "Problem Set/Equation Sheet", "body": "# Problem Set/Equation Sheet — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Problem Set/Equation Sheet\n| # | Bài/Phương trình | Cách giải/Chứng minh | Kết quả | Ghi chú |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "thesis-dissertation-planner", "name": "Thesis/Dissertation Planner", "body": "# Thesis/Dissertation Planner — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Thesis/Dissertation Planner\n| Chương | Mục tiêu | T/g dự kiến | Deadline | Trạng thái |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "bluebook-citation-tracker", "name": "Bluebook Citation Tracker", "body": "# Bluebook Citation Tracker — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Bluebook Citation Tracker\n| Nguồn | Loại trích dẫn | Trang/Pinpoint | Cú pháp Bluebook | Ghi chú |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "glossary-builder", "name": "Glossary Builder", "body": "# Glossary Builder — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Glossary Builder\n| Thuật ngữ | Định nghĩa | Nguồn | Ví dụ |\n|---|---|---|---|\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n"}, {"id": "smart-goals", "name": "SMART Goals", "body": "# SMART Goals — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# SMART Goals\n- **Specific:**\n- **Measurable:**\n- **Achievable:**\n- **Relevant:**\n- **Time-bound:**"}, {"id": "spaced-repetition-schedule", "name": "Spaced Repetition Schedule", "body": "# Spaced Repetition Schedule — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Spaced Repetition Schedule\n| Mục | Ngày tạo | Interval | Ease | Lần ôn tiếp | Ghi chú |\n|---|---|---|---|---|---|\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n"}, {"id": "language-study-flashcards", "name": "Language Study (flashcards)", "body": "# Language Study (flashcards) — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Language Study (flashcards)\n| Từ/Cụm | Nghĩa | Loại từ | Ví dụ | Điểm khó |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}], "B. Sáng tạo & Viết lách": [{"id": "brainstorm-grid", "name": "Brainstorm (grid)", "body": "# Brainstorm (grid) — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Brainstorm (grid)\n| Chủ đề | Ý tưởng | Nhóm | Ghi chú |\n|---|---|---|---|\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n"}, {"id": "mind-map", "name": "Mind Map", "body": "# Mind Map — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Mind Map\nTrung tâm:\n- Nhánh 1:\n  - \n- Nhánh 2:\n  - \n- Nhánh 3:\n  - "}, {"id": "storyboard", "name": "Storyboard", "body": "# Storyboard — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Storyboard\n| Cảnh # | Mô tả khung hình | Lời thoại/Âm thanh | Ghi chú |\n|---|---|---|---|\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n"}, {"id": "story-arc-beat-sheet", "name": "Story Arc Beat Sheet", "body": "# Story Arc Beat Sheet — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Story Arc Beat Sheet\nAct I — Setup:\n- \nInciting Incident:\n- \nAct II — Confrontation:\n- \nMidpoint:\n- \nAct III — Resolution:\n- "}, {"id": "scene-card", "name": "Scene Card", "body": "# Scene Card — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Scene Card\n| # | Mục tiêu cảnh | Nhân vật | Xung đột | Kết quả |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "plot-timeline", "name": "Plot Timeline", "body": "# Plot Timeline — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Plot Timeline\n| Mốc | Sự kiện | Nhân vật | Tác động |\n|---|---|---|---|\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n"}, {"id": "snowflake-method", "name": "Snowflake Method", "body": "# Snowflake Method — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Snowflake Method\nB1. Tóm tắt 1 câu:\n- \nB2. Tóm tắt 1 đoạn:\n- \nB3. Nhân vật chính:\n- \nB4. Mở rộng cốt truyện:\n- "}, {"id": "character-sheet", "name": "Character Sheet", "body": "# Character Sheet — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Character Sheet\n| Tên | Vai trò | Động cơ | Vết thương/Khuyết | Bí mật |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "worldbuilding-sheet", "name": "Worldbuilding Sheet", "body": "# Worldbuilding Sheet — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Worldbuilding Sheet\nThế giới:\nLịch sử:\nĐịa lý/Khí hậu:\nVăn hoá/Chính trị:\nPhép/Công nghệ:\nQuy tắc nền:"}, {"id": "cue-note-summary", "name": "Cue–Note–Summary", "body": "# Cue–Note–Summary — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Cue–Note–Summary\nCue:\n- \n\nNote:\n- \n\nSummary:\n- "}, {"id": "bullet-journal-checklist", "name": "Bullet Journal (checklist)", "body": "# Bullet Journal (checklist) — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Bullet Journal (checklist)\n- [ ] Việc 1\n- [ ] Việc 2\n- [ ] Việc 3"}, {"id": "article-essay-outline", "name": "Article/Essay Outline", "body": "# Article/Essay Outline — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Article/Essay Outline\nTiêu đề:\nLuận đề (thesis):\nI. Lập luận 1\n- Bằng chứng:\nII. Lập luận 2\n- Bằng chứng:\nIII. Lập luận 3\n- Bằng chứng:\nKết luận/CTA:"}, {"id": "editorial-calendar", "name": "Editorial Calendar", "body": "# Editorial Calendar — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Editorial Calendar\n| Tuần | Chủ đề | Kênh | Trạng thái | Ghi chú |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "pr-faq", "name": "PR/FAQ", "body": "# PR/FAQ — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# PR/FAQ\n## PR\nThông cáo (1 trang):\n\n## FAQ\n1) \n2) \n3) "}, {"id": "style-guide-editing-checklist", "name": "Style Guide & Editing Checklist", "body": "# Style Guide & Editing Checklist — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Style Guide & Editing Checklist\nGiọng điệu:\nNgôi xưng:\nTránh:\nFormatting:\nChecklist chỉnh sửa:\n- "}, {"id": "interview-script-notes", "name": "Interview Script + Notes", "body": "# Interview Script + Notes — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Interview Script + Notes\nMục tiêu phỏng vấn:\nĐối tượng:\nKịch bản mở đầu:\nCâu hỏi:\n1) \n2) \n3) \n\nGhi chú trong buổi:\n- "}, {"id": "quote-bank-source-tracker", "name": "Quote Bank/Source Tracker", "body": "# Quote Bank/Source Tracker — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Quote Bank/Source Tracker\n| Trích dẫn | Tác giả/Nguồn | Chủ đề | Trang/URL | Ghi chú |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "dot-grid", "name": "Dot Grid", "body": "# Dot Grid — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Dot Grid\n(In/ghi tay theo lưới.)"}, {"id": "hex-grid", "name": "Hex Grid", "body": "# Hex Grid — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Hex Grid\n(In/ghi tay theo lưới.)"}, {"id": "isometric-grid", "name": "Isometric Grid", "body": "# Isometric Grid — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Isometric Grid\n(In/ghi tay theo lưới.)"}], "C. Công việc & dự án": [{"id": "to-do-in-progress-done-kanban", "name": "To-Do / In-Progress / Done (Kanban)", "body": "# To-Do / In-Progress / Done (Kanban) — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# To-Do / In-Progress / Done (Kanban)\n## To-Do\n- [ ] \n\n## In-Progress\n- [ ] \n\n## Done\n- [x] "}, {"id": "kanban-swimlanes", "name": "Kanban Swimlanes", "body": "# Kanban Swimlanes — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Kanban Swimlanes\n| Swimlane | To-Do | Doing | Done |\n|---|---|---|---|\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n"}, {"id": "weekly-planner", "name": "Weekly Planner", "body": "# Weekly Planner — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Weekly Planner\n| Ngày | Ưu tiên | Sự kiện cố định | Việc chính | Ghi chú |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "monthly-calendar", "name": "Monthly Calendar", "body": "# Monthly Calendar — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Monthly Calendar\n| Ngày | Mục tiêu | Sự kiện | Ghi chú |\n|---|---|---|---|\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n"}, {"id": "calendar-week", "name": "Calendar Week", "body": "# Calendar Week — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Calendar Week\n| Thứ | Sáng | Chiều | Tối | Ghi chú |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "daily-time-blocks", "name": "Daily Time Blocks", "body": "# Daily Time Blocks — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Daily Time Blocks\n| Khung giờ | Công việc | Trạng thái | Ghi chú |\n|---|---|---|---|\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n"}, {"id": "meeting-minutes", "name": "Meeting Minutes", "body": "# Meeting Minutes — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Meeting Minutes\nCuộc họp:\nNgày/Giờ:\nNgười tham gia:\nAgenda:\n1) \n2) \n3) \n\nQuyết định:\n- \nHành động (Owner/Deadline):\n- "}, {"id": "meeting-minutes-timeline", "name": "Meeting Minutes Timeline", "body": "# Meeting Minutes Timeline — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Meeting Minutes Timeline\n| Mốc thời gian | Sự kiện/Ý kiến | Người nói | Ghi chú |\n|---|---|---|---|\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n"}, {"id": "1-1-meeting-agenda", "name": "1:1 Meeting Agenda", "body": "# 1:1 Meeting Agenda — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# 1:1 Meeting Agenda\nMục tiêu buổi 1:1:\n\n### Người A\n- Wins\n- Concerns\n- Growth\n\n### Người B\n- Wins\n- Concerns\n- Growth\n\nAction items:"}, {"id": "project-brief-overview-scope-timeline", "name": "Project Brief (Overview/Scope/Timeline)", "body": "# Project Brief (Overview/Scope/Timeline) — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Project Brief (Overview/Scope/Timeline)\n| Mục | Mô tả |\n|---|---|\nTổng quan:\nMục tiêu thành công:\nScope (In/Out):\nMốc/Timeline:\nRủi ro chính:\nStakeholders:\nNgân sách/KPI:"}, {"id": "roadmap-milestones", "name": "Roadmap/Milestones", "body": "# Roadmap/Milestones — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Roadmap/Milestones\n| Mốc | Mô tả | Chủ sở hữu | Ngày | Trạng thái |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "sprint-backlog", "name": "Sprint Backlog", "body": "# Sprint Backlog — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Sprint Backlog\n| User Story | Ưu tiên | Điểm | Trạng thái | Ghi chú |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "daily-stand-up-y-t-b", "name": "Daily Stand-up (Y–T–B)", "body": "# Daily Stand-up (Y–T–B) — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Daily Stand-up (Y–T–B)\n**Hôm qua (Y):**\n- \n**Hôm nay (T):**\n- \n**Cản trở (B):**\n- "}, {"id": "retrospective-start-stop-continue", "name": "Retrospective (Start–Stop–Continue)", "body": "# Retrospective (Start–Stop–Continue) — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Retrospective (Start–Stop–Continue)\n**Start**\n- \n\n**Stop**\n- \n\n**Continue**\n- "}, {"id": "stakeholder-map", "name": "Stakeholder Map", "body": "# Stakeholder Map — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Stakeholder Map\n| Nhóm | Quyền lực | Quan tâm | Thông điệp chính | Kênh |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "communication-plan", "name": "Communication Plan", "body": "# Communication Plan — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Communication Plan\n| Đối tượng | Thông điệp | Kênh | Tần suất | Owner |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "rtm-requirements-traceability", "name": "RTM (Requirements Traceability)", "body": "# RTM (Requirements Traceability) — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# RTM (Requirements Traceability)\n| Requirement ID | Nguồn | Thiết kế/Liên kết | Test Case | Trạng thái |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "gantt-main-project", "name": "Gantt (Main Project)", "body": "# Gantt (Main Project) — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Gantt (Main Project)\n| Hạng mục | Bắt đầu | Kết thúc | Owner | Trạng thái |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "design-sprint-canvas", "name": "Design Sprint Canvas", "body": "# Design Sprint Canvas — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Design Sprint Canvas\n| Ngày | Hoạt động | Kết quả mong đợi | Ghi chú |\n|---|---|---|---|\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n"}, {"id": "user-story-map", "name": "User Story Map", "body": "# User Story Map — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# User Story Map\n| Hoạt động | Bước | User Stories | Ghi chú |\n|---|---|---|---|\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n"}, {"id": "okr-tracker", "name": "OKR Tracker", "body": "# OKR Tracker — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# OKR Tracker\n## Objective 1\n- KR1:  \n- KR2:  \n- KR3:  \n\nSáng kiến:\n- "}, {"id": "kpi-dashboard", "name": "KPI Dashboard", "body": "# KPI Dashboard — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# KPI Dashboard\n| Chỉ số | Định nghĩa | Mục tiêu | Gần nhất | Xu hướng | Owner |\n|---|---|---|---|---|---|\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n"}, {"id": "expense-tracker", "name": "Expense Tracker", "body": "# Expense Tracker — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Expense Tracker\n| Ngày | Hạng mục | Giá trị | Ngân sách | Ghi chú |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "table-of-contents", "name": "Table of Contents", "body": "# Table of Contents — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Table of Contents\n1. \n2. \n3. \n4. "}, {"id": "decision-log", "name": "Decision Log", "body": "# Decision Log — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Decision Log\n| Ngày | Quyết định | Lý do | Tuỳ chọn đã cân nhắc | Tác động | Owner |\n|---|---|---|---|---|---|\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n"}, {"id": "change-log", "name": "Change Log", "body": "# Change Log — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Change Log\n| Phiên bản/Ngày | Thay đổi | Ai | Lý do |\n|---|---|---|---|\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n"}, {"id": "raci-matrix", "name": "RACI Matrix", "body": "# RACI Matrix — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# RACI Matrix\n| Công việc | R | A | C | I |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "raid-log", "name": "RAID Log", "body": "# RAID Log — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# RAID Log\n| Risk | Assumption | Issue | Dependency | Owner | Ghi chú |\n|---|---|---|---|---|---|\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n"}, {"id": "risk-register", "name": "Risk Register", "body": "# Risk Register — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Risk Register\n| ID | Rủi ro | Xác suất | Tác động | Mitigation | Owner | Trạng thái |\n|---|---|---|---|---|---|---|\n|   |   |   |   |   |   |   |\n|   |   |   |   |   |   |   |\n|   |   |   |   |   |   |   |\n|   |   |   |   |   |   |   |\n|   |   |   |   |   |   |   |\n|   |   |   |   |   |   |   |\n|   |   |   |   |   |   |   |\n|   |   |   |   |   |   |   |\n"}, {"id": "travel-itinerary", "name": "Travel Itinerary", "body": "# Travel Itinerary — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Travel Itinerary\n| Ngày | Chuyến bay/Di chuyển | Lưu trú | Lịch trình | Ghi chú |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "recipe-card", "name": "Recipe Card", "body": "# Recipe Card — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Recipe Card\nMón:\nKhẩu phần:\nNguyên liệu:\n- \nCách làm:\n1) \n2) \n3) \nGhi chú:"}, {"id": "meal-planner", "name": "Meal Planner", "body": "# Meal Planner — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Meal Planner\n| Ngày | Sáng | Trưa | Tối | Snack | Ghi chú |\n|---|---|---|---|---|---|\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n"}], "D. Kinh doanh & chiến lược": [{"id": "swot", "name": "SWOT", "body": "# SWOT — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# SWOT\n**Strengths**\n- \n\n**Weaknesses**\n- \n\n**Opportunities**\n- \n\n**Threats**\n- "}, {"id": "pestle", "name": "PESTLE", "body": "# PESTLE — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# PESTLE\n**Political**\n- \n**Economic**\n- \n**Social**\n- \n**Technological**\n- \n**Legal**\n- \n**Environmental**\n- "}, {"id": "porter-s-five-forces", "name": "Porter’s Five Forces", "body": "# Porter’s Five Forces — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Porter’s Five Forces\n- Rivalry among Competitors:\n- Threat of New Entrants:\n- Bargaining Power of Suppliers:\n- Bargaining Power of Buyers:\n- Threat of Substitutes:"}, {"id": "business-model-canvas", "name": "Business Model Canvas", "body": "# Business Model Canvas — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Business Model Canvas\n| CS | VP | CH | CR | RS | KR | KA | KP | C$ |\n|---|---|---|---|---|---|---|---|---|\n|   |   |   |   |   |   |   |   |   |\n\n(CS: Customer Segments, VP: Value Propositions, CH: Channels, CR: Relationships, RS: Revenue Streams, KR: Key Resources, KA: Activities, KP: Partnerships, C$: Cost Structure)"}, {"id": "lean-canvas", "name": "Lean Canvas", "body": "# Lean Canvas — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Lean Canvas\n| Vấn đề | Giải pháp | Key Metrics | UVP | Lợi thế | Kênh | Cấu trúc chi phí | Dòng doanh thu |\n|---|---|---|---|---|---|---|---|\n|   |   |   |   |   |   |   |   |\n"}, {"id": "value-proposition-canvas", "name": "Value Proposition Canvas", "body": "# Value Proposition Canvas — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Value Proposition Canvas\n| Jobs | Pains | Gains |\n|---|---|---|\n|   |   |   |\n\n| Pain relievers | Gain creators | Products/Services |\n|---|---|---|\n|   |   |   |\n"}, {"id": "competitive-analysis-matrix", "name": "Competitive Analysis Matrix", "body": "# Competitive Analysis Matrix — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Competitive Analysis Matrix\n| Đối thủ | Phân khúc | Tính năng chính | Giá | USP | Ghi chú |\n|---|---|---|---|---|---|\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n"}, {"id": "market-segmentation", "name": "Market Segmentation", "body": "# Market Segmentation — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Market Segmentation\n| Phân khúc | Đặc điểm | Nhu cầu | Thông điệp | Kênh |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "customer-interview-notes-insight-log", "name": "Customer Interview Notes/Insight Log", "body": "# Customer Interview Notes/Insight Log — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Customer Interview Notes/Insight Log\nHồ sơ khách:\nMục tiêu buổi:\nCâu hỏi:\n1) \n2) \n3) \n\nInsight rút ra:\n- "}, {"id": "pricing-packaging-matrix", "name": "Pricing & Packaging Matrix", "body": "# Pricing & Packaging Matrix — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Pricing & Packaging Matrix\n| Gói | Tính năng | Giá | Đối tượng | Ghi chú |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "sales-crm-pipeline-lead-tracker", "name": "Sales CRM Pipeline/Lead Tracker", "body": "# Sales CRM Pipeline/Lead Tracker — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Sales CRM Pipeline/Lead Tracker\n| Lead | Nguồn | Giai đoạn | Giá trị | Next step | Owner |\n|---|---|---|---|---|---|\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n"}, {"id": "balanced-scorecard", "name": "Balanced Scorecard", "body": "# Balanced Scorecard — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Balanced Scorecard\n| Góc nhìn | Mục tiêu | Chỉ tiêu | Sáng kiến | Owner |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "prd-one-pager", "name": "PRD / One-Pager", "body": "# PRD / One-Pager — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# PRD / One-Pager\n## Bối cảnh\n\n## Vấn đề & Mục tiêu\n\n## Yêu cầu (MVP)\n- \n\n## Phạm vi ngoài (Out of scope)\n- \n\n## Chỉ số/KPI\n- \n\n## Timeline\n- "}], "E. Thiết kế & UX": [{"id": "user-persona", "name": "User Persona", "body": "# User Persona — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# User Persona\n| Tên | Nhân khẩu học | Mục tiêu | Nỗi đau | Hành vi | Câu nói mẫu | Kênh |\n|---|---|---|---|---|---|---|\n|   |   |   |   |   |   |   |\n"}, {"id": "empathy-map", "name": "Empathy Map", "body": "# Empathy Map — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Empathy Map\n**Nói**\n- \n\n**Nghĩ**\n- \n\n**Làm**\n- \n\n**Cảm nhận**\n- \n\nNỗi đau/Lợi ích:\n- "}, {"id": "customer-journey-map", "name": "Customer Journey Map", "body": "# Customer Journey Map — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Customer Journey Map\n| Giai đoạn | Hành động | Điểm chạm | Cảm xúc | Ý tưởng |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "jobs-to-be-done-canvas", "name": "Jobs-To-Be-Done Canvas", "body": "# Jobs-To-Be-Done Canvas — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Jobs-To-Be-Done Canvas\n| Tình huống | Động lực | Kết quả mong muốn | Rào cản |\n|---|---|---|---|\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n"}, {"id": "feature-prioritization-rice", "name": "Feature Prioritization (RICE)", "body": "# Feature Prioritization (RICE) — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Feature Prioritization (RICE)\n| Tính năng | Reach | Impact | Confidence | Effort | Score |\n|---|---|---|---|---|---|\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n"}, {"id": "impact-effort-matrix", "name": "Impact–Effort Matrix", "body": "# Impact–Effort Matrix — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Impact–Effort Matrix\n| Hạng mục | Tác động | Nỗ lực | Ghi chú |\n|---|---|---|---|\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n"}, {"id": "usability-test-plan-findings", "name": "Usability Test Plan & Findings", "body": "# Usability Test Plan & Findings — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Usability Test Plan & Findings\nMục tiêu:\nChỉ số thành công:\nTuyển mẫu:\nKịch bản:\nTác vụ:\nQuan sát:\nVấn đề & mức nghiêm trọng:\nĐề xuất:"}, {"id": "heuristic-evaluation-nielsen", "name": "Heuristic Evaluation (Nielsen)", "body": "# Heuristic Evaluation (Nielsen) — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Heuristic Evaluation (Nielsen)\n| Nguyên tắc Nielsen | Phát hiện | Mức nghiêm trọng | Gợi ý |\n|---|---|---|---|\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n"}, {"id": "wireframe-annotations", "name": "Wireframe Annotations", "body": "# Wireframe Annotations — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Wireframe Annotations\n| Màn hình | Thành phần | Hành vi | Ghi chú |\n|---|---|---|---|\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n"}, {"id": "design-critique-notes", "name": "Design Critique Notes", "body": "# Design Critique Notes — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Design Critique Notes\nMục tiêu buổi critique:\nĐiều tốt:\nCó thể tốt hơn:\nRủi ro:\nQuyết định:"}, {"id": "a-b-test-plan-results", "name": "A/B Test Plan & Results", "body": "# A/B Test Plan & Results — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# A/B Test Plan & Results\nGiả thuyết:\nChỉ số mục tiêu:\nThiết kế thử nghiệm:\nBiến A:\nBiến B:\nKích thước mẫu:\nKết quả:\nKết luận & quyết định:"}], "F. Kỹ thuật & dữ liệu": [{"id": "api-design-api-redesign", "name": "API Design / API Redesign", "body": "# API Design / API Redesign — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# API Design / API Redesign\nDịch vụ:\nUse cases:\nEndpoints:\n- `GET /` : \n- `POST /` : \nSchemas:\n- Request/Response\nBảo mật/Rate limit:\nGhi chú triển khai:"}, {"id": "coding-session-log", "name": "Coding Session Log", "body": "# Coding Session Log — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Coding Session Log\nNgày: {{today}}\nMục tiêu:\nBước thực hiện:\n- \nKết quả:\n- \nVấn đề tồn tại:\n- \nBước tiếp:"}, {"id": "adr-architecture-decision-record", "name": "ADR (Architecture Decision Record)", "body": "# ADR (Architecture Decision Record) — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# ADR (Architecture Decision Record)\nID: ADR-{{ts}}\nBối cảnh:\nQuyết định:\nLý do:\nTác động:\nCác phương án đã cân nhắc:"}, {"id": "runbook-on-call-playbook", "name": "Runbook/On-call Playbook", "body": "# Runbook/On-call Playbook — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Runbook/On-call Playbook\nDịch vụ:\nMục tiêu SLO:\nLiên hệ:\n\n## Quy trình sự cố\n1) Phát hiện\n2) Chẩn đoán\n3) Khắc phục\n4) Hậu kiểm\n\nChecklist:\n- "}, {"id": "rca-postmortem-5-whys-fishbone", "name": "RCA & Postmortem (5 Whys/Fishbone)", "body": "# RCA & Postmortem (5 Whys/Fishbone) — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# RCA & Postmortem (5 Whys/Fishbone)\nSự cố:\nTác động:\nDòng thời gian:\n\n## 5 Whys\n1. \n2. \n3. \n4. \n5. \n\n## Sơ đồ xương cá (nhánh)\n- Con người\n- Quy trình\n- Công cụ\n- Khác\n\nHành động khắc phục:"}, {"id": "test-case-matrix", "name": "Test Case Matrix", "body": "# Test Case Matrix — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Test Case Matrix\n| ID | Mô tả | Tiền điều kiện | Bước | KQ mong đợi | Trạng thái |\n|---|---|---|---|---|---|\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n"}, {"id": "bug-report", "name": "Bug Report", "body": "# Bug Report — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Bug Report\nTiêu đề lỗi:\nMôi trường:\nBước tái hiện:\nKết quả hiện tại:\nKết quả mong đợi:\nẢnh/Log:\nĐộ ưu tiên:"}, {"id": "release-notes", "name": "Release Notes", "body": "# Release Notes — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Release Notes\n| Phiên bản | Ngày | Mục nổi bật | Sửa lỗi | Lưu ý nâng cấp |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "debugging-journal", "name": "Debugging Journal", "body": "# Debugging Journal — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Debugging Journal\nVấn đề:\nGiả thuyết:\nThử nghiệm:\nKết quả:\nKế hoạch tiếp:\nTài liệu/Link:"}, {"id": "cli-cheatsheet", "name": "CLI Cheatsheet", "body": "# CLI Cheatsheet — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# CLI Cheatsheet\nLệnh hay dùng:\n- \n- \n- "}, {"id": "ml-experiment-tracker", "name": "ML Experiment Tracker", "body": "# ML Experiment Tracker — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# ML Experiment Tracker\n| EXP ID | Dataset | Model/Params | Metric | Kết quả | Ghi chú |\n|---|---|---|---|---|---|\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n|   |   |   |   |   |   |\n"}, {"id": "dataset-datasheet-model-card", "name": "Dataset Datasheet / Model Card", "body": "# Dataset Datasheet / Model Card — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Dataset Datasheet / Model Card\n| Tên/Version | Nguồn | Miêu tả | Giới hạn/Bias | Giấy phép |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n\n| Chỉ số | Tập | Giá trị |\n|---|---|---|\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n"}, {"id": "eda-checklist", "name": "EDA Checklist", "body": "# EDA Checklist — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# EDA Checklist\n- Kiểm tra thiếu dữ liệu\n- Phân phối & mô tả\n- Tương quan\n- Outliers\n- Feature types\n- Ghi chú"}, {"id": "metrics-definition-sheet", "name": "Metrics Definition Sheet", "body": "# Metrics Definition Sheet — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Metrics Definition Sheet\n| Metric | Định nghĩa | Công thức | Nguồn dữ liệu | Owner |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "data-pipeline-dag-planner", "name": "Data Pipeline/DAG Planner", "body": "# Data Pipeline/DAG Planner — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Data Pipeline/DAG Planner\nSơ đồ: Nguồn → Xử lý → Lưu trữ → Trình bày\nThành phần:\n- \nLịch chạy:\n- \nTheo dõi lỗi:\n- "}], "G. Luật & tranh luận": [{"id": "case-brief-irac", "name": "Case Brief (IRAC)", "body": "# Case Brief (IRAC) — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Case Brief (IRAC)\n**Issue:**\n\n**Rule:**\n\n**Application:**\n\n**Conclusion:**"}, {"id": "creac-crac-brief", "name": "CREAC/CRAC Brief", "body": "# CREAC/CRAC Brief — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# CREAC/CRAC Brief\n**Conclusion (ngắn):**\n**Rule:**\n**Explanation:**\n**Application:**\n**Conclusion (đầy đủ):**"}, {"id": "statute-regulation-tracker", "name": "Statute/Regulation Tracker", "body": "# Statute/Regulation Tracker — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Statute/Regulation Tracker\n| Điều khoản | Chủ đề | Cơ quan | Tình trạng | Ghi chú |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "shepardizing-keycite-log", "name": "Shepardizing/KeyCite Log", "body": "# Shepardizing/KeyCite Log — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Shepardizing/KeyCite Log\n| Vụ án/Điều luật | Kết quả | Nguồn | Ngày | Ghi chú |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "exam-attack-outline", "name": "Exam Attack Outline", "body": "# Exam Attack Outline — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Exam Attack Outline\nMôn/Chủ đề:\n\nChiến lược tấn công:\n- Issue spotting\n- Cấu trúc lập luận\n- Quản lý thời gian\n\nGhi chú luyện đề:"}, {"id": "debate-flow", "name": "Debate Flow", "body": "# Debate Flow — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Debate Flow\nNghị quyết:\n\n**Aff**\n- Case:\n- Rebuttal:\n\n**Neg**\n- Case:\n- Rebuttal:\n\nCross-exam:\n- "}], "H. Cá nhân – sức khỏe – tài chính": [{"id": "habit-tracker", "name": "Habit Tracker", "body": "# Habit Tracker — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Habit Tracker\nTháng {{month}}\n| Ngày | Thói quen | ✅ |\n|---|---|---|\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n"}, {"id": "sleep-log", "name": "Sleep Log", "body": "# Sleep Log — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Sleep Log\n| Ngày | Giờ ngủ | Giờ dậy | Chất lượng (1–5) | Ghi chú |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "mood-tracker", "name": "Mood Tracker", "body": "# Mood Tracker — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Mood Tracker\n| Ngày | Tâm trạng (1–5) | Yếu tố | Ghi chú |\n|---|---|---|---|\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n"}, {"id": "energy-tracker", "name": "Energy Tracker", "body": "# Energy Tracker — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Energy Tracker\n| Ngày | Năng lượng (1–5) | Hoạt động | Ghi chú |\n|---|---|---|---|\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n"}, {"id": "workout-log", "name": "Workout Log", "body": "# Workout Log — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Workout Log\n| Ngày | Bài tập | Set x Rep | Tải (kg) | Ghi chú |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "body-measurements", "name": "Body Measurements", "body": "# Body Measurements — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Body Measurements\n| Vòng/Chỉ số | Giá trị | Ghi chú |\n|---|---|---|\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n"}, {"id": "water-intake", "name": "Water Intake", "body": "# Water Intake — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Water Intake\n| Ngày | Số ly (250ml) | Ghi chú |\n|---|---|---|\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n|   |   |   |\n"}, {"id": "medication-supplement-log", "name": "Medication/Supplement Log", "body": "# Medication/Supplement Log — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Medication/Supplement Log\n| Ngày | Tên | Liều | Thời điểm | Ghi chú |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "monthly-budget", "name": "Monthly Budget", "body": "# Monthly Budget — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Monthly Budget\nTháng {{month}}\n| Hạng mục | Dự toán | Thực chi | Chênh lệch | Ghi chú |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "cashflow", "name": "Cashflow", "body": "# Cashflow — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Cashflow\n| Ngày | Khoản thu | Khoản chi | Mô tả |\n|---|---|---|---|\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n"}, {"id": "net-worth-tracker", "name": "Net-Worth Tracker", "body": "# Net-Worth Tracker — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Net-Worth Tracker\n| Tài sản | Giá trị | Nợ | Ghi chú |\n|---|---|---|---|\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n"}, {"id": "debt-payoff", "name": "Debt Payoff", "body": "# Debt Payoff — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Debt Payoff\n| Khoản nợ | Lãi suất | Số dư | Kế hoạch trả |\n|---|---|---|---|\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n"}, {"id": "savings-goals", "name": "Savings Goals", "body": "# Savings Goals — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Savings Goals\n| Mục tiêu | Mốc | Số tiền | Tiến độ |\n|---|---|---|---|\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n|   |   |   |   |\n"}, {"id": "subscription-tracker", "name": "Subscription Tracker", "body": "# Subscription Tracker — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Subscription Tracker\n| Dịch vụ | Gói | Giá | Chu kỳ | Gia hạn |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "packing-list", "name": "Packing List", "body": "# Packing List — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Packing List\nĐiểm đến/Ngày:\n\n## Cần thiết\n- [ ] \n\n## Quần áo\n- [ ] \n\n## Điện tử\n- [ ] \n\n## Khác\n- [ ] "}, {"id": "housekeeping-checklist", "name": "Housekeeping Checklist", "body": "# Housekeeping Checklist — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Housekeeping Checklist\n| Mục | Tần suất | Lần gần nhất | Tiếp theo | Ghi chú |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}, {"id": "maintenance-schedule", "name": "Maintenance Schedule", "body": "# Maintenance Schedule — v2\n\n> **Ngày:** {today} · **Tags:** # · **Trạng thái:** Draft  \n> **Nguồn:**  · **Tác giả:**  \n\n---\n\n# Maintenance Schedule\n| Hạng mục | Chu kỳ | Lần gần nhất | Tiếp theo | Trách nhiệm |\n|---|---|---|---|---|\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n|   |   |   |   |   |\n"}]};

  function fill(s){
    const d = new Date();
    const today = d.toISOString().slice(0,10);
    const month = d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0');
    const week = (()=>{const onejan=new Date(d.getFullYear(),0,1);return Math.ceil((((d-onejan)/86400000)+onejan.getDay()+1)/7);})();
    return String(s||'').replaceAll('{today}',today).replaceAll('{month}',month).replaceAll('{week}',week).replaceAll('{ts}', Date.now());
  }
  function createModal(frame){
    const d=document, uniq='tplSearch_'+Date.now();
    const overlay=d.createElement('div'); overlay.style.cssText='position:fixed;inset:0;background:rgba(8,12,24,.68);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:9999';
    const box=d.createElement('div'); box.style.cssText='width:min(1100px,94vw);max-height:84vh;overflow:auto;background:#0b1224;border:1px solid rgba(255,255,255,.15);border-radius:16px;box-shadow:0 12px 42px rgba(2,6,23,.7);padding:14px;color:#e6edf7;font-family:Inter,system-ui,-apple-system';
    overlay.appendChild(box);
    const header=d.createElement('div'); header.style.cssText='display:flex;align-items:center;gap:10px;margin-bottom:8px';
    header.innerHTML='<div style="font-weight:800">Chọn mẫu ghi chú (100+)</div>'+
      '<input id="'+uniq+'" type="text" placeholder="Tìm mẫu..." style="flex:1;padding:8px 10px;border:1px solid rgba(255,255,255,.15);border-radius:10px;background:rgba(255,255,255,.04);color:#e6edf7">'+
      '<button id="tplCreate" style="padding:8px 12px;border:1px solid rgba(255,255,255,.2);background:linear-gradient(90deg,#8b5cf6,#22d3ee);color:#04111f;border-radius:10px;font-weight:800">Tạo</button>'+
      '<button id="tplClose" style="padding:8px 12px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);border-radius:10px;color:#e6edf7">Đóng</button>';
    box.appendChild(header);
    const grid=d.createElement('div'); grid.style.cssText='display:grid;grid-template-columns:280px 1fr;gap:12px'; box.appendChild(grid);
    const cats=d.createElement('div'); cats.style.cssText='border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:6px;overflow:auto;max-height:64vh';
    const list=d.createElement('div'); list.style.cssText='border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:8px;overflow:auto;max-height:64vh';
    grid.appendChild(cats); grid.appendChild(list);
    let currentCat=Object.keys(TEMPLATES)[0], selected=null;
    function renderCats(){
      cats.innerHTML='';
      Object.keys(TEMPLATES).forEach(cat=>{const b=d.createElement('button'); b.textContent=cat; b.style.cssText='text-align:left;padding:8px 10px;border:1px solid rgba(255,255,255,.15);background:'+(cat===currentCat?'rgba(139,92,246,.25)':'rgba(255,255,255,.04)')+';border-radius:10px;color:#e6edf7'; b.onclick=()=>{ currentCat=cat; renderList(); renderCats(); }; cats.appendChild(b); });
    }
    function renderList(){
      const q=((d.getElementById(uniq)||{}).value||'').toLowerCase();
      list.innerHTML='';
      (TEMPLATES[currentCat]||[]).filter(x=>x.name.toLowerCase().includes(q)).forEach(tpl=>{
        const it=d.createElement('div'); it.style.cssText='padding:10px;border:1px solid rgba(255,255,255,.12);border-radius:10px;margin:6px 2px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:8px;background:'+(selected&&selected.id===tpl.id?'rgba(126,231,255,.12)':'rgba(255,255,255,.03)') ;
        const span=d.createElement('div'); span.textContent=tpl.name;
        const preview=d.createElement('button'); preview.textContent='Xem nhanh';
        preview.style.cssText='padding:6px 8px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.04);border-radius:8px;color:#e6edf7';
        preview.onclick=(ev)=>{ ev.stopPropagation(); const w=window.open('', '_blank', 'width=780,height=820'); if(!w) return; w.document.write('<pre style="white-space:pre-wrap;font:15px/1.5 system-ui;padding:16px;background:#0b1224;color:#e6edf7">'+fill(tpl.body).replace(/[<>&]/g, s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))+'</pre>'); w.document.close(); };
        it.onclick=()=>{ selected=tpl; renderList(); };
        it.appendChild(span); it.appendChild(preview);
        list.appendChild(it);
      });
      if(!selected && (TEMPLATES[currentCat]||[]).length) selected=(TEMPLATES[currentCat]||[])[0];
    }
    function doCreate(){
      const tpl= selected || (TEMPLATES[currentCat]||[])[0]; if(!tpl) return;
      const title = prompt('Tên notebook mới:', tpl.name) || tpl.name;
      const win = frame && (frame.contentWindow || frame.contentDocument?.defaultView);
      const content = fill(tpl.body);
      try{
        if(win && typeof win.createNotebook==='function') win.createNotebook(title, content);
        else if(win && typeof win.getState==='function' && typeof win.setState==='function'){ const state=win.getState()||{}; state.notebooks=Array.isArray(state.notebooks)? state.notebooks:[]; state.notebooks.push({id:Date.now(), title, chunks:[{text:content}], updatedAt:Date.now()}); win.setState(state); if(typeof win.refreshBook==='function') win.refreshBook(); }
        else alert('Không truy cập được app bên trong để tạo notebook.');
      }catch(e){ console.error(e); alert('Lỗi khi tạo notebook từ template.'); }
      document.body.removeChild(overlay);
    }
    header.querySelector('#tplCreate').onclick=doCreate;
    header.querySelector('#tplClose').onclick=()=>document.body.removeChild(overlay);
    (d.getElementById(uniq)||{}).oninput=renderList;
    renderCats(); renderList();
    return overlay;
  }
  // override global factory
  window.createTemplateModal = createModal;
})();
</script>


<!-- Aurora quick shim: expose createNotebook/getState/setState inside the Notebook iframe -->
<script>
(function(){
  function installShim(){
    try{
      var frame = document.getElementById('frame-nlm');
      if(!frame) return;
      var win = frame.contentWindow || (frame.contentDocument && frame.contentDocument.defaultView);
      if(!win) return;

      var STORAGE_KEY = 'nlm_mvp_data_v1';
      function load(){ try{ return JSON.parse(win.localStorage.getItem(STORAGE_KEY) || '{}'); }catch(e){ return {}; } }
      function save(state){ try{ win.localStorage.setItem(STORAGE_KEY, JSON.stringify(state || {})); }catch(e){} }

      if(typeof win.getState !== 'function'){ win.getState = function(){ return load(); }; }
      if(typeof win.setState !== 'function'){ win.setState = function(s){ save(s || {}); }; }
      if(typeof win.createNotebook !== 'function'){
        win.createNotebook = function(title, text){
          var s = load();
          var nb = { id: Date.now(), title: title || 'Notebook', chunks: [{text: String(text||'')}], updatedAt: Date.now() };
          if(!Array.isArray(s.notebooks)) s.notebooks = [];
          s.notebooks.push(nb);
          save(s);
          if(typeof win.refreshBook === 'function') try{ win.refreshBook(); }catch(e){}
          try{ alert('Đã tạo notebook từ template. Mở Book View để xem.'); }catch(e){}
        };
      }
    }catch(e){ /* ignore */ }
  }

  // Run once DOM is ready and also after iframe load
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){
      var f = document.getElementById('frame-nlm');
      if(f){ f.addEventListener('load', installShim); }
      setTimeout(installShim, 1200);
    });
  }else{
    var f = document.getElementById('frame-nlm');
    if(f){ f.addEventListener('load', installShim); }
    setTimeout(installShim, 1200);
  }
})();
</script>


<!-- === Aurora: New Notebook -> Template -> Editor flow (v1) === -->
<script>
(function(){
  // Small DOM helpers
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const byText = (tag, txt) => $$(tag).find(e => (e.textContent||'').trim().toLowerCase()===String(txt).toLowerCase());

  // ------- Editor Modal -------
  function openEditorModal(defaultTitle, defaultBody, onSave){
    const overlay = document.createElement('div');
    overlay.style.cssText='position:fixed;inset:0;background:rgba(0,12,28,.66);backdrop-filter:blur(6px);z-index:99999;display:flex;align-items:center;justify-content:center';
    const box = document.createElement('div');
    box.style.cssText='width:min(1000px,92vw);height:min(86vh,900px);display:flex;flex-direction:column;background:#0b1224;border:1px solid rgba(126,231,255,.25);border-radius:14px;box-shadow:0 14px 50px rgba(2,6,23,.72)';
    overlay.appendChild(box);

    const head = document.createElement('div');
    head.style.cssText='display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid rgba(126,231,255,.18)';
    head.innerHTML = '<span style="font-weight:800;letter-spacing:.3px">Soạn nội dung trước khi tạo</span>';
    box.appendChild(head);

    const title = document.createElement('input');
    title.type='text'; title.value = defaultTitle||'Notebook';
    title.placeholder='Tiêu đề'; title.style.cssText='margin:10px 12px;padding:10px;border:1px solid rgba(126,231,255,.18);border-radius:10px;background:rgba(255,255,255,.03);color:#e6edf7;';
    box.appendChild(title);

    const ta = document.createElement('textarea');
    ta.value = defaultBody||'';
    ta.style.cssText='flex:1;margin:0 12px 12px 12px;padding:12px;font:15px/1.5 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#08101f;color:#e6edf7;border:1px solid rgba(126,231,255,.14);border-radius:10px;white-space:pre;';
    box.appendChild(ta);

    const bar = document.createElement('div');
    bar.style.cssText='display:flex;gap:10px;justify-content:flex-end;padding:10px 12px;border-top:1px solid rgba(126,231,255,.18)';
    const save=document.createElement('button'); save.textContent='Lưu & Tạo';
    save.style.cssText='padding:8px 12px;border:1px solid rgba(126,231,255,.35);background:linear-gradient(180deg,#7ee7ff,#22d3ee);color:#04111f;font-weight:800;border-radius:10px';
    const cancel=document.createElement('button'); cancel.textContent='Hủy';
    cancel.style.cssText='padding:8px 12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#e6edf7;border-radius:10px';
    bar.appendChild(cancel); bar.appendChild(save); box.appendChild(bar);

    cancel.onclick=()=> document.body.removeChild(overlay);
    save.onclick=()=>{ try{ onSave && onSave(title.value||'Notebook', ta.value||''); } finally { document.body.removeChild(overlay); } };

    document.body.appendChild(overlay);
  }

  // ------- Wrap createNotebook so it always opens the editor first -------
  function wrapCreateNotebook(ctx){
    try{
      const g = ctx || window;
      if(!g.__origCreateNotebook && typeof g.createNotebook==='function'){
        g.__origCreateNotebook = g.createNotebook;
        g.createNotebook = function(title, body){
          openEditorModal(title, body, (t,b)=> g.__origCreateNotebook.call(g, t, b));
        };
      }
    }catch(_){}
  }

  // ------- Install flow on "+ Notebook mới" button -------
  function installNewNotebookFlow(){
    const btn = byText('button','Notebook mới') || byText('div','Notebook mới');
    if(!btn) return false;
    btn.addEventListener('click', (ev)=>{
      try{
        ev.preventDefault(); ev.stopImmediatePropagation();
      }catch(_){}
      // Prefer using the big template picker already present in file
      const frame = document.getElementById('frame-nlm');
      if(typeof window.createTemplateModal === 'function'){
        // Ensure editor wrapper is active in both contexts
        wrapCreateNotebook(window);
        if(frame && frame.contentWindow){
          // If iframe has its own createNotebook, wrap it too (after it loads)
          try{ wrapCreateNotebook(frame.contentWindow); }catch(_){}
        }
        const modal = window.createTemplateModal(frame || window);
        document.body.appendChild(modal);
      }else{
        // Fallback: a minimal editor with empty body
        openEditorModal('Notebook', '# Ghi chú mới\\n- ',
          (t,b)=>{ if(typeof window.createNotebook==='function'){ window.createNotebook(t,b); } });
      }
      return false;
    }, true); // capture to override earlier handler
    return true;
  }

  // Wrap on parent
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', ()=>{ wrapCreateNotebook(window); installNewNotebookFlow(); });
  else { wrapCreateNotebook(window); installNewNotebookFlow(); }

  // Also wrap on iframe (when it loads) for safety
  (function attachToFrame(){
    const fr = document.getElementById('frame-nlm');
    if(!fr) return;
    const attach = ()=>{ try{ wrapCreateNotebook(fr.contentWindow); }catch(_){} };
    fr.addEventListener('load', attach);
    // try immediately in case it's already loaded
    attach();
  })();
})();
</script>


<!-- === Aurora: Intercept "+ Notebook mới" click at capture phase (v2) === -->
<script>
(function(){
  function textOf(el){
    return (el && (el.textContent||'')).replace(/\s+/g,' ').trim().toLowerCase();
  }
  function wantsTemplateFlow(el){
    if(!el) return false;
    const txt = textOf(el);
    return txt.includes('notebook mới'); // match "+ Notebook mới" or variants
  }
  function onCapture(ev){
    try{
      const btn = ev.target && ev.target.closest && ev.target.closest('button, .btn, a');
      if(btn && wantsTemplateFlow(btn)){
        ev.preventDefault();
        ev.stopImmediatePropagation();
        ev.stopPropagation();
        // Open the big template picker; pass the NLM iframe so it can write into it
        try {
          var frame = document.getElementById('frame-nlm');
          if(typeof window.createTemplateModal === 'function'){
            var modal = window.createTemplateModal(frame || window);
            document.body.appendChild(modal);
            return false;
          }
        } catch(e){ console.error(e); }
        // Fallback: just prompt then create
        var title = prompt('Tên notebook mới:');
        if(title){
          if(frame && frame.contentWindow && typeof frame.contentWindow.createNotebook==='function'){
            frame.contentWindow.createNotebook(title, '');
          } else if(typeof window.createNotebook==='function'){
            window.createNotebook(title, '');
          }
        }
        return false;
      }
    }catch(e){ /* ignore */ }
  }
  // Attach once
  window.addEventListener('click', onCapture, true);
})();
</script>


<script>
// === NLM TOC: generate from NLM state & navigate to Book View ===
(function(){
  const btnHost = document.getElementById('nlmTocBtn');
  const pane = document.getElementById('nlmTocPane');
  const body = document.getElementById('nlmTocBody');
  const tabNlm = document.getElementById('tab-nlm');
  const tabBook = document.getElementById('tab-book');
  const frame = document.getElementById('frame-nlm');
  const wrap = document.querySelector('.ifr-wrap');

  if(!btnHost || !pane || !body || !frame) return;

  // Show/hide the TOC controls only when NLM tab is active
  function syncVisibility(){
    const isNlm = tabNlm.classList.contains('on');
    btnHost.style.display = isNlm ? 'block' : 'none';
    pane.style.display = (isNlm && pane.getAttribute('data-open')==='1') ? 'flex' : (isNlm?'none':'none');
  }
  syncVisibility();
  ['click'].forEach(ev=>{
    document.getElementById('tab-nlm').addEventListener(ev, ()=>setTimeout(syncVisibility, 50));
    document.getElementById('tab-book').addEventListener(ev, ()=>setTimeout(syncVisibility, 50));
    document.getElementById('tab-kv').addEventListener(ev, ()=>setTimeout(syncVisibility, 50));
  });

  // Toggle
  btnHost.addEventListener('click', function(){
    if(pane.getAttribute('data-open')==='1'){ pane.setAttribute('data-open','0'); }
    else { pane.setAttribute('data-open','1'); buildToc(); }
    syncVisibility();
  });

  function getNlmState(){
    try{
      const win = frame && (frame.contentWindow || frame.contentDocument?.defaultView);
      if(win && typeof win.getState==='function'){
        return win.getState() || {};
      }
    }catch(e){ console.warn(e); }
    // fallback to parent storage (if mirrored)
    try{ return JSON.parse(localStorage.getItem('nlm_mvp_data_v1')||'{}'); }catch(_){}
    return {};
  }

  function extractHeadings(text){
    const items = [];
    if(!text) return items;
    const lines = String(text).split(/\n/);
    for(const line of lines){
      const m = line.match(/^(#{1,3})\s+(.+?)\s*$/);
      if(m){
        const lvl = m[1].length;
        const title = m[2].trim();
        items.push({lvl, title});
      }
    }
    return items;
  }

  function buildToc(){
    body.innerHTML='';
    const state = getNlmState();
    const notebooks = Array.isArray(state.notebooks) ? state.notebooks : [];
    if(!notebooks.length){
      body.innerHTML = '<div style="opacity:.7">Chưa có nội dung.</div>';
      return;
    }
    notebooks.forEach((nb, i)=>{
      const nbTitle = (nb && nb.title) ? nb.title : ('Notebook '+(i+1));
      const h = document.createElement('div');
      h.className = 'item lvl1';
      h.textContent = nbTitle;
      h.setAttribute('data-target', nbTitle);
      h.onclick = ()=> goToInBook(nbTitle);
      body.appendChild(h);
      (Array.isArray(nb.chunks)? nb.chunks : []).forEach(ch=>{
        const text = (ch && ch.text) ? ch.text : '';
        extractHeadings(text).forEach(obj=>{
          const it = document.createElement('div');
          it.className = 'item lvl'+Math.min(3, Math.max(1, obj.lvl));
          it.textContent = obj.title;
          it.setAttribute('data-target', obj.title);
          it.onclick = ()=> goToInBook(obj.title);
          body.appendChild(it);
        });
      });
    });
  }

  // Switch to Book View and scroll to matched heading/content
  window.scrollBookToText = function(text){
    try{
      const book = document.getElementById('book-view');
      const bookContent = book && book.querySelector('#bookContent');
      const bookPages = book && book.querySelector('#bookPages');
      if(!bookContent || !bookPages) return;
      function findEl(){
        // Prefer headings
        const cands = Array.from(bookContent.querySelectorAll('h1,h2,h3,h4'));
        let el = cands.find(e=> (e.textContent||'').trim().toLowerCase() === String(text).trim().toLowerCase());
        if(!el){
          el = cands.find(e=> (e.textContent||'').toLowerCase().includes(String(text).trim().toLowerCase()));
        }
        return el;
      }
      const el = findEl();
      if(!el) return;
      const range = document.createRange(); range.selectNode(el);
      const rect = range.getBoundingClientRect();
      const x = rect.left + scroller.scrollLeft - 60;
        scroller.scrollTo({left:x, behavior:'smooth'});
    }catch(e){ console.warn(e); }
  };

  function goToInBook(text){
    // Switch tab
    try{ tabBook.click(); }catch(_){ document.getElementById('tab-book').dispatchEvent(new Event('click')); }
    // Ensure book is rendered, then scroll
    setTimeout(function(){ 
      if(typeof window.ensureBookReady==='function'){ try{ window.ensureBookReady(); }catch(_){}} 
      setTimeout(()=> window.scrollBookToText(text), 200);
    }, 50);
  }

  // place the TOC button on top of iframe area
  if(wrap && btnHost) { wrap.style.position='relative'; btnHost.style.display='none'; }

  // Expose rebuild for external trigger
  window.rebuildNlmToc = buildToc;
})();
</script>

<script>
try{
  if(typeof ensureBookReady === 'function'){
    window.ensureBookReady = ensureBookReady;
  }
}catch(e){}
</script>


<script>
// Place "Mục lục" button next to "+ Notebook mới" and align the pane under the header row.
(function(){
  const pane   = document.getElementById('nlmTocPane');
  const body   = document.getElementById('nlmTocBody');
  const tabNlm = document.getElementById('tab-nlm');
  const wrap   = document.querySelector('.ifr-wrap');
  if(!pane || !wrap) return;

  function findNotebookNewBtn(){
    // search any .btn whose text equals "Notebook mới" (ignoring whitespace/case)
    const btns = Array.from(document.querySelectorAll('button, .btn'));
    return btns.find(b => (b.textContent||'').replace(/\s+/g,' ').trim().toLowerCase() === '+ notebook mới' 
                       || (b.textContent||'').replace(/\s+/g,' ').trim().toLowerCase() === 'notebook mới');
  }

  function ensureInlineButton(){
    const anchor = findNotebookNewBtn();
    if(!anchor || document.getElementById('btnNlmTocInline')) return false;
    const btn = document.createElement('button');
    btn.id = 'btnNlmTocInline';
    btn.className = anchor.className || 'btn';
    btn.textContent = 'Mục lục';
    // style to match group spacing
    btn.style.marginLeft = '8px';
    btn.addEventListener('click', function(){
      // open/close
      const open = pane.getAttribute('data-open')==='1';
      if(open){ pane.setAttribute('data-open','0'); pane.style.display='none'; return; }
      // calculate top/right so that pane sits right below the header row
      try{
        const rect = anchor.closest('div')?.getBoundingClientRect() || anchor.getBoundingClientRect();
        const container = wrap.getBoundingClientRect();
        const topPx = Math.max( rect.bottom - container.top + 8, 48 );
        pane.style.top = topPx + 'px';
        pane.style.right = '10px';
      }catch(_){}
      pane.setAttribute('data-open','1');
      pane.style.display='flex';
      if(typeof window.rebuildNlmToc==='function') window.rebuildNlmToc();
    });
    anchor.insertAdjacentElement('afterend', btn);
    return true;
  }

  // run when DOM ready and also after tab changes
  const ready = ()=>{ ensureInlineButton(); };
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', ready);
  else ready();

  ['click'].forEach(ev=>{
    tabNlm && tabNlm.addEventListener(ev, ()=> setTimeout(ensureInlineButton, 50));
  });
})();
</script>


<script>
// === Place NLM TOC button to the LEFT of "+ Notebook mới" (inside iframe) ===
(function(){
  function isNlmActive(){
    var tab = document.getElementById('tab-nlm');
    return tab && tab.classList.contains('on');
  }
  function placeNlmTocByNewBtn(){
    try{
      if(!isNlmActive()) return;
      var ifr = document.getElementById('frame-nlm');
      if(!ifr) return;
      var idoc = ifr.contentDocument || (ifr.contentWindow && ifr.contentWindow.document);
      if(!idoc) return;
      var newBtn = idoc.querySelector('#btnNew'); // "+ Notebook mới"
      var hostBtnWrap = document.getElementById('nlmTocBtn');
      var hostBtn = hostBtnWrap && hostBtnWrap.querySelector('button');
      var pane = document.getElementById('nlmTocPane');
      if(!newBtn || !hostBtnWrap || !hostBtn) return;

      // Measure relative to the outer .ifr-wrap (absolute container for TOC controls)
      var container = document.querySelector('.ifr-wrap');
      var contR = container.getBoundingClientRect();
      var ifrR = ifr.getBoundingClientRect();
      var nbR = newBtn.getBoundingClientRect();

      // Ensure host button is visible to get size
      hostBtnWrap.style.display = 'block';
      var hbR = hostBtn.getBoundingClientRect();

      // Compute coordinates so host button sits 8px to the LEFT of "+ Notebook mới"
      var left = (ifrR.left + nbR.left) - contR.left - hbR.width - 8;
      if(left < 12) left = 12; // clamp
      var top  = (ifrR.top + nbR.top) - contR.top + (nbR.height - hbR.height)/2;

      hostBtnWrap.style.left = left + 'px';
      hostBtnWrap.style.top  = Math.max(8, top) + 'px';
      hostBtnWrap.style.right = 'auto'; // override default

      // Anchor the TOC pane just under the host button
      if(pane){
        pane.style.left  = left + 'px';
        pane.style.right = 'auto';
        pane.style.top   = (Math.max(8, top) + hbR.height + 8) + 'px';
      }
    }catch(e){ /* noop */ }
  }

  // Reposition on key lifecycle moments
  window.addEventListener('resize', placeNlmTocByNewBtn);
  var ifr = document.getElementById('frame-nlm');
  if(ifr){
    ifr.addEventListener('load', function(){ setTimeout(placeNlmTocByNewBtn, 200); });
  }
  var tab = document.getElementById('tab-nlm');
  if(tab){
    tab.addEventListener('click', function(){ setTimeout(placeNlmTocByNewBtn, 120); });
  }
  // Small retry loop during first second to catch late layout
  var tries = 0, t = setInterval(function(){
    placeNlmTocByNewBtn();
    if(++tries > 15) clearInterval(t);
  }, 80);
})();
</script>


<script>
(function(){
  function onReady(fn){
    if(document.readyState!=='loading') fn();
    else document.addEventListener('DOMContentLoaded', fn, {once:true});
  }
  onReady(function(){
    const toc = document.getElementById('bookToc');
    const btn = document.getElementById('bookTocBtn');
    if(!toc || !btn) return;

    const STATE_KEY = 'bookTocPinned';
    const WIDTH_KEY = 'bookTocWidth';

    // Create pin button
    const pin = document.createElement('button');
    pin.id = 'bookTocPin';
    pin.className = 'book-btn';
    pin.title = 'Ghim Mục lục (luôn hiện)';
    pin.textContent = '📌';
    btn.insertAdjacentElement('afterend', pin);

    function setVisible(on){
      toc.style.display = on ? 'block' : 'none';
      pin.style.opacity = on ? '1' : '.7';
    }

    // Apply saved width
    const savedW = localStorage.getItem(WIDTH_KEY);
    if(savedW) toc.style.width = savedW;

    // Default: show if pinned; if no state saved yet, default to pinned = true
    let pinned = (localStorage.getItem(STATE_KEY) ?? '0') === '1';
    setVisible(pinned);

    // Pin toggle
    pin.addEventListener('click', function(){
      pinned = !pinned;
      localStorage.setItem(STATE_KEY, pinned ? '1' : '0');
      setVisible(pinned);
    });

    // Keep the original toggle working as a temporary show/hide
    btn.addEventListener('click', function(){
      const visible = toc.style.display !== 'none';
      setVisible(!visible);
    });

    // Save width when resized
    if ('ResizeObserver' in window){
      new ResizeObserver(()=>{
        const w = toc.getBoundingClientRect().width;
        if(w) localStorage.setItem(WIDTH_KEY, Math.round(w)+'px');
      }).observe(toc);
    }
  });
})();
</script>

<script>
// Force remove any pin button and only use ☰ to toggle the Book TOC
document.addEventListener('DOMContentLoaded', function(){
  try {
    var pin = document.getElementById('bookTocPin');
    if (pin) pin.remove();
  } catch(e) {}
  var tocPane = document.getElementById('bookToc');
  var tocBtn  = document.getElementById('bookTocBtn');
  if (tocPane && tocBtn) {
    // ensure hidden by default
    tocPane.style.display = 'none';
    // prevent duplicate handlers by cloning node (optional safety)
    var newBtn = tocBtn.cloneNode(true);
    tocBtn.parentNode.replaceChild(newBtn, tocBtn);
    newBtn.addEventListener('click', function(){
      var d = window.getComputedStyle(tocPane).display;
      tocPane.style.display = (d === 'none') ? 'block' : 'none';
    });
  }
});
</script>

<script>
// === Compact TOC in left "Sổ tay" for NotebookLM ===
(function(){
  const KEY = 'nlm_mvp_data_v1';
  const IFRAME_ID = 'frame-nlm';
  function getStateFromEither(iframe){
    // Prefer iframe.getState(); fallback to localStorage
    try{
      const win = iframe && (iframe.contentWindow || iframe.contentDocument?.defaultView);
      if(win && typeof win.getState==='function') return win.getState() || {};
    }catch(e){}
    try{ return JSON.parse(localStorage.getItem(KEY)||'{}'); }catch(_){ return {}; }
  }
  function extractHeadings(text){
    const items = []; if(!text) return items;
    const lines = String(text).split('\n');
    for(const line of lines){
      const m = line.match(/^(#{1,3})\s+(.+?)\s*$/);
      if(m){ items.push({lvl:m[1].length, title:m[2].trim()}); }
    }
    return items;
  }
  function buildInlineToc(){
    try{
      const iframe = document.getElementById(IFRAME_ID);
      const win = iframe && (iframe.contentWindow || iframe.contentDocument?.defaultView);
      const doc = win && (win.document || iframe.contentDocument);
      if(!doc) return;

      const state = getStateFromEither(iframe);
      const notebooks = Array.isArray(state.notebooks) ? state.notebooks : [];

      // styles (idempotent)
      let style = doc.getElementById('nlmSidebarTocStyle');
      if(!style){
        style = doc.createElement('style');
        style.id = 'nlmSidebarTocStyle';
        style.textContent = `
          #nlmSidebarToc{padding:10px}
          #nlmSidebarToc .sb-title{display:flex;align-items:center;justify-content:space-between;font-weight:700}
          #nlmSidebarToc .ctrls{display:flex;gap:6px}
          #nlmSidebarToc .tiny{font-size:11px;padding:4px 6px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.04);border-radius:8px;cursor:pointer}
          #nlmSidebarToc .search{margin:8px 0 6px}
          #nlmSidebarToc .search input{width:100%;padding:6px 8px;border:1px solid rgba(255,255,255,.12);background:#0b1224;border-radius:8px;color:#dbe7ff}
          #nlmSidebarToc details{border:1px solid rgba(255,255,255,.08);border-radius:10px;margin:6px 0;background:rgba(255,255,255,.02)}
          #nlmSidebarToc summary{list-style:none;padding:8px 10px;cursor:pointer;font-weight:600}
          #nlmSidebarToc summary::-webkit-details-marker{display:none}
          #nlmSidebarToc .toc-children{padding:6px 8px 8px 8px;display:flex;flex-direction:column;gap:4px}
          #nlmSidebarToc .toc-item{padding:6px 8px;border:1px solid rgba(255,255,255,.06);border-radius:8px;font-size:12.5px;cursor:pointer;background:rgba(255,255,255,.02)}
          #nlmSidebarToc .toc-item:hover{background:rgba(126,231,255,.08);border-color:rgba(126,231,255,.25)}
          #nlmSidebarToc .lvl2{margin-left:6px;opacity:.95}
          #nlmSidebarToc .lvl3{margin-left:12px;opacity:.85}
        `;
        (doc.head||doc.documentElement).appendChild(style);
      }

      const host = doc.getElementById('sidebarList') || doc.querySelector('.sidebar');
      if(!host) return;

      let box = doc.getElementById('nlmSidebarToc');
      if(!box){
        box = doc.createElement('div');
        box.id = 'nlmSidebarToc';
        box.className = 'sb-item';
        box.innerHTML = `
          <div class="sb-title">
            <span>Mục lục</span>
            <div class="ctrls">
              <button class="tiny" id="tocCollapse">Rút</button>
              <button class="tiny" id="tocExpand">Mở</button>
            <button class="tiny" id="tocDelete">Xóa NB</button></div>
          </div>
          <div class="search"><input id="tocSearch" placeholder="Lọc nhanh..." /></div>
          <div id="nlmSidebarTocBody" class="sb-sub"></div>`;
        host.prepend(box);
      }
      const body = box.querySelector('#nlmSidebarTocBody');
      
      // Hook delete button
      const delBtn = box.querySelector('#tocDelete');
      if(delBtn && !delBtn._wired){
        delBtn._wired = true;
        delBtn.addEventListener('click', function(ev){
          try{
            if(parent && typeof parent.createDeleteNotebookModal === 'function'){
              const overlay = parent.createDeleteNotebookModal();
              parent.document.body.appendChild(overlay);
            }else{
              alert('Chức năng xóa notebook chưa sẵn sàng.');
            }
          }catch(e){ alert('Không mở được hộp xoá.'); }
        });
      }
    const qInput = box.querySelector('#tocSearch');
      const lastOpen = Array.from(doc.querySelectorAll('#nlmSidebarToc details[open] summary')).map(s=>s.textContent.trim());
      const lastQ = box.getAttribute('data-q') || '';
      body.innerHTML = '';

      function addGroup(title){
        const det = doc.createElement('details');
        det.open = lastOpen.includes(title) || !!lastQ;
        det.className = 'toc-group';
        const sum = doc.createElement('summary'); sum.textContent = title;
        const inner = doc.createElement('div'); inner.className = 'toc-children';
        det.appendChild(sum); det.appendChild(inner); body.appendChild(det);
        return inner;
      }
      function addItem(container, text, lvl){
        const it = doc.createElement('div');
        it.className = 'toc-item lvl'+(lvl||1);
        it.textContent = text;
        it.addEventListener('click', function(){ try{ parent.goToInBook(text); }catch(_){}});
        container.appendChild(it);
      }

      notebooks.forEach((nb, i)=>{
        const nbTitle = (nb && nb.title) ? nb.title : ('Notebook '+(i+1));
        const container = addGroup(nbTitle);
        (Array.isArray(nb.chunks)? nb.chunks : []).forEach(ch=>{
          const t = (ch && ch.text) ? ch.text : '';
          extractHeadings(t).forEach(h=> addItem(container, h.title, Math.min(3, Math.max(1, h.lvl))));
        });
      });

      function applyFilter(){
        const q = (qInput.value||'').trim().toLowerCase();
        box.setAttribute('data-q', q);
        body.querySelectorAll('details').forEach(det=>{
          const title = det.querySelector('summary')?.textContent?.toLowerCase()||'';
          let any=false;
          det.querySelectorAll('.toc-item').forEach(it=>{
            const ok = !q || it.textContent.toLowerCase().includes(q);
            it.style.display = ok ? '' : 'none'; any = any || ok;
          });
          det.style.display = (!q || title.includes(q) || any) ? '' : 'none';
          if(q && any) det.open = true;
        });
      }
      qInput.value = lastQ; qInput.oninput = applyFilter; applyFilter();

      const btnCollapse = box.querySelector('#tocCollapse');
      const btnExpand   = box.querySelector('#tocExpand');
      btnCollapse.onclick = ()=> body.querySelectorAll('details').forEach(d=> d.open=false);
      btnExpand.onclick   = ()=> body.querySelectorAll('details').forEach(d=> d.open=true);
    }catch(e){ /* noop */ }
  }

  function boot(){
    const ifr = document.getElementById(IFRAME_ID);
    if(ifr){
      if(ifr.contentDocument && ifr.contentDocument.readyState === 'complete'){ setTimeout(buildInlineToc, 80); }
      ifr.addEventListener('load', ()=> setTimeout(buildInlineToc, 120));
      // Keep it in sync while typing/saving
      setInterval(buildInlineToc, 1500);
    }
    // expose rebuild for other scripts (e.g., Save bridge)
    window.rebuildNlmToc = buildInlineToc;
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot);
  else boot();
})();
</script>

<script>
// === Save bridge: attach handler to Lưu & Ctrl+Enter; write to localStorage KEY ===
(function(){
  const KEY = 'nlm_mvp_data_v1';
  function getState(){ try{ return JSON.parse(localStorage.getItem(KEY)||'{}'); }catch(_){ return {}; } }
  function setState(st){ localStorage.setItem(KEY, JSON.stringify(st)); }
  function ensureNotebooks(st){
    if(!st.notebooks || !Array.isArray(st.notebooks) || !st.notebooks.length){
      st.notebooks = [{ id: Date.now(), title: 'Notebook 1', chunks: [], updatedAt: Date.now() }];
    }
    return st;
  }
  function attach(){
    try{
      var ifr = document.getElementById('frame-nlm');
      if(!ifr) return;
      var idoc = ifr.contentDocument || (ifr.contentWindow && ifr.contentWindow.document);
      if(!idoc) return;
      var btn = idoc.getElementById('saveNoteBtn') || Array.from(idoc.getElementsByTagName('button')).find(b => (b.textContent||'').trim().toLowerCase()==='lưu');
      var title = idoc.getElementById('noteTitle') || idoc.querySelector('input[placeholder="Tiêu đề..."]');
      var body  = idoc.getElementById('noteBody')  || idoc.querySelector('textarea');
      var tags  = idoc.getElementById('noteTags');
      if(!btn || !body) return;

      function doSave(){
        var t = (title && title.value || '').trim();
        var b = (body && body.value || '').trim();
        var g = (tags && tags.value || '').trim();
        if(!t && !b) return;
        var text = (t ? ('# '+t+'\\n\\n') : '') + b + (g ? ('\\n\\nTags: '+g) : '');

        var st = ensureNotebooks(getState());
        var nb = st.notebooks[0]; nb.chunks = Array.isArray(nb.chunks) ? nb.chunks : [];
        nb.chunks.push({ text: text, createdAt: Date.now() });
        nb.updatedAt = Date.now(); setState(st);

        // Clear & refresh
        if(title) title.value=''; if(body) body.value=''; if(tags) tags.value='';
        try{ if(window.rebuildNlmToc) window.rebuildNlmToc(); }catch(_){}
        try{ var win = ifr.contentWindow || ifr.contentDocument.defaultView; if(win && typeof win.refreshBook==='function') win.refreshBook(); }catch(_){}
        // Toast
        try{
          var toast = idoc.createElement('div');
          toast.textContent = 'Đã lưu vào Notebook 1';
          toast.style.cssText='position:fixed;right:16px;bottom:16px;background:#0b1224;border:1px solid rgba(126,231,255,.3);padding:8px 12px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,.5);z-index:9999';
          idoc.body.appendChild(toast); setTimeout(()=> toast.remove(), 1200);
        }catch(_){}
      }
      if(!btn.getAttribute('data-bound')){ btn.addEventListener('click', doSave); btn.setAttribute('data-bound','1'); }
      if(body && !body.getAttribute('data-bound')){
        body.addEventListener('keydown', function(e){ if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ doSave(); } });
        body.setAttribute('data-bound','1');
      }
    }catch(e){}
  }

  var ifr = document.getElementById('frame-nlm');
  if(ifr){
    if(ifr.contentDocument && ifr.contentDocument.readyState === 'complete'){ setTimeout(attach, 120); }
    ifr.addEventListener('load', ()=> setTimeout(attach, 120));
  }
  // robust reattach
  let tries=0; const iv=setInterval(()=>{ attach(); if(++tries>60) clearInterval(iv); }, 600);
  try{
    var idoc2 = ifr && (ifr.contentDocument || (ifr.contentWindow && ifr.contentWindow.document));
    if(idoc2){ new MutationObserver(()=> attach()).observe(idoc2, {subtree:true, childList:true}); }
  }catch(_){}
})();
</script>
<script id="nbPickerAndSaveOverrideScript">
// === Notebook picker + override save target (Aurora request) ===
(function(){
  const KEY = 'nlm_mvp_data_v1';
  function getState(){ try{ return JSON.parse(localStorage.getItem(KEY)||'{}'); }catch(_){ return {}; } }
  function setState(st){ localStorage.setItem(KEY, JSON.stringify(st)); }
  function ensureNotebooks(st){
    if(!st.notebooks || !Array.isArray(st.notebooks) || !st.notebooks.length){
      st.notebooks = [{ id: Date.now(), title: 'Notebook 1', chunks: [], updatedAt: Date.now() }];
    }
    return st;
  }
  function getSelectedId(st){
    st = ensureNotebooks(st||getState());
    if(!st.selectedNotebookId){
      st.selectedNotebookId = st.notebooks[0]?.id;
      setState(st);
    }
    return st.selectedNotebookId;
  }
  function setSelectedId(id){
    const st = ensureNotebooks(getState());
    st.selectedNotebookId = id;
    setState(st);
  }
  function getNotebookTitleById(id){
    const st = ensureNotebooks(getState());
    const nb = (Array.isArray(st.notebooks)?st.notebooks:[]).find(n => String(n?.id)===String(id));
    return (nb && nb.title) ? nb.title : 'Notebook';
  }
  function addChunkToSelected(text){
    const st = ensureNotebooks(getState());
    const id = getSelectedId(st);
    const arr = Array.isArray(st.notebooks)? st.notebooks : [];
    const idx = arr.findIndex(n => String(n?.id)===String(id));
    const nb = idx>=0 ? arr[idx] : arr[0];
    if(!nb.chunks) nb.chunks = [];
    nb.chunks.push({ text, createdAt: Date.now() });
    nb.updatedAt = Date.now();
    setState(st);
    return nb && (nb.title || 'Notebook');
  }
  function getIframeDoc(){ const ifr = document.getElementById('frame-nlm'); return ifr && (ifr.contentDocument || (ifr.contentWindow && ifr.contentWindow.document)); }
  function buildPicker(){
    const idoc = getIframeDoc(); if(!idoc) return false;
    const hostRow = idoc.querySelector('#noteComposer .row3'); if(!hostRow) return false;
    let pick = idoc.getElementById('nbPicker');
    if(!pick){
      pick = idoc.createElement('select');
      pick.id = 'nbPicker';
      pick.title = 'Chọn Notebook để lưu';
      pick.style.marginLeft = '8px';
      pick.style.border = '1px solid var(--br, #223)';
      pick.style.background = 'rgba(255,255,255,.02)';
      pick.style.color = 'inherit';
      pick.style.borderRadius = '10px';
      pick.style.padding = '8px 10px';
      pick.style.minWidth = '180px';
      // Insert before date badge (if any) or before the Save button as fallback
      const dateBadge = idoc.getElementById('noteDate')?.parentElement || null;
      if(dateBadge) hostRow.insertBefore(pick, dateBadge);
      else{
        const saveBtn = idoc.getElementById('saveNoteBtn');
        if(saveBtn) hostRow.insertBefore(pick, saveBtn);
        else hostRow.appendChild(pick);
      }
    }
    // fill options
    const st = ensureNotebooks(getState());
    const selId = getSelectedId(st);
    pick.innerHTML = '';
    (Array.isArray(st.notebooks)? st.notebooks : []).forEach(nb => {
      const opt = idoc.createElement('option');
      opt.value = nb.id;
      opt.textContent = nb.title || 'Không tên';
      if(String(nb.id)===String(selId)) opt.selected = true;
      pick.appendChild(opt);
    });
    // change handler
    if(!pick.getAttribute('data-bound')){
      pick.addEventListener('change', function(){
        setSelectedId(this.value);
      });
      pick.setAttribute('data-bound','1');
    }
    return true;
  }
  function overrideSave(){
    const idoc = getIframeDoc(); if(!idoc) return;
    const btn = idoc.getElementById('saveNoteBtn') || Array.from(idoc.querySelectorAll('button,.btn')).find(b => (b.textContent||'').trim().toLowerCase()==='lưu');
    const body = idoc.getElementById('noteBody') || idoc.querySelector('textarea');
    const title = idoc.getElementById('noteTitle') || idoc.querySelector('input[placeholder="Tiêu đề..."]');
    const tags  = idoc.getElementById('noteTags');

    function composeText(){
      const t = (title && title.value || '').trim();
      const b = (body && body.value || '').trim();
      const g = (tags && tags.value || '').trim();
      if(!t && !b) return '';
      return (t ? ('# '+t+'\n\n') : '') + b + (g ? ('\n\nTags: '+g) : '');
    }
    function doOwnSave(){
      const text = composeText(); if(!text) return;
      const name = addChunkToSelected(text);
      // Clear inputs
      if(title) title.value=''; if(body) body.value=''; if(tags) tags.value='';
      // Trigger rebuilds
      try{ if(window.rebuildNlmToc) window.rebuildNlmToc(); }catch(_){}
      try{ const ifr = document.getElementById('frame-nlm'); const win = ifr && (ifr.contentWindow||ifr.contentDocument); if(win && typeof win.refreshBook==='function') win.refreshBook(); }catch(_){}
      // Toast
      try{
        const toast = idoc.createElement('div');
        toast.textContent = 'Đã lưu vào ' + name;
        toast.style.cssText='position:fixed;right:16px;bottom:14px;background:linear-gradient(180deg,#0e2344,#0a1b33);border:1px solid rgba(126,231,255,.3);padding:8px 12px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,.5);z-index:9999';
        idoc.body.appendChild(toast); setTimeout(()=> toast.remove(), 1200);
      }catch(_){}
    }
    // Intercept button click (capture) so the old handler doesn't run
    if(btn && !btn.getAttribute('data-capture')){
      btn.addEventListener('click', function(e){ try{ e.stopImmediatePropagation(); e.stopPropagation(); e.preventDefault(); }catch(_){}
        doOwnSave();
      }, true);
      btn.setAttribute('data-capture','1');
    }
    // Intercept Ctrl+Enter on textarea (capture)
    if(body && !body.getAttribute('data-capture')){
      body.addEventListener('keydown', function(e){
        if((e.ctrlKey||e.metaKey) && e.key==='Enter'){
          try{ e.stopImmediatePropagation(); e.stopPropagation(); e.preventDefault(); }catch(_){}
          doOwnSave();
        }
      }, true);
      body.setAttribute('data-capture','1');
    }
  }
  function watch(){
    buildPicker();
    overrideSave();
  }
  function boot(){
    const ifr = document.getElementById('frame-nlm');
    if(!ifr) return;
    if(ifr.contentDocument && ifr.contentDocument.readyState==='complete'){ setTimeout(watch, 120); }
    ifr.addEventListener('load', ()=> setTimeout(watch, 120));
    // retry a few times in case inner DOM mutates
    let tries=0; const iv=setInterval(()=>{ if(++tries>40) return clearInterval(iv); watch(); }, 500);
    // when clicking "+ Notebook mới", refresh picker after a short delay
    window.addEventListener('click', function(e){
      const t = e.target && e.target.closest && e.target.closest('button,.btn,div');
      const txt = t && (t.textContent||'').replace(/\s+/g,' ').trim().toLowerCase();
      if(txt && txt.includes('notebook mới')) setTimeout(watch, 600);
    }, true);
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot);
  else boot();
})();
</script>



<!-- === Aurora: Delete Notebook — selection modal + hooks (v1) === -->
<script>
(function(){
  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

  function getInnerWin(){
    const frame = document.getElementById('frame-nlm');
    if(!frame) return null;
    return frame.contentWindow || (frame.contentDocument && frame.contentDocument.defaultView) || null;
  }
  function getStateSafe(){
    try{
      const w = getInnerWin();
      if(w && typeof w.getState==='function') return w.getState() || {};
    }catch(e){}
    try{ return JSON.parse(localStorage.getItem('nlm_mvp_data_v1')||'{}'); }catch(_){}
    return {};
  }
  function setStateSafe(state){
    try{
      const w = getInnerWin();
      if(w && typeof w.setState==='function'){ w.setState(state||{}); return; }
    }catch(e){}
    try{ localStorage.setItem('nlm_mvp_data_v1', JSON.stringify(state||{})); }catch(_){}
  }
  function refreshInner(){
    try{
      const w = getInnerWin();
      if(w && typeof w.refreshBook==='function') w.refreshBook();
    }catch(e){}
    if(typeof window.rebuildNlmToc==='function') try{ window.rebuildNlmToc(); }catch(e){}
  }

  // Build the selection modal
  window.createDeleteNotebookModal = function(){
    const state = getStateSafe();
    const notebooks = Array.isArray(state.notebooks) ? state.notebooks.slice() : [];
    const overlay = document.createElement('div');
    overlay.style.position='fixed';
    overlay.style.inset='0';
    overlay.style.zIndex='9999';
    overlay.style.background='rgba(0,0,0,.45)';
    overlay.style.display='flex';
    overlay.style.alignItems='center';
    overlay.style.justifyContent='center';

    const wrap = document.createElement('div');
    wrap.setAttribute('role','dialog');
    wrap.setAttribute('aria-label','Chọn notebook để xoá');
    wrap.style.width='560px';
    wrap.style.maxWidth='92vw';
    wrap.style.background='linear-gradient(180deg, #0f162b 0%, #0b1224 100%)';
    wrap.style.border='1px solid var(--border, #223)';
    wrap.style.borderRadius='14px';
    wrap.style.boxShadow='0 18px 60px rgba(0,0,0,.4)';
    wrap.style.color='#e6edf7';
    wrap.style.font='14px/1.5 system-ui,-apple-system,Segoe UI,Roboto';
    wrap.style.padding='14px 14px 12px';

    const head = document.createElement('div');
    head.style.display='flex';
    head.style.alignItems='center';
    head.style.justifyContent='space-between';
    head.style.gap='8px';
    head.style.marginBottom='10px';
    head.innerHTML = '<div style="font-weight:700;font-size:18px">Chọn notebook để xoá</div>';
    const btnClose = document.createElement('button');
    btnClose.textContent='Đóng';
    btnClose.style.padding='6px 10px';
    btnClose.style.border='1px solid var(--border, #223)';
    btnClose.style.background='rgba(255,255,255,.06)';
    btnClose.style.borderRadius='8px';
    btnClose.style.color='inherit';
    btnClose.onclick=()=>document.body.removeChild(overlay);
    head.appendChild(btnClose);

    const search = document.createElement('input');
    search.type='text';
    search.placeholder='Tìm theo tên...';
    search.style.width='100%';
    search.style.margin='6px 0 8px';
    search.style.padding='10px 12px';
    search.style.borderRadius='10px';
    search.style.border='1px solid var(--border, #223)';
    search.style.background='rgba(255,255,255,.04)';
    search.style.color='inherit';

    const list = document.createElement('div');
    list.style.maxHeight='48vh';
    list.style.overflow='auto';
    list.style.border='1px solid var(--border, #223)';
    list.style.borderRadius='10px';
    list.style.background='rgba(255,255,255,.02)';

    let selectedId = notebooks[0] && notebooks[0].id;

    function render(){
      const q = (search.value||'').trim().toLowerCase();
      list.innerHTML='';
      notebooks
        .filter(nb=>!q || String(nb.title||'').toLowerCase().includes(q))
        .forEach(nb=>{
          const row = document.createElement('label');
          row.style.display='block';
          row.style.padding='10px 12px';
          row.style.borderBottom='1px solid rgba(255,255,255,.06)';
          row.style.cursor='pointer';
          row.onmouseenter=()=>row.style.background='rgba(255,255,255,.04)';
          row.onmouseleave=()=>row.style.background='transparent';

          const title = (nb && nb.title) ? nb.title : 'Không tên';
          const chunks = Array.isArray(nb?.chunks) ? nb.chunks : [];
          const isEmpty = !chunks.length || !String(chunks.map(c=>c?.text||'').join('\n')).trim();
          row.innerHTML =
            '<div style="display:flex;align-items:center;gap:10px">'+
            `<input type="radio" name="nbDel" value="${nb.id}" ${String(selectedId)===String(nb.id)?'checked':''} style="accent-color:#6aa2ff">`+
            `<div><div style="font-weight:600">${title}</div><div style="opacity:.7;font-size:12px">${isEmpty?'Trống':'Có nội dung'}</div></div>`+
            '</div>';
          row.addEventListener('click', ()=>{ selectedId = nb.id; });
          list.appendChild(row);
        });
      if(!list.children.length){
        list.innerHTML = '<div style="opacity:.8;padding:12px">Không tìm thấy notebook.</div>';
      }
    }
    search.oninput=render;

    const msg = document.createElement('div');
    msg.style.opacity='.8';
    msg.style.margin='8px 2px';
    msg.style.fontSize='12px';
    msg.textContent = 'Notebook đã chọn sẽ bị xoá vĩnh viễn khỏi trình duyệt này. Hành động không thể hoàn tác.';

    const actions = document.createElement('div');
    actions.style.display='flex';
    actions.style.justifyContent='flex-end';
    actions.style.gap='8px';
    actions.style.marginTop='10px';
    const btnCancel = document.createElement('button');
    btnCancel.textContent='Hủy';
    btnCancel.style.padding='8px 14px';
    btnCancel.style.borderRadius='10px';
    btnCancel.style.border='1px solid var(--border, #223)';
    btnCancel.style.background='rgba(255,255,255,.06)';
    btnCancel.style.color='inherit';
    btnCancel.onclick=()=>document.body.removeChild(overlay);
    const btnDel = document.createElement('button');
    btnDel.textContent='Xoá';
    btnDel.style.padding='8px 16px';
    btnDel.style.borderRadius='10px';
    btnDel.style.border='1px solid #b33';
    btnDel.style.background='linear-gradient(180deg,#ed5565,#c9302c)';
    btnDel.style.color='white';
    btnDel.onclick=function(){
      if(!selectedId){ alert('Chưa chọn notebook.'); return; }
      if(!confirm('Xoá notebook đã chọn?')) return;
      try{
        const w = getInnerWin();
        if(w && typeof w.deleteNotebook==='function'){
          w.deleteNotebook(selectedId);
        }else{
          const s = getStateSafe();
          const arr = Array.isArray(s.notebooks)? s.notebooks: [];
          s.notebooks = arr.filter(nb => String(nb.id) !== String(selectedId));
          setStateSafe(s);
        }
        refreshInner();
      }catch(e){
        console.error(e);
        alert('Không xoá được. Vui lòng thử lại.');
      }
      document.body.removeChild(overlay);
    };
    actions.appendChild(btnCancel);
    actions.appendChild(btnDel);

    wrap.appendChild(head);
    wrap.appendChild(search);
    wrap.appendChild(list);
    wrap.appendChild(msg);
    wrap.appendChild(actions);
    overlay.appendChild(wrap);
    render();
    return overlay;
  };

  // Add a small "Xóa NB" trigger into the NLM TOC pane header
  function ensureDeleteButton(){
    const header = document.querySelector('#nlmTocPane header');
    if(!header || header.querySelector('#btnNlmDelete')) return;
    const btn = document.createElement('button');
    btn.id = 'btnNlmDelete';
    btn.textContent = 'Xóa NB';
    btn.title = 'Xoá notebook…';
    btn.style.marginLeft='auto';
    btn.style.padding='6px 10px';
    btn.style.border='1px solid var(--border, #223)';
    btn.style.background='rgba(255,255,255,.06)';
    btn.style.borderRadius='8px';
    btn.style.color='inherit';
    btn.addEventListener('click', ()=>{
      const overlay = window.createDeleteNotebookModal();
      document.body.appendChild(overlay);
    });
    header.appendChild(btn);
  }

  // Also place a compact "Xóa NB" next to "+ Notebook mới" inside the iframe header row
  function ensureInlineDelete(){
    try{
      const frame = document.getElementById('frame-nlm');
      if(!frame) return;
      const d = frame.contentDocument; if(!d) return;
      // Find the "+ Notebook mới" button as anchor
      const btns = Array.from(d.querySelectorAll('button, .btn'));
      const anchor = btns.find(b => (b.textContent||'').replace(/\s+/g,' ').trim().toLowerCase() === '+ notebook mới'
                                   || (b.textContent||'').replace(/\s+/g,' ').trim().toLowerCase() === 'notebook mới');
      if(!anchor || d.getElementById('btnDeleteNbInline')) return;
      const del = d.createElement('button');
      del.id = 'btnDeleteNbInline';
      del.className = anchor.className || 'btn';
      del.textContent = 'Xóa NB';
      del.style.marginLeft = '8px';
      del.addEventListener('click', (ev)=>{
        ev.preventDefault(); ev.stopImmediatePropagation();
        const overlay = window.createDeleteNotebookModal();
        document.body.appendChild(overlay);
      }, true);
      anchor.insertAdjacentElement('afterend', del);
    }catch(e){ /* ignore cross-origin issues */ }
  }

  function boot(){
    ensureDeleteButton();
    ensureInlineDelete();
    const ifr = document.getElementById('frame-nlm');
    if(ifr){
      ifr.addEventListener('load', ()=>{ setTimeout(()=>{ ensureDeleteButton(); ensureInlineDelete(); }, 60); });
    }
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot);
  else boot();
})();
</script>

    <script>
    // Helper for Book View: compute current visible page width
    function getPageWidth(){
      const el = document.querySelector('.book-pages') || document.getElementById('bookPages') || document.body;
      if(!el) return window.innerWidth;
      return el.clientWidth || window.innerWidth;
    }
    </script>
    

<script>
(function(){
  try {
    const pages = document.querySelector('.book-pages') || document.getElementById('bookPages');
    const btnPrev = document.querySelector('[data-action="prev"]') || document.querySelector('#btnPrev') || document.querySelector('[aria-label="Prev"]');
    const btnNext = document.querySelector('[data-action="next"]') || document.querySelector('#btnNext') || document.querySelector('[aria-label="Next"]');
    const btnBm   = document.querySelector('[data-action="bookmark"]') || document.querySelector('#btnBm') || document.querySelector('[aria-label="Bookmark"]');

    function pageWidth(){ return getPageWidth(); }
    function go(delta){ if(!pages) return; pages.scrollBy({ left: delta*pageWidth(), behavior: 'smooth' }); }

    if(btnPrev){
      btnPrev.addEventListener('click', function(e){ e.preventDefault(); go(-1); });
    }
    if(btnNext){
      btnNext.addEventListener('click', function(e){ e.preventDefault(); go(1); });
    }

    function updatePageInfo(){
      const info = document.querySelector('.page-info') || document.getElementById('pageInfo');
      if(!pages || !info) return;
      const width = pageWidth();
      const total = Math.max(1, Math.round(pages.scrollWidth / width));
      const curr = Math.min(total, Math.max(1, Math.round(pages.scrollLeft / width) + 1));
      const pct = Math.min(100, Math.round((pages.scrollLeft + width) / pages.scrollWidth * 100));
      info.textContent = curr + ' / ' + total + ' · ' + pct + '%';
    }
    pages && pages.addEventListener('scroll', ()=>{ requestAnimationFrame(updatePageInfo); });
    window.addEventListener('resize', updatePageInfo);
    updatePageInfo();

    // Bookmark save/restore
    function saveBm(){
      if(!pages) return;
      const idx = Math.round(pages.scrollLeft / pageWidth());
      try{ localStorage.setItem('book_last_col', String(idx)); }catch{}
    }
    function restoreBm(){
      if(!pages) return;
      let idx = 0;
      try{ idx = parseInt(localStorage.getItem('book_last_col')||'0',10) || 0; }catch{ idx = 0; }
      pages.scrollTo({ left: idx*pageWidth(), behavior: 'auto' });
      updatePageInfo();
    }
    if(btnBm){
      btnBm.addEventListener('click', function(e){ e.preventDefault(); saveBm(); this.textContent='✅'; setTimeout(()=>this.textContent='🔖',900); });
    }
    // Restore on load
    restoreBm();

    // Optional: keyboard Left/Right
    document.addEventListener('keydown', (e)=>{
      if (['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
      if (e.key === 'ArrowLeft') go(-1);
      if (e.key === 'ArrowRight') go(1);
    });

  } catch(err){ console.warn('Book View override failed:', err); }
})();
</script>


<script>
(function(){
  const KEY = 'nlm_mvp_data_v1';
  const pagesWrap = document.getElementById('bookPages');
  const btnEdit = document.getElementById('btnEdit');
  const btnSave = document.getElementById('btnSave');
  const toc = document.getElementById('bookToc');

  if(!pagesWrap || !btnEdit || !btnSave) return;

  function getState(){ try{ return JSON.parse(localStorage.getItem(KEY)||'{}'); }catch{ return {}; } }
  function setState(st){ localStorage.setItem(KEY, JSON.stringify(st)); }
  function ensure(st){ if(!st.notebooks) st.notebooks=[]; return st; }

  function pageWidth(){ return pagesWrap.clientWidth || window.innerWidth; }
  function currentIndex(){ return Math.round(pagesWrap.scrollLeft / pageWidth()); }
  function pageEl(i){ return document.getElementById('nb_'+i); }

  function setEditing(on){
    const idx = currentIndex();
    const pg = pageEl(idx);
    if(!pg) return;
    pg.classList.toggle('editing', !!on);
    const head = pg.querySelector('.nb-head');
    const cards = pg.querySelectorAll('.note-card');
    [head, ...cards].forEach(el => { if(el) el.setAttribute('contenteditable', on ? 'true' : 'false'); });
    btnSave.disabled = !on;
    btnEdit.textContent = on ? 'Thoát sửa' : 'Sửa';
  }

  function htmlToText(root){
    if(!root) return '';
    // Clone to avoid touching live nodes
    const el = root.cloneNode(true);
    // Replace <br> with newline
    el.querySelectorAll('br').forEach(br => br.replaceWith('\n'));
    // Paragraphs -> join with blank line
    const ps = el.querySelectorAll('p');
    if(ps.length){
      return Array.from(ps).map(p => p.textContent).join('\n\n').trim();
    }
    return el.textContent.trim();
  }

  function saveCurrent(){
    const st = ensure(getState());
    const idx = currentIndex();
    const pg = pageEl(idx);
    if(!pg){ alert('Không tìm thấy trang hiện tại.'); return; }
    const head = pg.querySelector('.nb-head');
    const cards = pg.querySelectorAll('.note-card');
    const title = head ? head.textContent.trim() : ('Notebook ' + (idx+1));
    const chunks = Array.from(cards).map(c => ({ text: htmlToText(c) }));
    if(!st.notebooks[idx]) st.notebooks[idx] = {title, chunks: []};
    st.notebooks[idx].title = title;
    st.notebooks[idx].chunks = chunks;
    st.notebooks[idx].updatedAt = Date.now();
    setState(st);

    // Update TOC entry text live
    try{
      const link = toc && toc.querySelector(`a[href="#nb_${idx}"]`);
      if(link) link.textContent = title;
    }catch{}

    // Turn off edit mode
    setEditing(false);
    // Feedback
    btnSave.textContent = 'Đã lưu ✓';
    setTimeout(()=> btnSave.textContent='Lưu', 1200);
  }

  btnEdit.addEventListener('click', ()=>{
    const on = btnEdit.textContent !== 'Thoát sửa';
    setEditing(on);
  });
  btnSave.addEventListener('click', saveCurrent);

  // Ctrl+S save
  document.addEventListener('keydown', (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){
      const editing = btnEdit.textContent === 'Thoát sửa';
      if(editing){ e.preventDefault(); saveCurrent(); }
    }
  });
})();
</script>


<script>
// Lightweight Markdown -> HTML (GFM-lite) with table support.
(function(){
  function escapeHtml(s){ return s.replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
  function md2html_gfm(md){
    // Normalize line endings
    md = md.replace(/\r\n?/g, '\n');
    // Code fences (```)
    md = md.replace(/```([\s\S]*?)```/g, function(_, code){
      return '<pre><code>'+escapeHtml(code)+'</code></pre>';
    });
    // Blockquotes
    md = md.replace(/(^|\n)>([^\n]*)/g, function(_, br, body){
      return (br||'')+'<blockquote>'+escapeHtml(body.trim())+'</blockquote>';
    });
    // Headings
    md = md.replace(/^(#{1,6})[ \t]+(.+)$/gm, function(_, h, txt){
      const lvl = h.length; return '<h'+lvl+'>'+escapeHtml(txt.trim())+'</h'+lvl+'>';
    });
    // Horizontal rule
    md = md.replace(/^\s*[-*_]{3,}\s*$/gm, '<hr/>');

    // Tables (GFM): detect blocks with header | separator | rows
    md = md.replace(
      /(^|\n)(\|.*\|)\n(\|[ \t]*[-:]+[-| :]*\|)\n((?:\|.*\|\n?)*)/g,
      function(_, br, header, sep, rows){
        function splitRow(row){
          return row.trim().replace(/^\||\|$/g,'').split('|').map(c=>c.trim());
        }
        const heads = splitRow(header);
        const bodyRows = rows.trim().split(/\n/).filter(Boolean).map(splitRow);
        let thead = '<thead><tr>'+heads.map(h=>'<th>'+escapeHtml(h)+'</th>').join('')+'</tr></thead>';
        let tbody = '<tbody>'+bodyRows.map(r=>'<tr>'+r.map(c=>'<td>'+escapeHtml(c)+'</td>').join('')+'</tr>').join('')+'</tbody>';
        return (br||'')+'<table>'+thead+tbody+'</table>';
      }
    );
    // Unordered lists
    md = md.replace(/^(?:\s*[-*+]\s+.+(?:\n|$))+?/gm, function(block){
      const items = block.trim().split(/\n/).map(l=>l.replace(/^\s*[-*+]\s+/, '')).map(li=>'<li>'+escapeHtml(li)+'</li>').join('');
      return '<ul>'+items+'</ul>';
    });
    // Ordered lists
    md = md.replace(/^(?:\s*\d+\.\s+.+(?:\n|$))+?/gm, function(block){
      const items = block.trim().split(/\n/).map(l=>l.replace(/^\s*\d+\.\s+/, '')).map(li=>'<li>'+escapeHtml(li)+'</li>').join('');
      return '<ol>'+items+'</ol>';
    });
    // Bold/italic (basic, non-greedy)
    md = md.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>').replace(/\*([^*]+)\*/g, '<em>$1</em>');
    // Paragraphs: wrap leftover text lines into <p>
    md = md.replace(/(^|\n)([^<\n][^\n]*)/g, function(_, br, line){
      if(!line.trim()) return br || '';
      // Skip lines that already start with HTML tags we created
      if(/^\s*<(h\d|ul|ol|li|pre|blockquote|table|thead|tbody|tr|td|th|hr)/i.test(line)) return (br||'')+line;
      return (br||'')+'<p>'+escapeHtml(line)+'</p>';
    });
    return md;
  }
  window.md2html_gfm = md2html_gfm;
})();
</script>


<script>
// Intercept preview windows that write <pre>...</pre> and upgrade to HTML with table rendering.
(function(){
  const __origOpen = window.open;
  window.open = function(){
    const w = __origOpen.apply(window, arguments);
    if(!w || !w.document) return w;
    const doc = w.document;
    const origWrite = doc.write.bind(doc);
    doc.write = function(html){
      try{
        if (typeof html === 'string' && html.indexOf('<pre') !== -1 && html.indexOf('</pre>') !== -1){
          // Extract content inside <pre>...</pre>
          const m = html.match(/<pre[^>]*>([\s\S]*?)<\/pre>/i);
          if(m){
            let md = m[1];
            // Unescape common entities used by the preview
            md = md.replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&amp;/g,'&');
            const renderer = (window.md2html_gfm || (s=>s.replace(/\\n/g,'<br>')));
            const body = renderer(md);
            const page = '<!doctype html><meta charset="utf-8"><title>Preview</title>' +
              '<style>body{font:15px/1.6 system-ui;padding:18px;background:#0b1224;color:#e6edf7}'
              +'h1,h2,h3{margin:10px 0 8px} p{margin:6px 0}'
              +'table{border-collapse:collapse;width:100%;margin:12px 0}'
              +'th,td{border:1px solid rgba(255,255,255,.2);padding:6px 8px;vertical-align:top}'
              +'th{background:rgba(255,255,255,.06)}'
              +'code,pre{background:#0e1730;border:1px solid rgba(255,255,255,.08);padding:8px;border-radius:6px;display:block;overflow:auto}'
              +'blockquote{border-left:3px solid rgba(255,255,255,.25);padding-left:10px;margin:8px 0;color:#bcd}</style>'
              + body;
            return origWrite(page);
          }
        }
      }catch(e){ /* fallthrough */ }
      return origWrite(html);
    };
    return w;
  };
})();
</script>


<script>
(function(){
  const pagesWrap = document.getElementById('bookPages');
  const btnEdit = document.getElementById('btnEdit');
  const btnSave = document.getElementById('btnSave');
  const btnRender = document.getElementById('btnRender');
  const btnExportMd = document.getElementById('btnExportMd');

  if(!pagesWrap) return;

  function pageWidth(){ return pagesWrap.clientWidth || window.innerWidth; }
  function currentIndex(){ return Math.round(pagesWrap.scrollLeft / pageWidth()); }
  function pageEl(i){ return document.getElementById('nb_'+i); }

  // ---- Normalizer for new template content ----
  function normalizeMd(md){
    if(!md) return md;
    md = md.replace(/\r\n?/g, '\n');
    // Standardize HR
    md = md.replace(/^[ \t]*—[ \t]*$/gm, '---');
    // Ensure table rows end with trailing pipe when obvious table syntax
    md = md.replace(/^\|([^\n]+)\n\|([ \t:\-\|]+)\n((?:\|[^\n]*\n?)*)/gm, function(_, head, sep, body){
      function fixRow(r){
        let s = r.trim();
        if(!s.startsWith('|')) s = '|' + s;
        if(!s.endsWith('|')) s = s + '|';
        return s;
      }
      const fixedHead = fixRow(head);
      const fixedSep  = fixRow(sep.replace(/[^\-\|\:\s]/g,''));
      const fixedBody = body.split(/\n/).filter(Boolean).map(fixRow).join('\n') + '\n';
      return fixedHead+'\n'+fixedSep+'\n'+fixedBody;
    });
    // Normalize task list syntax
    md = md.replace(/^\s*-\s+\[\s\]/gm, '- [ ]');
    md = md.replace(/^\s*-\s+\[x\]/gmi, '- [x]');
    return md;
  }
  window.normalizeMd = normalizeMd; // expose for other scripts

  // ---- Render mode ----
  function renderCard(el){
    if(!el) return;
    if(!el.dataset.md) el.dataset.md = el.innerText;
    const md = el.dataset.md;
    const html = (window.md2html_gfm ? window.md2html_gfm(md) : md.replace(/\\n/g,'<br>'));
    // task list: convert "- [ ] " / "- [x] " to checkboxes
    const withTasks = html
      .replace(/- \[ \] ([^<\\n]+)(?=<|$)/g, function(_, text){
        return '<label><input type="checkbox" class="md-task"> '+text+'</label>';
      })
      .replace(/- \[x\] ([^<\\n]+)(?=<|$)/gi, function(_, text){
        return '<label><input type="checkbox" class="md-task" checked> '+text+'</label>';
      });
    el.innerHTML = withTasks;
    el.dataset.rendered = "1";
    // wire checkbox -> back to md
    el.querySelectorAll('input.md-task').forEach((box)=>{
      box.addEventListener('change', ()=>{
        // rebuild md from DOM
        const clone = el.cloneNode(true);
        clone.querySelectorAll('input.md-task').forEach(inp=>{
          const label = inp.closest('label');
          const text = label ? (label.textContent || '').trim() : '';
          const token = inp.checked ? '- [x] ' : '- [ ] ';
          label.replaceWith(token + text + '\\n');
        });
        el.dataset.md = clone.textContent;
      });
    });
  }

  function unrenderCard(el){
    if(!el) return;
    const md = el.dataset.md || el.innerText;
    el.textContent = md;
    el.dataset.rendered = "0";
  }

  function setRender(on){
    const idx = currentIndex();
    const pg = pageEl(idx);
    if(!pg) return;
    pg.classList.toggle('rendering', !!on);
    const cards = pg.querySelectorAll('.note-card');
    cards.forEach(el => on ? renderCard(el) : unrenderCard(el));
    btnRender.textContent = on ? 'Tắt hiển thị' : 'Hiển thị';
    // If entering render, ensure edit mode off
    if(on && btnEdit && btnEdit.textContent === 'Thoát sửa'){
      btnEdit.click();
    }
  }

  // hook buttons
  if(btnRender){
    btnRender.addEventListener('click', ()=>{
      const on = btnRender.textContent !== 'Tắt hiển thị';
      setRender(on);
    });
  }
  if(btnEdit){
    // turning on edit should disable render
    btnEdit.addEventListener('click', ()=>{
      const idx = currentIndex();
      const pg = pageEl(idx);
      if(!pg) return;
      if(pg.classList.contains('rendering')) setRender(false);
    });
  }

  // ---- Export current notebook to .md ----
  function exportCurrentMd(){
    const idx = currentIndex();
    const pg = pageEl(idx);
    if(!pg){ alert('Không tìm thấy trang hiện tại.'); return; }
    const title = pg.querySelector('.nb-head')?.textContent?.trim() || ('Notebook '+(idx+1));
    const parts = ['# '+title, ''];
    pg.querySelectorAll('.note-card').forEach(el=>{
      const md = el.dataset.md || el.innerText;
      parts.push(md.trim(), '');
    });
    const blob = new Blob([parts.join('\\n')], {type: 'text/markdown;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = title.replace(/[^\\w\\-]+/g,'_') + '.md';
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
  }
  if(btnExportMd) btnExportMd.addEventListener('click', exportCurrentMd);

  // ---- Integrate normalizer into existing creator if present ----
  try{
    // Monkey-patch global doCreate or the code path where content is prepared
    const oldDoCreate = window.doCreate;
    if(typeof oldDoCreate === 'function'){
      window.doCreate = function(){
        // temporarily intercept prompt -> but leave logic
        return oldDoCreate.apply(this, arguments);
      };
    }
  }catch{}

  // Replace 'const content = normalizeMd(fillPlaceholders(tpl.body));' to normalized version at runtime (in case not patched)
  try{
    // If inner iframe exposes factory: wrap createNotebook to normalize
    const frame = document.getElementById('bookAppFrame');
    const win = frame && (frame.contentWindow || frame.contentDocument?.defaultView);
    if(win && typeof win.createNotebook === 'function'){
      const orig = win.createNotebook;
      win.createNotebook = function(title, text){
        return orig.call(win, title, normalizeMd(text));
      };
    }
  }catch{}
})();
</script>


<script id="bookview-controller">
(function(){
  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }

  const bookView = document.getElementById('book-view');
  if(!bookView) return;
  const pagesWrap = document.getElementById('bookPages');
  const content = document.getElementById('bookContent');
  const btnPrev = document.getElementById('bookPrev');
  const btnNext = document.getElementById('bookNext');
  const pageLabel = document.getElementById('bookPageLabel');
  const progress = document.getElementById('bookProgress');
  const bookTocPane = document.getElementById('bookToc');
  const bookTocBtn = document.getElementById('bookTocBtn');
  const btnEdit = document.getElementById('btnEdit');
  const btnSave = document.getElementById('btnSave');
  const btnRender = document.getElementById('btnRender');
  const btnExport = document.getElementById('btnExport');
  const btnExportMd = document.getElementById('btnExportMd');
  const btnImport = document.getElementById('btnImport');
  const importFile = document.getElementById('importFile');
  const fontSlider = document.getElementById('bookFont');
  const bookmarkBtn = document.getElementById('bookBookmark');
  const STORAGE_KEY = 'bookv4_pages';

  // --- State ---
  let isEditing = false;
  let isRendering = false;

  // --- Helpers ---
  function pages(){ return $all('.nb-page', content); }
  function currentPageIndex(){
    const w = pagesWrap.clientWidth;
    const sc = pagesWrap.scrollLeft;
    return Math.round(sc / Math.max(1, w));
  }
  function goTo(i){
    const p = pages();
    if(p.length===0) return;
    const clamped = Math.max(0, Math.min(i, p.length-1));
    pagesWrap.scrollTo({ left: clamped * pagesWrap.clientWidth, behavior: 'smooth' });
    updateStatus();
  }
  function updateStatus(){
    const p = pages();
    const idx = currentPageIndex();
    pageLabel && (pageLabel.textContent = `${Math.min(idx+1, p.length)} / ${p.length}`);
    const maxScroll = pagesWrap.scrollWidth - pagesWrap.clientWidth;
    const pct = maxScroll > 0 ? Math.min(100, Math.round(pagesWrap.scrollLeft / maxScroll * 100)) : 0;
    progress && (progress.textContent = `${pct}%`);
  }
  function toggleTOC(){
    if(!bookTocPane) return;
    const visible = bookTocPane.style.display !== 'none';
    bookTocPane.style.display = visible ? 'none' : 'block';
  }
  function buildTOC(){
    if(!bookTocPane) return;
    bookTocPane.innerHTML = '<h4>Mục lục</h4>';
    pages().forEach((pg, i) => {
      const heads = $all('.nb-head, h2, h3', pg);
      if(heads.length === 0){
        const a = document.createElement('a');
        a.className = 'toc-item';
        a.textContent = `Trang ${i+1}`;
        a.href = 'javascript:void(0)';
        a.addEventListener('click', () => goTo(i));
        bookTocPane.appendChild(a);
      } else {
        heads.forEach(h => {
          const a = document.createElement('a');
          a.className = 'toc-item';
          a.textContent = `${i+1} · ${h.textContent.trim() || 'Untitled'}`;
          a.href = 'javascript:void(0)';
          a.addEventListener('click', () => goTo(i));
          bookTocPane.appendChild(a);
        });
      }
    });
  }
  function ensurePagesExist(){
    if(pages().length === 0){
      const pg = document.createElement('section');
      pg.className = 'nb-page';
      pg.innerHTML = '<div class="nb-block"><div class="nb-head">Trang mới</div><div class="note-card"><p>Nhập nội dung…</p></div></div>';
      content.appendChild(pg);
    }
  }
  function persist(){
    const payload = pages().map(pg => pg.innerHTML);
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      return true;
    }catch(e){ console.error(e); return false; }
  }
  function restore(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return false;
      const arr = JSON.parse(raw);
      if(!Array.isArray(arr)) return false;
      content.innerHTML = '';
      arr.forEach(html => {
        const pg = document.createElement('section');
        pg.className = 'nb-page';
        pg.innerHTML = html;
        content.appendChild(pg);
      });
      return true;
    }catch(e){ console.error(e); return false; }
  }

  function setEditing(on){
    isEditing = !!on;
    document.body.classList.toggle('editing', isEditing);
    $all('.nb-head, .note-card', content).forEach(el => {
      el.setAttribute('contenteditable', isEditing ? 'true' : 'false');
    });
    btnSave && (btnSave.disabled = !isEditing);
  }

  function setRendering(on){
    isRendering = !!on;
    document.body.classList.toggle('rendering', isRendering);
    $all('.note-card', content).forEach(el => {
      if(isRendering){ el.setAttribute('data-rendered','1'); }
      else { el.removeAttribute('data-rendered'); }
    });
  }

  // --- Import / Export ---
  function exportJSON(){
    const data = {
      version: 1,
      pages: pages().map(pg => pg.innerHTML)
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'book-data.json';
    a.click();
    URL.revokeObjectURL(url);
  }

  function exportMarkdown(){
    // extremely simple: concatenate textContent of blocks with headings
    const md = pages().map((pg, i) => {
      const parts = [`# Trang ${i+1}`];
      $all('.nb-head', pg).forEach(h => parts.push(`## ${h.textContent.trim()}`));
      $all('.note-card', pg).forEach(n => parts.push(n.textContent.trim()));
      return parts.join('\n\n');
    }).join('\n\n---\n\n');
    const blob = new Blob([md], {type:'text/markdown'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'book.md';
    a.click();
    URL.revokeObjectURL(url);
  }

  function importFromFile(file){
    const ext = (file.name.split('.').pop()||'').toLowerCase();
    const reader = new FileReader();
    reader.onload = function(){
      try{
        if(ext === 'json'){
          const data = JSON.parse(String(reader.result));
          const list = Array.isArray(data?.pages) ? data.pages : (Array.isArray(data) ? data : []);
          if(list.length){
            content.innerHTML = '';
            list.forEach(html => {
              const pg = document.createElement('section');
              pg.className = 'nb-page';
              pg.innerHTML = html;
              content.appendChild(pg);
            });
            persist();
            buildTOC();
            updateStatus();
            return;
          }
        } else if(ext === 'md' || ext === 'txt'){
          // naive split by heading delimiter
          const txt = String(reader.result);
          const splits = txt.split(/\n-{3,}\n/g);
          content.innerHTML = '';
          splits.forEach((chunk, i) => {
            const pg = document.createElement('section');
            pg.className = 'nb-page';
            pg.innerHTML = `<div class="nb-block"><div class="nb-head">Trang ${i+1}</div><div class="note-card"><p>${chunk.replace(/[&<>]/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[s]))}</p></div></div>`;
            content.appendChild(pg);
          });
          persist();
          buildTOC();
          updateStatus();
          return;
        }
        alert('Định dạng không hỗ trợ hoặc dữ liệu trống.');
      }catch(e){
        console.error(e);
        alert('Không thể nhập dữ liệu.');
      }
    };
    reader.readAsText(file);
  }

  // --- Bindings ---
  function bind(){
    ensurePagesExist();
    buildTOC();
    updateStatus();

    pagesWrap.addEventListener('scroll', () => { updateStatus(); }, {passive:true});
    window.addEventListener('resize', updateStatus);

    btnPrev && btnPrev.addEventListener('click', () => goTo(currentPageIndex()-1));
    btnNext && btnNext.addEventListener('click', () => goTo(currentPageIndex()+1));

    bookTocBtn && bookTocBtn.addEventListener('click', toggleTOC);

    btnEdit && btnEdit.addEventListener('click', () => setEditing(!isEditing));
    btnSave && btnSave.addEventListener('click', () => { if(persist()) btnSave.disabled = true; });
    content.addEventListener('input', () => { if(isEditing) btnSave && (btnSave.disabled = false); });

    btnRender && btnRender.addEventListener('click', () => setRendering(!isRendering));

    btnExport && btnExport.addEventListener('click', exportJSON);
    btnExportMd && btnExportMd.addEventListener('click', exportMarkdown);
    btnImport && btnImport.addEventListener('click', () => importFile && importFile.click());
    importFile && importFile.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if(f) importFromFile(f);
      e.target.value = '';
    });

    fontSlider && fontSlider.addEventListener('input', (e) => {
      const v = parseInt(e.target.value || '16', 10);
      content.style.setProperty('--book-font', v);
      content.style.fontSize = v + 'px';
    });

    // Restore persisted data if present
    if(!restore()){
      persist();
    }

    // Bookmark simply stores current page index
    bookmarkBtn && bookmarkBtn.addEventListener('click', () => {
      localStorage.setItem('bookv4_bookmark', String(currentPageIndex()));
      bookmarkBtn.textContent = '🔖 ✓';
      setTimeout(() => bookmarkBtn.textContent = '🔖', 1000);
    });

    // On load, jump to bookmark if exists
    const bm = parseInt(localStorage.getItem('bookv4_bookmark') || '-1', 10);
    if(bm >= 0) goTo(bm);
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bind);
  } else {
    bind();
  }
})();
</script>

</body>
</html>
